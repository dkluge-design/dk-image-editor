"use strict";var s=require("react/jsx-runtime"),w=require("react");const ze={QUARTER_TURN:90,NEGATIVE_QUARTER_TURN:-90},ae={FINETUNE:{min:-100,max:100},STROKE_WIDTH:{min:1,max:20},FONT_SIZE:{min:12,max:72}},je={RENDER:10,FILTER_RESET:50},ut=({size:a=16,color:e="currentColor"})=>s.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",stroke:e,strokeWidth:"2",children:[s.jsx("rect",{x:"3",y:"11",width:"18",height:"11",rx:"2",ry:"2"}),s.jsx("circle",{cx:"12",cy:"16",r:"1"}),s.jsx("path",{d:"M7 11V7a5 5 0 0 1 10 0v4"})]}),gt=({size:a=16,color:e="currentColor"})=>s.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",stroke:e,strokeWidth:"2",children:[s.jsx("rect",{x:"3",y:"11",width:"18",height:"11",rx:"2",ry:"2"}),s.jsx("circle",{cx:"12",cy:"16",r:"1"}),s.jsx("path",{d:"M7 11V7a5 5 0 0 1 9.9-1"})]});function Ie(a){const e=a.size||a.width||20,t=a.size||a.height||20;return s.jsxs("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[s.jsx("path",{d:"M3 12a9 9 0 019-9 9.75 9.75 0 016.74 2.74L21 8"}),s.jsx("path",{d:"M21 3v5h-5"}),s.jsx("path",{d:"M21 12a9 9 0 01-9 9 9.75 9.75 0 01-6.74-2.74L3 16"}),s.jsx("path",{d:"M3 21v-5h5"})]})}const pt={"common.cancel":"Cancel","header.copy":"Copy","header.copy.success":"Image copied to clipboard","header.copy.failed":"Failed to copy image","header.upload":"Upload Image","header.undo":"Undo","header.redo":"Redo","header.download":"Download","header.confirm":"Confirm","header.close":"Close","header.zoom.in":"Zoom In","header.zoom.out":"Zoom Out","header.zoom.reset":"Reset Zoom","header.close.confirm":"Are you sure you want to close? Any unsaved changes will be lost.","tool.select":"Select","tool.crop":"Crop","tool.filter":"Filter","tool.annotate":"Annotate","tool.sticker":"Sticker","tool.finetune":"Finetune","tool.frame":"Frame","crop.original":"Original","crop.lock.ratio":"Lock Aspect Ratio","crop.unlock.ratio":"Unlock Aspect Ratio","crop.rotation":"Rotation","crop.scale":"Scale","crop.skew":"Skew","crop.reset":"Reset All Adjustments","finetune.brightness":"Brightness","finetune.contrast":"Contrast","finetune.saturation":"Saturation","finetune.exposure":"Exposure","finetune.gamma":"Gamma","finetune.vignette":"Vignette","finetune.reset":"Reset All Finetune Settings","annotate.sharpie":"Sharpie","annotate.draw":"Draw","annotate.line":"Line","annotate.arrow":"Arrow","annotate.rectangle":"Rectangle","annotate.ellipse":"Ellipse","annotate.text":"Text","annotate.color":"Color","annotate.stroke":"Stroke","annotate.fill":"Fill","annotate.width":"Width","annotate.size":"Size","annotate.clear.fill":"Clear Fill","filter.basic":"Basic","filter.artistic":"Artistic","filter.enhance":"Enhance","filter.reset":"Reset","sticker.faces":"Faces","sticker.hands":"Hands","sticker.hearts":"Hearts","sticker.animals":"Animals","sticker.fruits":"Fruits","sticker.food":"Food","sticker.transport":"Transport","sticker.nature":"Nature","sticker.numbers":"Numbers","sticker.stickers":"Stickers","sticker.symbols":"Symbols","sticker.upload":"Upload","toolbar.delete":"Delete Selected","toolbar.copy":"Copy Selected","toolbar.front":"Bring to Front","toolbar.back":"Send to Back","toolbar.forward":"Move Forward","toolbar.backward":"Move Backward","toolbar.bold":"Bold","toolbar.italic":"Italic","toolbar.underline":"Underline","toolbar.strikethrough":"Strikethrough","toolbar.font.smaller":"Smaller Font","toolbar.font.larger":"Larger Font","toolbar.text.color":"Text Color","toolbar.stroke.color":"Stroke Color","toolbar.fill.color":"Fill Color","toolbar.stroke.width":"Stroke Width","toolbar.clear.fill":"Clear Fill","toolbar.opacity":"Opacity","toolbar.flip.horizontal":"Flip Horizontal","toolbar.flip.vertical":"Flip Vertical","loading.image":"Loading image...","frame.none":"None","frame.solidSharp":"Solid Sharp","frame.solidRound":"Solid Round","frame.lineSingle":"Single Line","frame.lineMultiple":"Multiple Lines","frame.edgeCross":"Edge Cross","frame.edgeSeparate":"Edge Separate","frame.edgeOverlap":"Edge Overlap","frame.hook":"Hook","frame.polaroid":"Polaroid","toolbar.delete.multi":"Delete {count} selected items","toolbar.copy.multi":"Copy {count} selected items","toolbar.selected.count":"{count} items selected","common.none":"None","common.width":"Width","common.height":"Height","common.color":"Color","common.size":"Size"},mt={"common.cancel":"\u53D6\u6D88","header.copy":"\u590D\u5236","header.copy.success":"\u56FE\u7247\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F","header.copy.failed":"\u590D\u5236\u56FE\u7247\u5931\u8D25","header.upload":"\u4E0A\u4F20\u56FE\u7247","header.undo":"\u64A4\u9500","header.redo":"\u91CD\u505A","header.download":"\u4E0B\u8F7D","header.confirm":"\u786E\u8BA4","header.close":"\u5173\u95ED","header.zoom.in":"\u653E\u5927","header.zoom.out":"\u7F29\u5C0F","header.zoom.reset":"\u91CD\u7F6E\u7F29\u653E","header.close.confirm":"\u786E\u5B9A\u8981\u5173\u95ED\u5417\uFF1F\u672A\u4FDD\u5B58\u7684\u66F4\u6539\u5C06\u4E22\u5931\u3002","tool.select":"\u9009\u62E9","tool.crop":"\u88C1\u526A","tool.filter":"\u6EE4\u955C","tool.annotate":"\u6807\u6CE8","tool.sticker":"\u8D34\u7EB8","tool.finetune":"\u5FAE\u8C03","tool.frame":"\u8FB9\u6846","crop.original":"\u539F\u59CB","crop.lock.ratio":"\u9501\u5B9A\u5BBD\u9AD8\u6BD4","crop.unlock.ratio":"\u89E3\u9501\u5BBD\u9AD8\u6BD4","crop.rotation":"\u65CB\u8F6C","crop.scale":"\u7F29\u653E","crop.skew":"\u503E\u659C","crop.reset":"\u91CD\u7F6E\u6240\u6709\u8C03\u6574","finetune.brightness":"\u4EAE\u5EA6","finetune.contrast":"\u5BF9\u6BD4\u5EA6","finetune.saturation":"\u9971\u548C\u5EA6","finetune.exposure":"\u66DD\u5149","finetune.gamma":"\u4F3D\u9A6C","finetune.vignette":"\u6697\u89D2","finetune.reset":"\u91CD\u7F6E\u6240\u6709\u5FAE\u8C03\u8BBE\u7F6E","annotate.sharpie":"\u9A6C\u514B\u7B14","annotate.draw":"\u7ED8\u5236","annotate.line":"\u76F4\u7EBF","annotate.arrow":"\u7BAD\u5934","annotate.rectangle":"\u77E9\u5F62","annotate.ellipse":"\u692D\u5706","annotate.text":"\u6587\u672C","annotate.color":"\u989C\u8272","annotate.stroke":"\u63CF\u8FB9","annotate.fill":"\u586B\u5145","annotate.width":"\u5BBD\u5EA6","annotate.size":"\u5927\u5C0F","annotate.clear.fill":"\u900F\u660E\u586B\u5145","filter.basic":"\u57FA\u7840\u6EE4\u955C","filter.artistic":"\u827A\u672F\u6EE4\u955C","filter.enhance":"\u589E\u5F3A\u6EE4\u955C","filter.reset":"\u91CD\u7F6E\u6EE4\u955C","sticker.faces":"\u8868\u60C5","sticker.hands":"\u624B\u52BF","sticker.hearts":"\u7231\u5FC3","sticker.animals":"\u52A8\u7269","sticker.fruits":"\u6C34\u679C","sticker.food":"\u98DF\u7269","sticker.transport":"\u4EA4\u901A","sticker.nature":"\u690D\u7269","sticker.numbers":"\u6570\u5B57","sticker.stickers":"\u8D34\u7EB8","sticker.symbols":"\u7B26\u53F7","sticker.upload":"\u4E0A\u4F20","toolbar.delete":"\u5220\u9664\u9009\u4E2D","toolbar.copy":"\u590D\u5236\u9009\u4E2D","toolbar.front":"\u79FB\u5230\u6700\u4E0A\u5C42","toolbar.back":"\u79FB\u5230\u6700\u4E0B\u5C42","toolbar.forward":"\u4E0A\u79FB\u4E00\u5C42","toolbar.backward":"\u4E0B\u79FB\u4E00\u5C42","toolbar.bold":"\u52A0\u7C97","toolbar.italic":"\u659C\u4F53","toolbar.underline":"\u4E0B\u5212\u7EBF","toolbar.strikethrough":"\u5220\u9664\u7EBF","toolbar.font.smaller":"\u5B57\u53F7-","toolbar.font.larger":"\u5B57\u53F7+","toolbar.text.color":"\u6587\u672C\u989C\u8272","toolbar.stroke.color":"\u63CF\u8FB9\u989C\u8272","toolbar.fill.color":"\u586B\u5145\u989C\u8272","toolbar.stroke.width":"\u63CF\u8FB9\u5BBD\u5EA6","toolbar.clear.fill":"\u6E05\u9664\u586B\u5145","toolbar.opacity":"\u900F\u660E\u5EA6","toolbar.flip.horizontal":"\u6C34\u5E73\u7FFB\u8F6C","toolbar.flip.vertical":"\u5782\u76F4\u7FFB\u8F6C","loading.image":"\u52A0\u8F7D\u56FE\u7247\u4E2D...","frame.none":"\u65E0\u8FB9\u6846","frame.solidSharp":"\u5B9E\u7EBF\u65B9\u6846","frame.solidRound":"\u5B9E\u7EBF\u5706\u89D2","frame.lineSingle":"\u5355\u7EBF\u8FB9\u6846","frame.lineMultiple":"\u591A\u7EBF\u8FB9\u6846","frame.edgeCross":"\u4EA4\u53C9\u8FB9\u6846","frame.edgeSeparate":"\u5206\u79BB\u8FB9\u6846","frame.edgeOverlap":"\u91CD\u53E0\u8FB9\u6846","frame.hook":"\u94A9\u5F62\u8FB9\u6846","frame.polaroid":"\u62CD\u7ACB\u5F97","toolbar.delete.multi":"\u5220\u9664\u9009\u4E2D\u7684 {count} \u4E2A\u5143\u7D20","toolbar.copy.multi":"\u590D\u5236\u9009\u4E2D\u7684 {count} \u4E2A\u5143\u7D20","toolbar.selected.count":"\u5DF2\u9009\u4E2D {count} \u4E2A\u5143\u7D20","common.none":"\u65E0","common.width":"\u5BBD\u5EA6","common.height":"\u9AD8\u5EA6","common.color":"\u989C\u8272","common.size":"\u5927\u5C0F"},re={en:pt,zh:mt},De=w.createContext(null),Pe=({language:a="en",translations:e,children:t})=>{const i=w.useMemo(()=>{const o=e?{...re,...Object.keys(e).reduce((l,r)=>(l[r]={...re[r]||re.en||{},...e[r]},l),{})}:re,n=o[a]||o.en||re.en;return{t:(l,r)=>{let c=n&&n[l]||l;return r&&Object.entries(r).forEach(([d,h])=>{c=c.replace(`{${d}}`,String(h))}),c},language:a}},[a,e]);return w.createElement(De.Provider,{value:i},t)},D=()=>{const a=w.useContext(De);if(!a)throw new Error("useTranslation must be used within I18nProvider");return a};function be(a,e){e===void 0&&(e={});var t=e.insertAt;if(!(!a||typeof document>"u")){var i=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css",t==="top"&&i.firstChild?i.insertBefore(o,i.firstChild):i.appendChild(o),o.styleSheet?o.styleSheet.cssText=a:o.appendChild(document.createTextNode(a))}}var xt=".dk-slider{align-items:center;display:flex;width:100%}.dk-slider input[type=range]{-webkit-appearance:none;appearance:none;background:linear-gradient(to right,#007bff 0,#007bff var(--progress,0),hsla(0,0%,100%,.2) var(--progress,0),hsla(0,0%,100%,.2) 100%);border-radius:2px;cursor:pointer;height:4px;outline:none;transition:all .2s ease;width:100%}.dk-slider input[type=range]:hover{background:linear-gradient(to right,#0056b3 0,#0056b3 var(--progress,0),hsla(0,0%,100%,.3) var(--progress,0),hsla(0,0%,100%,.3) 100%)}.dk-slider input[type=range]:disabled{cursor:not-allowed;opacity:.5}.dk-slider input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;background:#007bff;border:2px solid hsla(0,0%,100%,.816);border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,.2);cursor:pointer;height:16px;transition:all .2s ease;width:16px}.dk-slider input[type=range]::-webkit-slider-thumb:hover{background:#0056b3;transform:scale(1.1)}.dk-slider input[type=range]::-moz-range-thumb{background:#007bff;border:2px solid hsla(0,0%,100%,.816);border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,.2);cursor:pointer;height:16px;transition:all .2s ease;width:16px}.dk-slider input[type=range]::-moz-range-thumb:hover{background:#0056b3;transform:scale(1.1)}.dk-slider input[type=range]::-moz-range-track{background:hsla(0,0%,100%,.2);border-radius:2px;height:4px}.dk-slider input[type=range]::-moz-range-progress{background:#007bff;border-radius:2px;height:4px}.dk-slider label,.dk-slider span{flex-shrink:0;font-size:12px}";be(xt);function te({min:a,max:e,value:t,onChange:i,step:o=1,className:n="",disabled:l=!1,width:r="100%",showValue:c=!1,showLabel:d=!1,label:h}){const u=w.useRef(null),g=w.useCallback(()=>{if(u.current){const m=(t-a)/(e-a)*100;u.current.style.setProperty("--progress",`${m}%`)}},[t,a,e]),p=w.useCallback(m=>{const f=parseFloat(m.target.value);i(f)},[i]);return w.useEffect(()=>{g()},[g]),s.jsxs("div",{className:`dk-slider ${n}`,style:{width:r},children:[d&&h&&s.jsxs("label",{children:[h,"\xA0"]}),s.jsx("input",{ref:u,type:"range",min:a,max:e,step:o,value:t,onChange:p,disabled:l}),c&&s.jsxs("span",{children:["\xA0",t.toFixed(0)]})]})}const ft=({editorState:a,cropPresets:e,editorRef:t,onStateChange:i})=>{const{t:o}=D(),[n,l]=w.useState(!1),[r,c]=w.useState(""),[d,h]=w.useState("");w.useEffect(()=>{if(!a.crop||!t.current)return;const x=t.current,_=x.getImageDisplay(),b=x.getOriginalImageSize(),{crop:C}=a;if(!b.width||!_.width)return;const j=C.width/_.width,S=C.height/_.height,I=Math.round(b.width*j),M=Math.round(b.height*S);c(I.toString()),h(M.toString())},[a.crop,t.current]);const u=w.useCallback(()=>{const x=t.current;x&&x.recalculateImageDisplay&&x.recalculateImageDisplay()},[t]),g=w.useCallback(()=>{const x=t.current;x&&(i({rotation:0,flipX:!1,flipY:!1,scale:1,skewX:0,skewY:0}),setTimeout(()=>{u();const _=x.getImageDisplay();i({crop:{x:_.x,y:_.y,width:_.width,height:_.height}})},50))},[t,i,u]),p=w.useCallback(x=>{if(!x.ratio){g();return}const _=t.current;if(!_)return;const b=_.getImageDisplay(),C=_.getState(),j=(C.rotation||0)*Math.PI/180,S=C.scale||1,I=C.skewX||0,M=C.skewY||0,E=Math.abs(Math.cos(j)),T=Math.abs(Math.sin(j)),A=b.width*S,X=b.height*S,P=Math.abs(I)*X,Y=Math.abs(M)*A,ee=(A+P)*E+(X+Y)*T,oe=(X+Y)*E+(A+P)*T,se=b.x+b.width/2,R=b.y+b.height/2,K=_.canvas,he=K.width,ne=K.height,G={x:Math.max(0,Math.min(he-ee,se-ee/2)),y:Math.max(0,Math.min(ne-oe,R-oe/2)),width:Math.min(ee,he),height:Math.min(oe,ne)},{width:ue,height:ge}=G;let N,q;x.ratio>=ue/ge?(N=ue*.8,q=N/x.ratio):(q=ge*.8,N=q*x.ratio);const ve=G.x+(G.width-N)/2,we=G.y+(G.height-q)/2;i({crop:{x:ve,y:we,width:N,height:q}})},[t,i,g]),m=w.useCallback(x=>{i({rotation:(a.rotation||0)+x})},[a.rotation,i]),f=w.useCallback(x=>{const _=`flip${x}`;i({[_]:!a[_]})},[a,i]),k=w.useCallback((x,_)=>{const b=t.current,C=b.getImageDisplay(),j=b.getOriginalImageSize(),S=x/j.width*C.width,I=_/j.height*C.height;i({crop:{...a.crop,width:S,height:I}})},[a.crop,i]),y=w.useCallback(x=>{c(x);const _=parseInt(x)||0;if(_<=0)return;let b=parseInt(d)||0;n&&parseInt(r)>0&&parseInt(d)>0&&(b=Math.round(_/(parseInt(r)/parseInt(d))),h(b.toString())),k(_,b)},[r,d,n,k]),v=w.useCallback(x=>{h(x);const _=parseInt(x)||0;if(_<=0)return;let b=parseInt(r)||0;n&&parseInt(r)>0&&parseInt(d)>0&&(b=Math.round(_*(parseInt(r)/parseInt(d))),c(b.toString())),k(b,_)},[r,d,n,k]);return s.jsxs("div",{className:"dk-image-editor__crop-controls",children:[s.jsxs("div",{className:"dk-image-editor__actions",children:[s.jsx("button",{className:"dk-image-editor__preset-btn",onClick:()=>p({name:"Original"}),children:s.jsx(Ie,{size:14})}),s.jsx("select",{className:"dk-image-editor__preset-select",onChange:x=>{const _=e.find(b=>b.name===x.target.value);_&&p(_)},defaultValue:"",children:e.map(x=>s.jsx("option",{value:x.name,children:x.name},x.name))}),s.jsx("button",{onClick:()=>m(ze.NEGATIVE_QUARTER_TURN),children:"-90\xB0"}),s.jsx("button",{onClick:()=>m(ze.QUARTER_TURN),children:"+90\xB0"}),s.jsx("button",{onClick:()=>f("X"),children:"\u21C4"}),s.jsx("button",{onClick:()=>f("Y"),children:"\u21C5"}),s.jsxs("div",{className:"dk-image-editor__size-inputs desktop-only",children:[s.jsx("input",{type:"number",value:r,onChange:x=>y(x.target.value),min:"1",placeholder:"W"}),s.jsx("button",{className:`dk-image-editor__lock-btn ${n?"locked":""}`,onClick:()=>l(!n),title:o(n?"crop.unlock.ratio":"crop.lock.ratio"),children:n?s.jsx(ut,{size:14}):s.jsx(gt,{size:14})}),s.jsx("input",{type:"number",value:d,onChange:x=>v(x.target.value),min:"1",placeholder:"H"})]})]}),s.jsxs("div",{className:"dk-image-editor__rotation-controls desktop-only",children:[s.jsx(te,{min:-180,max:180,value:a.rotation||0,onChange:x=>i({rotation:x}),showValue:!0,showLabel:!0,label:o("crop.rotation")}),s.jsx(te,{min:.1,max:3,step:.1,value:a.scale||1,onChange:x=>i({scale:x}),showValue:!0,showLabel:!0,label:o("crop.scale")}),s.jsx(te,{min:0,max:360,step:5,value:(()=>{const x=a.skewX||0,_=a.skewY||0;if(x===0&&_===0)return 0;const b=Math.atan2(_,x)*180/Math.PI;return b<0?b+360:b})(),onChange:x=>{const _=x;if(_===0)i({skewX:0,skewY:0});else{const b=_*Math.PI/180,C=.5;i({skewX:Math.cos(b)*C,skewY:Math.sin(b)*C})}},showValue:!0,showLabel:!0,label:o("crop.skew")})]})]})};function kt(a,e){let t;return(...i)=>{clearTimeout(t),t=setTimeout(()=>a(...i),e)}}function bt(a){const e=a.size||a.width||20,t=a.size||a.height||20;return s.jsx("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:s.jsx("path",{d:"M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"})})}function yt(a){const e=a.size||a.width||20,t=a.size||a.height||20;return s.jsxs("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[s.jsx("path",{d:"M6.13 1L6 16a2 2 0 002 2h15"}),s.jsx("path",{d:"M1 6.13L16 6a2 2 0 012 2v15"})]})}function vt(a){const e=a.size||a.width||20,t=a.size||a.height||20;return s.jsx("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:s.jsx("path",{d:"M18.347 9.907a6.5 6.5 0 1 0-1.872 3.306M3.26 11.574a6.5 6.5 0 1 0 2.815-1.417 M10.15 17.897A6.503 6.503 0 0 0 16.5 23a6.5 6.5 0 1 0-6.183-8.51"})})}function wt(a){const e=a.size||a.width||20,t=a.size||a.height||20;return s.jsxs("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[s.jsx("line",{x1:"4",y1:"21",x2:"4",y2:"14"}),s.jsx("line",{x1:"4",y1:"10",x2:"4",y2:"3"}),s.jsx("line",{x1:"12",y1:"21",x2:"12",y2:"12"}),s.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"3"}),s.jsx("line",{x1:"20",y1:"21",x2:"20",y2:"16"}),s.jsx("line",{x1:"20",y1:"12",x2:"20",y2:"3"}),s.jsx("line",{x1:"1",y1:"14",x2:"7",y2:"14"}),s.jsx("line",{x1:"9",y1:"8",x2:"15",y2:"8"}),s.jsx("line",{x1:"17",y1:"16",x2:"23",y2:"16"})]})}const _t=({size:a=16,className:e=""})=>s.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:e,children:[s.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),s.jsx("rect",{x:"7",y:"7",width:"10",height:"10"})]});function St(a){const e=a.size||a.width||20,t=a.size||a.height||20;return s.jsx("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:s.jsx("path",{d:"M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"})})}function Ct(a){const e=a.size||a.width||20,t=a.size||a.height||20;return s.jsxs("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 1024 1024",fill:"currentColor",children:[s.jsx("path",{d:"M670.64 403.2c-5.04-18.776-14.808-34.984-27.056-45.696-12.16-10.712-27.904-16.856-43.816-12.584-15.872 4.264-26.456 17.448-31.576 32.768-5.248 15.44-5.632 34.304-0.6 53.16 5.04 18.776 14.808 34.984 27.056 45.696 12.16 10.712 27.904 16.856 43.776 12.584 15.92-4.264 26.448-17.408 31.656-32.768 5.2-15.44 5.592-34.304 0.56-53.12V403.2z m-247.384 66.264c-4.992-18.776-14.768-34.992-27.008-45.744-12.16-10.664-27.904-16.808-43.776-12.584-15.92 4.264-26.456 17.496-31.664 32.856-5.2 15.4-5.584 34.256-0.552 53.072 5.04 18.816 14.8 34.992 27.048 45.744 12.16 10.664 27.904 16.848 43.776 12.584 15.92-4.264 26.456-17.448 31.664-32.808 5.2-15.408 5.584-34.304 0.56-53.12h-0.048z"}),s.jsx("path",{d:"M512 32C246.912 32 32 246.912 32 512c0 265.088 214.912 480 480 480 42.024 0 78.936-19.376 105.384-45.816l328.8-328.8C972.624 590.984 992 554.024 992 512c0-265.088-214.912-480-480-480zM119.28 512a392.872 392.872 0 0 1 43.104-179.192 395.456 395.456 0 0 1 28.864-47.712 394 394 0 0 1 48.424-56.352A392.616 392.616 0 0 1 416.688 130.72a393.344 393.344 0 0 1 110.656-11.44 391.096 391.096 0 0 1 55.424 6.128 392.736 392.736 0 0 1 319.56 342.944c-91.072 0.224-150.2 2.096-200.16 19.6a350.928 350.928 0 0 0-43.248 18.48 355.96 355.96 0 0 0-20.592 11.376 352.52 352.52 0 0 0-32.464 21.968 359.096 359.096 0 0 0-18.224 14.88 354.48 354.48 0 0 0-22.664 21.68 354.992 354.992 0 0 0-20.624 23.64 352.992 352.992 0 0 0-18.416 25.384 355.52 355.52 0 0 0-12.28 20.072 310.4 310.4 0 0 1-55.176 4.544 307.424 307.424 0 0 1-39.464-2.816 308.056 308.056 0 0 1-31.12-5.872 44.656 44.656 0 0 0-8.488-1.32 44.784 44.784 0 0 0-8.584 0.368 45.48 45.48 0 0 0-6.304 1.384 43.888 43.888 0 0 0-13.408 6.688 45.064 45.064 0 0 0-4.896 4.2 44.728 44.728 0 0 0-5.464 6.632 44.032 44.032 0 0 0-5.52 11.624 45.416 45.416 0 0 0-1.408 6.288 46.728 46.728 0 0 0-0.416 4.28 43.848 43.848 0 0 0 2.536 16.912 43.48 43.48 0 0 0 15.24 20.384 43.792 43.792 0 0 0 15.504 7.216c35.352 8.856 73.096 12.648 111.84 10.816-8.768 42.896-9.992 94.472-10.12 165.56C272 880.64 119.272 714.168 119.272 512z m611.68 58.344c32.432-11.352 72.44-13.968 153.392-14.576l-328.584 328.584c0.56-80.952 3.224-120.96 14.576-153.384a261.104 261.104 0 0 1 21.616-46.544 267.28 267.28 0 0 1 11.976-18.48 268.08 268.08 0 0 1 13.488-17.4 268.664 268.664 0 0 1 14.904-16.216 266.92 266.92 0 0 1 16.208-14.904 261.096 261.096 0 0 1 48.744-32.568 268.624 268.624 0 0 1 19.968-9.28 259.544 259.544 0 0 1 13.72-5.232z"})]})}const Mt={select:{name:"Select",icon:s.jsx(St,{})},crop:{name:"Crop",icon:s.jsx(yt,{})},finetune:{name:"Finetune",icon:s.jsx(wt,{})},filter:{name:"Filter",icon:s.jsx(vt,{})},annotate:{name:"Annotate",icon:s.jsx(bt,{})},sticker:{name:"Sticker",icon:s.jsx(Ct,{})},frame:{name:"Frame",icon:s.jsx(_t,{})},"advanced-filter":{name:"Advanced",icon:"\u{1F3AD}"},image:{name:"Image",icon:"\u{1F5BC}\uFE0F"},resize:{name:"Resize",icon:"\u{1F4CF}"},fill:{name:"Fill",icon:"\u{1F3AF}"}},jt=[[void 0,"Original"],[1,"1:1"],[4/3,"4:3"],[16/9,"16:9"],[3/2,"3:2"]],It=[["sharpie","Draw"],["line","Line"],["arrow","Arrow"],["rectangle","Rectangle"],["ellipse","Ellipse"],["text","Text"]],Et=[["chrome","Chrome"],["fade","Fade"],["cold","Cold"],["warm","Warm"],["monoDefault","Mono"],["sepiaDefault","Sepia"],["blur","Blur"],["sharpen","Sharpen"],["emboss","Emboss"],["oil","Oil Paint"],["vintage","Vintage"],["dramatic","Dramatic"],["vivid","Vivid"],["noir","Noir"],["sunset","Sunset"],["ocean","Ocean"]],Tt=[["brightness","Brightness"],["contrast","Contrast"],["saturation","Saturation"],["exposure","Exposure"],["gamma","Gamma"],["vignette","Vignette"]],Ft=[["none","None"],["solidSharp","Mat"],["solidRound","Bevel"],["lineSingle","Line"],["lineMultiple","Zebra"],["edgeCross","Lumber"],["edgeSeparate","Inset"],["edgeOverlap","Plus"],["hook","Hook"],["polaroid","Polaroid"]],U={ANIMATION_DURATION:300,DEFAULT_STROKE_WIDTH:2,DEFAULT_FONT_SIZE:24,EMOJI_LIST:["\u{1F600}","\u{1F602}","\u{1F923}","\u{1F60A}","\u{1F60D}","\u{1F970}","\u{1F618}","\u{1F60B}","\u{1F914}","\u{1F60E}","\u{1F929}","\u{1F973}","\u{1F44D}","\u{1F44E}","\u{1F44C}","\u270C\uFE0F","\u{1F91E}","\u{1F91F}","\u{1F918}","\u{1F44F}","\u{1F64C}","\u{1F91D}","\u{1F4AA}","\u{1F9BE}","\u2764\uFE0F","\u{1F9E1}","\u{1F49B}","\u{1F49A}","\u{1F499}","\u{1F49C}","\u{1F5A4}","\u{1F90D}","\u{1F90E}","\u{1F495}","\u{1F496}","\u{1F497}","\u{1F436}","\u{1F415}","\u{1F9AE}","\u{1F415}\u200D\u{1F9BA}","\u{1F429}","\u{1F43A}","\u{1F98A}","\u{1F99D}","\u{1F431}","\u{1F408}","\u{1F408}\u200D\u2B1B","\u{1F981}","\u{1F525}","\u2B50","\u2728","\u{1F389}","\u{1F4AF}","\u{1F4A5}","\u26A1","\u{1F31F}","\u{1F38A}","\u{1F388}","\u{1F381}","\u{1F3C6}"],FINETUNE_SHORTCUTS:{brightness:"BR",contrast:"CO",saturation:"SA",exposure:"EX",gamma:"GA",vignette:"VI"}},Rt=({size:a=16,color:e="currentColor"})=>s.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[s.jsx("circle",{cx:"12",cy:"12",r:"4",fill:e}),s.jsx("path",{d:"M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41",stroke:e,strokeWidth:"2",strokeLinecap:"round"})]}),At=({size:a=16,color:e="currentColor"})=>s.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[s.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:e,strokeWidth:"2"}),s.jsx("path",{d:"M12 3a9 9 0 0 1 0 18z",fill:e})]}),zt=({size:a=16,color:e="currentColor"})=>s.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[s.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:e,strokeWidth:"2"}),s.jsx("path",{d:"M8 8h8M8 12h8M8 16h4",stroke:e,strokeWidth:"2",strokeLinecap:"round"}),s.jsx("path",{d:"M16 16l2-2M18 18l-2-2",stroke:e,strokeWidth:"2",strokeLinecap:"round"})]}),Dt=({size:a=16,color:e="currentColor"})=>s.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[s.jsx("path",{d:"M3 21h18l-9-18z",stroke:e,strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),s.jsx("path",{d:"M12 3v18",stroke:e,strokeWidth:"2",strokeLinecap:"round"}),s.jsx("path",{d:"M7.5 15h9",stroke:e,strokeWidth:"2",strokeLinecap:"round"})]}),Pt=({size:a=16,color:e="currentColor"})=>s.jsx("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:s.jsx("path",{d:"M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z",fill:e})}),Nt=({size:a=16,color:e="currentColor"})=>s.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[s.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",stroke:e,strokeWidth:"2"}),s.jsx("circle",{cx:"12",cy:"12",r:"6",fill:"none",stroke:e,strokeWidth:"2",strokeDasharray:"2 2"}),s.jsx("circle",{cx:"12",cy:"12",r:"3",fill:e})]}),Bt=({editorState:a,selectedFinetuneOption:e,finetuneOptions:t,editorRef:i,onStateChange:o,setSelectedFinetuneOption:n})=>{const{t:l}=D(),{FINETUNE_SHORTCUTS:r}=U,c=w.useMemo(()=>new Map(t),[t]),d=w.useMemo(()=>kt(()=>i.current?.render(),je.RENDER),[i]),h=w.useCallback(m=>{o({[e]:m}),d()},[e,o,d]),u=w.useCallback(()=>{const m={};t.forEach(([f])=>{m[f]=0}),o(m),d()},[t,o,d]),g=a?.[e]||0,p=l(`finetune.${e}`)||c.get(e)||"Brightness";return s.jsxs("div",{className:"dk-image-editor__finetune-controls",children:[s.jsx(te,{min:ae.FINETUNE.min,max:ae.FINETUNE.max,value:g,onChange:h,showValue:!0,showLabel:!0,label:p}),s.jsxs("div",{className:"dk-image-editor__finetune-options",children:[s.jsx("button",{className:"dk-image-editor__finetune-option",onClick:u,title:l("finetune.reset"),children:s.jsx(Ie,{size:14})}),t.map(([m,f])=>{const k=()=>{switch(m){case"brightness":return s.jsx(Rt,{size:14});case"contrast":return s.jsx(At,{size:14});case"saturation":return s.jsx(Pt,{size:14});case"exposure":return s.jsx(zt,{size:14});case"gamma":return s.jsx(Dt,{size:14});case"vignette":return s.jsx(Nt,{size:14});default:return r[m]||m.substring(0,2).toUpperCase()}};return s.jsx("button",{className:`dk-image-editor__finetune-option ${e===m?"dk-image-editor__finetune-option--active":""}`,onClick:()=>n(m),title:l(`finetune.${m}`),children:k()},m)})]})]})},Lt=({size:a=16,width:e,height:t,style:i})=>s.jsxs("svg",{width:e||a,height:t||a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:i,children:[s.jsx("line",{x1:"7",y1:"17",x2:"17",y2:"7"}),s.jsx("polyline",{points:"7,7 17,7 17,17"})]}),Ot=({size:a=16,width:e,height:t,style:i})=>s.jsx("svg",{width:e||a,height:t||a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:i,children:s.jsx("path",{d:"M3 17c3-3 6-6 9-3s6 6 9 3"})}),Ut=({size:a=16,width:e,height:t,style:i})=>s.jsx("svg",{width:e||a,height:t||a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:i,children:s.jsx("circle",{cx:"12",cy:"12",r:"10"})}),$t=({size:a=16,width:e,height:t,style:i})=>s.jsx("svg",{width:e||a,height:t||a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:i,children:s.jsx("line",{x1:"7",y1:"17",x2:"17",y2:"7"})}),Wt=({size:a=16,width:e,height:t,style:i})=>s.jsx("svg",{width:e||a,height:t||a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:i,children:s.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"})}),Xt=({size:a=16,width:e,height:t,style:i})=>s.jsxs("svg",{width:e||a,height:t||a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:i,children:[s.jsx("polyline",{points:"4,7 4,4 20,4 20,7"}),s.jsx("line",{x1:"9",y1:"20",x2:"15",y2:"20"}),s.jsx("line",{x1:"12",y1:"4",x2:"12",y2:"20"})]}),Ee=(a,e,t,i)=>({id:"",type:a,x:0,y:0,color:e,strokeWidth:t,fontSize:a==="text"?i:void 0,fillColor:a==="rectangle"||a==="ellipse"?"transparent":void 0,strokeColor:a!=="text"?e:void 0}),le=(a,e,t,i={})=>a?{...a,[e]:t}:{...Ee("rectangle","#000000",2),...i,[e]:t},Q=w.memo(({value:a,onChange:e,title:t})=>{const i=w.useCallback(n=>{n.preventDefault(),n.currentTarget.querySelector('input[type="color"]')?.click()},[]),o=w.useCallback(n=>{n.stopPropagation(),e(n.target.value)},[e]);return s.jsx("button",{className:"dk-image-editor__color-button",onClick:i,children:s.jsx("div",{className:"dk-image-editor__color-picker",children:s.jsx("input",{type:"color",value:a,onChange:o,title:t,onClick:n=>{console.log("\u{1F3A8} Color input clicked"),n.stopPropagation()}})})})});Q.displayName="ColorPicker";const Yt=({currentAnnotation:a,lastAnnotateColor:e,annotateTools:t,setCurrentAnnotation:i,setLastAnnotateColor:o})=>{const{t:n}=D(),{DEFAULT_STROKE_WIDTH:l,DEFAULT_FONT_SIZE:r}=U;w.useEffect(()=>{a||i(Ee("sharpie",e,l,r))},[a,e,i,l,r]);const c=w.useCallback(k=>{if(o(k),a){const y=le(a,"color",k);i(le(y,"strokeColor",k))}},[a,i,o]),d=w.useCallback(k=>{i(le(a,"strokeWidth",k,{color:e}))},[a,e,i]),h=w.useCallback(k=>{i(le(a,"fontSize",k))},[a,i]),u=w.useCallback(k=>{i(le(a,"fillColor",k))},[a,i]),g=w.useCallback(k=>{i(le(a,"strokeColor",k))},[a,i]),p=w.useCallback(k=>{i(Ee(k,e,a?.strokeWidth||l,a?.fontSize||r))},[a,e,i,l,r]),m=a?.type==="text"?s.jsx(te,{min:ae.FONT_SIZE.min,max:ae.FONT_SIZE.max,value:a.fontSize||r,onChange:h,showValue:!0,showLabel:!0,label:`${n("annotate.size")}:`,width:"150px"}):null,f=a?.type==="rectangle"||a?.type==="ellipse"?s.jsx(s.Fragment,{children:s.jsxs("div",{className:"dk-image-editor__color-box",children:[s.jsxs("label",{children:[n("annotate.fill"),": "]}),s.jsx(Q,{value:a.fillColor||"#000000",onChange:u,title:"Fill Color"}),a.fillColor&&a.fillColor!=="transparent"&&s.jsx("button",{onClick:()=>u("transparent"),className:"dk-image-editor__clear-fill",title:n("annotate.clear.fill"),children:"\u2715"})]})}):null;return s.jsxs("div",{className:"dk-image-editor__annotate-controls",children:[s.jsxs("div",{className:"dk-image-editor__annotate-settings",children:[a?.type==="text"?s.jsxs("div",{className:"dk-image-editor__color-box",children:[s.jsxs("label",{children:[n("annotate.color"),": "]}),s.jsx(Q,{value:e,onChange:c,title:n("toolbar.text.color")})]}):s.jsxs("div",{className:"dk-image-editor__color-box",children:[s.jsxs("label",{children:[n("annotate.stroke"),": "]}),s.jsx(Q,{value:a?.strokeColor||e,onChange:g,title:n("toolbar.stroke.color")})]}),f,a?.type!=="text"&&s.jsx(te,{min:ae.STROKE_WIDTH.min,max:ae.STROKE_WIDTH.max,value:a?.strokeWidth||l,onChange:d,showValue:!0,showLabel:!0,label:`${n("annotate.width")}:`,width:"150px"}),m]}),s.jsx("div",{className:"dk-image-editor__toolbar dk-image-editor__annotate-toolbar",children:t.map(([k,y])=>{const v=()=>{switch(k){case"sharpie":return s.jsx(Ot,{size:16});case"line":return s.jsx($t,{size:16});case"arrow":return s.jsx(Lt,{size:16});case"rectangle":return s.jsx(Wt,{size:16});case"ellipse":return s.jsx(Ut,{size:16});case"text":return s.jsx(Xt,{size:16});default:return null}};return s.jsxs("button",{onClick:()=>p(k),className:`dk-image-editor__tool-button ${a?.type===k?"dk-image-editor__unified-button--active":""}`,children:[v(),s.jsx("span",{className:"desktop-only",children:n(`annotate.${k}`)})]},k)})})]})};function Te(...a){const e=[];for(const t of a)if(t){if(typeof t=="string"||typeof t=="number")e.push(String(t));else if(Array.isArray(t)){const i=Te(...t);i&&e.push(i)}else if(typeof t=="object")for(const i in t)t[i]&&e.push(i)}return e.join(" ")}const Gt=({editorRef:a,stickerPluginRef:e,selectionPluginRef:t,imagePluginRef:i,zoomLevel:o,setHasSelection:n,currentSticker:l,setCurrentSticker:r})=>{const{t:c}=D(),{EMOJI_LIST:d}=U,[h,u]=w.useState("faces"),[g,p]=w.useState(new Set),m=w.useMemo(()=>["https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60d.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f602.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60e.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f973.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f970.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60b.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f929.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60a.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f618.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f44d.png"],[]),f=w.useMemo(()=>({faces:d.slice(0,12),hands:d.slice(12,24),hearts:d.slice(24,36),fruits:["\u{1F349}","\u{1F34A}","\u{1F34E}","\u{1F34B}","\u{1F34C}","\u{1F347}","\u{1F353}","\u{1FAD0}","\u{1F348}","\u{1F351}","\u{1F352}","\u{1F96D}"],food:["\u{1F355}","\u{1F354}","\u{1F35F}","\u{1F32D}","\u{1F96A}","\u{1F32E}","\u{1F32F}","\u{1F959}","\u{1F9C6}","\u{1F95A}","\u{1F373}","\u{1F95E}"],transport:["\u{1F697}","\u{1F695}","\u{1F699}","\u{1F68C}","\u{1F68E}","\u{1F3CE}\uFE0F","\u{1F693}","\u{1F691}","\u{1F692}","\u{1F690}","\u{1F6FB}","\u{1F69A}"],nature:["\u{1F338}","\u{1F33A}","\u{1F33B}","\u{1F337}","\u{1F339}","\u{1F940}","\u{1F33E}","\u{1F33F}","\u{1F340}","\u{1F343}","\u{1F331}","\u{1F332}"],animals:d.slice(36,48),numbers:["0\uFE0F\u20E3","1\uFE0F\u20E3","2\uFE0F\u20E3","3\uFE0F\u20E3","4\uFE0F\u20E3","5\uFE0F\u20E3","6\uFE0F\u20E3","7\uFE0F\u20E3","8\uFE0F\u20E3","9\uFE0F\u20E3","\u{1F51F}","#\uFE0F\u20E3"],stickers:m,symbols:d.slice(48)}),[d,m]);w.useEffect(()=>{if(!l){const v=f.faces[0]??"\u{1F600}";r({content:v,type:"emoji"})}},[l,r,f.faces]);const k=w.useCallback(v=>{v&&i.current&&i.current.addImageFromFile(v)},[i]),y=w.useCallback((v,x="emoji")=>{r({content:v,type:x})},[r]);return s.jsxs("div",{className:"dk-image-editor__sticker-controls",children:[s.jsx("div",{className:"d-flex align-items-center gap-2 dk-image-editor__sticker-category",children:Object.keys(f).map(v=>s.jsx("button",{className:`dk-image-editor__tool-button ${h===v?"active":""}`,onClick:()=>{u(v);const x=f[v][0];x&&r({content:x,type:v==="stickers"?"image":"emoji"})},children:(()=>{const x=f[v];if(v==="stickers"){const b=x[0];return b?s.jsx("img",{src:b,alt:"sticker",style:{width:"16px",height:"16px"}}):null}const _=x[0];return _?s.jsx("span",{style:{fontSize:"16px"},children:_}):null})()},v))}),s.jsxs("div",{className:"dk-image-editor__toolbar",children:[s.jsxs("label",{className:"dk-image-editor__upload-button",children:[s.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},onChange:v=>{const x=v.target.files?.[0];x&&k(x)}}),s.jsx("span",{className:"dk-image-editor__upload-icon",children:"+"})]}),f[h].map((v,x)=>{const _=l?.content===v;return s.jsx("span",{onClick:()=>y(v,h==="stickers"?"image":"emoji"),className:Te("dk-image-editor__sticker-button",{"css-loading":g.has(v),"dk-image-editor__unified-button--active":_}),style:{height:h==="stickers"?"auto":""},children:h==="stickers"?s.jsx("img",{src:v,alt:"sticker"}):s.jsx("span",{children:v})},typeof v=="string"?v:x)})]})]})};var Vt='.dk-filter-section{margin-bottom:24px}.dk-filter-section:last-child{margin-bottom:0}.dk-filter-section-title{color:#374151;font-size:14px;font-weight:600;letter-spacing:.5px;margin:0 0 12px;padding:0 4px;text-transform:uppercase}.dk-filter-section-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(85px,1fr))}.dk-image-editor__filter-preview{align-items:center;background:transparent;border:2px solid transparent;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.06),0 1px 3px rgba(0,0,0,.04);cursor:pointer;display:flex;flex-direction:column;overflow:hidden;padding:8px;position:relative;transition:all .3s cubic-bezier(.4,0,.2,1)}.dk-image-editor__filter-preview:before{background:linear-gradient(135deg,hsla(0,0%,100%,.1),hsla(0,0%,100%,0));bottom:0;content:"";left:0;opacity:0;pointer-events:none;position:absolute;right:0;top:0;transition:opacity .3s ease}.dk-image-editor__filter-preview:hover{transform:translateY(-2px) scale(1.02)}.dk-image-editor__filter-preview:hover:before{opacity:1}.dk-image-editor__filter-preview.dk-image-editor__unified-button--active{background:linear-gradient(135deg,#eef2ff,#e0e7ff);border-color:#6366f1;box-shadow:0 4px 12px rgba(99,102,241,.25);transform:translateY(-1px)}.dk-image-editor__filter-preview.dk-image-editor__unified-button--active:before{opacity:1}.dk-image-editor__filter-icon{border:1px solid rgba(0,0,0,.06);border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.1),inset 0 1px 0 hsla(0,0%,100%,.8);height:32px;margin-bottom:8px;overflow:hidden;padding:4px;position:relative;transition:all .3s cubic-bezier(.4,0,.2,1);width:32px}.dk-image-editor__filter-preview:hover .dk-image-editor__filter-icon{box-shadow:0 4px 12px rgba(0,0,0,.15);transform:scale(1.05)}.dk-image-editor__filter-icon svg{display:block;height:100%;width:100%}.dk-image-editor__filter-name{color:#475569;color:#ffffffd0;font-size:11px;font-weight:500;letter-spacing:.01em;line-height:1.3;text-align:center;transition:all .3s ease}.dk-image-editor__filter-preview:hover .dk-image-editor__filter-name{color:#6366f1;transform:translateY(-1px)}.dk-image-editor__filter-preview.dk-image-editor__unified-button--active .dk-image-editor__filter-name{color:#6366f1;font-weight:700;text-shadow:0 1px 2px rgba(99,102,241,.1)}.dk-image-editor__filter-preview--apply{.dk-image-editor__filter-icon{background:linear-gradient(135deg,#fffbeb,#fef3c7)}}.dk-image-editor__filter-preview--toggle{.dk-image-editor__filter-icon{background:linear-gradient(135deg,#f0fdf4,#dcfce7)}}.dk-filter-badge{color:#f59e0b;font-size:12px;font-weight:700;margin-left:2px}.dk-filter-count{background:#007bff;border-radius:50%;color:#ffffffd0;display:inline-block;font-size:10px;font-weight:700;height:16px;line-height:16px;margin-left:4px;text-align:center;width:16px}.dk-image-editor__spinner{animation:dk-spin 1s linear infinite;border:2px solid #f3f3f3;border-radius:50%;border-top-color:#4f46e5;height:20px;width:20px}@keyframes dk-spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}';be(Vt);const Zt=a=>{const e=a.data;for(let t=0;t<e.length;t+=4){const i=e[t]??0,o=e[t+1]??0,n=e[t+2]??0,l=.393*i+.769*o+.189*n,r=.349*i+.686*o+.168*n,c=.272*i+.534*o+.131*n;e[t]=Math.min(255,l*1.2+25),e[t+1]=Math.min(255,r*1.1+15),e[t+2]=Math.min(255,c*.9+5)}return console.log("imageData",a),a},Ht=a=>{const e=a.data;for(let t=0;t<e.length;t+=4){const i=e[t]??0,o=e[t+1]??0,n=e[t+2]??0,l=2.5,r=259*(l+255)/(255*(259-l));let c=Math.max(0,Math.min(255,r*(i-128)+128)),d=Math.max(0,Math.min(255,r*(o-128)+128)),h=Math.max(0,Math.min(255,r*(n-128)+128));const u=.299*c+.587*d+.114*h,g=1.8;c=Math.max(0,Math.min(255,u+g*(c-u))),d=Math.max(0,Math.min(255,u+g*(d-u))),h=Math.max(0,Math.min(255,u+g*(h-u))),.299*c+.587*d+.114*h<128?(c*=.7,d*=.7,h*=.7):(c=Math.min(255,c*1.3),d=Math.min(255,d*1.3),h=Math.min(255,h*1.3)),e[t]=c,e[t+1]=d,e[t+2]=h}return a},Kt=a=>{const e=a.data;for(let t=0;t<e.length;t+=4){const i=e[t]??0,o=e[t+1]??0,n=e[t+2]??0,l=1.6,r=.299*i+.587*o+.114*n;e[t]=Math.max(0,Math.min(255,r+l*(i-r))),e[t+1]=Math.max(0,Math.min(255,r+l*(o-r))),e[t+2]=Math.max(0,Math.min(255,r+l*(n-r)))}return a},qt=a=>{const e=a.data;for(let t=0;t<e.length;t+=4){const i=e[t]??0,o=e[t+1]??0,n=e[t+2]??0,l=.299*i+.587*o+.114*n,r=l>128?Math.min(255,l*1.3):Math.max(0,l*.7);e[t]=r,e[t+1]=r,e[t+2]=r}return a},Qt=a=>{const e=a.data;for(let t=0;t<e.length;t+=4){const i=e[t]??0,o=e[t+1]??0,n=e[t+2]??0;e[t]=Math.min(255,i*1.3+40),e[t+1]=Math.min(255,o*1.1+25),e[t+2]=Math.max(0,n*.6)}return a},Jt=a=>{const e=a.data;for(let t=0;t<e.length;t+=4){const i=e[t]??0,o=e[t+1]??0,n=e[t+2]??0;e[t]=Math.max(0,i*.7),e[t+1]=Math.min(255,o*1.2+20),e[t+2]=Math.min(255,n*1.4+30)}return a},ei={chrome:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("rect",{width:"40",height:"40",fill:"#FFFFFF",rx:"8"}),s.jsx("rect",{x:"6",y:"8",width:"28",height:"12",fill:"#1966FF",rx:"2"}),s.jsx("rect",{x:"10",y:"16",width:"24",height:"16",fill:"#00C87F",rx:"2"}),s.jsx("text",{x:"20",y:"26",textAnchor:"middle",fill:"#FFFFFF",fontSize:"8",fontWeight:"bold",children:"HD"})]}),fade:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("defs",{children:s.jsxs("linearGradient",{id:"fade-grad",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[s.jsx("stop",{offset:"0%",stopColor:"#333333",stopOpacity:"1"}),s.jsx("stop",{offset:"50%",stopColor:"#666666",stopOpacity:"0.6"}),s.jsx("stop",{offset:"100%",stopColor:"#cccccc",stopOpacity:"0.2"})]})}),s.jsx("rect",{width:"40",height:"40",fill:"#f5f5f5",rx:"6"}),s.jsx("rect",{x:"5",y:"15",width:"30",height:"10",fill:"url(#fade-grad)",rx:"2"})]}),cold:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("defs",{children:s.jsxs("linearGradient",{id:"cold-grad",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[s.jsx("stop",{offset:"0%",stopColor:"#e6f7ff"}),s.jsx("stop",{offset:"50%",stopColor:"#91d5ff"}),s.jsx("stop",{offset:"100%",stopColor:"#40a9ff"})]})}),s.jsx("rect",{width:"40",height:"40",fill:"url(#cold-grad)",rx:"4"}),s.jsx("path",{d:"M20 8 L24 16 L20 24 L16 16 Z",fill:"#fff",opacity:"0.7"}),s.jsx("path",{d:"M8 20 L16 24 L24 20 L16 16 Z",fill:"#fff",opacity:"0.5"})]}),warm:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("defs",{children:s.jsxs("radialGradient",{id:"warm-grad",children:[s.jsx("stop",{offset:"0%",stopColor:"#fff7e6"}),s.jsx("stop",{offset:"50%",stopColor:"#ffd591"}),s.jsx("stop",{offset:"100%",stopColor:"#fa8c16"})]})}),s.jsx("rect",{width:"40",height:"40",fill:"url(#warm-grad)",rx:"4"}),s.jsx("circle",{cx:"20",cy:"15",r:"6",fill:"#ffec3d",opacity:"0.8"}),s.jsx("path",{d:"M20 21 Q15 25 10 30 Q20 28 20 21",fill:"#ff7a45",opacity:"0.6"}),s.jsx("path",{d:"M20 21 Q25 25 30 30 Q20 28 20 21",fill:"#ff7a45",opacity:"0.6"})]}),monoDefault:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("rect",{width:"40",height:"40",fill:"#f0f0f0"}),s.jsx("rect",{width:"20",height:"40",fill:"#333"}),s.jsx("rect",{x:"10",y:"10",width:"20",height:"20",fill:"#666"}),s.jsx("rect",{x:"15",y:"15",width:"10",height:"10",fill:"#999"})]}),sepiaDefault:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("defs",{children:s.jsxs("linearGradient",{id:"sepia-grad",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[s.jsx("stop",{offset:"0%",stopColor:"#f4e4bc"}),s.jsx("stop",{offset:"50%",stopColor:"#d2b48c"}),s.jsx("stop",{offset:"100%",stopColor:"#8b7355"})]})}),s.jsx("rect",{width:"40",height:"40",fill:"url(#sepia-grad)",rx:"4"}),s.jsx("circle",{cx:"12",cy:"12",r:"4",fill:"#deb887",opacity:"0.8"}),s.jsx("circle",{cx:"28",cy:"28",r:"6",fill:"#cd853f",opacity:"0.6"})]}),blur:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("defs",{children:s.jsx("filter",{id:"blur-effect",children:s.jsx("feGaussianBlur",{in:"SourceGraphic",stdDeviation:"2"})})}),s.jsx("rect",{width:"40",height:"40",fill:"#f0f8ff"}),s.jsx("circle",{cx:"15",cy:"15",r:"8",fill:"#4169e1",filter:"url(#blur-effect)",opacity:"0.7"}),s.jsx("circle",{cx:"25",cy:"25",r:"6",fill:"#1e90ff",filter:"url(#blur-effect)",opacity:"0.5"})]}),sharpen:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("rect",{width:"40",height:"40",fill:"#fafafa"}),s.jsx("polygon",{points:"20,5 30,20 20,35 10,20",fill:"#ff4d4f",stroke:"#fff",strokeWidth:"2"}),s.jsx("polygon",{points:"20,10 25,20 20,30 15,20",fill:"#fff",opacity:"0.8"})]}),emboss:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("defs",{children:s.jsxs("linearGradient",{id:"emboss-grad",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[s.jsx("stop",{offset:"0%",stopColor:"#ffffff"}),s.jsx("stop",{offset:"50%",stopColor:"#cccccc"}),s.jsx("stop",{offset:"100%",stopColor:"#666666"})]})}),s.jsx("rect",{width:"40",height:"40",fill:"#e8e8e8"}),s.jsx("rect",{x:"8",y:"8",width:"24",height:"24",fill:"url(#emboss-grad)",rx:"2"}),s.jsx("rect",{x:"10",y:"10",width:"20",height:"20",fill:"none",stroke:"#999",strokeWidth:"1"})]}),oil:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("rect",{width:"40",height:"40",fill:"#2c3e50"}),s.jsx("circle",{cx:"12",cy:"15",r:"5",fill:"#e74c3c",opacity:"0.8"}),s.jsx("circle",{cx:"28",cy:"12",r:"4",fill:"#f39c12",opacity:"0.7"}),s.jsx("circle",{cx:"25",cy:"28",r:"6",fill:"#3498db",opacity:"0.6"}),s.jsx("circle",{cx:"15",cy:"30",r:"3",fill:"#2ecc71",opacity:"0.9"}),s.jsx("path",{d:"M10 25 Q20 20 30 25 Q25 30 15 28",fill:"#9b59b6",opacity:"0.5"})]}),vintage:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("defs",{children:s.jsxs("radialGradient",{id:"vintage-grad",children:[s.jsx("stop",{offset:"0%",stopColor:"#f5e6d3"}),s.jsx("stop",{offset:"70%",stopColor:"#d4a574"}),s.jsx("stop",{offset:"100%",stopColor:"#8b6914"})]})}),s.jsx("rect",{width:"40",height:"40",fill:"url(#vintage-grad)",rx:"6"}),s.jsx("circle",{cx:"20",cy:"20",r:"12",fill:"none",stroke:"#8b6914",strokeWidth:"2",opacity:"0.6"}),s.jsx("rect",{x:"16",y:"8",width:"8",height:"4",fill:"#8b6914",opacity:"0.8"})]}),dramatic:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("defs",{children:s.jsxs("linearGradient",{id:"dramatic-grad",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[s.jsx("stop",{offset:"0%",stopColor:"#000000"}),s.jsx("stop",{offset:"50%",stopColor:"#666666"}),s.jsx("stop",{offset:"100%",stopColor:"#ffffff"})]})}),s.jsx("rect",{width:"40",height:"40",fill:"url(#dramatic-grad)"}),s.jsx("polygon",{points:"20,8 28,20 20,32 12,20",fill:"#fff",opacity:"0.3"})]}),vivid:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("defs",{children:s.jsxs("radialGradient",{id:"vivid-grad",children:[s.jsx("stop",{offset:"0%",stopColor:"#ff6b6b"}),s.jsx("stop",{offset:"33%",stopColor:"#4ecdc4"}),s.jsx("stop",{offset:"66%",stopColor:"#45b7d1"}),s.jsx("stop",{offset:"100%",stopColor:"#96ceb4"})]})}),s.jsx("rect",{width:"40",height:"40",fill:"url(#vivid-grad)",rx:"8"}),s.jsx("circle",{cx:"15",cy:"15",r:"4",fill:"#fff",opacity:"0.4"}),s.jsx("circle",{cx:"25",cy:"25",r:"3",fill:"#fff",opacity:"0.6"})]}),noir:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("rect",{width:"40",height:"40",fill:"#1a1a1a"}),s.jsx("rect",{x:"5",y:"15",width:"30",height:"2",fill:"#ffffff"}),s.jsx("rect",{x:"5",y:"23",width:"30",height:"2",fill:"#cccccc"}),s.jsx("circle",{cx:"12",cy:"12",r:"3",fill:"#ffffff"}),s.jsx("circle",{cx:"28",cy:"28",r:"4",fill:"#888888"}),s.jsx("rect",{x:"18",y:"18",width:"4",height:"4",fill:"#ffffff"})]}),sunset:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("defs",{children:s.jsxs("linearGradient",{id:"sunset-grad",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[s.jsx("stop",{offset:"0%",stopColor:"#ff9a56"}),s.jsx("stop",{offset:"50%",stopColor:"#ff6b35"}),s.jsx("stop",{offset:"100%",stopColor:"#f7931e"})]})}),s.jsx("rect",{width:"40",height:"40",fill:"url(#sunset-grad)",rx:"4"}),s.jsx("circle",{cx:"20",cy:"12",r:"6",fill:"#fff59d",opacity:"0.9"}),s.jsx("ellipse",{cx:"20",cy:"32",rx:"15",ry:"4",fill:"#ff5722",opacity:"0.6"}),s.jsx("path",{d:"M5 25 Q20 20 35 25",stroke:"#ffcc02",strokeWidth:"2",fill:"none",opacity:"0.8"})]}),ocean:s.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[s.jsx("defs",{children:s.jsxs("linearGradient",{id:"ocean-grad",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[s.jsx("stop",{offset:"0%",stopColor:"#87ceeb"}),s.jsx("stop",{offset:"50%",stopColor:"#4682b4"}),s.jsx("stop",{offset:"100%",stopColor:"#191970"})]})}),s.jsx("rect",{width:"40",height:"40",fill:"url(#ocean-grad)",rx:"4"}),s.jsx("path",{d:"M0 30 Q10 25 20 30 T40 30 V40 H0 Z",fill:"#1e88e5",opacity:"0.7"}),s.jsx("path",{d:"M0 35 Q15 32 30 35 T40 35 V40 H0 Z",fill:"#0d47a1",opacity:"0.5"}),s.jsx("circle",{cx:"30",cy:"10",r:"2",fill:"#ffffff",opacity:"0.8"})]})},ti=({filterId:a,name:e,isActive:t,onClick:i,isLoading:o=!1,filterType:n="toggle",clickCount:l})=>s.jsxs("button",{className:Te("dk-image-editor__filter-preview",`dk-image-editor__filter-preview--${n}`,{"dk-image-editor__unified-button--active":t,"dk-image-editor__filter-preview--loading":o,"css-loading":o}),onClick:i,disabled:o,children:[s.jsx("div",{className:"dk-image-editor__filter-icon",children:ei[a]||s.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",fontSize:"24px"},children:"\u{1F3A8}"})}),s.jsxs("span",{className:"dk-image-editor__filter-name",children:[e,n==="apply"&&l!==void 0&&l>0&&s.jsx("span",{className:"dk-filter-count",children:l})]})]}),ii=({editorState:a,filters:e,editorRef:t,filterCounts:i,onStateChange:o,setFilterCounts:n,applyAdvancedFilter:l})=>{const{t:r}=D(),[c,d]=w.useState(null),[h,u]=w.useState("basic"),g=w.useMemo(()=>({toggle:["chrome","fade","cold","warm","monoDefault","sepiaDefault","blur"],apply:["sharpen","emboss","oil","vintage","dramatic","vivid","noir","sunset","ocean"]}),[]),{toggle:p,apply:m}=g,f=w.useCallback(S=>S.name==="Original"||S.id==="original"?(o({filter:null}),setTimeout(()=>t.current?.render(),je.FILTER_RESET),!0):!1,[o,t]),k=w.useCallback((S,I)=>{switch(I){case"vintage":return Zt(S);case"dramatic":return Ht(S);case"vivid":return Kt(S);case"noir":return qt(S);case"sunset":return Qt(S);case"ocean":return Jt(S);default:return S}},[]),y=w.useCallback(async S=>{if(!t.current)return;let I=t.current.getImageData();if(I){for(const[M,E]of Object.entries(i))if(M!==S&&E>0&&m.includes(M))for(let T=0;T<E;T++)["sharpen","emboss","oil"].includes(M)?I=await l(I,M):I=k(I,M);t.current.setImageData(I)}},[i,n,m,l,k,t]),v=w.useCallback(S=>{const I=a?.filter===S;o({filter:I?null:S}),setTimeout(()=>t.current?.render(),je.FILTER_RESET)},[a?.filter,o,t]),x=w.useCallback(async S=>{const I=i[S.id]||0,M=I>=3?0:I+1,E={...i,[S.id]:M};if(n(E),I>=3){const T=(a?.appliedFilters||[]).filter(A=>A.type!==S.id);o({appliedFilters:T}),t.current&&(t.current.resetToOriginal(),await y(S.id));return}d(S.id);try{if(!t.current)return;const T=t.current.getImageData();if(!T)return;let A;if(["sharpen","emboss","oil"].includes(S.id))try{await new Promise(P=>setTimeout(P,100)),A=await l(T,S.id)}catch(P){console.error(`Failed to apply ${S.id} filter:`,P);return}else A=k(T,S.id);t.current.setImageData(A);const X=[...a?.appliedFilters||[],{type:S.id,value:1}];o({appliedFilters:X})}finally{d(null)}},[i,n,a?.appliedFilters,o,t,l,k,y]),_=w.useCallback(async S=>{f(S)||(p.includes(S.id)?v(S.id):m.includes(S.id)&&await x(S))},[f,p,m,v,x]),b=w.useMemo(()=>{const S=e.filter(E=>p.includes(E.id)),I=e.filter(E=>["vintage","dramatic","vivid","noir","sunset","ocean"].includes(E.id)),M=e.filter(E=>["sharpen","emboss","oil"].includes(E.id));return{reset:[],all:e.filter(E=>E.name!=="Original"&&E.id!=="original"),basic:S,artistic:I,enhance:M}},[e,p]),C=w.useCallback(()=>{o({filter:null,appliedFilters:[]}),n({}),t.current&&t.current.resetToOriginal?.()},[o,n,t]),j=w.useCallback(()=>b[h]||[],[b,h]);return s.jsxs("div",{className:"dk-image-editor__filter-controls",children:[s.jsxs("div",{className:"d-flex align-items-center gap-2 mb-2",children:[(a?.filter||Object.values(i).some(S=>S>0))&&s.jsx("button",{className:"dk-image-editor__tool-button",onClick:C,children:s.jsx(Ie,{size:14})}),s.jsx("button",{className:`dk-image-editor__tool-button ${h==="basic"?"active":""}`,onClick:()=>u("basic"),children:r("filter.basic")}),s.jsx("button",{className:`dk-image-editor__tool-button ${h==="artistic"?"active":""}`,onClick:()=>u("artistic"),children:r("filter.artistic")}),s.jsx("button",{className:`dk-image-editor__tool-button ${h==="enhance"?"active":""}`,onClick:()=>u("enhance"),children:r("filter.enhance")})]}),s.jsx("div",{className:"dk-image-editor__toolbar",children:j().map(S=>{const I=p.includes(S.id),M=m.includes(S.id);return s.jsx(ti,{filterId:S.id,name:S.name,isActive:I&&a?.filter===S.id,onClick:()=>_(S),isLoading:c===S.id,filterType:M?"apply":"toggle",clickCount:M?i[S.id]||0:void 0},S.id)})})]})};var oi='.dk-image-editor__frame-list{display:flex;gap:12px}.dk-image-editor__frame-option{align-items:center;background:hsla(0,0%,100%,.05);border:2px solid transparent;border-radius:8px;cursor:pointer;display:flex;flex-direction:column;gap:8px;padding:8px;transition:all .2s ease}.dk-image-editor__frame-option:hover{background:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.3)}.dk-image-editor__frame-option.active{background:rgba(0,123,255,.2);border-color:#007bff}.dk-image-editor__frame-preview{align-items:center;display:flex;height:48px;justify-content:center;overflow:hidden;position:relative;width:48px}.dk-image-editor__frame-preview svg,.dk-image-editor__frame-preview>div{height:42px;width:42px}.dk-image-editor__frame-preview-content{background:linear-gradient(45deg,#f0f0f0 25%,transparent 0),linear-gradient(-45deg,#f0f0f0 25%,transparent 0),linear-gradient(45deg,transparent 75%,#f0f0f0 0),linear-gradient(-45deg,transparent 75%,#f0f0f0 0);background-position:0 0,0 4px,4px -4px,-4px 0;background-size:8px 8px;height:100%;width:100%}.dk-image-editor__frame-preview.none{border:none}.dk-image-editor__frame-preview.solid-border{border:3px solid #333}.dk-image-editor__frame-preview.rounded-border{border:3px solid #333;border-radius:8px}.dk-image-editor__frame-preview.shadow-effect{border:1px solid #ddd;box-shadow:0 4px 12px rgba(0,0,0,.3)}.dk-image-editor__frame-preview.polaroid-style{background:#ffffffd0;border:1px solid #ddd;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:4px 4px 8px}.dk-image-editor__frame-preview.vintage-frame{background:#f4e4bc;border:4px solid #8b4513;position:relative}.dk-image-editor__frame-preview.vintage-frame:before{border:1px solid #654321;bottom:2px;content:"";left:2px;position:absolute;right:2px;top:2px}.dk-image-editor__frame-preview.modern-frame{background:linear-gradient(45deg,#ecf0f1,#bdc3c7);border:2px solid #2c3e50}.dk-image-editor__frame-preview.classic-frame{background:#ecf0f1;border:3px solid #34495e;position:relative}.dk-image-editor__frame-preview.classic-frame:before{border:1px solid #7f8c8d;bottom:3px;content:"";left:3px;position:absolute;right:3px;top:3px}.dk-image-editor__frame-name{word-wrap:break-word;color:hsla(0,0%,100%,.7);font-size:10px;font-weight:500;line-height:1.2;max-width:50px;position:absolute;text-align:center;top:50%;transform:translateY(-50%) scale(.7);word-break:keep-all}.dk-image-editor__frame-option.active .dk-image-editor__frame-name{color:#007bff;font-weight:600}';be(oi);const si=({editorState:a,editorRef:e,onStateChange:t})=>{const{t:i}=D(),o=Ft.map(([l])=>({id:l,name:i(`frame.${l}`),svg:l==="none"?null:l==="solidSharp"?s.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"100%",height:"100%",strokeWidth:"1",stroke:"currentColor",fill:"none",children:s.jsx("rect",{strokeWidth:"5",x:"0",y:"0",width:"100%",height:"100%"})}):l==="solidRound"?s.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"100%",height:"100%",strokeWidth:"1",stroke:"currentColor",fill:"none",children:s.jsx("rect",{strokeWidth:"5",x:"0",y:"0",width:"100%",height:"100%",rx:"12%"})}):l==="lineSingle"?s.jsx("div",{style:{inset:"0.5em",boxShadow:"currentcolor 0px 0px 0px 1px inset"}}):l==="lineMultiple"?s.jsx("div",{style:{border:"3px double #eee"}}):l==="edgeCross"?s.jsxs(s.Fragment,{children:[s.jsx("div",{style:{inset:"-0.5em 0.5em",boxShadow:"currentcolor 0px 0px 0px 1px inset",position:"absolute",width:"initial",height:"initial"}}),s.jsx("div",{style:{inset:"0.5em -0.5em",boxShadow:"currentcolor 0px 0px 0px 1px inset",position:"absolute",width:"initial",height:"initial"}})]}):l==="edgeSeparate"?s.jsxs(s.Fragment,{children:[s.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",top:"0.75em",left:"0.5em",bottom:"0.75em",borderLeft:"1px solid"}}),s.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",top:"0.75em",right:"0.5em",bottom:"0.75em",borderRight:"1px solid"}}),s.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",top:"0.5em",left:"0.75em",right:"0.75em",borderTop:"1px solid"}}),s.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",bottom:"0.5em",left:"0.75em",right:"0.75em",borderBottom:"1px solid"}})]}):l==="edgeOverlap"?s.jsxs(s.Fragment,{children:[s.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",top:"0.3125em",left:"0.5em",bottom:"0.3125em",borderLeft:"1px solid"}}),s.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",top:"0.3125em",right:"0.5em",bottom:"0.3125em",borderRight:"1px solid"}}),s.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",top:"0.5em",left:"0.3125em",right:"0.3125em",borderTop:"1px solid"}}),s.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",bottom:"0.5em",left:"0.3125em",right:"0.3125em",borderBottom:"1px solid"}})]}):l==="hook"?s.jsxs(s.Fragment,{children:[s.jsx("div",{style:{position:"absolute",top:"0.5em",left:"0.5em",width:"0.75em",height:"0.75em",borderLeft:"1px solid",borderTop:"1px solid"}}),s.jsx("div",{style:{position:"absolute",top:"0.5em",right:"0.5em",width:"0.75em",height:"0.75em",borderRight:"1px solid",borderTop:"1px solid"}}),s.jsx("div",{style:{position:"absolute",bottom:"0.5em",left:"0.5em",width:"0.75em",height:"0.75em",borderLeft:"1px solid",borderBottom:"1px solid"}}),s.jsx("div",{style:{position:"absolute",bottom:"0.5em",right:"0.5em",width:"0.75em",height:"0.75em",borderRight:"1px solid",borderBottom:"1px solid"}})]}):l==="polaroid"?s.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"100%",height:"100%",strokeWidth:"1",stroke:"currentColor",fill:"none",children:s.jsx("rect",{strokeWidth:"20%",x:"-5%",y:"-5%",width:"110%",height:"96%"})}):null})),n=w.useCallback(l=>{t({frame:l}),setTimeout(()=>e.current?.render(),50)},[t,e]);return w.useCallback(()=>{t({frame:"none"}),setTimeout(()=>e.current?.render(),50)},[t,e]),s.jsx("div",{className:"dk-image-editor__frame-controls",children:s.jsx("div",{className:"dk-image-editor__frame-list",children:o.map(l=>s.jsxs("div",{className:`dk-image-editor__frame-option ${a?.frame===l.id?"active":""}`,onClick:()=>n(l.id),children:[s.jsx("div",{className:"dk-image-editor__frame-preview",children:l.svg||s.jsx("span",{})}),s.jsx("span",{className:"dk-image-editor__frame-name",children:l.name})]},l.id))})})},Ne={editorState:null,textEditing:{editingText:null,editingValue:"",editingTextItem:null},uiState:{activeTool:"crop",isVisible:!0,hasSelection:!1,selectedFinetuneOption:"brightness",lastAnnotateColor:"#e53a3a",zoomLevel:1,currentAnnotation:null,currentSticker:null},isImageLoading:!1};function ni(a,e){switch(e.type){case"SET_EDITOR_STATE":return{...a,editorState:e.payload};case"UPDATE_TEXT_EDITING":return{...a,textEditing:{...a.textEditing,...e.payload}};case"UPDATE_UI_STATE":return{...a,uiState:{...a.uiState,...e.payload}};case"SET_IMAGE_LOADING":return{...a,isImageLoading:e.payload};case"RESET_ALL_STATE":return Ne;default:return a}}const Be=w.createContext(null),ai=({children:a})=>{const[e,t]=w.useReducer(ni,Ne),i=w.useRef(null),o=w.useRef(null),n=w.useRef(null),l=w.useRef(null),r=w.useRef(null),c=w.useRef(null),d=w.useRef(null),h=w.useRef(null),u=w.useRef(null),g=w.useRef(null),p=w.useMemo(()=>({canvasRef:i,editorRef:o,cropPluginRef:n,filterPluginRef:l,annotatePluginRef:r,stickerPluginRef:c,finetunePluginRef:d,imagePluginRef:h,selectionPluginRef:u,advancedFilterPluginRef:g}),[]),m=w.useMemo(()=>({state:e,dispatch:t,refs:p}),[e,t,p]);return s.jsx(Be.Provider,{value:m,children:a})},ce=()=>{const a=w.useContext(Be);if(!a)throw new Error("useEditorContext must be used within EditorProvider");return a},Le=()=>{const{state:a}=ce();return a.editorState},Oe=()=>{const{state:a}=ce();return a.textEditing},pe=()=>{const{state:a}=ce();return a.uiState},ri=()=>{const{state:a}=ce();return a.isImageLoading},me=()=>{const{dispatch:a}=ce();return w.useMemo(()=>({setEditorState:e=>a({type:"SET_EDITOR_STATE",payload:e}),updateTextEditing:e=>a({type:"UPDATE_TEXT_EDITING",payload:e}),updateUIState:e=>a({type:"UPDATE_UI_STATE",payload:e}),setImageLoading:e=>a({type:"SET_IMAGE_LOADING",payload:e}),resetAllState:()=>a({type:"RESET_ALL_STATE"})}),[a])},de=()=>{const{refs:a}=ce();return a},li=({cropPresets:a,filters:e,annotateTools:t,finetuneOptions:i,onStateChange:o,applyAdvancedFilter:n})=>{const{activeTool:l,selectedFinetuneOption:r,lastAnnotateColor:c,zoomLevel:d,currentAnnotation:h,currentSticker:u}=pe(),g=Le(),{editorRef:p,stickerPluginRef:m,selectionPluginRef:f,imagePluginRef:k}=de(),{updateUIState:y}=me(),v=g?.filterCounts||{},x=E=>y({currentAnnotation:E}),_=E=>y({selectedFinetuneOption:E}),b=E=>y({lastAnnotateColor:E}),C=E=>y({hasSelection:E}),j=E=>o({filterCounts:E}),S=E=>y({currentSticker:E}),I=g||{crop:{x:0,y:0,width:0,height:0},rotation:0,flipX:!1,flipY:!1,scale:1,skewX:0,skewY:0,brightness:0,contrast:0,saturation:0,exposure:0,gamma:0,vignette:0,filter:"none",appliedFilters:[],annotations:[],stickers:[],images:[],backgroundColor:"transparent",frame:"none",filterCounts:{}},M=w.useMemo(()=>({editorState:I,editorRef:p,onStateChange:o}),[I,p,o]);return!l||l==="select"?s.jsx(s.Fragment,{}):s.jsxs("div",{className:"dk-image-editor__controls",children:[l==="crop"&&s.jsx(ft,{...M,cropPresets:a}),l==="finetune"&&s.jsx(Bt,{...M,selectedFinetuneOption:r,finetuneOptions:i,setSelectedFinetuneOption:_}),l==="annotate"&&s.jsx(Yt,{currentAnnotation:h,lastAnnotateColor:c,annotateTools:t,setCurrentAnnotation:x,setLastAnnotateColor:b}),l==="sticker"&&s.jsx(Gt,{editorRef:p,stickerPluginRef:m,selectionPluginRef:f,imagePluginRef:k,zoomLevel:d,setHasSelection:C,currentSticker:u,setCurrentSticker:S}),l==="filter"&&s.jsx(ii,{...M,filters:e,filterCounts:v,setFilterCounts:j,applyAdvancedFilter:n}),l==="frame"&&s.jsx(si,{...M})]})};function ci(a){const e=a.size||a.width||16,t=a.size||a.height||16;return s.jsxs("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[s.jsx("path",{d:"M8 8h8v8H8V8z"}),s.jsx("path",{d:"M4 12V4h8"}),s.jsx("path",{d:"M12 20h8v-8"})]})}function di(a){const e=a.size||a.width||16,t=a.size||a.height||16;return s.jsxs("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",children:[s.jsx("path",{d:"M825 268h-73v-73c0-38.6-31.4-70-70-70H195c-38.6 0-70 31.4-70 70v487c0 38.6 31.4 70 70 70h73v73c0 38.6 31.4 70 70 70h487c38.6 0 70-31.4 70-70V338c0-38.6-31.4-70-70-70zM195 692c-5.5 0-10-4.5-10-10V195c0-5.5 4.5-10 10-10h487c5.5 0 10 4.5 10 10v73H338c-38.6 0-70 31.4-70 70v354h-73z m640 133c0 5.5-4.5 10-10 10H338c-5.5 0-10-4.5-10-10V338c0-5.5 4.5-10 10-10h487c5.5 0 10 4.5 10 10v487z"}),s.jsx("path",{d:"M709 551.5h-97.5V454c0-16.6-13.4-30-30-30s-30 13.4-30 30v97.5H454c-16.6 0-30 13.4-30 30s13.4 30 30 30h97.5V709c0 16.6 13.4 30 30 30s30-13.4 30-30v-97.5H709c16.6 0 30-13.4 30-30s-13.4-30-30-30z"})]})}function hi(a){const e=a.size||a.width||16,t=a.size||a.height||16;return s.jsx("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:s.jsx("path",{d:"M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14zM10 11v6M14 11v6"})})}function ui(a){const e=a.size||a.width||16,t=a.size||a.height||16;return s.jsxs("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[s.jsx("path",{d:"M7 10l5 5 5-5"}),s.jsx("path",{d:"M12 5v10"})]})}function gi(a){const e=a.size||a.width||16,t=a.size||a.height||16;return s.jsxs("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[s.jsx("path",{d:"M7 14l5-5 5 5"}),s.jsx("path",{d:"M12 19V9"})]})}function pi(a){const e=a.size||a.width||16,t=a.size||a.height||16;return s.jsxs("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[s.jsx("path",{d:"M8 8h8v8H8V8z",opacity:"0.5"}),s.jsx("path",{d:"M4 4h8v8H4V4z"}),s.jsx("path",{d:"M12 12h8v8h-8v-8z"})]})}const Z={MIN_FONT_SIZE:12,MAX_FONT_SIZE:72,FONT_SIZE_STEP:2,FOCUS_DELAY:10},mi=({visible:a,editingText:e,editingTextItem:t,selectionPluginRef:i,onDelete:o,onCopy:n,onMoveToFront:l,onMoveToBack:r,onMoveUp:c,onMoveDown:d,onTextItemChange:h})=>{const{t:u}=D(),g=i.current?.isMultipleSelection()||!1,p=i.current?.getSelectedCount()||0,m=i.current?.getSelectedItem(),f=m&&m.type==="text"&&!e,k=m&&!e&&m.type!=="text",y=m&&("sticker"in m||"image"in m),v=()=>{setTimeout(()=>document.querySelector("[contenteditable]")?.focus(),Z.FOCUS_DELAY)},x=T=>{t&&(h({...t,...T}),v())},_=T=>{if(m&&m.type==="text"){i.current?.updateSelectedItemColors(T.color,void 0);const A={...m,...T};i.current?.updateSelectedTextProperties(A)}},b=T=>{i.current?.updateSelectedItemColors(T,void 0)},C=T=>{i.current?.updateSelectedItemColors(void 0,T)},j=()=>{i.current?.updateSelectedItemColors(void 0,"transparent")},S=T=>{i.current?.updateSelectedItemStrokeWidth(T)},I=T=>{i.current?.updateSelectedItemOpacity(T)},M=()=>{i.current?.flipSelectedItem("horizontal")},E=()=>{i.current?.flipSelectedItem("vertical")};return a?s.jsxs("div",{className:"dk-image-editor__floating-toolbar floatingToolbar",children:[s.jsxs("div",{className:"dk-image-editor__floating-toolbar-group",children:[s.jsx("button",{onClick:o,className:"dk-image-editor__toolbar-button",title:g?u("toolbar.delete.multi",{count:p}):u("toolbar.delete"),children:s.jsx(hi,{})}),s.jsx("button",{onClick:n,className:"dk-image-editor__toolbar-button desktop-only",title:g?u("toolbar.copy.multi",{count:p}):u("toolbar.copy"),children:s.jsx(di,{})}),!g&&s.jsxs(s.Fragment,{children:[s.jsx("button",{onClick:l,className:"desktop-only dk-image-editor__toolbar-button",title:u("toolbar.front"),children:s.jsx(ci,{})}),s.jsx("button",{onClick:r,className:"desktop-only dk-image-editor__toolbar-button",title:u("toolbar.back"),children:s.jsx(pi,{})}),s.jsx("button",{onClick:c,className:"dk-image-editor__toolbar-button",title:u("toolbar.forward"),children:s.jsx(gi,{})}),s.jsx("button",{onClick:d,className:"dk-image-editor__toolbar-button",title:u("toolbar.backward"),children:s.jsx(ui,{})})]})]}),s.jsxs("div",{className:"dk-image-editor__floating-toolbar-group",children:[g&&s.jsx("span",{className:"d-flex align-items-center",style:{color:"#ffffffd0",fontSize:"12px",padding:"0 8px"},children:u("toolbar.selected.count",{count:p})}),e&&t&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"dk-image-editor__v-divider"}),s.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.bold"),onClick:()=>x({fontWeight:t.fontWeight==="bold"?"normal":"bold"}),children:s.jsx("strong",{children:"B"})}),s.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.italic"),onClick:()=>x({fontStyle:t.fontStyle==="italic"?"normal":"italic"}),children:s.jsx("em",{children:"I"})}),s.jsx("button",{className:"dk-image-editor__toolbar-button desktop-only",title:u("toolbar.underline"),onClick:()=>x({textDecoration:t.textDecoration==="underline"?"none":"underline"}),children:s.jsx("u",{children:"U"})}),s.jsx("button",{className:"dk-image-editor__toolbar-button desktop-only",title:u("toolbar.strikethrough"),onClick:()=>x({textDecoration:t.textDecoration==="line-through"?"none":"line-through"}),children:s.jsx("s",{children:"S"})}),s.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.font.smaller"),onClick:()=>x({fontSize:Math.max(Z.MIN_FONT_SIZE,(t.fontSize||U.DEFAULT_FONT_SIZE)-Z.FONT_SIZE_STEP)}),children:"A-"}),s.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.font.larger"),onClick:()=>x({fontSize:Math.min(Z.MAX_FONT_SIZE,(t.fontSize||U.DEFAULT_FONT_SIZE)+Z.FONT_SIZE_STEP)}),children:"A+"}),s.jsx(Q,{value:t.color||"#000000",onChange:T=>x({color:T}),title:u("toolbar.text.color")})]}),f&&!g&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"dk-image-editor__v-divider"}),s.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.bold"),onClick:()=>_({fontWeight:m.fontWeight==="bold"?"normal":"bold"}),children:s.jsx("strong",{children:"B"})}),s.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.italic"),onClick:()=>_({fontStyle:m.fontStyle==="italic"?"normal":"italic"}),children:s.jsx("em",{children:"I"})}),s.jsx("button",{className:"dk-image-editor__toolbar-button desktop-only",title:u("toolbar.underline"),onClick:()=>_({textDecoration:m.textDecoration==="underline"?"none":"underline"}),children:s.jsx("u",{children:"U"})}),s.jsx("button",{className:"dk-image-editor__toolbar-button desktop-only",title:u("toolbar.strikethrough"),onClick:()=>_({textDecoration:m.textDecoration==="line-through"?"none":"line-through"}),children:s.jsx("s",{children:"S"})}),s.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.font.smaller"),onClick:()=>_({fontSize:Math.max(Z.MIN_FONT_SIZE,(m.fontSize||U.DEFAULT_FONT_SIZE)-Z.FONT_SIZE_STEP)}),children:"A-"}),s.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.font.larger"),onClick:()=>_({fontSize:Math.min(Z.MAX_FONT_SIZE,(m.fontSize||U.DEFAULT_FONT_SIZE)+Z.FONT_SIZE_STEP)}),children:"A+"}),s.jsx(Q,{value:m.color||"#000000",onChange:T=>_({color:T}),title:u("toolbar.text.color")})]})]}),s.jsx("div",{className:"dk-image-editor__floating-toolbar-group",children:k&&!g&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"dk-image-editor__v-divider"}),!y&&s.jsxs(s.Fragment,{children:[s.jsx(Q,{value:m?.strokeColor||m?.color||"#000000",onChange:b,title:u("toolbar.stroke.color")}),s.jsx("select",{value:m?.strokeWidth||2,onChange:T=>S(Number(T.target.value)),style:{background:"transparent",border:"#ffffff20",borderRadius:"4px",color:"#ffffffd0",fontSize:"12px"},title:u("toolbar.stroke.width"),children:[1,2,3,4,5,6,8,10,12,15,20].map(T=>s.jsxs("option",{value:T,style:{background:"#333",color:"#ffffffd0"},children:[T,"px"]},T))}),m?.type!=="line"&&m?.type!=="sharpie"&&m?.type!=="path"&&s.jsxs("div",{className:"d-flex align-items-center gap-50",children:[s.jsx(Q,{value:m?.fillColor||"#ffffff",onChange:C,title:u("toolbar.fill.color")}),m?.fillColor&&m?.fillColor!=="transparent"&&s.jsx("span",{className:"text-white hover",onClick:j,title:u("toolbar.clear.fill"),children:"\u2715"})]})]}),s.jsx(te,{min:0,max:100,value:(m?.opacity||1)*100,onChange:T=>I(T/100),className:"opacity-slider",width:"80px"}),s.jsx("button",{onClick:M,className:"dk-image-editor__toolbar-button",title:u("toolbar.flip.horizontal"),children:"\u21C4"}),s.jsx("button",{onClick:E,className:"dk-image-editor__toolbar-button",title:u("toolbar.flip.vertical"),children:"\u21C5"})]})})]}):null},xi=({editingText:a,editingValue:e,editingTextItem:t,canvasRef:i,zoomLevel:o,onValueChange:n,onBlur:l})=>{if(!a||!i.current)return null;const r=i.current,c=r.getBoundingClientRect(),d=r.parentElement?.getBoundingClientRect(),h=c.width/r.width,u=a.x/r.width*c.width+(h>1?0:(c.left||0)-(d?.left||0)),g=a.y/r.height*c.height+(h>1?0:(c.top||0)-(d?.top||0))-(t?.fontSize||U.DEFAULT_FONT_SIZE)*h;return s.jsx("div",{contentEditable:!0,suppressContentEditableWarning:!0,onInput:p=>n(p.currentTarget.textContent||""),onBlur:p=>{p.relatedTarget&&p.relatedTarget.closest(".floatingToolbar")||l()},onKeyDown:p=>{p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),p.currentTarget.blur())},ref:p=>{if(p&&a&&p.textContent!==e){p.textContent=e,p.focus();const m=document.createRange();m.selectNodeContents(p);const f=window.getSelection();f?.removeAllRanges(),f?.addRange(m)}},style:{position:"absolute",left:u,top:g,zIndex:1e3,padding:"0",border:"1px solid #007bff",borderRadius:"2px",background:"transparent",color:t?.color||"#ffffffd0",fontSize:`${(t?.fontSize||U.DEFAULT_FONT_SIZE)*o}px`,fontWeight:t?.fontWeight||"normal",fontStyle:t?.fontStyle||"normal",textDecoration:t?.textDecoration||"none",minWidth:`${100*o}px`,outline:"none",whiteSpace:"nowrap",transform:a.rotation?`rotate(${a.rotation}deg)`:"none",transformOrigin:"left baseline",lineHeight:"1"}})},fi=({onMouseDown:a,onMouseMove:e,onMouseUp:t,onDoubleClick:i,onTouchStart:o,onTouchMove:n,onTouchEnd:l})=>{const{activeTool:r,hasSelection:c,zoomLevel:d}=pe(),{editingText:h,editingValue:u,editingTextItem:g}=Oe(),{canvasRef:p,selectionPluginRef:m,editorRef:f}=de(),{updateTextEditing:k,updateUIState:y}=me(),v=C=>{k({editingTextItem:C})},x=C=>{k({editingValue:C})},_=()=>{if(g&&g.id){const C=f.current?.getState();if(C){const j={...g,text:u,id:g.id,type:g.type||"text",x:g.x||0,y:g.y||0,color:g.color||"#000000",strokeWidth:g.strokeWidth||1},S=[...C.annotations||[],j];f.current?.setState({annotations:S}),k({editingText:null,editingValue:"",editingTextItem:null}),y({hasSelection:!1}),f.current?.render()}}},b=C=>{const j=m.current?.selectedItem;if(j&&f.current){const S={front:"moveToFront",back:"moveToBack",forward:"moveForward",backward:"moveBackward"};f.current[S[C]](j.id)}};return s.jsxs(s.Fragment,{children:[s.jsx(mi,{visible:c||!!h,editingText:h,editingTextItem:g,selectionPluginRef:m,onDelete:()=>m.current?.deleteSelected(),onCopy:()=>m.current?.copySelected(),onMoveToFront:()=>b("front"),onMoveToBack:()=>b("back"),onMoveUp:()=>b("forward"),onMoveDown:()=>b("backward"),onTextItemChange:v}),s.jsxs("div",{className:"dk-image-editor__canvas",children:[s.jsx(xi,{editingText:h,editingValue:u,editingTextItem:g,canvasRef:p,zoomLevel:d,onValueChange:x,onBlur:_}),s.jsx("canvas",{ref:p,className:`dk-image-editor__image-canvas dk-image-editor__image-canvas--${r}`,onMouseDown:a,onMouseMove:e,onMouseUp:t,onDoubleClick:i,onTouchStart:o,onTouchMove:n,onTouchEnd:l,style:{touchAction:"none"}})]})]})};function ki(a){const e=a.size||a.width||16,t=a.size||a.height||16;return s.jsxs("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[s.jsx("path",{d:"M21 7v6h-6"}),s.jsx("path",{d:"M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"})]})}function bi(a){const e=a.size||a.width||16,t=a.size||a.height||16;return s.jsxs("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[s.jsx("path",{d:"M3 7v6h6"}),s.jsx("path",{d:"M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"})]})}function yi(a){const e=a.size||a.width||16,t=a.size||a.height||16;return s.jsxs("svg",{...a,width:e,height:t,className:a.className,style:a.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[s.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),s.jsx("polyline",{points:"7,10 12,5 17,10"}),s.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"15"})]})}const vi=({size:a=16,className:e=""})=>s.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:e,children:[s.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),s.jsx("polyline",{points:"7,10 12,15 17,10"}),s.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),wi=({size:a=16,className:e=""})=>s.jsx("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:e,children:s.jsx("polyline",{points:"20,6 9,17 4,12"})}),_i=({size:a=16,className:e=""})=>s.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:e,children:[s.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),s.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]}),Si=({size:a=16,className:e=""})=>s.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:e,children:[s.jsx("circle",{cx:"11",cy:"11",r:"8"}),s.jsx("path",{d:"m21 21-4.35-4.35"}),s.jsx("line",{x1:"11",y1:"8",x2:"11",y2:"14"}),s.jsx("line",{x1:"8",y1:"11",x2:"14",y2:"11"})]}),Ci=({size:a=16,className:e=""})=>s.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:e,children:[s.jsx("circle",{cx:"11",cy:"11",r:"8"}),s.jsx("path",{d:"m21 21-4.35-4.35"}),s.jsx("line",{x1:"8",y1:"11",x2:"14",y2:"11"})]}),xe={MIN_ZOOM:.5,MAX_ZOOM:3,ZOOM_IN_FACTOR:1.2,ZOOM_OUT_FACTOR:.8,TRANSITION_DURATION:200},Mi=()=>{const{zoomLevel:a}=pe(),{updateUIState:e}=me(),{canvasRef:t,selectionPluginRef:i}=de(),{t:o}=D(),n=w.useRef(null),l=g=>{document.querySelectorAll(".dk-img-editor-selection-overlay").forEach(p=>{p.style.display=g?"":"none"})},r=()=>{n.current&&clearTimeout(n.current),n.current=setTimeout(()=>{i.current?.refreshSelection?.(),l(!0)},xe.TRANSITION_DURATION)},c=(g,p=!0)=>{const m=t.current,f=m?.parentElement;if(!m||!f)return;l(!1);const k=f.getBoundingClientRect(),y=m.width*g,v=m.height*g;if(m.style.transform=`scale(${g})`,e({zoomLevel:g}),g<=1||y<=k.width&&v<=k.height)m.style.transformOrigin="center",f.scrollTo({left:0,top:0});else{const x=(f.scrollLeft+k.width/2)/a,_=(f.scrollTop+k.height/2)/a,b=x*g-k.width/2,C=_*g-k.height/2;m.style.transformOrigin="0 0",f.scrollTo({left:Math.max(0,b),top:Math.max(0,C)})}p&&r()},d=()=>{const g=Math.min(xe.MAX_ZOOM,a*xe.ZOOM_IN_FACTOR);c(g)},h=()=>c(1),u=()=>{const g=Math.max(xe.MIN_ZOOM,a*xe.ZOOM_OUT_FACTOR);c(g)};return s.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[s.jsx("button",{onClick:d,className:"dk-image-editor__action-btn",title:o("header.zoom.in"),children:s.jsx(Si,{size:16})}),s.jsxs("button",{onClick:h,className:"dk-image-editor__action-btn",title:o("header.zoom.reset"),children:[Math.round(a*100),"%"]}),s.jsx("button",{onClick:u,className:"dk-image-editor__action-btn",title:o("header.zoom.out"),children:s.jsx(Ci,{size:16})})]})},ji=({isOpen:a,title:e,message:t,confirmText:i,cancelText:o,onConfirm:n,onCancel:l})=>a?s.jsx("div",{className:"dk-confirm-overlay",children:s.jsxs("div",{className:"dk-confirm-dialog",children:[s.jsx("h3",{className:"dk-confirm-title",children:e}),s.jsx("p",{className:"dk-confirm-message",children:t}),s.jsxs("div",{className:"dk-confirm-actions",children:[s.jsx("button",{onClick:l,className:"dk-confirm-cancel",children:o}),s.jsx("button",{onClick:n,className:"dk-confirm-confirm",children:i})]})]})}):null;class Ue{static async isFormatSupported(e){if(this.supportCache.has(e))return this.supportCache.get(e);const t=document.createElement("canvas");t.width=1,t.height=1;const i=this.getMimeType(e);try{const o=t.toDataURL(i).startsWith(`data:${i}`);return this.supportCache.set(e,o),o}catch{return this.supportCache.set(e,!1),!1}}static async getSupportedFormats(){const e=["png","jpg","webp","avif","heic"],t=[];for(const i of e)await this.isFormatSupported(i)&&t.push(i);return t}static getMimeType(e){return{png:"image/png",jpg:"image/jpeg",webp:"image/webp",avif:"image/avif",heic:"image/heic"}[e]||"image/png"}}Ue.supportCache=new Map;const Ii=({onClose:a,onConfirm:e,onUndo:t,onRedo:i,onSave:o,onUpload:n,onCopy:l,showConfirmButton:r=!0,showCloseButton:c=!0,showDownloadButton:d=!0})=>{const{t:h}=D(),{canvasRef:u,selectionPluginRef:g}=de(),p=w.useRef(null),[m,f]=w.useState(!1),[k,y]=w.useState("png"),[v,x]=w.useState(["png","jpg"]);w.useEffect(()=>{(async()=>{const b=await Ue.getSupportedFormats();x(b.length>0?b:["png","jpg"])})()},[]);const _=()=>{p.current?.click()};return s.jsxs("div",{className:"dk-image-editor__header",children:[s.jsxs("div",{className:"dk-image-editor__header-left",children:[s.jsx("input",{ref:p,type:"file",accept:"image/*",onChange:b=>{const C=b.target.files?.[0];C&&n&&n(C),b.target.value=""},style:{display:"none"}}),s.jsx("button",{onClick:_,className:"dk-image-editor__action-btn",title:h("header.upload"),children:s.jsx(yi,{})}),s.jsx("button",{onClick:()=>{t(),g.current?.clearSelection()},className:"dk-image-editor__action-btn",title:h("header.undo"),children:s.jsx(bi,{})}),s.jsx("button",{onClick:()=>{i(),g.current?.clearSelection()},className:"dk-image-editor__action-btn",title:h("header.redo"),children:s.jsx(ki,{})}),s.jsx(Mi,{})]}),s.jsxs("div",{className:"dk-image-editor__header-right",children:[l&&s.jsx("button",{onClick:l,className:"dk-image-editor__action-btn desktop-only",title:h("header.copy"),children:s.jsx("span",{children:h("header.copy")})}),d&&s.jsxs("div",{className:"dk-image-editor__export-group",children:[s.jsx("select",{value:k,onChange:b=>y(b.target.value),className:"dk-image-editor__format-select desktop-only",children:v.map(b=>s.jsx("option",{value:b,children:b.toUpperCase()},b))}),s.jsxs("button",{onClick:()=>o(k),className:"dk-image-editor__save-btn",children:[s.jsx("span",{className:"desktop-only",children:h("header.download")}),s.jsx("span",{className:"mobile-only",children:s.jsx(vi,{size:16})})]})]}),r&&s.jsxs("button",{onClick:e,className:"dk-image-editor__confirm-btn",children:[s.jsx("span",{className:"desktop-only",children:h("header.confirm")}),s.jsx("span",{className:"mobile-only",children:s.jsx(wi,{size:16})})]}),c&&s.jsxs("button",{onClick:()=>f(!0),className:"dk-image-editor__action-btn",children:[s.jsx("span",{className:"desktop-only",children:h("header.close")}),s.jsx("span",{className:"mobile-only",children:s.jsx(_i,{size:16})})]})]}),s.jsx(ji,{isOpen:m,title:h("header.close"),message:h("header.close.confirm"),confirmText:h("header.close"),cancelText:h("common.cancel"),onConfirm:()=>{f(!1),a()},onCancel:()=>f(!1)})]})},Ei=({tools:a})=>{const{activeTool:e}=pe(),{updateUIState:t}=me(),{t:i}=D();return s.jsx("div",{className:"dk-image-editor__sidebar",children:a.map(o=>s.jsxs("button",{className:`dk-image-editor__tool-btn ${e===o.id?"dk-image-editor__tool-btn--active":""}`,onClick:()=>t({activeTool:o.id}),children:[s.jsx("span",{className:"dk-image-editor__tool-icon",children:o.icon}),s.jsx("span",{className:"dk-image-editor__tool-name",children:i(`tool.${o.id}`)})]},o.id))})},Ti=()=>{const{editorRef:a,cropPluginRef:e,filterPluginRef:t,annotatePluginRef:i,stickerPluginRef:o,finetunePluginRef:n,imagePluginRef:l,selectionPluginRef:r,advancedFilterPluginRef:c}=de();return{editorRef:a,cropPluginRef:e,filterPluginRef:t,annotatePluginRef:i,stickerPluginRef:o,finetunePluginRef:n,imagePluginRef:l,selectionPluginRef:r,advancedFilterPluginRef:c,applyAdvancedFilter:async(d,h)=>{if(!c.current)throw new Error("AdvancedFilterPlugin not initialized");return console.log(" advancedFilterPluginRef.current",c.current,d,h),await c.current.applyAdvancedFilter(d,h)}}};class $e{constructor(e){this.image=null,this.originalImage=null,this.imageDisplay={x:0,y:0,width:0,height:0},this.history=[],this.historyIndex=-1,this.plugins=new Map,this.eventListeners=new Map,this.resizeObserver=null,this.canvas=e,this.ctx=e.getContext("2d"),this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high",this.canvas.style.imageRendering="crisp-edges",this.state=this.getInitialState(),this.setupCanvasResize()}isSticker(e){return"sticker"in e}setupCanvasResize(){this.resizeObserver=new ResizeObserver(()=>this.updateCanvasSize()),this.canvas.parentElement&&this.resizeObserver.observe(this.canvas.parentElement)}updateCanvasSize(){const e=this.canvas.parentElement;if(!e)return;const t=e.getBoundingClientRect();this.canvas.width=Math.floor(t.width),this.canvas.height=Math.floor(t.height),this.image&&(this.calculateImageDisplay(),this.render())}calculateImageDisplay(){if(!this.image)return;const e=this.image.width/this.image.height,t=this.canvas.width/this.canvas.height,i=.96,[o,n]=e>t?[this.canvas.width*i,this.canvas.width*i/e]:[this.canvas.height*i*e,this.canvas.height*i],l=(this.canvas.width-o)/2,r=(this.canvas.height-n)/2,c=this.imageDisplay.width===0;this.imageDisplay={x:l,y:r,width:o,height:n},c&&this.setState({crop:{x:l,y:r,width:o,height:n}},!1)}getInitialState(){return{crop:{x:0,y:0,width:0,height:0},rotation:0,flipX:!1,flipY:!1,scale:1,skewX:0,skewY:0,brightness:0,contrast:0,saturation:0,exposure:0,gamma:0,vignette:0,filter:"none",appliedFilters:[],annotations:[],stickers:[],images:[],backgroundColor:"transparent",frame:"none",filterCounts:{}}}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){const i=this.eventListeners.get(e);if(!i)return;const o=i.indexOf(t);o>-1&&i.splice(o,1)}emit(e,t){this.eventListeners.get(e)?.forEach(i=>i(t))}addPlugin(e){this.plugins.set(e.name,e),e.init?.(this.canvas,this.ctx),e.initialize?.(this),e.updateStickers?.(this.state.stickers),e.updateAnnotations?.(this.state.annotations)}removePlugin(e){const t=this.plugins.get(e);t&&(t.destroy(),this.plugins.delete(e))}getState(){return{...this.state}}getImageDisplay(){return{...this.imageDisplay}}getOriginalImageSize(){return this.image?{width:this.image.width,height:this.image.height}:{width:0,height:0}}setState(e,t=!0){const i=n=>n.canvasRotation===void 0?{...n,canvasRotation:this.state.rotation,canvasFlipX:this.state.flipX,canvasFlipY:this.state.flipY,canvasScale:this.state.scale,canvasSkewX:this.state.skewX,canvasSkewY:this.state.skewY}:n;e.stickers&&(e.stickers=e.stickers.map(i)),e.annotations&&(e.annotations=e.annotations.map(i)),e.images&&(e.images=e.images.map(i));const o={...this.state,...e};t&&this.saveToHistory(o),this.state=o,this.plugins.forEach(n=>{e.stickers&&n.updateStickers?.(e.stickers),e.annotations&&n.updateAnnotations?.(e.annotations)}),this.emit("stateChange",o),this.render()}saveToHistory(e){this.history=this.history.slice(0,this.historyIndex+1),this.history.push(JSON.parse(JSON.stringify(e))),this.historyIndex++,this.history.length>50&&(this.history.shift(),this.historyIndex--)}restoreState(e){this.historyIndex=e;const t=this.history[e];t&&(this.state=t,this.emit("stateChange",this.state),this.render())}undo(){this.historyIndex>0&&this.restoreState(this.historyIndex-1)}redo(){this.historyIndex<this.history.length-1&&this.restoreState(this.historyIndex+1)}async loadImage(e){return new Promise((t,i)=>{const o=new Image;o.crossOrigin="anonymous",o.onload=()=>{this.image=o,this.originalImage=o.cloneNode(),this.updateCanvasSize(),this.calculateImageDisplay(),this.emit("imageLoaded",o),t()},o.onerror=i,typeof e=="string"?o.src=e:o.src=URL.createObjectURL(e)})}render(){if(!this.image)return;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.state.backgroundColor!=="transparent"&&(this.ctx.fillStyle=this.state.backgroundColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height));const e=this.plugins.get("crop"),t=e&&e.isActive;this.ctx.save(),!t&&this.state.crop&&(this.ctx.beginPath(),this.ctx.rect(this.state.crop.x,this.state.crop.y,this.state.crop.width,this.state.crop.height),this.ctx.clip());const i=this.imageDisplay.x+this.imageDisplay.width/2,o=this.imageDisplay.y+this.imageDisplay.height/2;this.ctx.translate(i,o),this.ctx.rotate(this.state.rotation*Math.PI/180),this.ctx.scale((this.state.flipX?-1:1)*this.state.scale,(this.state.flipY?-1:1)*this.state.scale),this.ctx.transform(1,this.state.skewY,this.state.skewX,1,0,0),this.applyFilters(),this.ctx.drawImage(this.image,-this.imageDisplay.width/2,-this.imageDisplay.height/2,this.imageDisplay.width,this.imageDisplay.height),this.state.vignette!==0&&this.applyVignette(this.ctx,this.state.vignette),this.ctx.restore(),this.ctx.restore(),this.ctx.save(),this.state.crop&&(this.ctx.beginPath(),this.ctx.rect(this.state.crop.x,this.state.crop.y,this.state.crop.width,this.state.crop.height),this.ctx.clip()),this.getAllItems().sort((l,r)=>(l.zIndex||0)-(r.zIndex||0)).forEach(l=>{this.ctx.save(),this.applyCanvasTransformForItem(l),this.isSticker(l)?this.drawSticker(l):l.type==="image"?this.drawImage(l):this.drawAnnotation(l)}),this.ctx.restore(),this.plugins.forEach(l=>{l.render&&l.name!=="selection"&&l.render(this.ctx)});const n=this.plugins.get("selection");n&&n.render&&n.render(this.ctx),this.state.frame!=="none"&&this.drawFrame(this.state.frame),this.emit("render")}applyFiltersToContext(e){const{brightness:t,contrast:i,saturation:o,exposure:n,gamma:l,filter:r}=this.state,c=[];t&&c.push(`brightness(${100+t}%)`),i&&c.push(`contrast(${100+i}%)`),o&&c.push(`saturate(${100+o}%)`),n&&c.push(`brightness(${100+n*.5}%)`),l&&c.push(`contrast(${100+l*.3}%)`);const d={monoDefault:"grayscale(100%)",sepiaDefault:"sepia(100%)",warm:"sepia(20%) saturate(120%) hue-rotate(15deg)",cold:"saturate(120%) hue-rotate(-15deg)",chrome:"contrast(120%) saturate(150%) hue-rotate(10deg)",fade:"contrast(80%) brightness(110%) saturate(80%)",blur:"blur(3px)"};d[r]&&c.push(d[r]),e.filter=c.join(" ")||"none"}applyFilters(){this.applyFiltersToContext(this.ctx)}applyVignette(e,t){if(!t)return;const{width:i,height:o}=this.imageDisplay,n=Math.sqrt((i/2)**2+(o/2)**2),l=n*.3,r=e.createRadialGradient(0,0,l,0,0,n),c=Math.abs(t)/100*.8;t>0?(r.addColorStop(0,"rgba(0, 0, 0, 0)"),r.addColorStop(.7,"rgba(0, 0, 0, 0)"),r.addColorStop(1,`rgba(0, 0, 0, ${c})`)):(r.addColorStop(0,`rgba(0, 0, 0, ${c})`),r.addColorStop(.7,"rgba(0, 0, 0, 0)"),r.addColorStop(1,"rgba(0, 0, 0, 0)")),e.save(),e.globalCompositeOperation="multiply",e.fillStyle=r,e.fillRect(-i/2,-o/2,i,o),e.restore()}drawAnnotation(e){const t=e.strokeColor||e.color,i=e.fillColor||(e.type==="text"?e.color:"transparent"),o=e.opacity||1,n=e.flipX||!1,l=e.flipY||!1;if(this.ctx.save(),this.ctx.globalAlpha=o,this.ctx.strokeStyle=t,this.ctx.fillStyle=e.type==="text"?e.color:i,this.ctx.lineWidth=e.strokeWidth,n||l){const r=e.x+(e.width||0)/2,c=e.y+(e.height||0)/2;this.ctx.translate(r,c),this.ctx.scale(n?-1:1,l?-1:1),this.ctx.translate(-r,-c)}this.applyRotation(e),this.drawAnnotationShape(e),this.ctx.restore()}applyRotation(e){if(!e.rotation)return;const{x:t,y:i,width:o=0,height:n=0,fontSize:l=24,type:r}=e,[c,d]=r==="text"?[t+o/2,i-l/2]:[t+o/2,i+n/2];this.ctx.translate(c,d),this.ctx.rotate(e.rotation*Math.PI/180),this.ctx.translate(-c,-d)}drawAnnotationShape(e){const{type:t,x:i,y:o,width:n=0,height:l=0}=e;switch(t){case"text":this.drawText(e);break;case"rectangle":this.drawRectangle(i,o,n,l);break;case"ellipse":this.drawEllipse(i,o,n,l);break;case"line":this.drawLine(i,o,n,l);break;case"arrow":this.drawArrow(e);break;case"sharpie":case"path":this.drawPath(e.points);break}}drawText(e){if(!e.text||!e.fontSize)return;const t=e.fontWeight||"normal",i=e.fontStyle||"normal";this.ctx.font=`${i} ${t} ${e.fontSize}px Arial`;const o=this.ctx.measureText(e.text).width,n=Math.max(1,e.fontSize/16),l=e.textDecoration;l==="underline"?this.drawTextDecoration(e.x,e.y+2,o,n):l==="line-through"&&this.drawTextDecoration(e.x,e.y-e.fontSize/3,o,n),this.ctx.fillText(e.text,e.x,e.y)}drawTextDecoration(e,t,i,o){const n=this.ctx.lineWidth;this.ctx.lineWidth=o,this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.lineTo(e+i,t),this.ctx.stroke(),this.ctx.lineWidth=n}drawRectangle(e,t,i,o){!i||!o||(this.ctx.fillStyle!=="transparent"&&this.ctx.fillRect(e,t,i,o),this.ctx.strokeRect(e,t,i,o))}drawEllipse(e,t,i,o){!i||!o||(this.ctx.beginPath(),this.ctx.ellipse(e+i/2,t+o/2,Math.abs(i/2),Math.abs(o/2),0,0,2*Math.PI),this.ctx.fillStyle!=="transparent"&&this.ctx.fill(),this.ctx.stroke())}drawLine(e,t,i,o){!i||!o||(this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.lineTo(e+i,t+o),this.ctx.stroke())}drawArrow(e){const{x:t,y:i,width:o=0,height:n=0,strokeWidth:l}=e;if(!o||!n)return;const r=t+o,c=i+n,d=Math.max(8,l*2),h=Math.atan2(n,o);this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(r,c),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(r-d*Math.cos(h+Math.PI/4),c-d*Math.sin(h+Math.PI/4)),this.ctx.lineTo(r,c),this.ctx.lineTo(r-d*Math.cos(h-Math.PI/4),c-d*Math.sin(h-Math.PI/4)),this.ctx.stroke()}drawPath(e){if(!e||e.length<2)return;this.ctx.beginPath();const t=e[0];t&&(this.ctx.moveTo(t.x,t.y),e.slice(1).forEach(i=>this.ctx.lineTo(i.x,i.y))),this.ctx.stroke()}drawImage(e){const{x:t,y:i,rotation:o,width:n,height:l,image:r}=e,c=e.opacity||1,d=e.flipX||!1,h=e.flipY||!1;this.ctx.save(),this.ctx.globalAlpha=c,this.ctx.translate(t,i),this.ctx.rotate(o*Math.PI/180),this.ctx.scale(d?-1:1,h?-1:1),this.ctx.drawImage(r,-n/2,-l/2,n,l),this.ctx.restore()}drawSticker(e){const{x:t,y:i,rotation:o,size:n,type:l,content:r,image:c}=e,d=e.opacity||1,h=e.flipX||!1,u=e.flipY||!1;this.ctx.save(),this.ctx.globalAlpha=d,this.ctx.translate(t,i),this.ctx.rotate(o*Math.PI/180),this.ctx.scale(h?-1:1,u?-1:1),l==="emoji"?(this.ctx.font=`${n}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(r,0,0)):l==="image"&&c&&this.ctx.drawImage(c,-n/2,-n/2,n,n),this.ctx.restore()}drawFrame(e){if(!this.state.crop)return;this.ctx.save();const{x:t,y:i,width:o,height:n}=this.state.crop;switch(e){case"undefined":case"none":break;case"solidSharp":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=5,this.ctx.strokeRect(t,i,o,n);break;case"solidRound":this.ctx.fillStyle="#fff";const l=5,r=o*.03;this.ctx.beginPath(),this.ctx.rect(t-l,i-l,o+2*l,n+2*l),this.ctx.roundRect(t,i,o,n,r),this.ctx.fill("evenodd");break;case"lineSingle":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3;const c=o*.05;this.ctx.strokeRect(t+c,i+c,o-2*c,n-2*c);break;case"lineMultiple":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3;const d=o*.075;this.ctx.strokeRect(t+d,i+d,o-2*d,n-2*d),this.ctx.strokeRect(t+d*.5,i+d*.5,o-d,n-d);break;case"edgeCross":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3;const h=o*.05;this.ctx.beginPath(),this.ctx.moveTo(t,i+h),this.ctx.lineTo(t+o,i+h),this.ctx.moveTo(t,i+n-h),this.ctx.lineTo(t+o,i+n-h),this.ctx.moveTo(t+h,i),this.ctx.lineTo(t+h,i+n),this.ctx.moveTo(t+o-h,i),this.ctx.lineTo(t+o-h,i+n),this.ctx.stroke();break;case"edgeOverlap":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3;const u=o*.075,g=o*.05;this.ctx.beginPath(),this.ctx.moveTo(t+g,i+u),this.ctx.lineTo(t+o-g,i+u),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t+g,i+n-u),this.ctx.lineTo(t+o-g,i+n-u),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t+u,i+g),this.ctx.lineTo(t+u,i+n-g),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t+o-u,i+g),this.ctx.lineTo(t+o-u,i+n-g),this.ctx.stroke();break;case"edgeSeparate":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3;const p=o*.03125,m=o*.05;this.ctx.beginPath(),this.ctx.moveTo(t+m,i+p),this.ctx.lineTo(t+o-m,i+p),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t+m,i+n-p),this.ctx.lineTo(t+o-m,i+n-p),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t+p,i+m),this.ctx.lineTo(t+p,i+n-m),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t+o-p,i+m),this.ctx.lineTo(t+o-p,i+n-m),this.ctx.stroke();break;case"hook":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3;const f=o*.075,k=o*.05;this.ctx.beginPath(),this.ctx.moveTo(t+k,i+k+f),this.ctx.lineTo(t+k,i+k),this.ctx.lineTo(t+k+f,i+k),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t+o-k-f,i+k),this.ctx.lineTo(t+o-k,i+k),this.ctx.lineTo(t+o-k,i+k+f),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t+k,i+n-k-f),this.ctx.lineTo(t+k,i+n-k),this.ctx.lineTo(t+k+f,i+n-k),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t+o-k-f,i+n-k),this.ctx.lineTo(t+o-k,i+n-k),this.ctx.lineTo(t+o-k,i+n-k-f),this.ctx.stroke();break;case"polaroid":this.ctx.fillStyle="#fff";const y=o*.05,v=o*.05,x=o*.1;this.ctx.fillRect(t-v,i-y,o+2*v,y),this.ctx.fillRect(t-v,i-y,v,n+y+x),this.ctx.fillRect(t+o,i-y,v,n+y+x),this.ctx.fillRect(t-v,i+n,o+2*v,x);break}this.ctx.restore()}getImageData(){if(!this.image)return null;const e=document.createElement("canvas"),t=e.getContext("2d");return e.width=Math.round(this.imageDisplay.width),e.height=Math.round(this.imageDisplay.height),t.drawImage(this.image,0,0,e.width,e.height),t.getImageData(0,0,e.width,e.height)}resetToOriginal(){this.originalImage&&(this.image=this.originalImage.cloneNode(),this.render())}setImageData(e){const t=document.createElement("canvas"),i=t.getContext("2d");t.width=e.width,t.height=e.height,i.putImageData(e,0,0);const o=new Image;o.onload=()=>{this.image=o,this.render()},o.src=t.toDataURL()}async export(e="blob",t,i,o="png"){if(!this.originalImage)throw new Error("No image loaded");const n=this.originalImage.width/this.imageDisplay.width;let l=t||Math.round(this.state.crop.width*n),r=i||Math.round(this.state.crop.height*n);if(this.state.frame==="polaroid"){const u=l*.05,g=l*.05,p=l*.1;l+=2*u,r+=g+p}const c=document.createElement("canvas"),d=c.getContext("2d");c.width=l,c.height=r,d.imageSmoothingEnabled=!1,this.renderToExportCanvas(d,l,r);const h=this.getMimeType(o);try{return e==="dataURL"?c.toDataURL(h):new Promise((u,g)=>{c.toBlob(p=>{p?u(p):c.toBlob(m=>{m?(console.warn(`Format ${o} not supported, falling back to PNG`),u(m)):g(new Error("Failed to create blob"))},"image/png")},h)})}catch(u){return console.warn(`Error with format ${o}, falling back to PNG:`,u),e==="dataURL"?c.toDataURL("image/png"):new Promise((g,p)=>{c.toBlob(m=>m?g(m):p(new Error("Failed to create blob")),"image/png")})}}renderToExportCanvas(e,t,i){if(!this.image)return;e.clearRect(0,0,t,i),this.state.backgroundColor!=="transparent"&&(e.fillStyle=this.state.backgroundColor,e.fillRect(0,0,t,i)),e.save();const o=t/this.state.crop.width,n={x:(this.imageDisplay.x-this.state.crop.x)*o,y:(this.imageDisplay.y-this.state.crop.y)*o,width:this.imageDisplay.width*o,height:this.imageDisplay.height*o},l=n.x+n.width/2,r=n.y+n.height/2;if(e.translate(l,r),e.rotate(this.state.rotation*Math.PI/180),e.scale((this.state.flipX?-1:1)*this.state.scale,(this.state.flipY?-1:1)*this.state.scale),e.transform(1,this.state.skewY,this.state.skewX,1,0,0),this.applyFiltersToContext(e),e.drawImage(this.image,-n.width/2,-n.height/2,n.width,n.height),this.state.vignette!==0&&this.applyVignetteToExport(e,this.state.vignette,n.width,n.height),e.restore(),this.getAllItems().sort((c,d)=>(c.zIndex||0)-(d.zIndex||0)).forEach(c=>{e.save(),this.applyCanvasTransformForItemToExport(e,c,n,o);const d=(c.x-this.state.crop.x)*o,h=(c.y-this.state.crop.y)*o;d>=-100&&d<=t+100&&h>=-100&&h<=i+100&&(this.isSticker(c)?this.drawStickerToExport(e,c,d,h,o):c.type==="image"?this.drawImageToExport(e,c,d,h,o):this.drawAnnotationToExport(e,c,d,h,o)),e.restore()}),this.state.frame!=="none")if(this.state.frame==="polaroid"){const c=t/1.1,d=c*.05,h=c*.05;e.translate(d,h),this.drawFrameToExport(e,this.state.frame,c,i-h-c*.1),e.translate(-d,-h)}else this.drawFrameToExport(e,this.state.frame,t,i)}drawStickerToExport(e,t,i,o,n){const l=t.opacity||1,r=t.flipX||!1,c=t.flipY||!1;if(e.save(),e.globalAlpha=l,e.translate(i,o),e.rotate(t.rotation*Math.PI/180),e.scale(r?-1:1,c?-1:1),t.type==="emoji")e.font=`${t.size*n}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText(t.content,0,0);else if(t.type==="image"&&t.image){const d=t.size*n;e.drawImage(t.image,-d/2,-d/2,d,d)}e.restore()}drawImageToExport(e,t,i,o,n){const l=t.opacity||1,r=t.flipX||!1,c=t.flipY||!1;e.save(),e.globalAlpha=l,e.translate(i,o),e.rotate(t.rotation*Math.PI/180),e.scale(r?-1:1,c?-1:1);const d=t.width*n,h=t.height*n;e.drawImage(t.image,-d/2,-h/2,d,h),e.restore()}drawAnnotationToExport(e,t,i,o,n){const l=t.strokeColor||t.color,r=t.fillColor||(t.type==="text"?t.color:"transparent");if(e.strokeStyle=l,e.fillStyle=t.type==="text"?t.color:r,e.lineWidth=t.strokeWidth*n,t.rotation)if(t.type==="text"){const c=(t.width||0)*n,d=(t.fontSize||24)*n,h=i+c/2,u=o-d/2;e.translate(h,u),e.rotate(t.rotation*Math.PI/180),e.translate(-h,-u)}else{const c=(t.width||0)*n,d=(t.height||0)*n,h=i+c/2,u=o+d/2;e.translate(h,u),e.rotate(t.rotation*Math.PI/180),e.translate(-h,-u)}switch(t.type){case"text":if(t.text&&t.fontSize){const c=t.fontSize*n,d=t.fontWeight||"normal",h=t.fontStyle||"normal";e.font=`${h} ${d} ${c}px Arial`,e.fillText(t.text,i,o)}break;case"rectangle":if(t.width&&t.height){const c=t.width*n,d=t.height*n;r&&r!=="transparent"&&e.fillRect(i,o,c,d),e.strokeRect(i,o,c,d)}break;case"ellipse":if(t.width&&t.height){const c=t.width*n,d=t.height*n;e.beginPath(),e.ellipse(i+c/2,o+d/2,Math.abs(c/2),Math.abs(d/2),0,0,2*Math.PI),r&&r!=="transparent"&&e.fill(),e.stroke()}break;case"line":t.width&&t.height&&(e.beginPath(),e.moveTo(i,o),e.lineTo(i+t.width*n,o+t.height*n),e.stroke());break;case"arrow":if(t.width&&t.height){const c=t.width*n,d=t.height*n,h=i+c,u=o+d,g=Math.max(8,t.strokeWidth*2)*n,p=Math.atan2(d,c);e.beginPath(),e.moveTo(i,o),e.lineTo(h,u),e.stroke(),e.beginPath(),e.moveTo(h-g*Math.cos(p+Math.PI/4),u-g*Math.sin(p+Math.PI/4)),e.lineTo(h,u),e.lineTo(h-g*Math.cos(p-Math.PI/4),u-g*Math.sin(p-Math.PI/4)),e.stroke()}break;case"sharpie":case"path":if(t.points&&t.points.length>1){e.beginPath();const c=t.points[0];if(c){e.moveTo((c.x-this.state.crop.x)*n,(c.y-this.state.crop.y)*n);for(let d=1;d<t.points.length;d++){const h=t.points[d];h&&e.lineTo((h.x-this.state.crop.x)*n,(h.y-this.state.crop.y)*n)}}e.stroke()}break}}drawFrameToExport(e,t,i,o){switch(e.save(),t){case"undefined":case"none":break;case"solidSharp":e.strokeStyle="#fff",e.lineWidth=Math.max(5,i*.01),e.strokeRect(0,0,i,o);break;case"solidRound":e.fillStyle="#fff";const n=Math.max(5,i*.01),l=i*.12;e.beginPath(),e.rect(-n,-n,i+2*n,o+2*n),e.roundRect(0,0,i,o,l),e.fill("evenodd");break;case"lineSingle":e.strokeStyle="#fff",e.lineWidth=Math.max(1,i*.002);const r=i*.05;e.strokeRect(r,r,i-2*r,o-2*r);break;case"lineMultiple":e.strokeStyle="#fff",e.lineWidth=Math.max(3,i*.006);const c=i*.075;e.strokeRect(c,c,i-2*c,o-2*c),e.strokeRect(c*.5,c*.5,i-c,o-c);break;case"edgeCross":e.strokeStyle="#fff",e.lineWidth=Math.max(1,i*.002);const d=i*.05;e.beginPath(),e.moveTo(0,d),e.lineTo(i,d),e.moveTo(0,o-d),e.lineTo(i,o-d),e.moveTo(d,0),e.lineTo(d,o),e.moveTo(i-d,0),e.lineTo(i-d,o),e.stroke();break;case"edgeOverlap":e.strokeStyle="#fff",e.lineWidth=Math.max(1,i*.002);const h=i*.075,u=i*.05;e.beginPath(),e.moveTo(u,h),e.lineTo(i-u,h),e.stroke(),e.beginPath(),e.moveTo(u,o-h),e.lineTo(i-u,o-h),e.stroke(),e.beginPath(),e.moveTo(h,u),e.lineTo(h,o-u),e.stroke(),e.beginPath(),e.moveTo(i-h,u),e.lineTo(i-h,o-u),e.stroke();break;case"edgeSeparate":e.strokeStyle="#fff",e.lineWidth=Math.max(1,i*.002);const g=i*.03125,p=i*.05;e.beginPath(),e.moveTo(p,g),e.lineTo(i-p,g),e.stroke(),e.beginPath(),e.moveTo(p,o-g),e.lineTo(i-p,o-g),e.stroke(),e.beginPath(),e.moveTo(g,p),e.lineTo(g,o-p),e.stroke(),e.beginPath(),e.moveTo(i-g,p),e.lineTo(i-g,o-p),e.stroke();break;case"hook":e.strokeStyle="#fff",e.lineWidth=Math.max(1,i*.002);const m=i*.075,f=i*.05;e.beginPath(),e.moveTo(f,f+m),e.lineTo(f,f),e.lineTo(f+m,f),e.stroke(),e.beginPath(),e.moveTo(i-f-m,f),e.lineTo(i-f,f),e.lineTo(i-f,f+m),e.stroke(),e.beginPath(),e.moveTo(f,o-f-m),e.lineTo(f,o-f),e.lineTo(f+m,o-f),e.stroke(),e.beginPath(),e.moveTo(i-f-m,o-f),e.lineTo(i-f,o-f),e.lineTo(i-f,o-f-m),e.stroke();break;case"polaroid":e.fillStyle="#fff";const k=i*.05,y=i*.05,v=i*.1;e.fillRect(-y,-k,i+2*y,k),e.fillRect(-y,-k,y,o+k+v),e.fillRect(i,-k,y,o+k+v),e.fillRect(-y,o,i+2*y,v);break}e.restore()}applyVignetteToExport(e,t,i,o){if(!t)return;const n=Math.sqrt((i/2)**2+(o/2)**2),l=n*.3,r=e.createRadialGradient(0,0,l,0,0,n),c=Math.abs(t)/100*.8;t>0?(r.addColorStop(0,"rgba(0, 0, 0, 0)"),r.addColorStop(.7,"rgba(0, 0, 0, 0)"),r.addColorStop(1,`rgba(0, 0, 0, ${c})`)):(r.addColorStop(0,`rgba(0, 0, 0, ${c})`),r.addColorStop(.7,"rgba(0, 0, 0, 0)"),r.addColorStop(1,"rgba(0, 0, 0, 0)")),e.save(),e.globalCompositeOperation="multiply",e.fillStyle=r,e.fillRect(-i/2,-o/2,i,o),e.restore()}getAllItems(){return[...this.state.stickers,...this.state.annotations,...this.state.images]}moveToFront(e){const t=Math.max(...this.getAllItems().map(i=>i.zIndex||0));this.updateItemZIndex(e,t+1)}moveToBack(e){const t=Math.min(...this.getAllItems().map(i=>i.zIndex||0));this.updateItemZIndex(e,t-1)}moveForward(e){const t=this.getAllItems(),i=t.find(l=>l.id===e);if(!i)return;const o=i.zIndex||0,n=t.filter(l=>(l.zIndex||0)>o).sort((l,r)=>(l.zIndex||0)-(r.zIndex||0))[0]?.zIndex;n!==void 0&&this.updateItemZIndex(e,n+1)}moveBackward(e){const t=this.getAllItems(),i=t.find(l=>l.id===e);if(!i)return;const o=i.zIndex||0,n=t.filter(l=>(l.zIndex||0)<o).sort((l,r)=>(r.zIndex||0)-(l.zIndex||0))[0]?.zIndex;n!==void 0&&this.updateItemZIndex(e,n-1)}updateItemZIndex(e,t){const i=o=>o.id===e?{...o,zIndex:t}:o;this.setState({stickers:this.state.stickers.map(i),annotations:this.state.annotations.map(i),images:this.state.images.map(i)})}recalculateImageDisplay(){this.canvas.parentElement&&(this.calculateImageDisplay(),this.render())}getMimeType(e){return{png:"image/png",jpg:"image/jpeg",webp:"image/webp",avif:"image/avif",heic:"image/heic"}[e]||"image/png"}destroy(){this.plugins.forEach(e=>e.destroy()),this.plugins.clear(),this.eventListeners.clear(),this.resizeObserver?.disconnect(),this.resizeObserver=null}applyCanvasTransformForItem(e){if(e.canvasRotation===void 0||e.canvasFlipX===void 0)return;const t=this.state.rotation-e.canvasRotation,i=this.state.flipX!==e.canvasFlipX,o=this.state.flipY!==(e.canvasFlipY||!1),n=this.state.scale-(e.canvasScale||1),l=this.state.skewX-(e.canvasSkewX||0),r=this.state.skewY-(e.canvasSkewY||0);if(!t&&!i&&!o&&!n&&!l&&!r)return;const c=this.imageDisplay.x+this.imageDisplay.width/2,d=this.imageDisplay.y+this.imageDisplay.height/2;if(this.ctx.translate(c,d),t&&this.ctx.rotate(t*Math.PI/180),n){const h=this.state.scale/(e.canvasScale||1);this.ctx.scale(h,h)}(l||r)&&this.ctx.transform(1,r,l,1,0,0),(i||o)&&this.ctx.scale(i?-1:1,o?-1:1),this.ctx.translate(-c,-d)}applyCanvasTransformForItemToExport(e,t,i,o){if(t.canvasRotation===void 0||t.canvasFlipX===void 0)return;const n=this.state.rotation-t.canvasRotation,l=this.state.flipX!==t.canvasFlipX,r=this.state.flipY!==(t.canvasFlipY||!1),c=this.state.scale-(t.canvasScale||1),d=this.state.skewX-(t.canvasSkewX||0),h=this.state.skewY-(t.canvasSkewY||0);if(!n&&!l&&!r&&!c&&!d&&!h)return;const u=i.x+i.width/2,g=i.y+i.height/2;if(e.translate(u,g),n&&e.rotate(n*Math.PI/180),c){const p=this.state.scale/(t.canvasScale||1);e.scale(p,p)}(d||h)&&e.transform(1,h,d,1,0,0),(l||r)&&e.scale(l?-1:1,r?-1:1),e.translate(-u,-g)}}const $={RGBA_BYTES_PER_PIXEL:4,DEFAULT_CHUNK_SIZE:1024,MAX_CANVAS_POOL_SIZE:10,CANVAS_RESET_SIZE:1,ASYNC_DELAY:0};class ie{static setLimits(e){this.limits={...this.limits,...e}}static checkImageSize(e,t){const i=e*t,o=i*$.RGBA_BYTES_PER_PIXEL;return i<=this.limits.maxCanvasSize&&o<=this.limits.maxImageSize}static calculateOptimalSize(e,t){const i=this.limits.maxCanvasSize,o=e*t;if(o<=i)return{width:e,height:t};const n=Math.sqrt(i/o);return{width:Math.floor(e*n),height:Math.floor(t*n)}}static async processLargeImage(e,t,i=$.DEFAULT_CHUNK_SIZE){const{width:o,height:n}=e,l=new ImageData(o,n);for(let r=0;r<n;r+=i)for(let c=0;c<o;c+=i){const d=Math.min(i,o-c),h=Math.min(i,n-r),u=this.extractChunk(e,c,r,d,h),g=t(u);this.insertChunk(l,g,c,r),await new Promise(p=>setTimeout(p,$.ASYNC_DELAY))}return l}static extractChunk(e,t,i,o,n){const l=new ImageData(o,n),r=e.data,c=l.data;for(let d=0;d<n;d++)for(let h=0;h<o;h++){const u=((i+d)*e.width+(t+h))*4,g=(d*o+h)*4;c[g]=r[u]??0,c[g+1]=r[u+1]??0,c[g+2]=r[u+2]??0,c[g+3]=r[u+3]??255}return l}static insertChunk(e,t,i,o){const n=e.data,l=t.data;for(let r=0;r<t.height;r++)for(let c=0;c<t.width;c++){const d=((o+r)*e.width+(i+c))*4,h=(r*t.width+c)*4;n[d]=l[h]??0,n[d+1]=l[h+1]??0,n[d+2]=l[h+2]??0,n[d+3]=l[h+3]??255}}static getCanvas(e,t){const i=this.canvasPool.pop()||document.createElement("canvas");i.width=e,i.height=t;const o=e*t*$.RGBA_BYTES_PER_PIXEL;return this.memoryUsage+=o,i}static releaseCanvas(e){const t=e.width*e.height*$.RGBA_BYTES_PER_PIXEL;this.memoryUsage-=t,this.canvasPool.length<$.MAX_CANVAS_POOL_SIZE&&(e.width=$.CANVAS_RESET_SIZE,e.height=$.CANVAS_RESET_SIZE,this.canvasPool.push(e))}static getMemoryUsage(){return this.memoryUsage}static isMemoryAvailable(e){return this.memoryUsage+e<=this.limits.maxMemoryUsage}static cleanup(){this.canvasPool.forEach(e=>{e.width=$.CANVAS_RESET_SIZE,e.height=$.CANVAS_RESET_SIZE}),this.canvasPool=[],this.memoryUsage=0}}ie.limits={maxCanvasSize:16777216,maxImageSize:50*1024*1024,maxMemoryUsage:200*1024*1024},ie.memoryUsage=0,ie.canvasPool=[];const L=a=>Math.max(0,Math.min(255,a)),J=(a,e)=>{for(let t=0;t<a.length;t+=4){const[i,o,n,l]=e(a[t]??0,a[t+1]??0,a[t+2]??0,a[t+3]??255,t);a[t]=L(i),a[t+1]=L(o),a[t+2]=L(n),a[t+3]=l}},Fi=(a,e,t,i,o)=>{const n=new Uint8ClampedArray(a),l=Math.floor(o/2);for(let r=0;r<t;r++)for(let c=0;c<e;c++){let d=0,h=0,u=0;for(let p=0;p<o;p++)for(let m=0;m<o;m++){const f=Math.min(t-1,Math.max(0,r+p-l)),k=Math.min(e-1,Math.max(0,c+m-l)),y=(f*e+k)*4,v=i[p*o+m]??0;d+=(n[y]??0)*v,h+=(n[y+1]??0)*v,u+=(n[y+2]??0)*v}const g=(r*e+c)*4;a[g]=L(d),a[g+1]=L(h),a[g+2]=L(u)}};class We{constructor(){this.name="advancedFilter",this.canvas=null,this.ctx=null}init(e,t){this.canvas=e,this.ctx=t}async applyAdvancedFilter(e,t,i={}){return ie.checkImageSize(e.width,e.height)?this.applyFilterDirect(e,t,i):this.applyFilterChunked(e,t,i)}async applyFilterChunked(e,t,i){return ie.processLargeImage(e,o=>this.applyFilterDirect(o,t,i),512)}applyFilterDirect(e,t,i){const o=new Uint8ClampedArray(e.data),{width:n,height:l}=e;switch(t){case"blur":this.applyGaussianBlur(o,n,l,i.radius||5);break;case"sharpen":this.applySharpen(o,n,l,i.intensity||1);break;case"emboss":this.applyEmboss(o,n,l);break;case"edge":this.applyEdgeDetection(o,n,l);break;case"oil":this.applyOilPainting(o,n,l,i.radius||3);break;case"vintage":this.applyVintage(o);break;case"cross-process":this.applyCrossProcess(o);break;case"lomo":this.applyLomo(o,n,l);break;default:return e}return new ImageData(o,n,l)}applyGaussianBlur(e,t,i,o){const n=this.createGaussianKernel(o);this.applyHorizontalBlur(e,t,i,n),this.applyVerticalBlur(e,t,i,n)}applyHorizontalBlur(e,t,i,o){const n=new Uint8ClampedArray(e),l=Math.floor(o.length/2);for(let r=0;r<i;r++)for(let c=0;c<t;c++){let d=0,h=0,u=0;for(let p=0;p<o.length;p++){const m=Math.min(t-1,Math.max(0,c+p-l)),f=(r*t+m)*4,k=o[p]??0;d+=(n[f]??0)*k,h+=(n[f+1]??0)*k,u+=(n[f+2]??0)*k}const g=(r*t+c)*4;e[g]=L(d),e[g+1]=L(h),e[g+2]=L(u)}}applyVerticalBlur(e,t,i,o){const n=new Uint8ClampedArray(e),l=Math.floor(o.length/2);for(let r=0;r<i;r++)for(let c=0;c<t;c++){let d=0,h=0,u=0;for(let p=0;p<o.length;p++){const m=(Math.min(i-1,Math.max(0,r+p-l))*t+c)*4,f=o[p]??0;d+=(n[m]??0)*f,h+=(n[m+1]??0)*f,u+=(n[m+2]??0)*f}const g=(r*t+c)*4;e[g]=L(d),e[g+1]=L(h),e[g+2]=L(u)}}applySharpen(e,t,i,o){const n=[0,-o,0,-o,1+4*o,-o,0,-o,0];this.applyConvolution(e,t,i,n,3)}applyEmboss(e,t,i){const o=[-2,-1,0,-1,1,1,0,1,2];this.applyConvolution(e,t,i,o,3)}applyEdgeDetection(e,t,i){const o=[-1,-1,-1,-1,8,-1,-1,-1,-1];this.applyConvolution(e,t,i,o,3)}applyOilPainting(e,t,i,o){const n=new Uint8ClampedArray(e);for(let l=0;l<i;l++)for(let r=0;r<t;r++){const c=new Array(256).fill(0),d=new Array(256).fill(0),h=new Array(256).fill(0),u=new Array(256).fill(0);for(let f=-o;f<=o;f++)for(let k=-o;k<=o;k++){const y=Math.max(0,Math.min(t-1,r+k)),v=(Math.max(0,Math.min(i-1,l+f))*t+y)*4,x=n[v]??0,_=n[v+1]??0,b=n[v+2]??0,C=Math.floor((x+_+b)/3);c[C]++,d[C]+=x,h[C]+=_,u[C]+=b}let g=0,p=0;for(let f=0;f<256;f++)c[f]>g&&(g=c[f],p=f);const m=(l*t+r)*4;e[m]=d[p]/g,e[m+1]=h[p]/g,e[m+2]=u[p]/g}}applyVintage(e){J(e,(t,i,o,n)=>[t*.9+i*.5+o*.1,t*.3+i*.8+o*.1,t*.2+i*.3+o*.5,n])}applyCrossProcess(e){J(e,(t,i,o,n)=>{const l=t/255,r=i/255,c=o/255;return[(l*1.4-.2)*255,(r*1.2-.1)*255,(c*.8+.2)*255,n]})}applyLomo(e,t,i){const o=t/2,n=i/2,l=Math.sqrt(o*o+n*n);for(let r=0;r<i;r++)for(let c=0;c<t;c++){const d=1-Math.sqrt((c-o)**2+(r-n)**2)/l*.6,h=(r*t+c)*4;e[h]=Math.max(0,Math.min(255,(e[h]??0)*d*1.2)),e[h+1]=Math.max(0,Math.min(255,(e[h+1]??0)*d)),e[h+2]=Math.max(0,Math.min(255,(e[h+2]??0)*d*.8))}}createGaussianKernel(e){const t=e*2+1,i=new Array(t),o=e/3;let n=0;for(let l=0;l<t;l++){const r=l-e;i[l]=Math.exp(-(r*r)/(2*o*o)),n+=i[l]}for(let l=0;l<t;l++)i[l]/=n;return i}applyConvolution(e,t,i,o,n){Fi(e,t,i,o,n)}initialize(e){}destroy(){this.canvas=null,this.ctx=null}}const fe=(a,e)=>{const t=e.getBoundingClientRect(),i=a.clientX-t.left,o=a.clientY-t.top;return{x:i/t.width*e.width,y:o/t.height*e.height}},Ri=(a,e)=>a.x>=e.x&&a.x<=e.x+e.width&&a.y>=e.y&&a.y<=e.y+e.height,ye=()=>Math.random().toString(36).substring(2,9);class Xe{constructor(){this.name="annotate",this.isDrawing=!1,this.currentAnnotation=null,this.canvasScale=1}initialize(e){this.editor=e}setAnnotationCompleteCallback(e){this.onAnnotationComplete=e}setCanvasScale(e){this.canvasScale=e}handleMouseDown(e,t,i){const o=this.editor.canvas;if(!o)return;const{x:n,y:l}=fe(e,o),r=this.editor.getImageDisplay();Ri({x:n,y:l},r)&&(this.isDrawing=!0,this.currentAnnotation={opacity:1,flipX:!1,flipY:!1,rotation:0,id:ye(),type:t,x:t==="text"?r.x+r.width/2:n,y:t==="text"?r.y+r.height/2:l,width:0,height:0,color:i.color||"#ff0000",strokeWidth:i.strokeWidth||2,fontSize:i.fontSize||24,text:i.text||(t==="text"?"Text":void 0),points:t==="sharpie"?[{x:n,y:l}]:void 0,zIndex:Date.now(),fillColor:i.fillColor||(t!=="line"&&t!=="sharpie"&&t!=="path"&&t!=="text"?"transparent":void 0),strokeColor:i.strokeColor||i.color||"#ff0000"})}handleMouseMove(e){if(!this.isDrawing||!this.currentAnnotation)return;const t=this.editor.canvas;if(!t)return;const{x:i,y:o}=fe(e,t);this.currentAnnotation.type==="sharpie"?this.currentAnnotation.points?.push({x:i,y:o}):this.currentAnnotation.type!=="text"&&(this.currentAnnotation.width=i-this.currentAnnotation.x,this.currentAnnotation.height=o-this.currentAnnotation.y),this.editor.render()}handleMouseUp(){if(this.currentAnnotation&&this.isDrawing){const e=[...this.editor.getState().annotations];let t=!1;this.currentAnnotation.type==="sharpie"&&this.currentAnnotation.points&&this.currentAnnotation.points.length>1?(e.push(this.currentAnnotation),this.editor.setState({annotations:e}),t=!0):this.currentAnnotation.type!=="sharpie"&&(Math.abs(this.currentAnnotation.width||0)>5||Math.abs(this.currentAnnotation.height||0)>5)?(e.push(this.currentAnnotation),this.editor.setState({annotations:e}),t=!0):this.currentAnnotation.type==="text"&&(e.push(this.currentAnnotation),this.editor.setState({annotations:e}),t=!0),t&&this.onAnnotationComplete&&this.onAnnotationComplete(this.currentAnnotation)}this.isDrawing=!1,this.currentAnnotation=null}render(e){this.currentAnnotation&&this.renderAnnotation(e,this.currentAnnotation)}renderAnnotation(e,t){e.save();const i=t.strokeColor||t.color,o=t.fillColor||(t.type==="text"?t.color:"transparent");switch(e.strokeStyle=i,e.fillStyle=t.type==="text"?t.color:o,e.lineWidth=t.strokeWidth,t.type){case"rectangle":if(t.width&&t.height){const n=t.fillColor;n&&n!=="transparent"&&(e.fillStyle=n,e.fillRect(t.x,t.y,t.width,t.height)),e.strokeRect(t.x,t.y,t.width,t.height)}break;case"ellipse":if(t.width&&t.height){e.beginPath(),e.ellipse(t.x+t.width/2,t.y+t.height/2,Math.abs(t.width/2),Math.abs(t.height/2),0,0,2*Math.PI);const n=t.fillColor;n&&n!=="transparent"&&(e.fillStyle=n,e.fill()),e.stroke()}break;case"line":t.width&&t.height&&(e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.x+t.width,t.y+t.height),e.stroke());break;case"arrow":t.width&&t.height&&this.drawArrow(e,t.x,t.y,t.x+t.width,t.y+t.height,t.strokeWidth);break;case"text":if(t.text&&t.fontSize){const n=t.fontWeight||"normal",l=t.fontStyle||"normal";e.font=`${l} ${n} ${t.fontSize}px Arial`;const r=e.measureText(t.text).width,c=Math.max(1,t.fontSize/16);if(t.textDecoration==="underline"){const d=e.lineWidth;e.lineWidth=c,e.beginPath(),e.moveTo(t.x,t.y+2),e.lineTo(t.x+r,t.y+2),e.stroke(),e.lineWidth=d}else if(t.textDecoration==="line-through"){const d=e.lineWidth;e.lineWidth=c,e.beginPath(),e.moveTo(t.x,t.y-t.fontSize/3),e.lineTo(t.x+r,t.y-t.fontSize/3),e.stroke(),e.lineWidth=d}e.fillText(t.text,t.x,t.y)}break;case"sharpie":if(t.points&&t.points.length>1){e.beginPath(),e.moveTo(t.points[0]?.x??0,t.points[0]?.y??0);for(let n=1;n<t.points.length;n++)e.lineTo(t.points[n]?.x??0,t.points[n]?.y??0);e.stroke()}break}e.restore()}drawArrow(e,t,i,o,n,l=2){const r=Math.max(10,l*3),c=Math.atan2(n-i,o-t),d=o-r*.7*Math.cos(c),h=n-r*.7*Math.sin(c);e.beginPath(),e.moveTo(t,i),e.lineTo(d,h),e.stroke(),e.beginPath(),e.moveTo(o,n),e.lineTo(o-r*Math.cos(c-Math.PI/4),n-r*Math.sin(c-Math.PI/4)),e.lineTo(o-r*Math.cos(c+Math.PI/4),n-r*Math.sin(c+Math.PI/4)),e.closePath(),e.fill()}updateAnnotations(e){}destroy(){this.editor=null,this.currentAnnotation=null}}const H={MIN_CROP_SIZE:50,HANDLE_SIZE:12,GRID_LINES:3,STROKE_WIDTH:2,OVERLAY_ALPHA:.6};class Ye{constructor(){this.name="crop",this.isDragging=!1,this.dragMode="none",this.dragStart={x:0,y:0},this.initialCrop={x:0,y:0,width:0,height:0},this.initialAspectRatio=1,this._isActive=!1,this.isShiftPressed=!1}initialize(e){this.editor=e,document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this))}setActive(e){this._isActive=e}get isActive(){return this._isActive}getTransformedBounds(e){const t=this.editor.getState(),i=this.editor.getImageDisplay(),o=(t.rotation||0)*Math.PI/180,n=t.scale||1,l=t.skewX||0,r=t.skewY||0,c=Math.abs(Math.cos(o)),d=Math.abs(Math.sin(o)),h=i.width*n,u=i.height*n,g=Math.abs(l)*u,p=Math.abs(r)*h,m=(h+g)*c+(u+p)*d,f=(u+p)*c+(h+g)*d,k=i.x+i.width/2,y=i.y+i.height/2;return{x:Math.max(0,Math.min(e.width-m,k-m/2)),y:Math.max(0,Math.min(e.height-f,y-f/2)),width:Math.min(m,e.width),height:Math.min(f,e.height)}}render(e){this._isActive&&this.editor.getState().crop&&this.drawCropOverlay(e)}drawCropOverlay(e){const t=e.canvas,i=this.editor.getState(),{crop:o}=i;e.save();const n=this.getTransformedBounds(t),l=Math.max(n.x,Math.min(o.x,n.x+n.width-H.MIN_CROP_SIZE)),r=Math.max(n.y,Math.min(o.y,n.y+n.height-H.MIN_CROP_SIZE)),c=Math.min(o.width,n.x+n.width-l),d=Math.min(o.height,n.y+n.height-r);e.fillStyle=`rgba(0, 0, 0, ${H.OVERLAY_ALPHA})`,e.beginPath(),e.rect(0,0,t.width,t.height),e.rect(l+c,r,-c,d),e.fill("evenodd"),e.strokeStyle="#ffffffd0",e.lineWidth=H.STROKE_WIDTH,e.strokeRect(l,r,c,d),e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=1;for(let u=1;u<H.GRID_LINES;u++){const g=l+c/3*u,p=r+d/3*u;e.beginPath(),e.moveTo(g,r),e.lineTo(g,r+d),e.moveTo(l,p),e.lineTo(l+c,p),e.stroke()}const h=H.HANDLE_SIZE;e.fillStyle="#fff",e.strokeStyle="#007bff",e.lineWidth=H.STROKE_WIDTH,[{x:l,y:r,cursor:"nw-resize"},{x:l+c,y:r,cursor:"ne-resize"},{x:l+c,y:r+d,cursor:"se-resize"},{x:l,y:r+d,cursor:"sw-resize"},{x:l+c/2,y:r,cursor:"n-resize"},{x:l+c,y:r+d/2,cursor:"e-resize"},{x:l+c/2,y:r+d,cursor:"s-resize"},{x:l,y:r+d/2,cursor:"w-resize"}].forEach(u=>{e.fillRect(u.x-h/2,u.y-h/2,h,h),e.strokeRect(u.x-h/2,u.y-h/2,h,h)}),e.restore()}handleMouseDown(e){const t=this.editor.canvas,i=fe(e,t),o=i.x,n=i.y;this.dragStart={x:o,y:n},this.isDragging=!0;const l=this.editor.getState(),{crop:r}=l;this.initialCrop={...r},this.initialAspectRatio=r.width/r.height;const c=H.HANDLE_SIZE,d=[{x:r.x,y:r.y,mode:"tl"},{x:r.x+r.width,y:r.y,mode:"tr"},{x:r.x+r.width,y:r.y+r.height,mode:"br"},{x:r.x,y:r.y+r.height,mode:"bl"},{x:r.x+r.width/2,y:r.y,mode:"t"},{x:r.x+r.width,y:r.y+r.height/2,mode:"r"},{x:r.x+r.width/2,y:r.y+r.height,mode:"b"},{x:r.x,y:r.y+r.height/2,mode:"l"}];let h=!1;for(const u of d)if(Math.abs(o-u.x)<c&&Math.abs(n-u.y)<c){this.dragMode=u.mode,h=!0;break}if(!h){const u=this.getTransformedBounds(t);if(o>=r.x&&o<=r.x+r.width&&n>=r.y&&n<=r.y+r.height)this.dragMode="move";else if(o>=u.x&&o<=u.x+u.width&&n>=u.y&&n<=u.y+u.height)this.dragMode="resize";else{this.isDragging=!1;return}}}handleMouseMove(e){if(!this.isDragging)return;const t=this.editor.canvas,i=fe(e,t),o=i.x,n=i.y,l=H.MIN_CROP_SIZE,r=this.getTransformedBounds(t);let c={...this.initialCrop};switch(this.dragMode){case"move":const d=o-this.dragStart.x,h=n-this.dragStart.y;c.x=Math.max(r.x,Math.min(r.x+r.width-c.width,this.initialCrop.x+d)),c.y=Math.max(r.y,Math.min(r.y+r.height-c.height,this.initialCrop.y+h));break;case"resize":const u=Math.min(this.dragStart.x,o),g=Math.min(this.dragStart.y,n),p=Math.max(this.dragStart.x,o),m=Math.max(this.dragStart.y,n);c={x:Math.max(r.x,u),y:Math.max(r.y,g),width:Math.min(r.x+r.width-u,p-u),height:Math.min(r.y+r.height-g,m-g)};break;case"tl":const f=this.initialCrop.x+this.initialCrop.width,k=this.initialCrop.y+this.initialCrop.height;if(this.isShiftPressed){const C=o-this.dragStart.x,j=n-this.dragStart.y,S=Math.min(Math.abs(C),Math.abs(j))*(C<0&&j<0?1:-1);c.x=Math.max(r.x,Math.min(this.initialCrop.x+S,f-l)),c.y=Math.max(r.y,Math.min(this.initialCrop.y+S/this.initialAspectRatio,k-l)),c.width=f-c.x,c.height=k-c.y}else c.x=Math.max(r.x,Math.min(o,f-l)),c.y=Math.max(r.y,Math.min(n,k-l)),c.width=f-c.x,c.height=k-c.y;break;case"tr":const y=this.initialCrop.x,v=this.initialCrop.y+this.initialCrop.height;if(this.isShiftPressed){const C=o-this.dragStart.x,j=n-this.dragStart.y,S=Math.min(Math.abs(C),Math.abs(j))*(C>0&&j<0?1:-1);c.x=y,c.y=Math.max(r.y,Math.min(this.initialCrop.y-S/this.initialAspectRatio,v-l)),c.width=Math.min(r.x+r.width-y,Math.max(l,this.initialCrop.width+S)),c.height=v-c.y}else c.x=y,c.y=Math.max(r.y,Math.min(n,v-l)),c.width=Math.min(r.x+r.width-y,Math.max(l,o-y)),c.height=v-c.y;break;case"br":if(this.isShiftPressed){const C=o-this.dragStart.x,j=n-this.dragStart.y,S=Math.min(Math.abs(C),Math.abs(j))*(C>0&&j>0?1:-1);c.width=Math.min(r.x+r.width-this.initialCrop.x,Math.max(l,this.initialCrop.width+S)),c.height=Math.min(r.y+r.height-this.initialCrop.y,Math.max(l,this.initialCrop.height+S/this.initialAspectRatio))}else c.width=Math.min(r.x+r.width-this.initialCrop.x,Math.max(l,o-this.initialCrop.x)),c.height=Math.min(r.y+r.height-this.initialCrop.y,Math.max(l,n-this.initialCrop.y));break;case"bl":const x=this.initialCrop.x+this.initialCrop.width;if(this.isShiftPressed){const C=o-this.dragStart.x,j=n-this.dragStart.y,S=Math.min(Math.abs(C),Math.abs(j))*(C<0&&j>0?1:-1);c.x=Math.max(r.x,Math.min(this.initialCrop.x-S,x-l)),c.width=x-c.x,c.height=Math.min(r.y+r.height-this.initialCrop.y,Math.max(l,this.initialCrop.height+S/this.initialAspectRatio))}else c.x=Math.max(r.x,Math.min(o,x-l)),c.width=x-c.x,c.height=Math.min(r.y+r.height-this.initialCrop.y,Math.max(l,n-this.initialCrop.y));break;case"t":const _=this.initialCrop.y+this.initialCrop.height;c.y=Math.max(r.y,Math.min(n,_-l)),c.height=_-c.y;break;case"r":c.width=Math.min(r.x+r.width-this.initialCrop.x,Math.max(l,o-this.initialCrop.x));break;case"b":c.height=Math.min(r.y+r.height-this.initialCrop.y,Math.max(l,n-this.initialCrop.y));break;case"l":const b=this.initialCrop.x+this.initialCrop.width;c.x=Math.max(r.x,Math.min(o,b-l)),c.width=b-c.x;break}this.editor.setState({crop:c})}handleMouseUp(){this.isDragging=!1,this.dragMode="none"}handleKeyDown(e){e.key==="Shift"&&(this.isShiftPressed=!0)}handleKeyUp(e){e.key==="Shift"&&(this.isShiftPressed=!1)}destroy(){document.removeEventListener("keydown",this.handleKeyDown.bind(this)),document.removeEventListener("keyup",this.handleKeyUp.bind(this))}}const Ai=(a,e)=>{for(let t=0;t<a.length;t+=4){const[i,o,n,l]=e(a[t]??0,a[t+1]??0,a[t+2]??0,a[t+3]??255);a[t]=Math.max(0,Math.min(255,i)),a[t+1]=Math.max(0,Math.min(255,o)),a[t+2]=Math.max(0,Math.min(255,n)),a[t+3]=l}},zi={chrome:(a,e,t,i)=>[a*1.2,e*1.1,t*.9,i],fade:(a,e,t,i)=>[a+30,e+30,t+30,i],cold:(a,e,t,i)=>[a-20,e,t+20,i],warm:(a,e,t,i)=>[a+20,e+10,t-20,i],mono:(a,e,t,i)=>{const o=a*.299+e*.587+t*.114;return[o,o,o,i]},sepia:(a,e,t,i)=>[a*.393+e*.769+t*.189,a*.349+e*.686+t*.168,a*.272+e*.534+t*.131,i]},Di=(a,e)=>{const t=new Uint8ClampedArray(a.data),i=zi[e];return i&&Ai(t,i),new ImageData(t,a.width,a.height)};class Ge{constructor(){this.name="filter",this.canvas=null,this.ctx=null}init(e,t){this.canvas=e,this.ctx=t}applyFilter(e,t){const i={monoDefault:"mono",sepiaDefault:"sepia"}[t]||t;return Di(e,i)}initialize(e){}destroy(){this.canvas=null,this.ctx=null}}class Ve{constructor(){this.name="finetune",this.canvas=null,this.ctx=null}init(e,t){this.canvas=e,this.ctx=t}applyAdjustments(e,t){const i=new Uint8ClampedArray(e.data),o=e.width,n=e.height;return t.brightness!==void 0&&t.brightness!==0&&this.applyBrightness(i,t.brightness),t.contrast!==void 0&&t.contrast!==0&&this.applyContrast(i,t.contrast),t.saturation!==void 0&&t.saturation!==0&&this.applySaturation(i,t.saturation),t.exposure!==void 0&&t.exposure!==0&&this.applyExposure(i,t.exposure),t.gamma!==void 0&&t.gamma!==0&&this.applyGamma(i,t.gamma),t.vignette!==void 0&&t.vignette!==0&&this.applyVignette(i,o,n,t.vignette),new ImageData(i,o,n)}applyBrightness(e,t){const i=t*2.55;J(e,(o,n,l,r)=>[o+i,n+i,l+i,r])}applyContrast(e,t){const i=259*(t+255)/(255*(259-t));J(e,(o,n,l,r)=>[i*(o-128)+128,i*(n-128)+128,i*(l-128)+128,r])}applySaturation(e,t){const i=(t+100)/100;J(e,(o,n,l,r)=>{const c=.299*o+.587*n+.114*l;return[c+i*(o-c),c+i*(n-c),c+i*(l-c),r]})}applyExposure(e,t){const i=Math.pow(2,t/100);J(e,(o,n,l,r)=>[o*i,n*i,l*i,r])}applyGamma(e,t){const i=1/(1+t/100);J(e,(o,n,l,r)=>[255*Math.pow(o/255,i),255*Math.pow(n/255,i),255*Math.pow(l/255,i),r])}applyVignette(e,t,i,o){const n=t/2,l=i/2,r=Math.sqrt(n*n+l*l),c=o/100;J(e,(d,h,u,g,p)=>{const m=p/4,f=m%t,k=Math.floor(m/t),y=1-Math.sqrt((f-n)**2+(k-l)**2)/r*c;return[d*y,h*y,u*y,g]})}initialize(e){}destroy(){this.canvas=null,this.ctx=null}}class Pi{constructor(){this.name="htmlSelection",this.selectedItem=null,this.isDragging=!1,this.isResizing=!1,this.isRotating=!1,this.dragOffset={x:0,y:0},this.resizeHandle="",this.rotateStartAngle=0,this.isSelectMode=!1,this.overlayContainer=null,this.manipulators=[],this.canvasScale=1,this.isBoxSelecting=!1,this.boxSelectStart={x:0,y:0},this.boxSelectEnd={x:0,y:0},this.selectionBox=null,this.selectedItems=[],this.isShiftPressed=!1,this.initialAspectRatio=1,this.handleKeyDown=e=>{e.key==="Shift"&&(this.isShiftPressed=!0)},this.handleKeyUp=e=>{e.key==="Shift"&&(this.isShiftPressed=!1)},this.handleGlobalMouseMove=e=>{if(console.log("handleGlobalMouseMove",e.type,this.isResizing,this.isRotating),!this.selectedItem||!this.isResizing&&!this.isRotating)return;const t=this.editor.canvas;if(!t)return;const i=t.getBoundingClientRect(),o=t.width,n=t.height;let l,r;"touches"in e&&e.touches.length>0?(l=e.touches[0]?.clientX||0,r=e.touches[0]?.clientY||0):(l=e.clientX,r=e.clientY);const c=l-i.left,d=r-i.top,h=c/i.width*o,u=d/i.height*n;if(this.isResizing)this.resizeItem(this.selectedItem,h,u,this.resizeHandle,this.isShiftPressed),this.updateManipulatorPositions();else if(this.isRotating){const{x:g,y:p}=this.getItemCenter(this.selectedItem),m=g/o*i.width+i.left,f=p/n*i.height+i.top,k=Math.atan2(r-f,l-m);let y=(k-this.rotateStartAngle)*180/Math.PI;y>180&&(y-=360),y<-180&&(y+=360),this.selectedItem.rotation=(this.selectedItem.rotation||0)+y,this.rotateStartAngle=k,this.updateManipulatorPositions()}this.updateItemInState(this.selectedItem),this.editor.render()},this.handleGlobalMouseUp=()=>{if(console.log("handleGlobalMouseUp",this.isResizing,this.isRotating),this.isResizing||this.isRotating){const e=this.editor.getState();this.editor.setState({stickers:e.stickers,annotations:e.annotations,images:e.images}),this.selectedItem&&this.showManipulators(this.selectedItem)}this.isResizing=!1,this.isRotating=!1,this.resizeHandle="",this.removeGlobalListeners()},this.handleGlobalTouchMove=e=>{console.log("handleGlobalTouchMove",e.touches.length,this.isResizing,this.isRotating),e.preventDefault(),e.stopPropagation(),e.touches.length>0&&(this.isResizing||this.isRotating)&&this.handleGlobalMouseMove(e)},this.handleGlobalTouchEnd=e=>{console.log("handleGlobalTouchEnd"),e.preventDefault(),e.stopPropagation(),this.handleGlobalMouseUp()}}initialize(e){this.editor=e,this.createOverlay(),this.addKeyboardListeners()}setSelectMode(e){this.isSelectMode=e,e||this.hideManipulators()}selectItem(e){this.selectedItem=e,this.selectedItems=[e],this.showManipulators(e),this.onSelectionChange&&this.onSelectionChange(!0)}setSelectionChangeCallback(e){this.onSelectionChange=e}setCanvasScale(e){this.canvasScale=e,this.selectedItem&&this.isSelectMode&&this.showManipulators(this.selectedItem)}clearSelection(){this.selectedItem=null,this.selectedItems=[],this.hideManipulators(),this.hideSelectionBox(),this.onSelectionChange&&this.onSelectionChange(!1)}createOverlay(){const e=this.editor.canvas;e&&(this.overlayContainer=document.createElement("div"),this.overlayContainer.className="dk-img-editor-selection-overlay",this.overlayContainer.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    `,e.parentElement?.appendChild(this.overlayContainer))}createManipulator(e,t,i,o,n){const l=document.createElement("div");l.className="dk-img-editor-manipulator",l.dataset.control=e,n&&(l.dataset.handle=n);const r="ontouchstart"in window,c=e==="rotate"?r?32:16:r?24:12,d=e==="rotate"?0:2;l.style.cssText=`
      position: absolute;
      width: ${c}px;
      height: ${c}px;
      background: ${e==="rotate"?"transparent":"#007bff"};
      border: ${e==="rotate"?"none":`${d}px solid #ffffffd0`};
      border-radius: ${e==="rotate"?"0":"2px"};
      cursor: ${t};
      pointer-events: auto;
      transform: translate(-50%, -50%);
      left: ${i}px;
      top: ${o}px;
      z-index: 11;
      color: #007bff;
      box-sizing: border-box;
    `;const h=u=>{u.stopPropagation(),u.preventDefault(),console.log("handleStart",e,n,u.type),e==="rotate"?this.startRotation(u):n&&this.startResize(u,n)};return l.addEventListener("mousedown",h),l.addEventListener("touchstart",h,{passive:!1}),l}showManipulators(e){if(this.hideManipulators(),!this.overlayContainer||!this.isSelectMode)return;const t=this.editor.canvas,i=t.width,o=t.height,n=t.getBoundingClientRect(),l=t.parentElement.getBoundingClientRect();this.overlayContainer.style.transform="none",this.overlayContainer.style.transformOrigin="initial";const r=n.width/i,c=n.height/o,d=t.parentElement,h=n.left-l.left+d.scrollLeft,u=n.top-l.top+d.scrollTop,g=this.getItemBounds(e),{left:p,top:m,right:f,bottom:k}=g,y=(p+f)/2,v=(m+k)/2,x=document.createElement("div");x.className="dk-img-editor-selection-box";const _=e.rotation||0,b="center",C=g.left*r+h,j=g.top*c+u,S=(g.right-g.left)*r,I=(g.bottom-g.top)*c,M=2;x.style.cssText=`
      position: absolute;
      left: ${C}px;
      top: ${j}px;
      width: ${S}px;
      height: ${I}px;
      border: ${M}px dashed #ffffffd0;
      pointer-events: none;
      z-index: 10;
      transform-origin: ${b};
      transform: rotate(${_}deg);
    `,this.manipulators.push(x),this.overlayContainer.appendChild(x),[{x:p,y:m,cursor:"nw-resize",handle:"tl"},{x:f,y:m,cursor:"ne-resize",handle:"tr"},{x:f,y:k,cursor:"se-resize",handle:"br"},{x:p,y:k,cursor:"sw-resize",handle:"bl"}].forEach(Y=>{const{x:ee,y:oe}=this.transformPoint(Y.x,Y.y,y,v,_,r,c,h,u),se=this.createManipulator("point",Y.cursor,ee,oe,Y.handle);this.manipulators.push(se),this.overlayContainer.appendChild(se)});const E=f+25,T=m,{x:A,y:X}=this.transformPoint(E,T,y,v,_,r,c,h,u),P=this.createManipulator("rotate","grab",A,X);P.innerHTML=`
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M1 4v6h6" stroke="#ffffffd0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M3.51 15a9 9 0 102.13-9.36L1 10" stroke="#ffffffd0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `,this.manipulators.push(P),this.overlayContainer.appendChild(P)}hideManipulators(){this.manipulators.forEach(e=>e.remove()),this.manipulators=[]}updateManipulatorPositions(){if(!this.selectedItem||!this.overlayContainer||this.manipulators.length===0)return;const e=this.editor.canvas,t=e.getBoundingClientRect(),i=e.parentElement.getBoundingClientRect(),o=t.width/e.width,n=t.height/e.height,l=e.parentElement,r=t.left-i.left+l.scrollLeft,c=t.top-i.top+l.scrollTop,d=this.getItemBounds(this.selectedItem),{left:h,top:u,right:g,bottom:p}=d,m=(h+g)/2,f=(u+p)/2,k=this.selectedItem.rotation||0,y=this.manipulators[0];if(y&&y.className==="dk-img-editor-selection-box"){const x=d.left*o+r,_=d.top*n+c,b=(d.right-d.left)*o,C=(d.bottom-d.top)*n;y.style.left=`${x}px`,y.style.top=`${_}px`,y.style.width=`${b}px`,y.style.height=`${C}px`,y.style.transform=`rotate(${k}deg)`}[{x:h,y:u},{x:g,y:u},{x:g,y:p},{x:h,y:p}].forEach((x,_)=>{const b=this.manipulators[_+1];if(b&&b.dataset.control==="point"){const{x:C,y:j}=this.transformPoint(x.x,x.y,m,f,k,o,n,r,c);b.style.left=`${C}px`,b.style.top=`${j}px`}});const v=this.manipulators[5];if(v&&v.dataset.control==="rotate"){const x=g+25,_=u,{x:b,y:C}=this.transformPoint(x,_,m,f,k,o,n,r,c);v.style.left=`${b}px`,v.style.top=`${C}px`}}startResize(e,t){if(this.isResizing=!0,this.resizeHandle=t,this.selectedItem){const i=this.getItemBounds(this.selectedItem),o=i.right-i.left,n=i.bottom-i.top;this.initialAspectRatio=o/n}e.preventDefault(),this.addGlobalListeners()}startRotation(e){if(!this.selectedItem)return;this.isRotating=!0;const t=this.editor.canvas,i=t.getBoundingClientRect(),{x:o,y:n}=this.getItemCenter(this.selectedItem),l=o/t.width*i.width+i.left,r=n/t.height*i.height+i.top;let c,d;"touches"in e&&e.touches.length>0?(c=e.touches[0]?.clientX||0,d=e.touches[0]?.clientY||0):(c=e.clientX,d=e.clientY),this.rotateStartAngle=Math.atan2(d-r,c-l),e.preventDefault(),this.addGlobalListeners()}addGlobalListeners(){console.log("addGlobalListeners called"),document.addEventListener("mousemove",this.handleGlobalMouseMove),document.addEventListener("mouseup",this.handleGlobalMouseUp),document.addEventListener("touchmove",this.handleGlobalTouchMove,{passive:!1}),document.addEventListener("touchend",this.handleGlobalTouchEnd),document.addEventListener("touchcancel",this.handleGlobalTouchEnd)}removeGlobalListeners(){console.log("removeGlobalListeners called"),document.removeEventListener("mousemove",this.handleGlobalMouseMove),document.removeEventListener("mouseup",this.handleGlobalMouseUp),document.removeEventListener("touchmove",this.handleGlobalTouchMove),document.removeEventListener("touchend",this.handleGlobalTouchEnd),document.removeEventListener("touchcancel",this.handleGlobalTouchEnd)}addKeyboardListeners(){document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}handleMouseDown(e){const t=this.editor.canvas;if(!t)return;const i=t.getBoundingClientRect(),o=t.width,n=t.height,l=e.clientX-i.left,r=e.clientY-i.top,c=l/i.width*o,d=r/i.height*n,h=this.editor.getState(),u=[...h.stickers||[],...h.annotations||[],...h.images||[]];let g=null;for(let p=u.length-1;p>=0;p--)if(this.isPointInItem(c,d,u[p])){g=u[p];break}g?(this.selectedItems.some(p=>p.id===g.id)||(this.selectedItem=g,this.selectedItems=[g],this.showManipulators(g)),this.onSelectionChange&&this.onSelectionChange(!0),this.isSelectMode&&!this.isResizing&&!this.isRotating&&(this.isDragging=!0,this.dragOffset={x:c-g.x,y:d-g.y})):(this.hideSelectionBox(),this.isSelectMode&&(this.isBoxSelecting=!0,this.boxSelectStart={x:c,y:d},this.boxSelectEnd={x:c,y:d},this.showSelectionBox()),this.selectedItem=null,this.selectedItems=[],this.hideManipulators(),this.onSelectionChange&&this.onSelectionChange(!1))}handleMouseMove(e){const t=this.editor.canvas;if(!t)return;const i=t.getBoundingClientRect(),o=t.width,n=t.height,l=e.clientX-i.left,r=e.clientY-i.top,c=l/i.width*o,d=r/i.height*n;if(this.isBoxSelecting){this.boxSelectEnd={x:c,y:d},this.updateSelectionBox();return}if(!(!this.selectedItem||!this.isSelectMode)){if(this.isDragging)if(this.selectedItems.length>1){const h=c-this.dragOffset.x,u=d-this.dragOffset.y,g=h-this.selectedItem.x,p=u-this.selectedItem.y;this.selectedItems.forEach(m=>{m.type==="sharpie"&&m.points&&(m.points=m.points.map(f=>({x:f.x+g,y:f.y+p}))),m.x+=g,m.y+=p}),this.hideManipulators(),this.showMultiSelectionBorders()}else this.moveItem(this.selectedItem,c-this.dragOffset.x,d-this.dragOffset.y),this.showManipulators(this.selectedItem);else if(this.isResizing)this.resizeItem(this.selectedItem,c,d,this.resizeHandle),this.showManipulators(this.selectedItem);else if(this.isRotating){const{x:h,y:u}=this.getItemCenter(this.selectedItem),g=Math.atan2(d-u,c-h);let p=(g-this.rotateStartAngle)*180/Math.PI;p>180&&(p-=360),p<-180&&(p+=360),this.selectedItem.rotation=(this.selectedItem.rotation||0)+p,this.rotateStartAngle=g,this.showManipulators(this.selectedItem)}(this.isDragging||this.isResizing||this.isRotating)&&(this.updateItemInState(this.selectedItem),this.editor.render())}}handleMouseUp(){if(this.isBoxSelecting){this.finishBoxSelection(),this.isBoxSelecting=!1,this.hideSelectionBox();return}if((this.isDragging||this.isResizing||this.isRotating)&&this.isSelectMode)if(this.selectedItems.length>1&&this.isDragging)this.updateMultipleItemsInState();else{const e=this.editor.getState();this.editor.setState({stickers:e.stickers,annotations:e.annotations,images:e.images})}this.isDragging=!1,this.isResizing=!1,this.isRotating=!1,this.resizeHandle=""}render(e){}deleteSelected(){if(this.selectedItems.length===0)return;const e=this.editor.getState(),t=new Set(this.selectedItems.map(l=>l.id)),i=e.stickers.filter(l=>!t.has(l.id)),o=e.images.filter(l=>!t.has(l.id)),n=e.annotations.filter(l=>!t.has(l.id));this.editor.setState({stickers:i,images:o,annotations:n}),this.selectedItem=null,this.selectedItems=[],this.hideManipulators(),this.onSelectionChange&&this.onSelectionChange(!1)}copySelected(){if(this.selectedItems.length===0)return;const e=this.editor.getState(),t=[],i=20;this.selectedItems.forEach(r=>{const c=Date.now().toString()+Math.random().toString(36).substr(2,9),d={...r,id:c,x:r.x+i,y:r.y+i,zIndex:(r.zIndex||0)+1};r.type==="sharpie"&&r.points&&(d.points=r.points.map(h=>({x:h.x+i,y:h.y+i}))),t.push(d)});const o=[...e.stickers],n=[...e.images],l=[...e.annotations];t.forEach(r=>{this.isSticker(r)?o.push(r):this.isImage(r)?n.push(r):l.push(r)}),this.editor.setState({stickers:o,images:n,annotations:l}),this.selectedItems=t,t.length===1?(this.selectedItem=t[0]??null,this.selectedItem&&this.showManipulators(this.selectedItem)):(this.selectedItem=t[0]??null,this.hideManipulators(),this.showMultiSelectionBorders())}isSticker(e){return"sticker"in e}isImage(e){return e.type==="image"}getItemCenter(e){return this.isSticker(e)?{x:e.x,y:e.y}:{x:e.x+(e.width||0)/2,y:e.y+(e.height||0)/2}}moveItem(e,t,i){if(e.type==="sharpie"&&e.points){const o=t-e.x,n=i-e.y;e.points=e.points.map(l=>({x:l.x+o,y:l.y+n}))}e.x=t,e.y=i}resizeItem(e,t,i,o,n=!1){if(this.isSticker(e)){const l=e.x,r=e.y;let c=Math.max(20,Math.min(200,Math.sqrt(Math.pow(t-l,2)+Math.pow(i-r,2))*2));e.size=c}else if(this.isImage(e)){const l=e.x,r=e.y,c=e.width/e.height,d=Math.sqrt(Math.pow(t-l,2)+Math.pow(i-r,2));e.width=Math.max(50,Math.min(6e3,d*2)),e.height=e.width/c}else if(e.type==="sharpie"&&e.points){const l=e.points,r=l.map(b=>b.x),c=l.map(b=>b.y),d=Math.min(...r),h=Math.max(...r),u=Math.min(...c),g=Math.max(...c),p=(d+h)/2,m=(u+g)/2,f=h-d,k=g-u;let y=f,v=k;switch(o){case"br":if(y=Math.max(20,t-d),v=Math.max(20,i-u),n){const b=Math.max(y/f,v/k);y=f*b,v=k*b}break;case"tr":if(y=Math.max(20,t-d),v=Math.max(20,g-i),n){const b=Math.max(y/f,v/k);y=f*b,v=k*b}break;case"bl":if(y=Math.max(20,h-t),v=Math.max(20,i-u),n){const b=Math.max(y/f,v/k);y=f*b,v=k*b}break;case"tl":if(y=Math.max(20,h-t),v=Math.max(20,g-i),n){const b=Math.max(y/f,v/k);y=f*b,v=k*b}break}const x=y/f,_=v/k;e.points=l.map(b=>({x:p+(b.x-p)*x,y:m+(b.y-m)*_})),e.x=p,e.y=m}else if(e.type==="text"){const l=e.width||100,r=e.fontSize||24;let c,d;switch(o){case"br":c=Math.max(50,t-e.x),d=Math.max(12,e.y-i);break;case"tr":c=Math.max(50,t-e.x),d=Math.max(12,r);break;case"bl":c=Math.max(50,l),d=Math.max(12,e.y-i);break;case"tl":c=Math.max(50,l),d=Math.max(12,r);break;default:c=l,d=r}const h=c/l,u=d/r,g=Math.max(h,u),p=Math.max(12,Math.min(72,(e.fontSize||24)*g));if(e.fontSize=p,e.text){const m=document.createElement("canvas").getContext("2d"),f=e.fontWeight||"normal",k=e.fontStyle||"normal";m.font=`${k} ${f} ${p}px Arial`,e.width=m.measureText(e.text).width,e.height=p}}else{const l=e.x,r=e.y,c=e.width||0,d=e.height||0;let h,u,g=l,p=r;switch(o){case"tl":h=l+c-t,u=r+d-i,g=t,p=i;break;case"tr":h=t-l,u=r+d-i,p=i;break;case"br":h=t-l,u=i-r;break;case"bl":h=l+c-t,u=i-r,g=t;break;default:h=c,u=d}if(n&&this.initialAspectRatio>0)switch(h/u>this.initialAspectRatio?h=u*this.initialAspectRatio:u=h/this.initialAspectRatio,o){case"tl":g=l+c-h,p=r+d-u;break;case"tr":p=r+d-u;break;case"bl":g=l+c-h;break}e.width=Math.max(20,h),e.height=Math.max(20,u),e.x=g,e.y=p}}updateItemInState(e){const t=this.editor.getState();if(this.isSticker(e)){const i=[...t.stickers],o=i.findIndex(n=>n.id===e.id);o!==-1&&(i[o]=e,this.editor.setState({stickers:i},!1))}else if(this.isImage(e)){const i=[...t.images],o=i.findIndex(n=>n.id===e.id);o!==-1&&(i[o]=e,this.editor.setState({images:i},!1))}else{const i=[...t.annotations],o=i.findIndex(n=>n.id===e.id);o!==-1&&(i[o]=e,this.editor.setState({annotations:i},!1))}}isPointInItem(e,t,i){if(this.isSticker(i)){const o=i.size/2;return e>=i.x-o&&e<=i.x+o&&t>=i.y-o&&t<=i.y+o}else if(this.isImage(i)){const o=i.width/2,n=i.height/2;return e>=i.x-o&&e<=i.x+o&&t>=i.y-n&&t<=i.y+n}else if(i.type==="text"){const o=this.getTextWidth(i),n=i.fontSize||24,l=i.x,r=i.x+o,c=i.y-n*.8,d=i.y+n*.2;if(i.rotation){const h=(l+r)/2,u=(c+d)/2,g=-i.rotation*Math.PI/180,p=e-h,m=t-u,f=p*Math.cos(g)-m*Math.sin(g)+h,k=p*Math.sin(g)+m*Math.cos(g)+u;return f>=l&&f<=r&&k>=c&&k<=d}else return e>=l&&e<=r&&t>=c&&t<=d}else if(i.type==="sharpie"&&i.points){const o=i.points,n=10;for(let l=0;l<o.length-1;l++){const r=o[l],c=o[l+1];if(this.pointToLineDistance(e,t,r.x,r.y,c.x,c.y)<=n)return!0}return!1}else{const o=Math.min(i.x,i.x+(i.width||0)),n=Math.max(i.x,i.x+(i.width||0)),l=Math.min(i.y,i.y+(i.height||0)),r=Math.max(i.y,i.y+(i.height||0));return e>=o&&e<=n&&t>=l&&t<=r}}refreshSelection(){this.selectedItem&&this.isSelectMode&&this.showManipulators(this.selectedItem)}showSelectionBox(){this.overlayContainer&&(this.selectionBox=document.createElement("div"),this.selectionBox.style.cssText=`
      position: absolute;
      border: 2px dashed #007bff;
      background: rgba(0, 123, 255, 0.1);
      pointer-events: none;
      z-index: 15;
    `,this.overlayContainer.appendChild(this.selectionBox))}updateSelectionBox(){if(!this.selectionBox||!this.overlayContainer)return;const e=this.editor.canvas,t=e.getBoundingClientRect(),i=e.parentElement.getBoundingClientRect(),o=t.width/e.width,n=t.height/e.height,l=t.left-i.left,r=t.top-i.top,c=Math.min(this.boxSelectStart.x,this.boxSelectEnd.x),d=Math.min(this.boxSelectStart.y,this.boxSelectEnd.y),h=Math.abs(this.boxSelectEnd.x-this.boxSelectStart.x),u=Math.abs(this.boxSelectEnd.y-this.boxSelectStart.y);this.selectionBox.style.left=`${c*o+l}px`,this.selectionBox.style.top=`${d*n+r}px`,this.selectionBox.style.width=`${h*o}px`,this.selectionBox.style.height=`${u*n}px`}hideSelectionBox(){this.selectionBox&&(this.selectionBox.remove(),this.selectionBox=null)}finishBoxSelection(){const e=Math.min(this.boxSelectStart.x,this.boxSelectEnd.x),t=Math.min(this.boxSelectStart.y,this.boxSelectEnd.y),i=Math.max(this.boxSelectStart.x,this.boxSelectEnd.x),o=Math.max(this.boxSelectStart.y,this.boxSelectEnd.y);if(i-e<5||o-t<5){this.clearSelection(),this.hideSelectionBox();return}const n=this.editor.getState(),l=[...n.stickers||[],...n.annotations||[],...n.images||[]];this.selectedItems=l.filter(r=>this.isItemInBox(r,e,t,i,o)),this.selectedItems.length>0?(this.selectedItems.length===1?(this.selectedItem=this.selectedItems[0]??null,this.selectedItem&&this.showManipulators(this.selectedItem)):(this.selectedItem=this.selectedItems[0]??null,this.hideManipulators(),this.showMultiSelectionBorders()),this.onSelectionChange&&this.onSelectionChange(!0)):(this.clearSelection(),this.hideSelectionBox())}getItemBounds(e){if(this.isSticker(e)){const t=e.size/2;return{left:e.x-t,top:e.y-t,right:e.x+t,bottom:e.y+t}}if(this.isImage(e)){const t=e.width/2,i=e.height/2;return{left:e.x-t,top:e.y-i,right:e.x+t,bottom:e.y+i}}if(e.type==="text"){const t=this.getTextWidth(e),i=e.fontSize||24;return{left:e.x,right:e.x+t,top:e.y-i*.8,bottom:e.y+i*.2}}if(e.type==="sharpie"&&e.points){const t=e.points,i=t.map(n=>n.x),o=t.map(n=>n.y);return{left:Math.min(...i),right:Math.max(...i),top:Math.min(...o),bottom:Math.max(...o)}}return{left:Math.min(e.x,e.x+(e.width||0)),right:Math.max(e.x,e.x+(e.width||0)),top:Math.min(e.y,e.y+(e.height||0)),bottom:Math.max(e.y,e.y+(e.height||0))}}showMultiSelectionBorders(){if(!this.overlayContainer||this.selectedItems.length===0)return;const e=this.editor.canvas,t=e.getBoundingClientRect(),i=e.parentElement.getBoundingClientRect(),o=t.width/e.width,n=t.height/e.height,l=t.left-i.left,r=t.top-i.top;this.selectedItems.forEach(c=>{const d=this.getItemBounds(c),h=this.createSelectionBorder(d,c.rotation||0,o,n,l,r);this.manipulators.push(h),this.overlayContainer?.appendChild(h)})}isItemInBox(e,t,i,o,n){const{left:l,top:r,right:c,bottom:d}=this.getItemBounds(e);return!(c<t||l>o||d<i||r>n)}updateMultipleItemsInState(){const e=this.editor.getState(),t=[...e.stickers],i=[...e.annotations],o=[...e.images];this.selectedItems.forEach(n=>{if(this.isSticker(n)){const l=t.findIndex(r=>r.id===n.id);l!==-1&&(t[l]=n)}else if(this.isImage(n)){const l=o.findIndex(r=>r.id===n.id);l!==-1&&(o[l]=n)}else{const l=i.findIndex(r=>r.id===n.id);l!==-1&&(i[l]=n)}}),this.editor.setState({stickers:t,annotations:i,images:o})}moveSelectedToFront(){if(this.selectedItems.length===0)return;const e=this.editor.getState(),t=[...e.stickers,...e.annotations,...e.images],i=Math.max(...t.map(o=>o.zIndex||0));this.selectedItems.forEach((o,n)=>{o.zIndex=i+n+1}),this.updateMultipleItemsInState(),this.editor.render()}moveSelectedToBack(){if(this.selectedItems.length===0)return;const e=this.editor.getState(),t=[...e.stickers,...e.annotations,...e.images],i=Math.min(...t.map(o=>o.zIndex||0));this.selectedItems.forEach((o,n)=>{o.zIndex=i-this.selectedItems.length+n}),this.updateMultipleItemsInState(),this.editor.render()}moveSelectedForward(){this.selectedItems.length!==0&&(this.selectedItems.forEach(e=>{e.zIndex=(e.zIndex||0)+1}),this.updateMultipleItemsInState(),this.editor.render())}moveSelectedBackward(){this.selectedItems.length!==0&&(this.selectedItems.forEach(e=>{e.zIndex=(e.zIndex||0)-1}),this.updateMultipleItemsInState(),this.editor.render())}isMultipleSelection(){return this.selectedItems.length>1}getSelectedCount(){return this.selectedItems.length}hasSelection(){return this.selectedItems.length>0}getSelectedItem(){return this.selectedItem}getSelectedItems(){return this.selectedItems}updateSelectedItemColors(e,t){this.selectedItems.length!==0&&(this.selectedItems.forEach(i=>{"color"in i&&(e!==void 0&&(i.type==="text"||(i.strokeColor=e),i.color=e),t!==void 0&&i.type!=="text"&&i.type!=="line"&&i.type!=="sharpie"&&i.type!=="path"&&(i.fillColor=t))}),this.updateMultipleItemsInState(),this.editor.render())}updateSelectedTextProperties(e){if(!(this.selectedItems.length===0||!this.selectedItem)){if(Object.assign(this.selectedItem,e),this.selectedItem.type==="text"&&e.text){const t=document.createElement("canvas").getContext("2d"),i=e.fontSize||24,o=e.fontWeight||"normal",n=e.fontStyle||"normal";t.font=`${n} ${o} ${i}px Arial`,this.selectedItem.width=t.measureText(e.text).width,this.selectedItem.height=i}this.updateItemInState(this.selectedItem),this.showManipulators(this.selectedItem),this.editor.render()}}updateSelectedItemStrokeWidth(e){this.selectedItems.length!==0&&(this.selectedItems.forEach(t=>{"strokeWidth"in t&&(t.strokeWidth=e)}),this.updateMultipleItemsInState(),this.editor.render())}updateSelectedItemOpacity(e){this.selectedItems.length!==0&&(this.selectedItems.forEach(t=>{t.opacity=e}),this.updateMultipleItemsInState(),this.editor.render())}flipSelectedItem(e){this.selectedItems.length!==0&&(this.selectedItems.forEach(t=>{e==="horizontal"?t.flipX=!t.flipX:t.flipY=!t.flipY}),this.updateMultipleItemsInState(),this.editor.render())}transformPoint(e,t,i,o,n,l,r,c,d){if(n===0)return{x:e*l+c,y:t*r+d};const h=n*Math.PI/180,u=e-i,g=t-o,p=i+u*Math.cos(h)-g*Math.sin(h),m=o+u*Math.sin(h)+g*Math.cos(h);return{x:p*l+c,y:m*r+d}}getTextWidth(e){let t=e.width;if(!t&&e.text){const i=document.createElement("canvas").getContext("2d"),o=e.fontSize||24,n=e.fontWeight||"normal",l=e.fontStyle||"normal";i.font=`${l} ${n} ${o}px Arial`,t=i.measureText(e.text).width}return t||100}createSelectionBorder(e,t,i,o,n,l){const r=document.createElement("div");r.className="dk-img-editor-multi-selection-border";const c=e.left*i+n,d=e.top*o+l,h=(e.right-e.left)*i,u=(e.bottom-e.top)*o;return r.style.cssText=`
      position: absolute;
      left: ${c}px;
      top: ${d}px;
      width: ${h}px;
      height: ${u}px;
      border: 2px dashed #007bff;
      pointer-events: none;
      z-index: 10;
      transform-origin: center;
      transform: rotate(${t}deg);
    `,r}pointToLineDistance(e,t,i,o,n,l){const r=e-i,c=t-o,d=n-i,h=l-o,u=r*d+c*h,g=d*d+h*h;let p=g===0?-1:u/g,m,f;p<0?(m=i,f=o):p>1?(m=n,f=l):(m=i+p*d,f=o+p*h);const k=e-m,y=t-f;return Math.sqrt(k*k+y*y)}destroy(){this.hideManipulators(),this.hideSelectionBox(),this.removeGlobalListeners(),document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp),this.overlayContainer&&this.overlayContainer.remove(),this.editor=null,this.selectedItem=null,this.selectedItems=[]}}class Ni{constructor(){this.name="image"}initialize(e){this.editor=e}setImageCompleteCallback(e){this.onImageComplete=e}async addImageFromFile(e){const t=new Image;console.log("file---",e),t.onload=()=>{const i=this.editor.getImageDisplay(),o=Math.min(200/t.width,200/t.height);console.log("imageDisplay",i),console.log("scale",o);const n={id:ye(),type:"image",x:i.x+i.width/2,y:i.y+i.height/2,width:t.width*o,height:t.height*o,rotation:0,zIndex:Date.now(),image:t},l=[...this.editor.getState().images||[],n];this.editor.setState({images:l}),this.onImageComplete&&this.onImageComplete(n)},t.onerror=i=>{console.error("Failed to load image",i)},t.src=typeof e=="string"?e:URL.createObjectURL(e)}async addImageFromClipboard(e){const t=Array.from(e.items).find(i=>i.type.startsWith("image/"));if(t){const i=t.getAsFile();i&&await this.addImageFromFile(i)}}handleMouseDown(e){}handleMouseMove(e){}handleMouseUp(){}render(e){}destroy(){this.editor=null}}class Ze{constructor(){this.name="sticker",this.canvasScale=1}initialize(e){this.editor=e}setCanvasScale(e){this.canvasScale=e}addSticker(e){const t=[...this.editor.getState().stickers,e];this.editor.setState({stickers:t})}handleMouseDown(e){}handleMouseMove(e){}handleMouseUp(){}render(e){}updateStickers(e){}deleteSelected(){}destroy(){this.editor=null}}const He={SRGB_TO_P3:{r:1.1,g:1.05,b:1.15},P3_TO_SRGB:{r:.9090909090909091,g:.9523809523809523,b:.8695652173913044}};class Fe{static async initialize(){this.supportedColorSpaces=await this.detectSupportedColorSpaces()}static async detectSupportedColorSpaces(){const e=["srgb"];if(typeof window<"u"){const t=document.createElement("canvas");t.width=1,t.height=1;try{const i=t.getContext("2d",{colorSpace:"display-p3"});i&&i.getContextAttributes?.()?.colorSpace==="display-p3"&&e.push("display-p3")}catch{}try{const i=t.getContext("2d",{colorSpace:"rec2020"});i&&i.getContextAttributes?.()?.colorSpace==="rec2020"&&e.push("rec2020")}catch{}}return e}static isSupported(e){return this.supportedColorSpaces.includes(e)}static getBestColorSpace(e="srgb"){return this.isSupported(e)?e:this.isSupported("display-p3")?"display-p3":"srgb"}static createCanvas(e,t,i="srgb"){const o=document.createElement("canvas");return o.width=e,o.height=t,o}static getContext(e,t="srgb"){const i=this.getBestColorSpace(t);return e.getContext("2d",{colorSpace:i,willReadFrequently:!0})}static convertColorSpace(e,t,i){if(t===i)return e;const o=new Uint8ClampedArray(e.data);if(t==="srgb"&&i==="display-p3"){const n=He.SRGB_TO_P3;for(let l=0;l<o.length;l+=4)o[l]=Math.min(255,(o[l]??0)*n.r),o[l+1]=Math.min(255,(o[l+1]??0)*n.g),o[l+2]=Math.min(255,(o[l+2]??0)*n.b)}else if(t==="display-p3"&&i==="srgb"){const n=He.P3_TO_SRGB;for(let l=0;l<o.length;l+=4)o[l]=Math.max(0,(o[l]??0)*n.r),o[l+1]=Math.max(0,(o[l+1]??0)*n.g),o[l+2]=Math.max(0,(o[l+2]??0)*n.b)}return new ImageData(o,e.width,e.height)}}Fe.supportedColorSpaces=[];const O={JPEG_MARKER:65496,EXIF_MARKER:65505,SOS_MARKER:65498,EXIF_SIGNATURE:1165519206,LITTLE_ENDIAN:18761,TIFF_MAGIC:42,ENTRY_SIZE:12,TAGS:{ORIENTATION:274,MAKE:271,MODEL:272,DATETIME:306}};class Ke{static async readExif(e){const t=await e.arrayBuffer(),i=new DataView(t);if(i.getUint16(0)!==O.JPEG_MARKER)return{};let o=2;for(;o<i.byteLength;){const n=i.getUint16(o);if(n===O.EXIF_MARKER){const l=i.getUint16(o+2),r=this.parseExifSegment(i,o+4,l-2);if(r)return r}if(n===O.SOS_MARKER)break;o+=2+i.getUint16(o+2)}return{}}static parseExifSegment(e,t,i){if(e.getUint32(t)!==O.EXIF_SIGNATURE)return null;t+=6;const o=e.getUint16(t)===O.LITTLE_ENDIAN;if(t+=2,e.getUint16(t,o)!==O.TIFF_MAGIC)return null;t+=2;const n=e.getUint32(t,o);return this.parseIFD(e,t+n,o)}static parseIFD(e,t,i){const o={},n=e.getUint16(t,i);t+=2;for(let l=0;l<n;l++){const r=e.getUint16(t,i);e.getUint16(t+2,i);const c=e.getUint32(t+4,i),d=e.getUint32(t+8,i);switch(r){case O.TAGS.ORIENTATION:o.orientation=e.getUint16(t+8,i);break;case O.TAGS.MAKE:o.make=this.readString(e,d,c);break;case O.TAGS.MODEL:o.model=this.readString(e,d,c);break;case O.TAGS.DATETIME:o.dateTime=this.readString(e,d,c);break}t+=O.ENTRY_SIZE}return o}static readString(e,t,i){let o="";for(let n=0;n<i-1;n++)o+=String.fromCharCode(e.getUint8(t+n));return o}static getOrientationTransform(e=1){return{1:"none",2:"scaleX(-1)",3:"rotate(180deg)",4:"scaleY(-1)",5:"rotate(90deg) scaleX(-1)",6:"rotate(90deg)",7:"rotate(-90deg) scaleX(-1)",8:"rotate(-90deg)"}[e]||"none"}}const Bi=({canvasRef:a,editorRef:e,cropPluginRef:t,filterPluginRef:i,annotatePluginRef:o,stickerPluginRef:n,finetunePluginRef:l,imagePluginRef:r,selectionPluginRef:c,advancedFilterPluginRef:d,src:h,zoomLevel:u,setEditorState:g,setHasSelection:p,onImageLoadStart:m,onImageLoadEnd:f})=>{const k=w.useCallback(async(y,v)=>{try{if(y instanceof File){const x=await Ke.readExif(y);console.log("EXIF data loaded for file:",y.name)}await v.loadImage(y),f?.()}catch(x){console.error("Failed to load image:",x),f?.()}},[f]);w.useEffect(()=>((async()=>{if(a.current&&!e.current){await Fe.initialize();const y=new $e(a.current),v=new Ye,x=new Ge,_=new Xe,b=new Ze,C=new Ve,j=new Ni,S=new Pi,I=new We;y.addPlugin(v),y.addPlugin(x),y.addPlugin(_),y.addPlugin(b),y.addPlugin(C),y.addPlugin(j),y.addPlugin(S),y.addPlugin(I),y.on("stateChange",M=>{g(M),M.stickers&&b.updateStickers(M.stickers),M.annotations&&_.updateAnnotations(M.annotations)}),e.current=y,t.current=v,i.current=x,o.current=_,n.current=b,l.current=C,r.current=j,c.current=S,d.current=I,_.setAnnotationCompleteCallback(M=>{if(c.current){c.current.setCanvasScale?.(u),c.current.setSelectMode(!0);const E={...M,zIndex:M.zIndex??Date.now()};c.current.selectItem(E),p(!0),e.current?.render()}}),S.setSelectionChangeCallback(M=>{p(M)}),j.setImageCompleteCallback(M=>{c.current&&(c.current.setCanvasScale?.(u),c.current.setSelectMode(!0),c.current.selectItem({...M,zIndex:M.zIndex||Date.now()}),p(!0),e.current?.render())}),v.setActive(!0),h&&await k(h,y)}})(),()=>{e.current&&e.current.destroy(),ie.cleanup()}),[]),w.useEffect(()=>{h&&e.current&&k(h,e.current)},[h])},W={PLACEHOLDER:"Double click to edit",FONT_SIZE:24,COLOR:"#000000",FONT_WEIGHT:"normal",FONT_STYLE:"normal",TEXT_DECORATION:"none",STROKE_WIDTH:0},Li=({canvasRef:a,activeTool:e,currentAnnotation:t,currentSticker:i,editorRef:o,cropPluginRef:n,annotatePluginRef:l,stickerPluginRef:r,selectionPluginRef:c,setHasSelection:d,setEditingText:h,setEditingValue:u,setEditingTextItem:g,setActiveTool:p})=>{const m=w.useCallback(x=>{if(!a.current)return{canvasX:0,canvasY:0};let _,b;"touches"in x&&x.touches.length>0?(_=x.touches[0]?.clientX||0,b=x.touches[0]?.clientY||0):"changedTouches"in x&&x.changedTouches.length>0?(_=x.changedTouches[0]?.clientX||0,b=x.changedTouches[0]?.clientY||0):(_=x.clientX||0,b=x.clientY||0);const C=fe({clientX:_,clientY:b},a.current);return{canvasX:C.x,canvasY:C.y}},[]),f=w.useCallback(x=>{if(!a.current)return;const{canvasX:_,canvasY:b}=m(x);let C,j;"touches"in x&&x.touches.length>0?(C=x.touches[0]?.clientX||0,j=x.touches[0]?.clientY||0):(C=x.clientX||0,j=x.clientY||0);const S={...x.nativeEvent,clientX:C,clientY:j,canvasX:_,canvasY:b};let I=!1;if((e==="annotate"||e==="sticker")&&c.current){const M=o.current?.getState(),E=[...M?.stickers||[],...M?.annotations||[],...M?.images||[]];for(let T=E.length-1;T>=0;T--)if(c.current.isPointInItem&&c.current.isPointInItem(_,b,E[T])){c.current.handleMouseDown(S),I=!0;break}}if(!I)switch(e){case"select":c.current?.handleMouseDown(S);break;case"crop":n.current?.handleMouseDown(S);break;case"annotate":if(t?.type==="text"){const M=document.createElement("canvas").getContext("2d");M.font=`${t.fontSize||W.FONT_SIZE}px Arial`;const E=M.measureText(W.PLACEHOLDER),T={id:ye(),type:"text",x:_,y:b,width:E.width,height:t.fontSize||W.FONT_SIZE,text:W.PLACEHOLDER,color:t.color||W.COLOR,strokeWidth:W.STROKE_WIDTH,fontSize:t.fontSize||W.FONT_SIZE,fontWeight:W.FONT_WEIGHT,fontStyle:W.FONT_STYLE,textDecoration:W.TEXT_DECORATION,zIndex:Date.now()},A=[...o.current?.getState()?.annotations||[],T];o.current?.setState({annotations:A}),c.current&&(c.current.setSelectMode(!0),c.current.selectItem(T),d(!0),o.current?.render())}else l.current?.handleMouseDown(S,t?.type||"rectangle",t||{});break;case"sticker":if(i&&r.current){const M={id:ye(),sticker:1,type:i.type,content:i.content,x:_,y:b,size:48,rotation:0,zIndex:Date.now()};if(i.type==="image"){const E=new Image;E.crossOrigin="anonymous",E.onload=()=>{M.image=E,r.current.addSticker(M),c.current&&(c.current.setSelectMode(!0),c.current.selectItem(M),d(!0),o.current?.render())},E.onerror=T=>{console.error("Failed to load image:",T,i.content)},E.src=i.content}else r.current.addSticker(M),c.current&&(c.current.setSelectMode(!0),c.current.selectItem(M),d(!0),o.current?.render())}break}},[e,t,i,m,r,c,d,o]),k=w.useCallback(x=>{if(!a.current)return;const{canvasX:_,canvasY:b}=m(x);let C,j;"touches"in x&&x.touches.length>0?(C=x.touches[0]?.clientX||0,j=x.touches[0]?.clientY||0):(C=x.clientX||0,j=x.clientY||0);const S={...x.nativeEvent,clientX:C,clientY:j,canvasX:_,canvasY:b};if((e==="annotate"||e==="sticker")&&c.current&&c.current.isDragging)c.current.handleMouseMove(S);else switch(e){case"select":c.current?.handleMouseMove(S);break;case"crop":n.current?.handleMouseMove(S);break;case"annotate":l.current?.handleMouseMove(S);break;case"sticker":r.current?.handleMouseMove(S);break}},[e,m]),y=w.useCallback(()=>{switch(c.current?.handleMouseUp(),e){case"crop":n.current?.handleMouseUp();break;case"annotate":l.current?.handleMouseUp();break;case"sticker":r.current?.handleMouseUp();break}},[e]),v=w.useCallback(x=>{if(!a.current||!c.current)return;const{canvasX:_,canvasY:b}=m(x);let C,j;"touches"in x&&x.touches.length>0?(C=x.touches[0]?.clientX||0,j=x.touches[0]?.clientY||0):(C=x.clientX||0,j=x.clientY||0);const S={...x.nativeEvent,clientX:C,clientY:j,canvasX:_,canvasY:b};c.current.handleMouseDown(S);const I=c.current.selectedItem;if(I)if(I.type==="text"){p("select"),h({id:I.id,x:I.x,y:I.y,rotation:I.rotation||0}),u(I.text||"");const M=o.current?.getState()?.annotations?.filter(E=>E.id!==I.id)||[];o.current?.setState({annotations:M}),c.current?.clearSelection(),g(I),d(!0),o.current?.render()}else p("select"),d(!0),o.current?.render()},[m,p,h,u,g,d]);return{handleCanvasMouseDown:f,handleCanvasMouseMove:k,handleCanvasMouseUp:y,handleCanvasDoubleClick:v,handleCanvasTouchStart:f,handleCanvasTouchMove:k,handleCanvasTouchEnd:y}},Oi=({onUndo:a,onRedo:e,selectionPluginRef:t,imagePluginRef:i,setHasSelection:o})=>{const n=w.useCallback(l=>{const r=l.clipboardData?.items;if(r){for(const c of Array.from(r))if(c.type.startsWith("image/")){const d=c.getAsFile();d&&i.current&&i.current.addImageFromFile(d);break}}},[i]);w.useEffect(()=>{const l=r=>{const c=document.activeElement,d=c&&(c.tagName==="INPUT"||c.tagName==="TEXTAREA"||c.contentEditable==="true");r.ctrlKey||r.metaKey?r.key==="z"&&!r.shiftKey?(r.preventDefault(),a()):r.key==="z"&&r.shiftKey||r.key==="y"?(r.preventDefault(),e()):r.key==="v"&&(r.preventDefault(),navigator.clipboard.read().then(h=>{for(const u of h)for(const g of u.types)if(g.startsWith("image/")){u.getType(g).then(p=>{const m=new File([p],"pasted-image.png",{type:g});i.current&&i.current.addImageFromFile(m)});return}}).catch(()=>{n(r)})):(r.key==="Delete"||r.key==="Backspace")&&!d&&(r.preventDefault(),t.current&&(t.current.deleteSelected(),o(!1)))};return document.addEventListener("keydown",l),()=>document.removeEventListener("keydown",l)},[a,e,n,t,i,o])},ke=(a,e,t)=>{if(a.width===e.width&&a.height===e.height&&a.x===e.x&&a.y===e.y)return t;const i=e.width/a.width,o=e.height/a.height,n=e.x-a.x*i,l=e.y-a.y*o;return t.map(r=>({...r,x:r.x*i+n,y:r.y*o+l,width:r.width?r.width*i:r.width,height:r.height?r.height*o:r.height,size:r.size?r.size*Math.min(i,o):r.size,fontSize:r.fontSize?r.fontSize*Math.min(i,o):r.fontSize}))},Ui=(a,e,t)=>{if(!t)return null;const i=e.width/a.width,o=e.height/a.height,n=e.x-a.x*i,l=e.y-a.y*o;return{...t,x:t.x*i+n,y:t.y*o+l}},$i=10,Wi=({activeTool:a,editingText:e,editingTextItem:t,editorRef:i,cropPluginRef:o,selectionPluginRef:n,updateTextEditing:l})=>{w.useEffect(()=>{if(!i.current)return;const r=i.current.getImageDisplay();o.current&&o.current.setActive(a==="crop"),n.current&&n.current.setSelectMode(a==="select"),setTimeout(()=>{if(i.current){const c=i.current.getImageDisplay(),d=i.current.getState(),h=ke(r,c,d.annotations||[]),u=ke(r,c,d.stickers||[]),g=ke(r,c,d.images||[]);i.current.setState({annotations:h,stickers:u,images:g},!1);const p=Ui(r,c,e);if(p&&l({editingText:p}),t){const m=ke(r,c,[t])[0];m&&l({editingTextItem:m})}if(n.current&&n.current.selectedItem){const m=n.current.selectedItem,f=ke(r,c,[m])[0];n.current.selectedItem=f}i.current.render()}},$i)},[a])},Xi=({utils:a,filterOptions:e,cropSelectPresetOptions:t})=>{const i=w.useMemo(()=>a.map(l=>({id:l,...Mt[l]})).filter(Boolean),[a]),o=w.useMemo(()=>[{id:"none",name:"Original"},...e.map(([l,r])=>({id:l,name:r}))],[e]),n=w.useMemo(()=>t.map(([l,r])=>({ratio:l,name:r})),[t]);return{tools:i,filters:o,cropPresets:n}},Yi=()=>{const{t:a}=D();return s.jsxs("div",{className:"dk-image-editor__loading",children:[s.jsx("div",{className:"dk-image-editor__loading-spinner"}),s.jsx("div",{className:"dk-image-editor__loading-text",children:a("loading.image")})]})},Gi=({message:a,duration:e=3e3,onClose:t})=>{const[i,o]=w.useState(!0),{t:n}=D();return w.useEffect(()=>{const l=setTimeout(()=>{o(!1),t&&t()},e);return()=>clearTimeout(l)},[e,t]),i?s.jsx("div",{className:"dk-image-editor__toast",children:s.jsx("div",{className:"dk-image-editor__toast-content",children:a})}):null};var Vi='.dk-image-editor canvas{image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges}.dk-image-editor{background:#4d4d4d;display:flex;flex-direction:column;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;height:100%;position:relative;width:100%}.dk-image-editor__header{align-items:center;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:8px;color:hsla(0,0%,100%,.816);display:flex;justify-content:space-between;left:50%;padding:.5rem;position:absolute;top:20px;transform:translateX(-50%);z-index:1000}.dk-image-editor__header-left,.dk-image-editor__header-right{align-items:center;display:flex;gap:.5rem}.dk-image-editor__action-btn,.dk-image-editor__confirm-btn,.dk-image-editor__save-btn{align-items:center;border:none;border-radius:4px;cursor:pointer;display:flex;font-size:1rem;font-size:14px;padding:4px 8px}.dk-image-editor__save-btn{margin-left:4px}.dk-image-editor__action-btn{background:transparent;color:hsla(0,0%,100%,.816)}.dk-image-editor__action-btn:hover{background:hsla(0,0%,100%,.1)}.dk-image-editor__save-btn{background:#007bff;color:hsla(0,0%,100%,.816)}.dk-image-editor__save-btn:hover{background:#0056b3}.dk-image-editor__export-group{align-items:center;display:flex;gap:.5rem}.dk-image-editor__format-select{background:rgba(0,0,0,.5);border:1px solid hsla(0,0%,100%,.2);border-radius:4px;color:hsla(0,0%,100%,.816);cursor:pointer;font-size:12px;padding:4px 2px}.dk-image-editor__format-select:focus{border-color:#007bff;outline:none}.dk-image-editor__format-select option{background:#333;color:hsla(0,0%,100%,.816)}.dk-image-editor__confirm-btn{background:#28a745;color:hsla(0,0%,100%,.816)}.dk-image-editor__confirm-btn:hover{background:#1e7e34}.dk-image-editor__output-size{align-items:center;display:flex;gap:4px;position:relative}.dk-image-editor__output-size input[type=number]{background:rgba(0,0,0,.5);border:1px solid hsla(0,0%,100%,.3);border-radius:4px;color:hsla(0,0%,100%,.816);font-size:12px;padding:4px 6px;text-align:center;width:60px}.dk-image-editor__output-size input[type=number]:focus{border-color:#007bff;outline:none}.dk-image-editor__output-size span{color:hsla(0,0%,100%,.8);font-size:12px}.dk-image-editor__lock-btn{align-items:center;background:transparent;border:1px solid hsla(0,0%,100%,.2);border-radius:4px;color:hsla(0,0%,100%,.7);cursor:pointer;display:flex;font-size:12px;height:28px;justify-content:center;padding:4px 6px;transition:all .2s}.dk-image-editor__lock-btn:hover{background:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.4);color:hsla(0,0%,100%,.816)}.dk-image-editor__lock-btn.locked{background:rgba(0,123,255,.2);border-color:#007bff;color:#007bff}.dk-image-editor__lock-btn.locked:hover{background:rgba(0,123,255,.3)}.dk-image-editor__main{display:flex;flex:1;overflow:auto;position:relative}.dk-image-editor__sidebar{backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);background:rgba(0,0,0,.3);border-radius:8px;display:flex;flex-direction:column;gap:.5rem;left:20px;max-height:70vh;overflow-y:auto;padding:1rem 0;position:absolute;top:50%;transform:translateY(-50%);width:80px;z-index:1000}.dk-image-editor__tool-btn{align-items:center;background:transparent;border:none;border-radius:4px;color:hsla(0,0%,100%,.7);cursor:pointer;display:flex;flex-direction:column;gap:.25rem;margin:0 .5rem;padding:.5rem;transition:all .2s}.dk-image-editor__tool-btn:hover{background:hsla(0,0%,100%,.1);color:hsla(0,0%,100%,.816)}.dk-image-editor__tool-btn--active{background:rgba(0,123,255,.2);color:#007bff}.dk-image-editor__tool-icon{font-size:1.5rem}.dk-image-editor__tool-name{font-size:.75rem;text-align:center}.dk-image-editor__canvas{background:#222;flex:1;min-height:0;overflow:auto;position:relative}.dk-image-editor__canvas,.dk-image-editor__loading{align-items:center;display:flex;justify-content:center}.dk-image-editor__loading{background:rgba(34,34,34,.9);bottom:0;flex-direction:column;gap:1rem;left:0;position:absolute;right:0;top:0;z-index:100}.dk-image-editor__loading-spinner{animation:spin 1s linear infinite;border:3px solid hsla(0,0%,100%,.3);border-radius:50%;border-top-color:#007bff;height:40px;width:40px}.dk-image-editor__loading-text{color:hsla(0,0%,100%,.816);font-size:14px;font-weight:500}.dk-image-editor__floating-toolbar{backdrop-filter:blur(10px);background:rgba(0,0,0,.5);border-radius:8px;display:flex;gap:8px;left:50%;padding:8px 12px;position:absolute;top:80px;transform:translateX(-50%);z-index:100}.dk-image-editor__floating-toolbar-group{align-items:center;display:flex;gap:8px}.dk-image-editor__v-divider{background:hsla(0,0%,100%,.3);height:24px;margin:0 4px;width:1px}.dk-image-editor__toolbar-button{align-items:center;background:hsla(0,0%,100%,.05);border:0;border-radius:4px;color:hsla(0,0%,100%,.816);cursor:pointer;display:flex;height:32px;justify-content:center;transition:all .2s;width:32px}.dk-image-editor__toolbar-button:hover{background:hsla(0,0%,100%,.1)}.dk-image-editor__image-canvas{border-radius:4px;cursor:default;display:block;height:80%;width:80%}.dk-image-editor__image-canvas--select{cursor:default}.dk-image-editor__image-canvas--annotate,.dk-image-editor__image-canvas--crop{cursor:crosshair}.dk-image-editor__image-canvas--sticker{cursor:copy}.dk-image-editor__image-canvas--resize{cursor:nw-resize}.dk-image-editor__image-canvas--move{cursor:move}.dk-image-editor__image-canvas--rotate{cursor:grab}.dk-image-editor__controls{backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);background:rgba(0,0,0,.3);border-radius:8px;bottom:20px;color:hsla(0,0%,100%,.816);left:50%;max-height:160px;max-width:80%;min-width:300px;overflow-y:auto;padding:1rem;position:absolute;transform:translateX(-50%);z-index:1000}.dk-image-editor__filter-btn,.dk-image-editor__preset-btn,.dk-image-editor__tool-button,.dk-image-editor__unified-button,.dk-image-editor__upload-button{align-items:center;background:hsla(0,0%,100%,.05);border:0;border-radius:4px;color:hsla(0,0%,100%,.816);cursor:pointer;display:flex;font-size:12px;font-weight:500;height:28px;justify-content:center;padding:0 12px;transition:all .2s;white-space:nowrap}.dk-image-editor__filter-btn:hover,.dk-image-editor__preset-btn:hover,.dk-image-editor__tool-button:hover,.dk-image-editor__unified-button:hover,.dk-image-editor__upload-button:hover{background:hsla(0,0%,100%,.1)}.dk-image-editor__unified-button--active{background:rgba(0,123,255,.3);border-color:#007bff;color:#007bff}.dk-image-editor__crop-controls{display:flex;flex-direction:column;gap:1rem}.dk-image-editor__presets{align-items:center;display:flex;flex-wrap:wrap;gap:8px}.dk-image-editor__size-inputs{align-items:center;display:flex;gap:4px;margin-left:12px;position:relative}.dk-image-editor__size-inputs input::-webkit-inner-spin-button,.dk-image-editor__size-inputs input::-webkit-outer-spin-button{-webkit-appearance:none!important}.dk-image-editor__size-inputs input[type=number]{-moz-appearance:textfield;background:transparent;border:1px solid hsla(0,0%,100%,.1);border-radius:4px;color:hsla(0,0%,100%,.816);font-size:12px;height:28px;padding:0 6px;text-align:center;transition:all .2s;width:60px}.dk-image-editor__size-inputs input[type=number]:focus{background:rgba(0,0,0,.7);border-color:#007bff;outline:none}.dk-image-editor__size-inputs input[type=number]::placeholder{color:hsla(0,0%,100%,.5)}.dk-image-editor__rotation-controls{display:flex;gap:1rem}.dk-image-editor__actions{display:flex;gap:.5rem}.dk-image-editor__actions button{align-items:center;background:hsla(0,0%,100%,.05);border:0;border-radius:4px;color:hsla(0,0%,100%,.816);cursor:pointer;display:flex;font-size:12px;height:28px;justify-content:center;padding:0 12px;transition:all .2s}.dk-image-editor__actions button:hover{background:hsla(0,0%,100%,.1)}.dk-image-editor__finetune-controls{display:flex;gap:1rem}.dk-image-editor__finetune-options{display:flex;gap:6px}.dk-image-editor__finetune-option{align-items:center;background:hsla(0,0%,100%,.05);border:0;border-radius:4px;color:hsla(0,0%,100%,.816);cursor:pointer;display:flex;font-size:10px;font-weight:500;height:32px;justify-content:center;transition:all .2s;width:32px}.dk-image-editor__finetune-option:hover{background:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.4)}.dk-image-editor__finetune-option--active{background:rgba(0,123,255,.3);border-color:#007bff;color:#007bff}.dk-image-editor__annotate-controls{display:flex;flex-direction:column;gap:1rem}.dk-image-editor__annotate-settings{align-items:center;display:flex;gap:1rem;justify-content:center}.dk-image-editor__clear-fill{align-items:center;background:hsla(0,0%,100%,.05);border:0;border-radius:2px;color:hsla(0,0%,100%,.816);cursor:pointer;display:flex;font-size:10px;height:20px;justify-content:center;transition:all .2s;width:20px}.dk-image-editor__clear-fill:hover{background:hsla(0,0%,100%,.1)}.dk-image-editor__color-box{align-items:center;display:flex;gap:8px}.dk-image-editor__color-box label{font-size:12px}.dk-image-editor__toolbar{display:flex;gap:.5rem}.dk-image-editor__tool-button{align-items:center;display:flex;gap:4px;justify-content:center}.dk-image-editor__tool-button.active{background:rgba(0,123,255,.3);border-color:#007bff;color:#007bff}.dk-image-editor__sticker-button{border-radius:4px;cursor:pointer;padding:2px 6px}.dk-image-editor__sticker-button img{height:32px;width:32px}.dk-image-editor__sticker-button span{font-size:24px}.dk-image-editor__fill-controls,.dk-image-editor__frame-controls,.dk-image-editor__image-controls,.dk-image-editor__resize-controls,.dk-image-editor__sticker-controls{display:flex;flex-direction:column;gap:1rem}.dk-image-editor__upload-button{align-items:center;align-self:stretch;border-radius:4px;cursor:pointer;display:flex;flex-direction:row;gap:4px;height:auto;justify-content:center;width:auto}.dk-image-editor__upload-icon{font-size:16px;font-weight:300;line-height:1}.dk-image-editor__upload-text{font-size:12px}.dk-image-editor .dk-img-editor-selection-box{border:2px dashed hsla(0,0%,100%,.816)!important;box-sizing:border-box!important;pointer-events:none!important;z-index:10!important}.dk-image-editor .dk-img-editor-manipulator{box-sizing:border-box!important;pointer-events:auto!important;z-index:11!important}.dk-image-editor .dk-img-editor-manipulator[data-control=point]{background:#007bff!important;border:2px solid hsla(0,0%,100%,.816)!important;border-radius:2px!important;height:12px!important;width:12px!important}.dk-image-editor .dk-img-editor-manipulator[data-control=rotate]{background:transparent!important;border:none!important;border-radius:0!important;height:16px!important;width:16px!important}.dk-image-editor__preset-select{background:hsla(0,0%,100%,.05);border:0;border-radius:4px;color:hsla(0,0%,100%,.816);font-size:12px;padding:0 4px}@media (max-width:768px){.dk-image-editor__main{flex-direction:column}.dk-image-editor__sticker-category{overflow:auto;width:100%}.dk-image-editor__sidebar{bottom:10px;flex-direction:row;height:auto;left:5%;overflow-x:auto;padding:12px;top:auto;transform:none;width:calc(90% - 24px)}.dk-image-editor__toolbar{flex-wrap:wrap;gap:8px;margin-top:12px}.dk-image-editor__annotate-controls{gap:0}.dk-image-editor__actions,.dk-image-editor__annotate-toolbar{justify-content:center}.dk-image-editor__finetune-options{flex-wrap:wrap}.dk-image-editor__filter-preview{border-radius:4px;padding:3px}.dk-image-editor__tool-name{font-size:10px}.dk-image-editor__tool-btn{margin:0 .25rem;min-width:60px;padding:2px}.dk-image-editor__controls{bottom:100px;font-size:10px;left:5%;max-height:120px;max-width:calc(90% - 24px);overflow-y:auto;padding:12px;transform:none;width:calc(90% - 24px)}.dk-image-editor__controls label{font-size:10px}.dk-image-editor__loading-spinner{height:30px;width:30px}.dk-image-editor__loading-text{font-size:12px}.dk-image-editor__actions button,.dk-image-editor__lock-btn,.dk-image-editor__preset-btn,.dk-image-editor__size-inputs input[type=number],.dk-image-editor__tool-button{height:24px;padding:0 8px}.dk-image-editor__filter-icon{height:28px;width:28px}.dk-image-editor__filter-name{font-size:10px}.dk-image-editor__filter-preview{border:0}.dk-image-editor__finetune-controls{flex-direction:column}.dk-image-editor__header-left,.dk-image-editor__header-right{gap:4px}.dk-image-editor__export-group{flex-direction:column;gap:4px}.dk-image-editor__format-select{display:none}.dk-image-editor__sticker-button img{height:24px;width:auto}.dk-image-editor__sticker-button span{font-size:medium}.dk-image-editor__floating-toolbar{background:transparent;border-bottom:1px solid hsla(0,0%,100%,.063);border-radius:0;flex-wrap:wrap;justify-content:center;width:calc(90% - 24px)}.dk-image-editor__v-divider{display:none}}.dk-image-editor .dk-image-editor__color-button{background:transparent;border:0}.dk-image-editor .dk-image-editor__color-button .dk-image-editor__color-picker{align-items:center;border:2px solid #fff;border-radius:50%;cursor:pointer;display:flex;flex-shrink:0;height:22px;overflow:hidden;transition:all .2s;width:22px}.dk-image-editor .dk-image-editor__color-button .dk-image-editor__color-picker input[type=color]{background:none;border:none;cursor:pointer;height:100%;transform:scale(3);transform-origin:center;width:100%}.dk-image-editor .dk-image-editor__color-button .dk-image-editor__color-picker input[type=color]:hover{border-color:hsla(0,0%,100%,.6);transform:scale(4)}.dk-image-editor .text-white{color:#fff}.dk-image-editor .d-flex{display:flex}.dk-image-editor .align-items-center{align-items:center}.dk-image-editor .justify-content-center{justify-content:center}.dk-image-editor .flex-shrink-0{flex-shrink:0}.dk-image-editor .gap-2{gap:12px}.dk-image-editor .mb-2{margin-bottom:12px}.dk-image-editor .ms-2{margin-left:12px}.dk-image-editor .gap-50{gap:4px}.dk-image-editor .css-loading{background-color:rgba(0,0,2,0);min-height:60px;position:relative}.dk-image-editor .css-loading:before{background:hsla(0,0%,100%,.251);bottom:0;content:"";left:0;position:absolute;right:0;top:0;z-index:1}.dk-image-editor .css-loading:after{animation:spin 1s linear infinite;border:3px solid #f0f4f7;border-radius:50%;border-top-color:#007bff;content:"";height:30px;left:calc(50% - 15px);position:absolute;top:calc(50% - 15px);width:30px;z-index:2}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.dk-image-editor .dk-confirm-overlay{align-items:center;background:rgba(0,0,0,.5);bottom:0;display:flex;justify-content:center;left:0;position:fixed;right:0;top:0;z-index:10000}.dk-image-editor .dk-confirm-dialog{background:rgba(0,0,0,.878);border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.3);margin-top:200px;max-width:400px;min-width:320px;padding:24px}.dk-image-editor .dk-confirm-title{color:#ddd;font-size:18px;font-weight:600;margin:0 0 12px}.dk-image-editor .dk-confirm-message{color:#ddd;line-height:1.5;margin:0 0 20px}.dk-image-editor .dk-confirm-actions{display:flex;gap:12px;justify-content:flex-end}.dk-image-editor .dk-confirm-cancel,.dk-image-editor .dk-confirm-confirm{border:none;border-radius:4px;cursor:pointer;font-size:14px;padding:8px 16px}.dk-image-editor .dk-confirm-cancel{background:transparent;border:1px solid hsla(0,0%,87%,.251);color:#ddd}.dk-image-editor .dk-confirm-cancel:hover{background:hsla(0,0%,87%,.502)}.dk-image-editor .dk-confirm-confirm{background:rgba(2,123,255,.502);color:hsla(0,0%,100%,.816)}.dk-image-editor .dk-confirm-confirm:hover{background:#027bff}.dk-image-editor .mobile-only{display:none}@media (max-width:768px){.dk-image-editor .desktop-only{display:none}.dk-image-editor .mobile-only{display:inline}}.dk-image-editor__toast{animation:dkToastFadeIn .3s ease-out;left:50%;position:fixed;top:50%;transform:translate(-50%,-50%);z-index:9999}.dk-image-editor__toast-content{backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);background:rgba(0,0,0,.8);border-radius:4px;box-shadow:0 4px 12px rgba(0,0,0,.3);color:hsla(0,0%,100%,.816);font-size:14px;padding:12px 24px}@keyframes dkToastFadeIn{0%{opacity:0;transform:translate(-50%,-50%) scale(.8)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}';be(Vi);const Zi=({src:a,onSave:e,onClose:t,onConfirm:i,className:o="",utils:n=["select","crop","filter","annotate","sticker","finetune","frame"],cropSelectPresetOptions:l=jt,annotateTools:r=It,filterOptions:c=Et,finetuneOptions:d=Tt,showCloseButton:h=!0,showConfirmButton:u=!1,showDownloadButton:g=!0})=>{const p=Le(),m=pe(),f=Oe(),k=ri(),{setEditorState:y,updateUIState:v,updateTextEditing:x,setImageLoading:_}=me(),{canvasRef:b}=de(),[C,j]=w.useState(null),{t:S}=D(),{activeTool:I,isVisible:M,hasSelection:E,selectedFinetuneOption:T,lastAnnotateColor:A,zoomLevel:X,currentAnnotation:P,currentSticker:Y}=m,{editingText:ee,editingValue:oe,editingTextItem:se}=f,{editorRef:R,cropPluginRef:K,filterPluginRef:he,annotatePluginRef:ne,stickerPluginRef:G,finetunePluginRef:ue,imagePluginRef:ge,selectionPluginRef:N,advancedFilterPluginRef:q,applyAdvancedFilter:ve}=Ti(),{tools:we,filters:qe,cropPresets:Qe}=Xi({utils:n,filterOptions:c,cropSelectPresetOptions:l}),_e=typeof a=="string"&&(a.startsWith("http://")||a.startsWith("https://"));w.useEffect(()=>{_e&&_(!0)},[a,_e,_]),Bi({canvasRef:b,editorRef:R,cropPluginRef:K,filterPluginRef:he,annotatePluginRef:ne,stickerPluginRef:G,finetunePluginRef:ue,imagePluginRef:ge,selectionPluginRef:N,advancedFilterPluginRef:q,src:a,zoomLevel:X,setEditorState:y,setHasSelection:F=>v({hasSelection:F}),onImageLoadStart:()=>_e&&_(!0),onImageLoadEnd:()=>_(!1)}),Wi({activeTool:I,editingText:ee,editingTextItem:se,editorRef:R,cropPluginRef:K,selectionPluginRef:N,updateTextEditing:x});const{handleCanvasMouseDown:Je,handleCanvasMouseMove:et,handleCanvasMouseUp:tt,handleCanvasDoubleClick:it,handleCanvasTouchStart:ot,handleCanvasTouchMove:st,handleCanvasTouchEnd:nt}=Li({canvasRef:b,activeTool:I,currentAnnotation:P,currentSticker:Y,editorRef:R,cropPluginRef:K,annotatePluginRef:ne,stickerPluginRef:G,selectionPluginRef:N,setHasSelection:F=>v({hasSelection:F}),setEditingText:F=>x({editingText:F}),setEditingValue:F=>x({editingValue:F}),setEditingTextItem:F=>x({editingTextItem:F}),setActiveTool:F=>v({activeTool:F})}),Re=w.useCallback(()=>R.current?.undo(),[]),Ae=w.useCallback(()=>R.current?.redo(),[]);Oi({onUndo:Re,onRedo:Ae,selectionPluginRef:N,imagePluginRef:ge,setHasSelection:F=>v({hasSelection:F})});const at=w.useCallback(F=>{if(!R.current)return;N.current?.clearSelection();const z={rotation:0,flipX:!1,flipY:!1,scale:1,skewX:0,skewY:0,brightness:0,contrast:0,saturation:0,exposure:0,gamma:0,vignette:0,filter:"none",appliedFilters:[],annotations:[],stickers:[],images:[],backgroundColor:"transparent",frame:"none",filterCounts:{}};R.current.setState(z,!1),y(z),v({activeTool:"select",hasSelection:!1,selectedFinetuneOption:"brightness",lastAnnotateColor:"#e53a3a",zoomLevel:1,currentAnnotation:null,currentSticker:null}),x({editingText:null,editingValue:"",editingTextItem:null}),K.current?.setActive?.(!1);const B=new FileReader;B.onload=V=>{V.target?.result&&R.current&&R.current.loadImage(V.target.result)},B.readAsDataURL(F)},[y,v,x,N,K,he,ne,G,ue,q]),rt=w.useCallback(async(F="png")=>{if(!(!R.current||!e||!p))try{const z=await R.current.export("blob",void 0,void 0,F),B=z.type==="image/png"&&F!=="png"?"png":F,V=new File([z],`edited-image.${B}`,{type:z.type}),Se=URL.createObjectURL(z);e({src:Se,dest:V,imageState:p})}catch(z){console.error("Export failed:",z)}},[e,p]),lt=w.useCallback(async()=>{if(R.current)try{const F=await R.current.export("blob");if(navigator.clipboard&&navigator.clipboard.write)await navigator.clipboard.write([new ClipboardItem({[F.type]:F})]),j(S("header.copy.success"));else{const z=await R.current.export("dataURL"),B=new Image;B.src=z,B.onload=()=>{const V=document.createElement("canvas");V.width=B.width,V.height=B.height,V.getContext("2d")?.drawImage(B,0,0),V.toBlob(Se=>{if(Se){const Ce=document.createElement("input");document.body.appendChild(Ce),Ce.select();const Me=event?.clipboardData||window.clipboardData;Me&&(Me.setData("text/html",`<img src="${z}">`),Me.setData("text/plain",z)),document.execCommand("copy"),document.body.removeChild(Ce),j(S("header.copy.success"))}},F.type)}}}catch(F){console.error("Copy failed:",F),j(S("header.copy.failed"))}},[]),ct=w.useCallback(async()=>{if(!(!R.current||!i||!b.current||!p))try{const F=await R.current.export("blob"),z=new File([F],"edited-image.png",{type:"image/png"}),B=URL.createObjectURL(F);i({src:B,dest:z,imageState:p,canvas:b.current})}catch(F){console.error("Confirm export failed:",F)}},[i,p]),dt=w.useCallback(F=>{R.current&&R.current.setState(F)},[]),ht=w.useCallback(()=>{v({isVisible:!1}),setTimeout(()=>t?.(),U.ANIMATION_DURATION)},[t,v]);return M?s.jsxs("div",{className:`dk-image-editor ${o}`,children:[s.jsx(Ii,{onClose:ht,onConfirm:ct,onUndo:Re,onRedo:Ae,onSave:rt,onUpload:at,onCopy:lt,showConfirmButton:u,showCloseButton:h,showDownloadButton:g}),s.jsxs("div",{className:"dk-image-editor__main",children:[s.jsx(Ei,{tools:we}),k&&s.jsx(Yi,{}),s.jsx(fi,{onMouseDown:Je,onMouseMove:et,onMouseUp:tt,onDoubleClick:it,onTouchStart:ot,onTouchMove:st,onTouchEnd:nt})]}),s.jsx(li,{cropPresets:Qe,filters:qe,annotateTools:r,finetuneOptions:d,onStateChange:dt,applyAdvancedFilter:ve}),s.jsxs("div",{style:{position:"absolute",color:"#ffffff30",right:"10px",bottom:"10px",fontSize:"12px"},children:["Power by"," ",s.jsx("a",{target:"_blank",href:"https://www.dkluge.com",style:{color:"#ffffff30"},children:"DKluge"})]}),C&&s.jsx(Gi,{message:C,onClose:()=>j(null)})]}):null},Hi=a=>s.jsx(Pe,{language:a.language||"en",translations:a.translations,children:s.jsx(ai,{children:s.jsx(Zi,{...a})})});class Ki{static async loadImageFromFile(e){return new Promise((t,i)=>{const o=new Image;o.onload=()=>t(o),o.onerror=i,o.src=URL.createObjectURL(e)})}static async getImageData(e){const t=document.createElement("canvas");t.width=e.width||e.naturalWidth,t.height=e.height||e.naturalHeight;const i=t.getContext("2d");return i.drawImage(e,0,0),i.getImageData(0,0,t.width,t.height)}static createCanvasFromImageData(e){const t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").putImageData(e,0,0),t}static async canvasToBlob(e,t="image/png",i=.9){return new Promise((o,n)=>{e.toBlob(l=>{l?o(l):n(new Error("Failed to create blob"))},t,i)})}}exports.AdvancedFilterPlugin=We,exports.AnnotatePlugin=Xe,exports.ColorSpaceManager=Fe,exports.CropPlugin=Ye,exports.DkImageEditor=Hi,exports.EditorCore=$e,exports.ExifProcessor=Ke,exports.FilterPlugin=Ge,exports.FinetunePlugin=Ve,exports.I18nProvider=Pe,exports.ImageProcessor=Ki,exports.MemoryManager=ie,exports.StickerPlugin=Ze,exports.defaultTranslations=re,exports.useTranslation=D;
//# sourceMappingURL=index.js.map
