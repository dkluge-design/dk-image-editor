"use strict";var n=require("react/jsx-runtime"),_=require("react");const Et={QUARTER_TURN:90,NEGATIVE_QUARTER_TURN:-90},et={FINETUNE:{min:-100,max:100},STROKE_WIDTH:{min:1,max:20},FONT_SIZE:{min:12,max:72}},bt={RENDER:10,FILTER_RESET:50},te=({size:r=16,color:t="currentColor"})=>n.jsxs("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",stroke:t,strokeWidth:"2",children:[n.jsx("rect",{x:"3",y:"11",width:"18",height:"11",rx:"2",ry:"2"}),n.jsx("circle",{cx:"12",cy:"16",r:"1"}),n.jsx("path",{d:"M7 11V7a5 5 0 0 1 10 0v4"})]}),ee=({size:r=16,color:t="currentColor"})=>n.jsxs("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",stroke:t,strokeWidth:"2",children:[n.jsx("rect",{x:"3",y:"11",width:"18",height:"11",rx:"2",ry:"2"}),n.jsx("circle",{cx:"12",cy:"16",r:"1"}),n.jsx("path",{d:"M7 11V7a5 5 0 0 1 9.9-1"})]});function yt(r){const t=r.size||r.width||20,e=r.size||r.height||20;return n.jsxs("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M3 12a9 9 0 019-9 9.75 9.75 0 016.74 2.74L21 8"}),n.jsx("path",{d:"M21 3v5h-5"}),n.jsx("path",{d:"M21 12a9 9 0 01-9 9 9.75 9.75 0 01-6.74-2.74L3 16"}),n.jsx("path",{d:"M3 21v-5h5"})]})}const ie={"header.upload":"Upload Image","header.undo":"Undo","header.redo":"Redo","header.download":"Download","header.confirm":"Confirm","header.close":"Close","header.zoom.in":"Zoom In","header.zoom.out":"Zoom Out","header.zoom.reset":"Reset Zoom","header.close.confirm":"Are you sure you want to close? Any unsaved changes will be lost.","tool.select":"Select","tool.crop":"Crop","tool.filter":"Filter","tool.annotate":"Annotate","tool.sticker":"Sticker","tool.finetune":"Finetune","tool.frame":"Frame","crop.original":"Original","crop.lock.ratio":"Lock Aspect Ratio","crop.unlock.ratio":"Unlock Aspect Ratio","crop.rotation":"Rotation","crop.scale":"Scale","crop.skew":"Skew","crop.reset":"Reset All Adjustments","finetune.brightness":"Brightness","finetune.contrast":"Contrast","finetune.saturation":"Saturation","finetune.exposure":"Exposure","finetune.gamma":"Gamma","finetune.vignette":"Vignette","finetune.reset":"Reset All Finetune Settings","annotate.sharpie":"Sharpie","annotate.draw":"Draw","annotate.line":"Line","annotate.arrow":"Arrow","annotate.rectangle":"Rectangle","annotate.ellipse":"Ellipse","annotate.text":"Text","annotate.color":"Color","annotate.stroke":"Stroke","annotate.fill":"Fill","annotate.width":"Width","annotate.size":"Size","annotate.clear.fill":"Clear Fill","filter.basic":"Basic Filters","filter.artistic":"Artistic Filters","filter.enhance":"Enhance Filters","filter.reset":"Reset Filters","sticker.faces":"Faces","sticker.hands":"Hands","sticker.hearts":"Hearts","sticker.animals":"Animals","sticker.fruits":"Fruits","sticker.food":"Food","sticker.transport":"Transport","sticker.nature":"Nature","sticker.numbers":"Numbers","sticker.stickers":"Stickers","sticker.symbols":"Symbols","sticker.upload":"Upload","toolbar.delete":"Delete Selected","toolbar.copy":"Copy Selected","toolbar.front":"Bring to Front","toolbar.back":"Send to Back","toolbar.forward":"Move Forward","toolbar.backward":"Move Backward","toolbar.bold":"Bold","toolbar.italic":"Italic","toolbar.underline":"Underline","toolbar.strikethrough":"Strikethrough","toolbar.font.smaller":"Smaller Font","toolbar.font.larger":"Larger Font","toolbar.text.color":"Text Color","toolbar.stroke.color":"Stroke Color","toolbar.fill.color":"Fill Color","toolbar.stroke.width":"Stroke Width","toolbar.clear.fill":"Clear Fill","loading.image":"Loading image...","frame.none":"None","frame.solidSharp":"Solid Sharp","frame.solidRound":"Solid Round","frame.lineSingle":"Single Line","frame.lineMultiple":"Multiple Lines","frame.edgeCross":"Edge Cross","frame.edgeSeparate":"Edge Separate","frame.edgeOverlap":"Edge Overlap","frame.hook":"Hook","frame.polaroid":"Polaroid","toolbar.delete.multi":"Delete {count} selected items","toolbar.copy.multi":"Copy {count} selected items","toolbar.selected.count":"{count} items selected","common.none":"None","common.width":"Width","common.height":"Height","common.color":"Color","common.size":"Size"},oe={"header.upload":"\u4E0A\u4F20\u56FE\u7247","header.undo":"\u64A4\u9500","header.redo":"\u91CD\u505A","header.download":"\u4E0B\u8F7D","header.confirm":"\u786E\u8BA4","header.close":"\u5173\u95ED","header.zoom.in":"\u653E\u5927","header.zoom.out":"\u7F29\u5C0F","header.zoom.reset":"\u91CD\u7F6E\u7F29\u653E","header.close.confirm":"\u786E\u5B9A\u8981\u5173\u95ED\u5417\uFF1F\u672A\u4FDD\u5B58\u7684\u66F4\u6539\u5C06\u4E22\u5931\u3002","tool.select":"\u9009\u62E9","tool.crop":"\u88C1\u526A","tool.filter":"\u6EE4\u955C","tool.annotate":"\u6807\u6CE8","tool.sticker":"\u8D34\u7EB8","tool.finetune":"\u5FAE\u8C03","tool.frame":"\u8FB9\u6846","crop.original":"\u539F\u59CB","crop.lock.ratio":"\u9501\u5B9A\u5BBD\u9AD8\u6BD4","crop.unlock.ratio":"\u89E3\u9501\u5BBD\u9AD8\u6BD4","crop.rotation":"\u65CB\u8F6C","crop.scale":"\u7F29\u653E","crop.skew":"\u503E\u659C","crop.reset":"\u91CD\u7F6E\u6240\u6709\u8C03\u6574","finetune.brightness":"\u4EAE\u5EA6","finetune.contrast":"\u5BF9\u6BD4\u5EA6","finetune.saturation":"\u9971\u548C\u5EA6","finetune.exposure":"\u66DD\u5149","finetune.gamma":"\u4F3D\u9A6C","finetune.vignette":"\u6697\u89D2","finetune.reset":"\u91CD\u7F6E\u6240\u6709\u5FAE\u8C03\u8BBE\u7F6E","annotate.sharpie":"\u9A6C\u514B\u7B14","annotate.draw":"\u7ED8\u5236","annotate.line":"\u76F4\u7EBF","annotate.arrow":"\u7BAD\u5934","annotate.rectangle":"\u77E9\u5F62","annotate.ellipse":"\u692D\u5706","annotate.text":"\u6587\u672C","annotate.color":"\u989C\u8272","annotate.stroke":"\u63CF\u8FB9","annotate.fill":"\u586B\u5145","annotate.width":"\u5BBD\u5EA6","annotate.size":"\u5927\u5C0F","annotate.clear.fill":"\u900F\u660E\u586B\u5145","filter.basic":"\u57FA\u7840\u6EE4\u955C","filter.artistic":"\u827A\u672F\u6EE4\u955C","filter.enhance":"\u589E\u5F3A\u6EE4\u955C","filter.reset":"\u91CD\u7F6E\u6EE4\u955C","sticker.faces":"\u8868\u60C5","sticker.hands":"\u624B\u52BF","sticker.hearts":"\u7231\u5FC3","sticker.animals":"\u52A8\u7269","sticker.fruits":"\u6C34\u679C","sticker.food":"\u98DF\u7269","sticker.transport":"\u4EA4\u901A","sticker.nature":"\u690D\u7269","sticker.numbers":"\u6570\u5B57","sticker.stickers":"\u8D34\u7EB8","sticker.symbols":"\u7B26\u53F7","sticker.upload":"\u4E0A\u4F20","toolbar.delete":"\u5220\u9664\u9009\u4E2D","toolbar.copy":"\u590D\u5236\u9009\u4E2D","toolbar.front":"\u79FB\u5230\u6700\u4E0A\u5C42","toolbar.back":"\u79FB\u5230\u6700\u4E0B\u5C42","toolbar.forward":"\u4E0A\u79FB\u4E00\u5C42","toolbar.backward":"\u4E0B\u79FB\u4E00\u5C42","toolbar.bold":"\u52A0\u7C97","toolbar.italic":"\u659C\u4F53","toolbar.underline":"\u4E0B\u5212\u7EBF","toolbar.strikethrough":"\u5220\u9664\u7EBF","toolbar.font.smaller":"\u5B57\u53F7-","toolbar.font.larger":"\u5B57\u53F7+","toolbar.text.color":"\u6587\u672C\u989C\u8272","toolbar.stroke.color":"\u63CF\u8FB9\u989C\u8272","toolbar.fill.color":"\u586B\u5145\u989C\u8272","toolbar.stroke.width":"\u63CF\u8FB9\u5BBD\u5EA6","toolbar.clear.fill":"\u6E05\u9664\u586B\u5145","loading.image":"\u52A0\u8F7D\u56FE\u7247\u4E2D...","frame.none":"\u65E0\u8FB9\u6846","frame.solidSharp":"\u5B9E\u7EBF\u65B9\u6846","frame.solidRound":"\u5B9E\u7EBF\u5706\u89D2","frame.lineSingle":"\u5355\u7EBF\u8FB9\u6846","frame.lineMultiple":"\u591A\u7EBF\u8FB9\u6846","frame.edgeCross":"\u4EA4\u53C9\u8FB9\u6846","frame.edgeSeparate":"\u5206\u79BB\u8FB9\u6846","frame.edgeOverlap":"\u91CD\u53E0\u8FB9\u6846","frame.hook":"\u94A9\u5F62\u8FB9\u6846","frame.polaroid":"\u62CD\u7ACB\u5F97","toolbar.delete.multi":"\u5220\u9664\u9009\u4E2D\u7684 {count} \u4E2A\u5143\u7D20","toolbar.copy.multi":"\u590D\u5236\u9009\u4E2D\u7684 {count} \u4E2A\u5143\u7D20","toolbar.selected.count":"\u5DF2\u9009\u4E2D {count} \u4E2A\u5143\u7D20","common.none":"\u65E0","common.width":"\u5BBD\u5EA6","common.height":"\u9AD8\u5EA6","common.color":"\u989C\u8272","common.size":"\u5927\u5C0F"},it={en:ie,zh:oe},Tt=_.createContext(null),Ft=({language:r="en",translations:t,children:e})=>{const i=_.useMemo(()=>{const o=t?{...it,...Object.keys(t).reduce((a,l)=>(a[l]={...it[l]||it.en||{},...t[l]},a),{})}:it,s=o[r]||o.en||it.en;return{t:(a,l)=>{let c=s&&s[a]||a;return l&&Object.entries(l).forEach(([h,d])=>{c=c.replace(`{${h}}`,String(d))}),c},language:r}},[r,t]);return _.createElement(Tt.Provider,{value:i},e)},N=()=>{const r=_.useContext(Tt);if(!r)throw new Error("useTranslation must be used within I18nProvider");return r},se=({editorState:r,cropPresets:t,editorRef:e,onStateChange:i})=>{const{t:o}=N(),[s,a]=_.useState(!1),[l,c]=_.useState(""),[h,d]=_.useState("");_.useEffect(()=>{if(!r.crop||!e.current)return;const k=e.current,S=k.getImageDisplay(),y=k.getOriginalImageSize(),{crop:C}=r;if(!y.width||!S.width)return;const j=C.width/S.width,w=C.height/S.height,M=Math.round(y.width*j),I=Math.round(y.height*w);c(M.toString()),d(I.toString())},[r.crop,e.current]);const u=_.useCallback(()=>{const k=e.current;k&&k.recalculateImageDisplay&&k.recalculateImageDisplay()},[e]),p=_.useCallback(()=>{const k=e.current;k&&(i({rotation:0,flipX:!1,flipY:!1,scale:1,skewX:0,skewY:0}),setTimeout(()=>{u();const S=k.getImageDisplay();i({crop:{x:S.x,y:S.y,width:S.width,height:S.height}})},50))},[e,i,u]),g=_.useCallback(k=>{if(!k.ratio){p();return}const S=e.current;if(!S)return;const y=S.getImageDisplay(),C=S.getState(),j=(C.rotation||0)*Math.PI/180,w=C.scale||1,M=C.skewX||0,I=C.skewY||0,E=Math.abs(Math.cos(j)),R=Math.abs(Math.sin(j)),A=y.width*w,L=y.height*w,z=Math.abs(M)*L,q=Math.abs(I)*A,F=(A+z)*E+(L+q)*R,P=(L+q)*E+(A+z)*R,mt=y.x+y.width/2,at=y.y+y.height/2,Q=S.canvas,rt=Q.width,lt=Q.height,D={x:Math.max(0,Math.min(rt-F,mt-F/2)),y:Math.max(0,Math.min(lt-P,at-P/2)),width:Math.min(F,rt),height:Math.min(P,lt)},{width:ct,height:xt}=D;let H,V;k.ratio>=ct/xt?(H=ct*.8,V=H/k.ratio):(V=xt*.8,H=V*k.ratio);const kt=D.x+(D.width-H)/2,ht=D.y+(D.height-V)/2;i({crop:{x:kt,y:ht,width:H,height:V}})},[e,i,p]),m=_.useCallback(k=>{i({rotation:(r.rotation||0)+k})},[r.rotation,i]),x=_.useCallback(k=>{const S=`flip${k}`;i({[S]:!r[S]})},[r,i]),f=_.useCallback((k,S)=>{const y=e.current,C=y.getImageDisplay(),j=y.getOriginalImageSize(),w=k/j.width*C.width,M=S/j.height*C.height;i({crop:{...r.crop,width:w,height:M}})},[r.crop,i]),v=_.useCallback(k=>{c(k);const S=parseInt(k)||0;if(S<=0)return;let y=parseInt(h)||0;s&&parseInt(l)>0&&parseInt(h)>0&&(y=Math.round(S/(parseInt(l)/parseInt(h))),d(y.toString())),f(S,y)},[l,h,s,f]),b=_.useCallback(k=>{d(k);const S=parseInt(k)||0;if(S<=0)return;let y=parseInt(l)||0;s&&parseInt(l)>0&&parseInt(h)>0&&(y=Math.round(S*(parseInt(l)/parseInt(h))),c(y.toString())),f(y,S)},[l,h,s,f]);return n.jsxs("div",{className:"dk-image-editor__crop-controls",children:[n.jsxs("div",{className:"dk-image-editor__actions",children:[n.jsx("button",{className:"dk-image-editor__preset-btn",onClick:()=>g({name:"Original"}),children:n.jsx(yt,{size:14})}),n.jsx("select",{className:"dk-image-editor__preset-select",onChange:k=>{const S=t.find(y=>y.name===k.target.value);S&&g(S)},defaultValue:"",children:t.map(k=>n.jsx("option",{value:k.name,children:k.name},k.name))}),n.jsx("button",{onClick:()=>m(Et.NEGATIVE_QUARTER_TURN),children:"-90\xB0"}),n.jsx("button",{onClick:()=>m(Et.QUARTER_TURN),children:"+90\xB0"}),n.jsx("button",{onClick:()=>x("X"),children:"\u21C4"}),n.jsx("button",{onClick:()=>x("Y"),children:"\u21C5"}),n.jsxs("div",{className:"dk-image-editor__size-inputs",children:[n.jsx("input",{type:"number",value:l,onChange:k=>v(k.target.value),min:"1",placeholder:"W"}),n.jsx("button",{className:`dk-image-editor__lock-btn ${s?"locked":""}`,onClick:()=>a(!s),title:o(s?"crop.unlock.ratio":"crop.lock.ratio"),children:s?n.jsx(te,{size:14}):n.jsx(ee,{size:14})}),n.jsx("input",{type:"number",value:h,onChange:k=>b(k.target.value),min:"1",placeholder:"H"})]})]}),n.jsxs("div",{className:"dk-image-editor__rotation-controls",children:[n.jsxs("div",{className:"dk-image-editor__slider",children:[n.jsx("label",{children:o("crop.rotation")}),n.jsx("input",{type:"range",min:"-180",max:"180",value:r.rotation||0,onChange:k=>i({rotation:Number(k.target.value)})}),n.jsxs("span",{children:[r?.rotation||0,"\xB0"]})]}),n.jsxs("div",{className:"dk-image-editor__slider",children:[n.jsx("label",{children:o("crop.scale")}),n.jsx("input",{type:"range",min:"0.1",max:"3",step:"0.1",value:r.scale||1,onChange:k=>i({scale:Number(k.target.value)})}),n.jsxs("span",{children:[(r?.scale||1).toFixed(1),"x"]})]}),n.jsxs("div",{className:"dk-image-editor__slider",children:[n.jsx("label",{children:o("crop.skew")}),n.jsx("input",{type:"range",min:"0",max:"360",step:"5",value:(()=>{const k=r.skewX||0,S=r.skewY||0;if(k===0&&S===0)return 0;const y=Math.atan2(S,k)*180/Math.PI;return y<0?y+360:y})(),onChange:k=>{const S=Number(k.target.value);if(S===0)i({skewX:0,skewY:0});else{const y=S*Math.PI/180,C=.5;i({skewX:Math.cos(y)*C,skewY:Math.sin(y)*C})}}}),n.jsx("span",{children:(()=>{const k=r.skewX||0,S=r.skewY||0;if(k===0&&S===0)return o("common.none");const y=Math.atan2(S,k)*180/Math.PI;return Math.round(y<0?y+360:y)+"\xB0"})()})]})]})]})};function ne(r,t){let e;return(...i)=>{clearTimeout(e),e=setTimeout(()=>r(...i),t)}}function ae(r){const t=r.size||r.width||20,e=r.size||r.height||20;return n.jsx("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:n.jsx("path",{d:"M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"})})}function re(r){const t=r.size||r.width||20,e=r.size||r.height||20;return n.jsxs("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M6.13 1L6 16a2 2 0 002 2h15"}),n.jsx("path",{d:"M1 6.13L16 6a2 2 0 012 2v15"})]})}function le(r){const t=r.size||r.width||20,e=r.size||r.height||20;return n.jsx("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:n.jsx("path",{d:"M18.347 9.907a6.5 6.5 0 1 0-1.872 3.306M3.26 11.574a6.5 6.5 0 1 0 2.815-1.417 M10.15 17.897A6.503 6.503 0 0 0 16.5 23a6.5 6.5 0 1 0-6.183-8.51"})})}function ce(r){const t=r.size||r.width||20,e=r.size||r.height||20;return n.jsxs("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("line",{x1:"4",y1:"21",x2:"4",y2:"14"}),n.jsx("line",{x1:"4",y1:"10",x2:"4",y2:"3"}),n.jsx("line",{x1:"12",y1:"21",x2:"12",y2:"12"}),n.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"3"}),n.jsx("line",{x1:"20",y1:"21",x2:"20",y2:"16"}),n.jsx("line",{x1:"20",y1:"12",x2:"20",y2:"3"}),n.jsx("line",{x1:"1",y1:"14",x2:"7",y2:"14"}),n.jsx("line",{x1:"9",y1:"8",x2:"15",y2:"8"}),n.jsx("line",{x1:"17",y1:"16",x2:"23",y2:"16"})]})}const he=({size:r=16,className:t=""})=>n.jsxs("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:t,children:[n.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),n.jsx("rect",{x:"7",y:"7",width:"10",height:"10"})]});function de(r){const t=r.size||r.width||20,e=r.size||r.height||20;return n.jsx("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:n.jsx("path",{d:"M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"})})}function ue(r){const t=r.size||r.width||20,e=r.size||r.height||20;return n.jsxs("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 1024 1024",fill:"currentColor",children:[n.jsx("path",{d:"M670.64 403.2c-5.04-18.776-14.808-34.984-27.056-45.696-12.16-10.712-27.904-16.856-43.816-12.584-15.872 4.264-26.456 17.448-31.576 32.768-5.248 15.44-5.632 34.304-0.6 53.16 5.04 18.776 14.808 34.984 27.056 45.696 12.16 10.712 27.904 16.856 43.776 12.584 15.92-4.264 26.448-17.408 31.656-32.768 5.2-15.44 5.592-34.304 0.56-53.12V403.2z m-247.384 66.264c-4.992-18.776-14.768-34.992-27.008-45.744-12.16-10.664-27.904-16.808-43.776-12.584-15.92 4.264-26.456 17.496-31.664 32.856-5.2 15.4-5.584 34.256-0.552 53.072 5.04 18.816 14.8 34.992 27.048 45.744 12.16 10.664 27.904 16.848 43.776 12.584 15.92-4.264 26.456-17.448 31.664-32.808 5.2-15.408 5.584-34.304 0.56-53.12h-0.048z"}),n.jsx("path",{d:"M512 32C246.912 32 32 246.912 32 512c0 265.088 214.912 480 480 480 42.024 0 78.936-19.376 105.384-45.816l328.8-328.8C972.624 590.984 992 554.024 992 512c0-265.088-214.912-480-480-480zM119.28 512a392.872 392.872 0 0 1 43.104-179.192 395.456 395.456 0 0 1 28.864-47.712 394 394 0 0 1 48.424-56.352A392.616 392.616 0 0 1 416.688 130.72a393.344 393.344 0 0 1 110.656-11.44 391.096 391.096 0 0 1 55.424 6.128 392.736 392.736 0 0 1 319.56 342.944c-91.072 0.224-150.2 2.096-200.16 19.6a350.928 350.928 0 0 0-43.248 18.48 355.96 355.96 0 0 0-20.592 11.376 352.52 352.52 0 0 0-32.464 21.968 359.096 359.096 0 0 0-18.224 14.88 354.48 354.48 0 0 0-22.664 21.68 354.992 354.992 0 0 0-20.624 23.64 352.992 352.992 0 0 0-18.416 25.384 355.52 355.52 0 0 0-12.28 20.072 310.4 310.4 0 0 1-55.176 4.544 307.424 307.424 0 0 1-39.464-2.816 308.056 308.056 0 0 1-31.12-5.872 44.656 44.656 0 0 0-8.488-1.32 44.784 44.784 0 0 0-8.584 0.368 45.48 45.48 0 0 0-6.304 1.384 43.888 43.888 0 0 0-13.408 6.688 45.064 45.064 0 0 0-4.896 4.2 44.728 44.728 0 0 0-5.464 6.632 44.032 44.032 0 0 0-5.52 11.624 45.416 45.416 0 0 0-1.408 6.288 46.728 46.728 0 0 0-0.416 4.28 43.848 43.848 0 0 0 2.536 16.912 43.48 43.48 0 0 0 15.24 20.384 43.792 43.792 0 0 0 15.504 7.216c35.352 8.856 73.096 12.648 111.84 10.816-8.768 42.896-9.992 94.472-10.12 165.56C272 880.64 119.272 714.168 119.272 512z m611.68 58.344c32.432-11.352 72.44-13.968 153.392-14.576l-328.584 328.584c0.56-80.952 3.224-120.96 14.576-153.384a261.104 261.104 0 0 1 21.616-46.544 267.28 267.28 0 0 1 11.976-18.48 268.08 268.08 0 0 1 13.488-17.4 268.664 268.664 0 0 1 14.904-16.216 266.92 266.92 0 0 1 16.208-14.904 261.096 261.096 0 0 1 48.744-32.568 268.624 268.624 0 0 1 19.968-9.28 259.544 259.544 0 0 1 13.72-5.232z"})]})}const ge={select:{name:"Select",icon:n.jsx(de,{})},crop:{name:"Crop",icon:n.jsx(re,{})},finetune:{name:"Finetune",icon:n.jsx(ce,{})},filter:{name:"Filter",icon:n.jsx(le,{})},annotate:{name:"Annotate",icon:n.jsx(ae,{})},sticker:{name:"Sticker",icon:n.jsx(ue,{})},frame:{name:"Frame",icon:n.jsx(he,{})},"advanced-filter":{name:"Advanced",icon:"\u{1F3AD}"},image:{name:"Image",icon:"\u{1F5BC}\uFE0F"},resize:{name:"Resize",icon:"\u{1F4CF}"},fill:{name:"Fill",icon:"\u{1F3AF}"}},pe=[[void 0,"Original"],[1,"1:1"],[4/3,"4:3"],[16/9,"16:9"],[3/2,"3:2"]],me=[["sharpie","Draw"],["line","Line"],["arrow","Arrow"],["rectangle","Rectangle"],["ellipse","Ellipse"],["text","Text"]],xe=[["chrome","Chrome"],["fade","Fade"],["cold","Cold"],["warm","Warm"],["monoDefault","Mono"],["sepiaDefault","Sepia"],["blur","Blur"],["sharpen","Sharpen"],["emboss","Emboss"],["oil","Oil Paint"],["vintage","Vintage"],["dramatic","Dramatic"],["vivid","Vivid"],["noir","Noir"],["sunset","Sunset"],["ocean","Ocean"]],fe=[["brightness","Brightness"],["contrast","Contrast"],["saturation","Saturation"],["exposure","Exposure"],["gamma","Gamma"],["vignette","Vignette"]],ke=[["none","None"],["solidSharp","Mat"],["solidRound","Bevel"],["lineSingle","Line"],["lineMultiple","Zebra"],["edgeCross","Lumber"],["edgeSeparate","Inset"],["edgeOverlap","Plus"],["hook","Hook"],["polaroid","Polaroid"]],U={ANIMATION_DURATION:300,DEFAULT_STROKE_WIDTH:2,DEFAULT_FONT_SIZE:24,EMOJI_LIST:["\u{1F600}","\u{1F602}","\u{1F923}","\u{1F60A}","\u{1F60D}","\u{1F970}","\u{1F618}","\u{1F60B}","\u{1F914}","\u{1F60E}","\u{1F929}","\u{1F973}","\u{1F44D}","\u{1F44E}","\u{1F44C}","\u270C\uFE0F","\u{1F91E}","\u{1F91F}","\u{1F918}","\u{1F44F}","\u{1F64C}","\u{1F91D}","\u{1F4AA}","\u{1F9BE}","\u2764\uFE0F","\u{1F9E1}","\u{1F49B}","\u{1F49A}","\u{1F499}","\u{1F49C}","\u{1F5A4}","\u{1F90D}","\u{1F90E}","\u{1F495}","\u{1F496}","\u{1F497}","\u{1F436}","\u{1F415}","\u{1F9AE}","\u{1F415}\u200D\u{1F9BA}","\u{1F429}","\u{1F43A}","\u{1F98A}","\u{1F99D}","\u{1F431}","\u{1F408}","\u{1F408}\u200D\u2B1B","\u{1F981}","\u{1F525}","\u2B50","\u2728","\u{1F389}","\u{1F4AF}","\u{1F4A5}","\u26A1","\u{1F31F}","\u{1F38A}","\u{1F388}","\u{1F381}","\u{1F3C6}"],FINETUNE_SHORTCUTS:{brightness:"BR",contrast:"CO",saturation:"SA",exposure:"EX",gamma:"GA",vignette:"VI"}},be=({size:r=16,color:t="currentColor"})=>n.jsxs("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[n.jsx("circle",{cx:"12",cy:"12",r:"4",fill:t}),n.jsx("path",{d:"M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41",stroke:t,strokeWidth:"2",strokeLinecap:"round"})]}),ye=({size:r=16,color:t="currentColor"})=>n.jsxs("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[n.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:t,strokeWidth:"2"}),n.jsx("path",{d:"M12 3a9 9 0 0 1 0 18z",fill:t})]}),we=({size:r=16,color:t="currentColor"})=>n.jsxs("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[n.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:t,strokeWidth:"2"}),n.jsx("path",{d:"M8 8h8M8 12h8M8 16h4",stroke:t,strokeWidth:"2",strokeLinecap:"round"}),n.jsx("path",{d:"M16 16l2-2M18 18l-2-2",stroke:t,strokeWidth:"2",strokeLinecap:"round"})]}),ve=({size:r=16,color:t="currentColor"})=>n.jsxs("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[n.jsx("path",{d:"M3 21h18l-9-18z",stroke:t,strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),n.jsx("path",{d:"M12 3v18",stroke:t,strokeWidth:"2",strokeLinecap:"round"}),n.jsx("path",{d:"M7.5 15h9",stroke:t,strokeWidth:"2",strokeLinecap:"round"})]}),_e=({size:r=16,color:t="currentColor"})=>n.jsx("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:n.jsx("path",{d:"M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z",fill:t})}),Se=({size:r=16,color:t="currentColor"})=>n.jsxs("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[n.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",stroke:t,strokeWidth:"2"}),n.jsx("circle",{cx:"12",cy:"12",r:"6",fill:"none",stroke:t,strokeWidth:"2",strokeDasharray:"2 2"}),n.jsx("circle",{cx:"12",cy:"12",r:"3",fill:t})]}),Ce=({editorState:r,selectedFinetuneOption:t,finetuneOptions:e,editorRef:i,onStateChange:o,setSelectedFinetuneOption:s})=>{const{t:a}=N(),{FINETUNE_SHORTCUTS:l}=U,c=_.useMemo(()=>new Map(e),[e]),h=_.useMemo(()=>ne(()=>i.current?.render(),bt.RENDER),[i]),d=_.useCallback(m=>{o({[t]:m}),h()},[t,o,h]),u=_.useCallback(()=>{const m={};e.forEach(([x])=>{m[x]=0}),o(m),h()},[e,o,h]),p=r?.[t]||0,g=a(`finetune.${t}`)||c.get(t)||"Brightness";return n.jsxs("div",{className:"dk-image-editor__finetune-controls",children:[n.jsxs("div",{className:"dk-image-editor__slider",children:[n.jsx("label",{children:g}),n.jsx("input",{type:"range",min:et.FINETUNE.min,max:et.FINETUNE.max,value:p,onChange:m=>d(Number(m.target.value))}),n.jsx("span",{children:p})]}),n.jsxs("div",{className:"dk-image-editor__finetune-options",children:[n.jsx("button",{className:"dk-image-editor__finetune-option",onClick:u,title:a("finetune.reset"),children:n.jsx(yt,{size:14})}),e.map(([m,x])=>{const f=()=>{switch(m){case"brightness":return n.jsx(be,{size:14});case"contrast":return n.jsx(ye,{size:14});case"saturation":return n.jsx(_e,{size:14});case"exposure":return n.jsx(we,{size:14});case"gamma":return n.jsx(ve,{size:14});case"vignette":return n.jsx(Se,{size:14});default:return l[m]||m.substring(0,2).toUpperCase()}};return n.jsx("button",{className:`dk-image-editor__finetune-option ${t===m?"dk-image-editor__finetune-option--active":""}`,onClick:()=>s(m),title:a(`finetune.${m}`),children:f()},m)})]})]})},Me=({size:r=16,width:t,height:e,style:i})=>n.jsxs("svg",{width:t||r,height:e||r,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:i,children:[n.jsx("line",{x1:"7",y1:"17",x2:"17",y2:"7"}),n.jsx("polyline",{points:"7,7 17,7 17,17"})]}),Ie=({size:r=16,width:t,height:e,style:i})=>n.jsx("svg",{width:t||r,height:e||r,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:i,children:n.jsx("path",{d:"M3 17c3-3 6-6 9-3s6 6 9 3"})}),je=({size:r=16,width:t,height:e,style:i})=>n.jsx("svg",{width:t||r,height:e||r,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:i,children:n.jsx("circle",{cx:"12",cy:"12",r:"10"})}),Ee=({size:r=16,width:t,height:e,style:i})=>n.jsx("svg",{width:t||r,height:e||r,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:i,children:n.jsx("line",{x1:"7",y1:"17",x2:"17",y2:"7"})}),Te=({size:r=16,width:t,height:e,style:i})=>n.jsx("svg",{width:t||r,height:e||r,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:i,children:n.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"})}),Fe=({size:r=16,width:t,height:e,style:i})=>n.jsxs("svg",{width:t||r,height:e||r,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:i,children:[n.jsx("polyline",{points:"4,7 4,4 20,4 20,7"}),n.jsx("line",{x1:"9",y1:"20",x2:"15",y2:"20"}),n.jsx("line",{x1:"12",y1:"4",x2:"12",y2:"20"})]}),wt=(r,t,e,i)=>({id:"",type:r,x:0,y:0,color:t,strokeWidth:e,fontSize:r==="text"?i:void 0,fillColor:r==="rectangle"||r==="ellipse"?"transparent":void 0,strokeColor:r!=="text"?t:void 0}),ot=(r,t,e,i={})=>r?{...r,[t]:e}:{...wt("rectangle","#000000",2),...i,[t]:e},G=_.memo(({value:r,onChange:t,title:e})=>{const i=_.useCallback(s=>{s.preventDefault(),s.currentTarget.querySelector('input[type="color"]')?.click()},[]),o=_.useCallback(s=>{s.stopPropagation(),t(s.target.value)},[t]);return n.jsx("button",{className:"dk-image-editor__color-button",onClick:i,children:n.jsx("div",{className:"dk-image-editor__color-picker",children:n.jsx("input",{type:"color",value:r,onChange:o,title:e,onClick:s=>{console.log("\u{1F3A8} Color input clicked"),s.stopPropagation()}})})})});G.displayName="ColorPicker";const Re=({currentAnnotation:r,lastAnnotateColor:t,annotateTools:e,setCurrentAnnotation:i,setLastAnnotateColor:o})=>{const{t:s}=N(),{DEFAULT_STROKE_WIDTH:a,DEFAULT_FONT_SIZE:l}=U;_.useEffect(()=>{r||i(wt("sharpie",t,a,l))},[r,t,i,a,l]);const c=_.useCallback(f=>{if(o(f),r){const v=ot(r,"color",f);i(ot(v,"strokeColor",f))}},[r,i,o]),h=_.useCallback(f=>{i(ot(r,"strokeWidth",f,{color:t}))},[r,t,i]),d=_.useCallback(f=>{i(ot(r,"fontSize",f))},[r,i]),u=_.useCallback(f=>{i(ot(r,"fillColor",f))},[r,i]),p=_.useCallback(f=>{i(ot(r,"strokeColor",f))},[r,i]),g=_.useCallback(f=>{i(wt(f,t,r?.strokeWidth||a,r?.fontSize||l))},[r,t,i,a,l]),m=r?.type==="text"?n.jsxs("div",{className:"dk-image-editor__compact-slider",children:[n.jsxs("label",{children:[s("annotate.size"),":"]}),n.jsx("input",{type:"range",min:et.FONT_SIZE.min,max:et.FONT_SIZE.max,value:r.fontSize||l,onChange:f=>d(Number(f.target.value))}),n.jsx("span",{children:r.fontSize||l})]}):null,x=r?.type==="rectangle"||r?.type==="ellipse"?n.jsx(n.Fragment,{children:n.jsxs("div",{className:"dk-image-editor__color-box",children:[n.jsxs("label",{children:[s("annotate.fill"),": "]}),n.jsx(G,{value:r.fillColor||"#000000",onChange:u,title:"Fill Color"}),r.fillColor&&r.fillColor!=="transparent"&&n.jsx("button",{onClick:()=>u("transparent"),className:"dk-image-editor__clear-fill",title:s("annotate.clear.fill"),children:"\u2715"})]})}):null;return n.jsxs("div",{className:"dk-image-editor__annotate-controls",children:[n.jsxs("div",{className:"dk-image-editor__annotate-settings",children:[r?.type==="text"?n.jsxs("div",{className:"dk-image-editor__color-box",children:[n.jsxs("label",{children:[s("annotate.color"),": "]}),n.jsx(G,{value:t,onChange:c,title:s("toolbar.text.color")})]}):n.jsxs("div",{className:"dk-image-editor__color-box",children:[n.jsxs("label",{children:[s("annotate.stroke"),": "]}),n.jsx(G,{value:r?.strokeColor||t,onChange:p,title:s("toolbar.stroke.color")})]}),x,r?.type!=="text"&&n.jsxs("div",{className:"dk-image-editor__compact-slider",children:[n.jsxs("label",{children:[s("annotate.width"),":"]}),n.jsx("input",{type:"range",min:et.STROKE_WIDTH.min,max:et.STROKE_WIDTH.max,value:r?.strokeWidth||a,onChange:f=>h(Number(f.target.value))}),n.jsx("span",{children:r?.strokeWidth||a})]}),m]}),n.jsx("div",{className:"dk-image-editor__toolbar",children:e.map(([f,v])=>{const b=()=>{switch(f){case"sharpie":return n.jsx(Ie,{size:16});case"line":return n.jsx(Ee,{size:16});case"arrow":return n.jsx(Me,{size:16});case"rectangle":return n.jsx(Te,{size:16});case"ellipse":return n.jsx(je,{size:16});case"text":return n.jsx(Fe,{size:16});default:return null}};return n.jsxs("button",{onClick:()=>g(f),className:`dk-image-editor__tool-button ${r?.type===f?"dk-image-editor__unified-button--active":""}`,children:[b(),s(`annotate.${f}`)]},f)})})]})};function vt(...r){const t=[];for(const e of r)if(e){if(typeof e=="string"||typeof e=="number")t.push(String(e));else if(Array.isArray(e)){const i=vt(...e);i&&t.push(i)}else if(typeof e=="object")for(const i in e)e[i]&&t.push(i)}return t.join(" ")}const Ae=({editorRef:r,stickerPluginRef:t,selectionPluginRef:e,imagePluginRef:i,zoomLevel:o,setHasSelection:s,currentSticker:a,setCurrentSticker:l})=>{const{t:c}=N(),{EMOJI_LIST:h}=U,[d,u]=_.useState("faces"),[p,g]=_.useState(new Set),m=_.useMemo(()=>["https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60d.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f602.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60e.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f973.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f970.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60b.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f929.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60a.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f618.png","https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f44d.png"],[]),x=_.useMemo(()=>({faces:h.slice(0,12),hands:h.slice(12,24),hearts:h.slice(24,36),fruits:["\u{1F349}","\u{1F34A}","\u{1F34E}","\u{1F34B}","\u{1F34C}","\u{1F347}","\u{1F353}","\u{1FAD0}","\u{1F348}","\u{1F351}","\u{1F352}","\u{1F96D}"],food:["\u{1F355}","\u{1F354}","\u{1F35F}","\u{1F32D}","\u{1F96A}","\u{1F32E}","\u{1F32F}","\u{1F959}","\u{1F9C6}","\u{1F95A}","\u{1F373}","\u{1F95E}"],transport:["\u{1F697}","\u{1F695}","\u{1F699}","\u{1F68C}","\u{1F68E}","\u{1F3CE}\uFE0F","\u{1F693}","\u{1F691}","\u{1F692}","\u{1F690}","\u{1F6FB}","\u{1F69A}"],nature:["\u{1F338}","\u{1F33A}","\u{1F33B}","\u{1F337}","\u{1F339}","\u{1F940}","\u{1F33E}","\u{1F33F}","\u{1F340}","\u{1F343}","\u{1F331}","\u{1F332}"],animals:h.slice(36,48),numbers:["0\uFE0F\u20E3","1\uFE0F\u20E3","2\uFE0F\u20E3","3\uFE0F\u20E3","4\uFE0F\u20E3","5\uFE0F\u20E3","6\uFE0F\u20E3","7\uFE0F\u20E3","8\uFE0F\u20E3","9\uFE0F\u20E3","\u{1F51F}","#\uFE0F\u20E3"],stickers:m,symbols:h.slice(48)}),[h,m]);_.useEffect(()=>{if(!a){const b=x.faces[0]??"\u{1F600}";l({content:b,type:"emoji"})}},[a,l,x.faces]);const f=_.useCallback(b=>{b&&i.current&&i.current.addImageFromFile(b)},[i]),v=_.useCallback((b,k="emoji")=>{l({content:b,type:k})},[l]);return n.jsxs("div",{className:"dk-image-editor__sticker-controls",children:[n.jsx("div",{className:"d-flex align-items-center gap-2",children:Object.keys(x).map(b=>n.jsxs("button",{className:`dk-image-editor__tool-button ${d===b?"active":""}`,onClick:()=>{u(b);const k=x[b][0];k&&l({content:k,type:b==="stickers"?"image":"emoji"})},children:[(()=>{const k=x[b];if(b==="stickers"){const y=k[0];return y?n.jsx("img",{src:y,alt:"sticker",style:{width:"16px",height:"16px"}}):null}const S=k[0];return S?n.jsx("span",{style:{fontSize:"16px"},children:S}):null})(),c(`sticker.${b}`)]},b))}),n.jsxs("div",{className:"dk-image-editor__toolbar",children:[n.jsxs("label",{className:"dk-image-editor__upload-button",children:[n.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},onChange:b=>{const k=b.target.files?.[0];k&&f(k)}}),n.jsx("span",{className:"dk-image-editor__upload-icon",children:"+"}),n.jsx("span",{className:"dk-image-editor__upload-text",children:c("sticker.upload")})]}),x[d].map((b,k)=>{const S=a?.content===b;return n.jsx("button",{onClick:()=>v(b,d==="stickers"?"image":"emoji"),className:vt("dk-image-editor__tool-button",{"css-loading":p.has(b),"dk-image-editor__unified-button--active":S}),style:{height:d==="stickers"?"auto":""},children:d==="stickers"?n.jsx("img",{src:b,alt:"sticker",style:{width:"32px",height:"32px"}}):n.jsx("span",{style:{fontSize:"24px"},children:b})},typeof b=="string"?b:k)})]})]})};function _t(r,t){t===void 0&&(t={});var e=t.insertAt;if(!(!r||typeof document>"u")){var i=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css",e==="top"&&i.firstChild?i.insertBefore(o,i.firstChild):i.appendChild(o),o.styleSheet?o.styleSheet.cssText=r:o.appendChild(document.createTextNode(r))}}var ze='.dk-filter-section{margin-bottom:24px}.dk-filter-section:last-child{margin-bottom:0}.dk-filter-section-title{color:#374151;font-size:14px;font-weight:600;letter-spacing:.5px;margin:0 0 12px;padding:0 4px;text-transform:uppercase}.dk-filter-section-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(85px,1fr))}.dk-image-editor__filter-preview{align-items:center;background:transparent;border:2px solid transparent;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.06),0 1px 3px rgba(0,0,0,.04);cursor:pointer;display:flex;flex-direction:column;overflow:visible;padding:8px;position:relative;transition:all .3s cubic-bezier(.4,0,.2,1)}.dk-image-editor__filter-preview:before{background:linear-gradient(135deg,hsla(0,0%,100%,.1),hsla(0,0%,100%,0));bottom:0;content:"";left:0;opacity:0;pointer-events:none;position:absolute;right:0;top:0;transition:opacity .3s ease}.dk-image-editor__filter-preview:hover{transform:translateY(-2px) scale(1.02)}.dk-image-editor__filter-preview:hover:before{opacity:1}.dk-image-editor__filter-preview.dk-image-editor__unified-button--active{background:linear-gradient(135deg,#eef2ff,#e0e7ff);border-color:#6366f1;box-shadow:0 4px 12px rgba(99,102,241,.25);transform:translateY(-1px)}.dk-image-editor__filter-preview.dk-image-editor__unified-button--active:before{opacity:1}.dk-image-editor__filter-icon{border:1px solid rgba(0,0,0,.06);border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.1),inset 0 1px 0 hsla(0,0%,100%,.8);height:40px;margin-bottom:8px;overflow:hidden;padding:4px;position:relative;transition:all .3s cubic-bezier(.4,0,.2,1);width:40px}.dk-image-editor__filter-preview:hover .dk-image-editor__filter-icon{box-shadow:0 4px 12px rgba(0,0,0,.15);transform:scale(1.05)}.dk-image-editor__filter-icon svg{display:block;height:100%;width:100%}.dk-image-editor__filter-name{color:#475569;color:#fff;font-size:11px;font-weight:500;letter-spacing:.01em;line-height:1.3;text-align:center;transition:all .3s ease}.dk-image-editor__filter-preview:hover .dk-image-editor__filter-name{color:#6366f1;transform:translateY(-1px)}.dk-image-editor__filter-preview.dk-image-editor__unified-button--active .dk-image-editor__filter-name{color:#6366f1;font-weight:700;text-shadow:0 1px 2px rgba(99,102,241,.1)}.dk-image-editor__filter-preview--apply{.dk-image-editor__filter-icon{background:linear-gradient(135deg,#fffbeb,#fef3c7)}}.dk-image-editor__filter-preview--toggle{.dk-image-editor__filter-icon{background:linear-gradient(135deg,#f0fdf4,#dcfce7)}}.dk-filter-badge{color:#f59e0b;font-size:12px;font-weight:700;margin-left:2px}.dk-filter-count{background:#007bff;border-radius:50%;color:#fff;display:inline-block;font-size:10px;font-weight:700;height:16px;line-height:16px;margin-left:4px;text-align:center;width:16px}.dk-image-editor__spinner{animation:dk-spin 1s linear infinite;border:2px solid #f3f3f3;border-radius:50%;border-top-color:#4f46e5;height:20px;width:20px}@keyframes dk-spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}';_t(ze);const Pe=r=>{const t=r.data;for(let e=0;e<t.length;e+=4){const i=t[e]??0,o=t[e+1]??0,s=t[e+2]??0,a=.393*i+.769*o+.189*s,l=.349*i+.686*o+.168*s,c=.272*i+.534*o+.131*s;t[e]=Math.min(255,a*1.2+25),t[e+1]=Math.min(255,l*1.1+15),t[e+2]=Math.min(255,c*.9+5)}return console.log("imageData",r),r},De=r=>{const t=r.data;for(let e=0;e<t.length;e+=4){const i=t[e]??0,o=t[e+1]??0,s=t[e+2]??0,a=2.5,l=259*(a+255)/(255*(259-a));let c=Math.max(0,Math.min(255,l*(i-128)+128)),h=Math.max(0,Math.min(255,l*(o-128)+128)),d=Math.max(0,Math.min(255,l*(s-128)+128));const u=.299*c+.587*h+.114*d,p=1.8;c=Math.max(0,Math.min(255,u+p*(c-u))),h=Math.max(0,Math.min(255,u+p*(h-u))),d=Math.max(0,Math.min(255,u+p*(d-u))),.299*c+.587*h+.114*d<128?(c*=.7,h*=.7,d*=.7):(c=Math.min(255,c*1.3),h=Math.min(255,h*1.3),d=Math.min(255,d*1.3)),t[e]=c,t[e+1]=h,t[e+2]=d}return r},Ne=r=>{const t=r.data;for(let e=0;e<t.length;e+=4){const i=t[e]??0,o=t[e+1]??0,s=t[e+2]??0,a=1.6,l=.299*i+.587*o+.114*s;t[e]=Math.max(0,Math.min(255,l+a*(i-l))),t[e+1]=Math.max(0,Math.min(255,l+a*(o-l))),t[e+2]=Math.max(0,Math.min(255,l+a*(s-l)))}return r},Be=r=>{const t=r.data;for(let e=0;e<t.length;e+=4){const i=t[e]??0,o=t[e+1]??0,s=t[e+2]??0,a=.299*i+.587*o+.114*s,l=a>128?Math.min(255,a*1.3):Math.max(0,a*.7);t[e]=l,t[e+1]=l,t[e+2]=l}return r},Le=r=>{const t=r.data;for(let e=0;e<t.length;e+=4){const i=t[e]??0,o=t[e+1]??0,s=t[e+2]??0;t[e]=Math.min(255,i*1.3+40),t[e+1]=Math.min(255,o*1.1+25),t[e+2]=Math.max(0,s*.6)}return r},Oe=r=>{const t=r.data;for(let e=0;e<t.length;e+=4){const i=t[e]??0,o=t[e+1]??0,s=t[e+2]??0;t[e]=Math.max(0,i*.7),t[e+1]=Math.min(255,o*1.2+20),t[e+2]=Math.min(255,s*1.4+30)}return r},Ue={chrome:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("rect",{width:"40",height:"40",fill:"#FFFFFF",rx:"8"}),n.jsx("rect",{x:"6",y:"8",width:"28",height:"12",fill:"#1966FF",rx:"2"}),n.jsx("rect",{x:"10",y:"16",width:"24",height:"16",fill:"#00C87F",rx:"2"}),n.jsx("text",{x:"20",y:"26",textAnchor:"middle",fill:"#FFFFFF",fontSize:"8",fontWeight:"bold",children:"HD"})]}),fade:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("defs",{children:n.jsxs("linearGradient",{id:"fade-grad",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[n.jsx("stop",{offset:"0%",stopColor:"#333333",stopOpacity:"1"}),n.jsx("stop",{offset:"50%",stopColor:"#666666",stopOpacity:"0.6"}),n.jsx("stop",{offset:"100%",stopColor:"#cccccc",stopOpacity:"0.2"})]})}),n.jsx("rect",{width:"40",height:"40",fill:"#f5f5f5",rx:"6"}),n.jsx("rect",{x:"5",y:"15",width:"30",height:"10",fill:"url(#fade-grad)",rx:"2"})]}),cold:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("defs",{children:n.jsxs("linearGradient",{id:"cold-grad",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[n.jsx("stop",{offset:"0%",stopColor:"#e6f7ff"}),n.jsx("stop",{offset:"50%",stopColor:"#91d5ff"}),n.jsx("stop",{offset:"100%",stopColor:"#40a9ff"})]})}),n.jsx("rect",{width:"40",height:"40",fill:"url(#cold-grad)",rx:"4"}),n.jsx("path",{d:"M20 8 L24 16 L20 24 L16 16 Z",fill:"#fff",opacity:"0.7"}),n.jsx("path",{d:"M8 20 L16 24 L24 20 L16 16 Z",fill:"#fff",opacity:"0.5"})]}),warm:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("defs",{children:n.jsxs("radialGradient",{id:"warm-grad",children:[n.jsx("stop",{offset:"0%",stopColor:"#fff7e6"}),n.jsx("stop",{offset:"50%",stopColor:"#ffd591"}),n.jsx("stop",{offset:"100%",stopColor:"#fa8c16"})]})}),n.jsx("rect",{width:"40",height:"40",fill:"url(#warm-grad)",rx:"4"}),n.jsx("circle",{cx:"20",cy:"15",r:"6",fill:"#ffec3d",opacity:"0.8"}),n.jsx("path",{d:"M20 21 Q15 25 10 30 Q20 28 20 21",fill:"#ff7a45",opacity:"0.6"}),n.jsx("path",{d:"M20 21 Q25 25 30 30 Q20 28 20 21",fill:"#ff7a45",opacity:"0.6"})]}),monoDefault:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("rect",{width:"40",height:"40",fill:"#f0f0f0"}),n.jsx("rect",{width:"20",height:"40",fill:"#333"}),n.jsx("rect",{x:"10",y:"10",width:"20",height:"20",fill:"#666"}),n.jsx("rect",{x:"15",y:"15",width:"10",height:"10",fill:"#999"})]}),sepiaDefault:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("defs",{children:n.jsxs("linearGradient",{id:"sepia-grad",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[n.jsx("stop",{offset:"0%",stopColor:"#f4e4bc"}),n.jsx("stop",{offset:"50%",stopColor:"#d2b48c"}),n.jsx("stop",{offset:"100%",stopColor:"#8b7355"})]})}),n.jsx("rect",{width:"40",height:"40",fill:"url(#sepia-grad)",rx:"4"}),n.jsx("circle",{cx:"12",cy:"12",r:"4",fill:"#deb887",opacity:"0.8"}),n.jsx("circle",{cx:"28",cy:"28",r:"6",fill:"#cd853f",opacity:"0.6"})]}),blur:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("defs",{children:n.jsx("filter",{id:"blur-effect",children:n.jsx("feGaussianBlur",{in:"SourceGraphic",stdDeviation:"2"})})}),n.jsx("rect",{width:"40",height:"40",fill:"#f0f8ff"}),n.jsx("circle",{cx:"15",cy:"15",r:"8",fill:"#4169e1",filter:"url(#blur-effect)",opacity:"0.7"}),n.jsx("circle",{cx:"25",cy:"25",r:"6",fill:"#1e90ff",filter:"url(#blur-effect)",opacity:"0.5"})]}),sharpen:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("rect",{width:"40",height:"40",fill:"#fafafa"}),n.jsx("polygon",{points:"20,5 30,20 20,35 10,20",fill:"#ff4d4f",stroke:"#fff",strokeWidth:"2"}),n.jsx("polygon",{points:"20,10 25,20 20,30 15,20",fill:"#fff",opacity:"0.8"})]}),emboss:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("defs",{children:n.jsxs("linearGradient",{id:"emboss-grad",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[n.jsx("stop",{offset:"0%",stopColor:"#ffffff"}),n.jsx("stop",{offset:"50%",stopColor:"#cccccc"}),n.jsx("stop",{offset:"100%",stopColor:"#666666"})]})}),n.jsx("rect",{width:"40",height:"40",fill:"#e8e8e8"}),n.jsx("rect",{x:"8",y:"8",width:"24",height:"24",fill:"url(#emboss-grad)",rx:"2"}),n.jsx("rect",{x:"10",y:"10",width:"20",height:"20",fill:"none",stroke:"#999",strokeWidth:"1"})]}),oil:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("rect",{width:"40",height:"40",fill:"#2c3e50"}),n.jsx("circle",{cx:"12",cy:"15",r:"5",fill:"#e74c3c",opacity:"0.8"}),n.jsx("circle",{cx:"28",cy:"12",r:"4",fill:"#f39c12",opacity:"0.7"}),n.jsx("circle",{cx:"25",cy:"28",r:"6",fill:"#3498db",opacity:"0.6"}),n.jsx("circle",{cx:"15",cy:"30",r:"3",fill:"#2ecc71",opacity:"0.9"}),n.jsx("path",{d:"M10 25 Q20 20 30 25 Q25 30 15 28",fill:"#9b59b6",opacity:"0.5"})]}),vintage:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("defs",{children:n.jsxs("radialGradient",{id:"vintage-grad",children:[n.jsx("stop",{offset:"0%",stopColor:"#f5e6d3"}),n.jsx("stop",{offset:"70%",stopColor:"#d4a574"}),n.jsx("stop",{offset:"100%",stopColor:"#8b6914"})]})}),n.jsx("rect",{width:"40",height:"40",fill:"url(#vintage-grad)",rx:"6"}),n.jsx("circle",{cx:"20",cy:"20",r:"12",fill:"none",stroke:"#8b6914",strokeWidth:"2",opacity:"0.6"}),n.jsx("rect",{x:"16",y:"8",width:"8",height:"4",fill:"#8b6914",opacity:"0.8"})]}),dramatic:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("defs",{children:n.jsxs("linearGradient",{id:"dramatic-grad",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[n.jsx("stop",{offset:"0%",stopColor:"#000000"}),n.jsx("stop",{offset:"50%",stopColor:"#666666"}),n.jsx("stop",{offset:"100%",stopColor:"#ffffff"})]})}),n.jsx("rect",{width:"40",height:"40",fill:"url(#dramatic-grad)"}),n.jsx("polygon",{points:"20,8 28,20 20,32 12,20",fill:"#fff",opacity:"0.3"})]}),vivid:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("defs",{children:n.jsxs("radialGradient",{id:"vivid-grad",children:[n.jsx("stop",{offset:"0%",stopColor:"#ff6b6b"}),n.jsx("stop",{offset:"33%",stopColor:"#4ecdc4"}),n.jsx("stop",{offset:"66%",stopColor:"#45b7d1"}),n.jsx("stop",{offset:"100%",stopColor:"#96ceb4"})]})}),n.jsx("rect",{width:"40",height:"40",fill:"url(#vivid-grad)",rx:"8"}),n.jsx("circle",{cx:"15",cy:"15",r:"4",fill:"#fff",opacity:"0.4"}),n.jsx("circle",{cx:"25",cy:"25",r:"3",fill:"#fff",opacity:"0.6"})]}),noir:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("rect",{width:"40",height:"40",fill:"#1a1a1a"}),n.jsx("rect",{x:"5",y:"15",width:"30",height:"2",fill:"#ffffff"}),n.jsx("rect",{x:"5",y:"23",width:"30",height:"2",fill:"#cccccc"}),n.jsx("circle",{cx:"12",cy:"12",r:"3",fill:"#ffffff"}),n.jsx("circle",{cx:"28",cy:"28",r:"4",fill:"#888888"}),n.jsx("rect",{x:"18",y:"18",width:"4",height:"4",fill:"#ffffff"})]}),sunset:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("defs",{children:n.jsxs("linearGradient",{id:"sunset-grad",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[n.jsx("stop",{offset:"0%",stopColor:"#ff9a56"}),n.jsx("stop",{offset:"50%",stopColor:"#ff6b35"}),n.jsx("stop",{offset:"100%",stopColor:"#f7931e"})]})}),n.jsx("rect",{width:"40",height:"40",fill:"url(#sunset-grad)",rx:"4"}),n.jsx("circle",{cx:"20",cy:"12",r:"6",fill:"#fff59d",opacity:"0.9"}),n.jsx("ellipse",{cx:"20",cy:"32",rx:"15",ry:"4",fill:"#ff5722",opacity:"0.6"}),n.jsx("path",{d:"M5 25 Q20 20 35 25",stroke:"#ffcc02",strokeWidth:"2",fill:"none",opacity:"0.8"})]}),ocean:n.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 40 40",children:[n.jsx("defs",{children:n.jsxs("linearGradient",{id:"ocean-grad",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[n.jsx("stop",{offset:"0%",stopColor:"#87ceeb"}),n.jsx("stop",{offset:"50%",stopColor:"#4682b4"}),n.jsx("stop",{offset:"100%",stopColor:"#191970"})]})}),n.jsx("rect",{width:"40",height:"40",fill:"url(#ocean-grad)",rx:"4"}),n.jsx("path",{d:"M0 30 Q10 25 20 30 T40 30 V40 H0 Z",fill:"#1e88e5",opacity:"0.7"}),n.jsx("path",{d:"M0 35 Q15 32 30 35 T40 35 V40 H0 Z",fill:"#0d47a1",opacity:"0.5"}),n.jsx("circle",{cx:"30",cy:"10",r:"2",fill:"#ffffff",opacity:"0.8"})]})},We=({filterId:r,name:t,isActive:e,onClick:i,isLoading:o=!1,filterType:s="toggle",clickCount:a})=>n.jsxs("button",{className:vt("dk-image-editor__filter-preview",`dk-image-editor__filter-preview--${s}`,{"dk-image-editor__unified-button--active":e,"dk-image-editor__filter-preview--loading":o,"css-loading":o}),onClick:i,disabled:o,children:[n.jsx("div",{className:"dk-image-editor__filter-icon",children:Ue[r]||n.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",fontSize:"24px"},children:"\u{1F3A8}"})}),n.jsxs("span",{className:"dk-image-editor__filter-name",children:[t,s==="apply"&&a!==void 0&&a>0&&n.jsx("span",{className:"dk-filter-count",children:a})]})]}),$e=({editorState:r,filters:t,editorRef:e,filterCounts:i,onStateChange:o,setFilterCounts:s,applyAdvancedFilter:a})=>{const{t:l}=N(),[c,h]=_.useState(null),[d,u]=_.useState("basic"),p=_.useMemo(()=>({toggle:["chrome","fade","cold","warm","monoDefault","sepiaDefault","blur"],apply:["sharpen","emboss","oil","vintage","dramatic","vivid","noir","sunset","ocean"]}),[]),{toggle:g,apply:m}=p,x=_.useCallback(w=>w.name==="Original"||w.id==="original"?(o({filter:null}),setTimeout(()=>e.current?.render(),bt.FILTER_RESET),!0):!1,[o,e]),f=_.useCallback((w,M)=>{switch(M){case"vintage":return Pe(w);case"dramatic":return De(w);case"vivid":return Ne(w);case"noir":return Be(w);case"sunset":return Le(w);case"ocean":return Oe(w);default:return w}},[]),v=_.useCallback(async w=>{if(!e.current)return;let M=e.current.getImageData();if(M){for(const[I,E]of Object.entries(i))if(I!==w&&E>0&&m.includes(I))for(let R=0;R<E;R++)["sharpen","emboss","oil"].includes(I)?M=await a(M,I):M=f(M,I);e.current.setImageData(M)}},[i,s,m,a,f,e]),b=_.useCallback(w=>{const M=r?.filter===w;o({filter:M?null:w}),setTimeout(()=>e.current?.render(),bt.FILTER_RESET)},[r?.filter,o,e]),k=_.useCallback(async w=>{const M=i[w.id]||0,I=M>=3?0:M+1,E={...i,[w.id]:I};if(s(E),M>=3){const R=(r?.appliedFilters||[]).filter(A=>A.type!==w.id);o({appliedFilters:R}),e.current&&(e.current.resetToOriginal(),await v(w.id));return}h(w.id);try{if(!e.current)return;const R=e.current.getImageData();if(!R)return;let A;if(["sharpen","emboss","oil"].includes(w.id))try{await new Promise(z=>setTimeout(z,100)),A=await a(R,w.id)}catch(z){console.error(`Failed to apply ${w.id} filter:`,z);return}else A=f(R,w.id);e.current.setImageData(A);const L=[...r?.appliedFilters||[],{type:w.id,value:1}];o({appliedFilters:L})}finally{h(null)}},[i,s,r?.appliedFilters,o,e,a,f,v]),S=_.useCallback(async w=>{x(w)||(g.includes(w.id)?b(w.id):m.includes(w.id)&&await k(w))},[x,g,m,b,k]),y=_.useMemo(()=>{const w=t.filter(E=>g.includes(E.id)),M=t.filter(E=>["vintage","dramatic","vivid","noir","sunset","ocean"].includes(E.id)),I=t.filter(E=>["sharpen","emboss","oil"].includes(E.id));return{reset:[],all:t.filter(E=>E.name!=="Original"&&E.id!=="original"),basic:w,artistic:M,enhance:I}},[t,g]),C=_.useCallback(()=>{o({filter:null,appliedFilters:[]}),s({}),e.current&&e.current.resetToOriginal?.()},[o,s,e]),j=_.useCallback(()=>y[d]||[],[y,d]);return n.jsxs("div",{className:"dk-image-editor__filter-controls",children:[n.jsxs("div",{className:"d-flex align-items-center gap-2 mb-2",children:[(r?.filter||Object.values(i).some(w=>w>0))&&n.jsx("button",{className:"dk-image-editor__tool-button",onClick:C,children:n.jsx(yt,{size:14})}),n.jsx("button",{className:`dk-image-editor__tool-button ${d==="basic"?"active":""}`,onClick:()=>u("basic"),children:l("filter.basic")}),n.jsx("button",{className:`dk-image-editor__tool-button ${d==="artistic"?"active":""}`,onClick:()=>u("artistic"),children:l("filter.artistic")}),n.jsx("button",{className:`dk-image-editor__tool-button ${d==="enhance"?"active":""}`,onClick:()=>u("enhance"),children:l("filter.enhance")})]}),n.jsx("div",{className:"dk-image-editor__toolbar",children:j().map(w=>{const M=g.includes(w.id),I=m.includes(w.id);return n.jsx(We,{filterId:w.id,name:w.name,isActive:M&&r?.filter===w.id,onClick:()=>S(w),isLoading:c===w.id,filterType:I?"apply":"toggle",clickCount:I?i[w.id]||0:void 0},w.id)})})]})};var Xe='.dk-image-editor__frame-list{display:flex;gap:12px}.dk-image-editor__frame-option{align-items:center;background:hsla(0,0%,100%,.05);border:2px solid transparent;border-radius:8px;cursor:pointer;display:flex;flex-direction:column;gap:8px;padding:8px;transition:all .2s ease}.dk-image-editor__frame-option:hover{background:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.3)}.dk-image-editor__frame-option.active{background:rgba(0,123,255,.2);border-color:#007bff}.dk-image-editor__frame-preview{align-items:center;display:flex;height:48px;justify-content:center;overflow:hidden;position:relative;width:48px}.dk-image-editor__frame-preview svg,.dk-image-editor__frame-preview>div{height:42px;width:42px}.dk-image-editor__frame-preview-content{background:linear-gradient(45deg,#f0f0f0 25%,transparent 0),linear-gradient(-45deg,#f0f0f0 25%,transparent 0),linear-gradient(45deg,transparent 75%,#f0f0f0 0),linear-gradient(-45deg,transparent 75%,#f0f0f0 0);background-position:0 0,0 4px,4px -4px,-4px 0;background-size:8px 8px;height:100%;width:100%}.dk-image-editor__frame-preview.none{border:none}.dk-image-editor__frame-preview.solid-border{border:3px solid #333}.dk-image-editor__frame-preview.rounded-border{border:3px solid #333;border-radius:8px}.dk-image-editor__frame-preview.shadow-effect{border:1px solid #ddd;box-shadow:0 4px 12px rgba(0,0,0,.3)}.dk-image-editor__frame-preview.polaroid-style{background:#fff;border:1px solid #ddd;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:4px 4px 8px}.dk-image-editor__frame-preview.vintage-frame{background:#f4e4bc;border:4px solid #8b4513;position:relative}.dk-image-editor__frame-preview.vintage-frame:before{border:1px solid #654321;bottom:2px;content:"";left:2px;position:absolute;right:2px;top:2px}.dk-image-editor__frame-preview.modern-frame{background:linear-gradient(45deg,#ecf0f1,#bdc3c7);border:2px solid #2c3e50}.dk-image-editor__frame-preview.classic-frame{background:#ecf0f1;border:3px solid #34495e;position:relative}.dk-image-editor__frame-preview.classic-frame:before{border:1px solid #7f8c8d;bottom:3px;content:"";left:3px;position:absolute;right:3px;top:3px}.dk-image-editor__frame-name{color:hsla(0,0%,100%,.7);font-size:10px;font-weight:500;position:absolute;text-align:center;top:50%;transform:translateY(-50%) scale(.7)}.dk-image-editor__frame-option.active .dk-image-editor__frame-name{color:#007bff;font-weight:600}';_t(Xe);const Ye=({editorState:r,editorRef:t,onStateChange:e})=>{const{t:i}=N(),o=ke.map(([a])=>({id:a,name:i(`frame.${a}`),svg:a==="none"?null:a==="solidSharp"?n.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"100%",height:"100%",strokeWidth:"1",stroke:"currentColor",fill:"none",children:n.jsx("rect",{strokeWidth:"5",x:"0",y:"0",width:"100%",height:"100%"})}):a==="solidRound"?n.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"100%",height:"100%",strokeWidth:"1",stroke:"currentColor",fill:"none",children:n.jsx("rect",{strokeWidth:"5",x:"0",y:"0",width:"100%",height:"100%",rx:"12%"})}):a==="lineSingle"?n.jsx("div",{style:{inset:"0.5em",boxShadow:"currentcolor 0px 0px 0px 1px inset"}}):a==="lineMultiple"?n.jsx("div",{style:{border:"3px double #eee"}}):a==="edgeCross"?n.jsxs(n.Fragment,{children:[n.jsx("div",{style:{inset:"-0.5em 0.5em",boxShadow:"currentcolor 0px 0px 0px 1px inset",position:"absolute",width:"initial",height:"initial"}}),n.jsx("div",{style:{inset:"0.5em -0.5em",boxShadow:"currentcolor 0px 0px 0px 1px inset",position:"absolute",width:"initial",height:"initial"}})]}):a==="edgeSeparate"?n.jsxs(n.Fragment,{children:[n.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",top:"0.75em",left:"0.5em",bottom:"0.75em",borderLeft:"1px solid"}}),n.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",top:"0.75em",right:"0.5em",bottom:"0.75em",borderRight:"1px solid"}}),n.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",top:"0.5em",left:"0.75em",right:"0.75em",borderTop:"1px solid"}}),n.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",bottom:"0.5em",left:"0.75em",right:"0.75em",borderBottom:"1px solid"}})]}):a==="edgeOverlap"?n.jsxs(n.Fragment,{children:[n.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",top:"0.3125em",left:"0.5em",bottom:"0.3125em",borderLeft:"1px solid"}}),n.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",top:"0.3125em",right:"0.5em",bottom:"0.3125em",borderRight:"1px solid"}}),n.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",top:"0.5em",left:"0.3125em",right:"0.3125em",borderTop:"1px solid"}}),n.jsx("div",{style:{height:"initial",width:"initial",position:"absolute",bottom:"0.5em",left:"0.3125em",right:"0.3125em",borderBottom:"1px solid"}})]}):a==="hook"?n.jsxs(n.Fragment,{children:[n.jsx("div",{style:{position:"absolute",top:"0.5em",left:"0.5em",width:"0.75em",height:"0.75em",borderLeft:"1px solid",borderTop:"1px solid"}}),n.jsx("div",{style:{position:"absolute",top:"0.5em",right:"0.5em",width:"0.75em",height:"0.75em",borderRight:"1px solid",borderTop:"1px solid"}}),n.jsx("div",{style:{position:"absolute",bottom:"0.5em",left:"0.5em",width:"0.75em",height:"0.75em",borderLeft:"1px solid",borderBottom:"1px solid"}}),n.jsx("div",{style:{position:"absolute",bottom:"0.5em",right:"0.5em",width:"0.75em",height:"0.75em",borderRight:"1px solid",borderBottom:"1px solid"}})]}):a==="polaroid"?n.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"100%",height:"100%",strokeWidth:"1",stroke:"currentColor",fill:"none",children:n.jsx("rect",{strokeWidth:"20%",x:"-5%",y:"-5%",width:"110%",height:"96%"})}):null})),s=_.useCallback(a=>{e({frame:a}),setTimeout(()=>t.current?.render(),50)},[e,t]);return _.useCallback(()=>{e({frame:"none"}),setTimeout(()=>t.current?.render(),50)},[e,t]),n.jsx("div",{className:"dk-image-editor__frame-controls",children:n.jsx("div",{className:"dk-image-editor__frame-list",children:o.map(a=>n.jsxs("div",{className:`dk-image-editor__frame-option ${r?.frame===a.id?"active":""}`,onClick:()=>s(a.id),children:[n.jsx("div",{className:"dk-image-editor__frame-preview",children:a.svg||n.jsx("span",{})}),n.jsx("span",{className:"dk-image-editor__frame-name",children:a.name})]},a.id))})})},Rt={editorState:null,textEditing:{editingText:null,editingValue:"",editingTextItem:null},uiState:{activeTool:"crop",isVisible:!0,hasSelection:!1,selectedFinetuneOption:"brightness",lastAnnotateColor:"#ff0000",zoomLevel:1,currentAnnotation:null,currentSticker:null},isImageLoading:!1};function Ge(r,t){switch(t.type){case"SET_EDITOR_STATE":return{...r,editorState:t.payload};case"UPDATE_TEXT_EDITING":return{...r,textEditing:{...r.textEditing,...t.payload}};case"UPDATE_UI_STATE":return{...r,uiState:{...r.uiState,...t.payload}};case"SET_IMAGE_LOADING":return{...r,isImageLoading:t.payload};case"RESET_ALL_STATE":return Rt;default:return r}}const At=_.createContext(null),Ze=({children:r})=>{const[t,e]=_.useReducer(Ge,Rt),i=_.useRef(null),o=_.useRef(null),s=_.useRef(null),a=_.useRef(null),l=_.useRef(null),c=_.useRef(null),h=_.useRef(null),d=_.useRef(null),u=_.useRef(null),p=_.useRef(null),g=_.useMemo(()=>({canvasRef:i,editorRef:o,cropPluginRef:s,filterPluginRef:a,annotatePluginRef:l,stickerPluginRef:c,finetunePluginRef:h,imagePluginRef:d,selectionPluginRef:u,advancedFilterPluginRef:p}),[]),m=_.useMemo(()=>({state:t,dispatch:e,refs:g}),[t,e,g]);return n.jsx(At.Provider,{value:m,children:r})},st=()=>{const r=_.useContext(At);if(!r)throw new Error("useEditorContext must be used within EditorProvider");return r},zt=()=>{const{state:r}=st();return r.editorState},Pt=()=>{const{state:r}=st();return r.textEditing},dt=()=>{const{state:r}=st();return r.uiState},He=()=>{const{state:r}=st();return r.isImageLoading},ut=()=>{const{dispatch:r}=st();return _.useMemo(()=>({setEditorState:t=>r({type:"SET_EDITOR_STATE",payload:t}),updateTextEditing:t=>r({type:"UPDATE_TEXT_EDITING",payload:t}),updateUIState:t=>r({type:"UPDATE_UI_STATE",payload:t}),setImageLoading:t=>r({type:"SET_IMAGE_LOADING",payload:t}),resetAllState:()=>r({type:"RESET_ALL_STATE"})}),[r])},nt=()=>{const{refs:r}=st();return r},Ve=({cropPresets:r,filters:t,annotateTools:e,finetuneOptions:i,onStateChange:o,applyAdvancedFilter:s})=>{const{activeTool:a,selectedFinetuneOption:l,lastAnnotateColor:c,zoomLevel:h,currentAnnotation:d,currentSticker:u}=dt(),p=zt(),{editorRef:g,stickerPluginRef:m,selectionPluginRef:x,imagePluginRef:f}=nt(),{updateUIState:v}=ut(),b=p?.filterCounts||{},k=E=>v({currentAnnotation:E}),S=E=>v({selectedFinetuneOption:E}),y=E=>v({lastAnnotateColor:E}),C=E=>v({hasSelection:E}),j=E=>o({filterCounts:E}),w=E=>v({currentSticker:E}),M=p||{crop:{x:0,y:0,width:0,height:0},rotation:0,flipX:!1,flipY:!1,scale:1,skewX:0,skewY:0,brightness:0,contrast:0,saturation:0,exposure:0,gamma:0,vignette:0,filter:"none",appliedFilters:[],annotations:[],stickers:[],images:[],backgroundColor:"transparent",frame:"none",filterCounts:{}},I=_.useMemo(()=>({editorState:M,editorRef:g,onStateChange:o}),[M,g,o]);return!a||a==="select"?n.jsx(n.Fragment,{}):n.jsxs("div",{className:"dk-image-editor__controls",children:[a==="crop"&&n.jsx(se,{...I,cropPresets:r}),a==="finetune"&&n.jsx(Ce,{...I,selectedFinetuneOption:l,finetuneOptions:i,setSelectedFinetuneOption:S}),a==="annotate"&&n.jsx(Re,{currentAnnotation:d,lastAnnotateColor:c,annotateTools:e,setCurrentAnnotation:k,setLastAnnotateColor:y}),a==="sticker"&&n.jsx(Ae,{editorRef:g,stickerPluginRef:m,selectionPluginRef:x,imagePluginRef:f,zoomLevel:h,setHasSelection:C,currentSticker:u,setCurrentSticker:w}),a==="filter"&&n.jsx($e,{...I,filters:t,filterCounts:b,setFilterCounts:j,applyAdvancedFilter:s}),a==="frame"&&n.jsx(Ye,{...I})]})};function Ke(r){const t=r.size||r.width||16,e=r.size||r.height||16;return n.jsxs("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M8 8h8v8H8V8z"}),n.jsx("path",{d:"M4 12V4h8"}),n.jsx("path",{d:"M12 20h8v-8"})]})}function qe(r){const t=r.size||r.width||16,e=r.size||r.height||16;return n.jsxs("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[n.jsx("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"}),n.jsx("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"})]})}function Qe(r){const t=r.size||r.width||16,e=r.size||r.height||16;return n.jsx("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:n.jsx("path",{d:"M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14zM10 11v6M14 11v6"})})}function Je(r){const t=r.size||r.width||16,e=r.size||r.height||16;return n.jsxs("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M7 10l5 5 5-5"}),n.jsx("path",{d:"M12 5v10"})]})}function ti(r){const t=r.size||r.width||16,e=r.size||r.height||16;return n.jsxs("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M7 14l5-5 5 5"}),n.jsx("path",{d:"M12 19V9"})]})}function ei(r){const t=r.size||r.width||16,e=r.size||r.height||16;return n.jsxs("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M8 8h8v8H8V8z",opacity:"0.5"}),n.jsx("path",{d:"M4 4h8v8H4V4z"}),n.jsx("path",{d:"M12 12h8v8h-8v-8z"})]})}const X={MIN_FONT_SIZE:12,MAX_FONT_SIZE:72,FONT_SIZE_STEP:2,FOCUS_DELAY:10},ii=({visible:r,editingText:t,editingTextItem:e,selectionPluginRef:i,onDelete:o,onCopy:s,onMoveToFront:a,onMoveToBack:l,onMoveUp:c,onMoveDown:h,onTextItemChange:d})=>{const{t:u}=N(),p=i.current?.isMultipleSelection()||!1,g=i.current?.getSelectedCount()||0,m=i.current?.getSelectedItem(),x=m&&m.type==="text"&&!t,f=m&&!t&&m.type!=="text",v=()=>{setTimeout(()=>document.querySelector("[contenteditable]")?.focus(),X.FOCUS_DELAY)},b=w=>{e&&(d({...e,...w}),v())},k=w=>{if(m&&m.type==="text"){i.current?.updateSelectedItemColors(w.color,void 0);const M={...m,...w};i.current?.updateSelectedTextProperties(M)}},S=w=>{i.current?.updateSelectedItemColors(w,void 0)},y=w=>{i.current?.updateSelectedItemColors(void 0,w)},C=()=>{i.current?.updateSelectedItemColors(void 0,"transparent")},j=w=>{i.current?.updateSelectedItemStrokeWidth(w)};return r?n.jsxs("div",{className:"dk-image-editor__floating-toolbar floatingToolbar",children:[n.jsx("button",{onClick:o,className:"dk-image-editor__toolbar-button",title:p?u("toolbar.delete.multi",{count:g}):u("toolbar.delete"),children:n.jsx(Qe,{})}),n.jsx("button",{onClick:s,className:"dk-image-editor__toolbar-button",title:p?u("toolbar.copy.multi",{count:g}):u("toolbar.copy"),children:n.jsx(qe,{})}),!p&&n.jsxs(n.Fragment,{children:[n.jsx("button",{onClick:a,className:"dk-image-editor__toolbar-button",title:u("toolbar.front"),children:n.jsx(Ke,{})}),n.jsx("button",{onClick:l,className:"dk-image-editor__toolbar-button",title:u("toolbar.back"),children:n.jsx(ei,{})}),n.jsx("button",{onClick:c,className:"dk-image-editor__toolbar-button",title:u("toolbar.forward"),children:n.jsx(ti,{})}),n.jsx("button",{onClick:h,className:"dk-image-editor__toolbar-button",title:u("toolbar.backward"),children:n.jsx(Je,{})})]}),p&&n.jsx("span",{className:"d-flex align-items-center",style:{color:"white",fontSize:"12px",padding:"0 8px"},children:u("toolbar.selected.count",{count:g})}),t&&e&&n.jsxs(n.Fragment,{children:[n.jsx("div",{style:{width:"1px",height:"24px",background:"rgba(255,255,255,0.3)",margin:"0 4px"}}),n.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.bold"),onClick:()=>b({fontWeight:e.fontWeight==="bold"?"normal":"bold"}),children:n.jsx("strong",{children:"B"})}),n.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.italic"),onClick:()=>b({fontStyle:e.fontStyle==="italic"?"normal":"italic"}),children:n.jsx("em",{children:"I"})}),n.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.underline"),onClick:()=>b({textDecoration:e.textDecoration==="underline"?"none":"underline"}),children:n.jsx("u",{children:"U"})}),n.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.strikethrough"),onClick:()=>b({textDecoration:e.textDecoration==="line-through"?"none":"line-through"}),children:n.jsx("s",{children:"S"})}),n.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.font.smaller"),onClick:()=>b({fontSize:Math.max(X.MIN_FONT_SIZE,(e.fontSize||U.DEFAULT_FONT_SIZE)-X.FONT_SIZE_STEP)}),children:"A-"}),n.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.font.larger"),onClick:()=>b({fontSize:Math.min(X.MAX_FONT_SIZE,(e.fontSize||U.DEFAULT_FONT_SIZE)+X.FONT_SIZE_STEP)}),children:"A+"}),n.jsx(G,{value:e.color||"#000000",onChange:w=>b({color:w}),title:u("toolbar.text.color")})]}),x&&!p&&n.jsxs(n.Fragment,{children:[n.jsx("div",{style:{width:"1px",height:"24px",background:"rgba(255,255,255,0.3)",margin:"0 4px"}}),n.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.bold"),onClick:()=>k({fontWeight:m.fontWeight==="bold"?"normal":"bold"}),children:n.jsx("strong",{children:"B"})}),n.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.italic"),onClick:()=>k({fontStyle:m.fontStyle==="italic"?"normal":"italic"}),children:n.jsx("em",{children:"I"})}),n.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.underline"),onClick:()=>k({textDecoration:m.textDecoration==="underline"?"none":"underline"}),children:n.jsx("u",{children:"U"})}),n.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.strikethrough"),onClick:()=>k({textDecoration:m.textDecoration==="line-through"?"none":"line-through"}),children:n.jsx("s",{children:"S"})}),n.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.font.smaller"),onClick:()=>k({fontSize:Math.max(X.MIN_FONT_SIZE,(m.fontSize||U.DEFAULT_FONT_SIZE)-X.FONT_SIZE_STEP)}),children:"A-"}),n.jsx("button",{className:"dk-image-editor__toolbar-button",title:u("toolbar.font.larger"),onClick:()=>k({fontSize:Math.min(X.MAX_FONT_SIZE,(m.fontSize||U.DEFAULT_FONT_SIZE)+X.FONT_SIZE_STEP)}),children:"A+"}),n.jsx(G,{value:m.color||"#000000",onChange:w=>k({color:w}),title:u("toolbar.text.color")})]}),f&&!p&&n.jsxs(n.Fragment,{children:[n.jsx("div",{style:{width:"1px",height:"24px",background:"rgba(255,255,255,0.3)",margin:"0 4px"}}),n.jsx(G,{value:m?.strokeColor||m?.color||"#000000",onChange:S,title:u("toolbar.stroke.color")}),n.jsx("select",{value:m?.strokeWidth||2,onChange:w=>j(Number(w.target.value)),style:{background:"transparent",border:"#ffffff20",borderRadius:"4px",color:"white",fontSize:"12px"},title:u("toolbar.stroke.width"),children:[1,2,3,4,5,6,8,10,12,15,20].map(w=>n.jsxs("option",{value:w,style:{background:"#333",color:"white"},children:[w,"px"]},w))}),m?.type!=="line"&&m?.type!=="sharpie"&&m?.type!=="path"&&n.jsxs("div",{className:"d-flex align-items-center gap-50",children:[n.jsx(G,{value:m?.fillColor||"#ffffff",onChange:y,title:u("toolbar.fill.color")}),m?.fillColor&&m?.fillColor!=="transparent"&&n.jsx("span",{className:"text-white hover",onClick:C,title:u("toolbar.clear.fill"),children:"\u2715"})]})]})]}):null},oi=({editingText:r,editingValue:t,editingTextItem:e,canvasRef:i,zoomLevel:o,onValueChange:s,onBlur:a})=>{if(!r||!i.current)return null;const l=i.current,c=l.getBoundingClientRect(),h=l.parentElement?.getBoundingClientRect(),d=c.width/l.width,u=r.x/l.width*c.width+(d>1?0:(c.left||0)-(h?.left||0)),p=r.y/l.height*c.height+(d>1?0:(c.top||0)-(h?.top||0))-(e?.fontSize||U.DEFAULT_FONT_SIZE)*d;return n.jsx("div",{contentEditable:!0,suppressContentEditableWarning:!0,onInput:g=>s(g.currentTarget.textContent||""),onBlur:g=>{g.relatedTarget&&g.relatedTarget.closest(".floatingToolbar")||a()},onKeyDown:g=>{g.key==="Enter"&&!g.shiftKey&&(g.preventDefault(),g.currentTarget.blur())},ref:g=>{if(g&&r){g.textContent=t,g.focus();const m=document.createRange();m.selectNodeContents(g);const x=window.getSelection();x?.removeAllRanges(),x?.addRange(m)}},style:{position:"absolute",left:u,top:p,zIndex:1e3,padding:"0",border:"1px solid #007bff",borderRadius:"2px",background:"transparent",color:e?.color||"white",fontSize:`${(e?.fontSize||U.DEFAULT_FONT_SIZE)*o}px`,fontWeight:e?.fontWeight||"normal",fontStyle:e?.fontStyle||"normal",textDecoration:e?.textDecoration||"none",minWidth:`${100*o}px`,outline:"none",whiteSpace:"nowrap",transform:r.rotation?`rotate(${r.rotation}deg)`:"none",transformOrigin:"left baseline",lineHeight:"1"}})},si=({onMouseDown:r,onMouseMove:t,onMouseUp:e,onDoubleClick:i})=>{const{activeTool:o,hasSelection:s,zoomLevel:a}=dt(),{editingText:l,editingValue:c,editingTextItem:h}=Pt(),{canvasRef:d,selectionPluginRef:u,editorRef:p}=nt(),{updateTextEditing:g,updateUIState:m}=ut(),x=k=>{g({editingTextItem:k})},f=k=>{g({editingValue:k})},v=()=>{if(h&&h.id){const k=p.current?.getState();if(k){const S={...h,text:c,id:h.id,type:h.type||"text",x:h.x||0,y:h.y||0,color:h.color||"#000000",strokeWidth:h.strokeWidth||1},y=[...k.annotations||[],S];p.current?.setState({annotations:y}),g({editingText:null,editingValue:"",editingTextItem:null}),m({hasSelection:!1}),p.current?.render()}}},b=k=>{const S=u.current?.selectedItem;if(S&&p.current){const y={front:"moveToFront",back:"moveToBack",forward:"moveForward",backward:"moveBackward"};p.current[y[k]](S.id)}};return n.jsxs("div",{className:"dk-image-editor__canvas",children:[n.jsx(ii,{visible:s||!!l,editingText:l,editingTextItem:h,selectionPluginRef:u,onDelete:()=>u.current?.deleteSelected(),onCopy:()=>u.current?.copySelected(),onMoveToFront:()=>b("front"),onMoveToBack:()=>b("back"),onMoveUp:()=>b("forward"),onMoveDown:()=>b("backward"),onTextItemChange:x}),n.jsx(oi,{editingText:l,editingValue:c,editingTextItem:h,canvasRef:d,zoomLevel:a,onValueChange:f,onBlur:v}),n.jsx("canvas",{ref:d,className:`dk-image-editor__image-canvas dk-image-editor__image-canvas--${o}`,onMouseDown:r,onMouseMove:t,onMouseUp:e,onDoubleClick:i})]})};function ni(r){const t=r.size||r.width||16,e=r.size||r.height||16;return n.jsxs("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M21 7v6h-6"}),n.jsx("path",{d:"M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"})]})}function ai(r){const t=r.size||r.width||16,e=r.size||r.height||16;return n.jsxs("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M3 7v6h6"}),n.jsx("path",{d:"M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"})]})}function ri(r){const t=r.size||r.width||16,e=r.size||r.height||16;return n.jsxs("svg",{...r,width:t,height:e,className:r.className,style:r.style,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),n.jsx("polyline",{points:"7,10 12,5 17,10"}),n.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"15"})]})}const li=({size:r=16,className:t=""})=>n.jsxs("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:t,children:[n.jsx("circle",{cx:"11",cy:"11",r:"8"}),n.jsx("path",{d:"m21 21-4.35-4.35"}),n.jsx("line",{x1:"11",y1:"8",x2:"11",y2:"14"}),n.jsx("line",{x1:"8",y1:"11",x2:"14",y2:"11"})]}),ci=({size:r=16,className:t=""})=>n.jsxs("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:t,children:[n.jsx("circle",{cx:"11",cy:"11",r:"8"}),n.jsx("path",{d:"m21 21-4.35-4.35"}),n.jsx("line",{x1:"8",y1:"11",x2:"14",y2:"11"})]}),gt={MIN_ZOOM:.5,MAX_ZOOM:3,ZOOM_IN_FACTOR:1.2,ZOOM_OUT_FACTOR:.8,TRANSITION_DURATION:200},hi=()=>{const{zoomLevel:r}=dt(),{updateUIState:t}=ut(),{canvasRef:e,selectionPluginRef:i}=nt(),{t:o}=N(),s=_.useRef(null),a=p=>{document.querySelectorAll(".dk-img-editor-selection-overlay").forEach(g=>{g.style.display=p?"":"none"})},l=()=>{s.current&&clearTimeout(s.current),s.current=setTimeout(()=>{i.current?.refreshSelection?.(),a(!0)},gt.TRANSITION_DURATION)},c=(p,g=!0)=>{const m=e.current,x=m?.parentElement;if(!m||!x)return;a(!1);const f=x.getBoundingClientRect(),v=m.width*p,b=m.height*p;if(m.style.transform=`scale(${p})`,t({zoomLevel:p}),p<=1||v<=f.width&&b<=f.height)m.style.transformOrigin="center",x.scrollTo({left:0,top:0});else{const k=(x.scrollLeft+f.width/2)/r,S=(x.scrollTop+f.height/2)/r,y=k*p-f.width/2,C=S*p-f.height/2;m.style.transformOrigin="0 0",x.scrollTo({left:Math.max(0,y),top:Math.max(0,C)})}g&&l()},h=()=>{const p=Math.min(gt.MAX_ZOOM,r*gt.ZOOM_IN_FACTOR);c(p)},d=()=>c(1),u=()=>{const p=Math.max(gt.MIN_ZOOM,r*gt.ZOOM_OUT_FACTOR);c(p)};return n.jsxs(n.Fragment,{children:[n.jsx("button",{onClick:h,className:"dk-image-editor__action-btn",title:o("header.zoom.in"),children:n.jsx(li,{size:16})}),n.jsxs("button",{onClick:d,className:"dk-image-editor__action-btn",title:o("header.zoom.reset"),children:[Math.round(r*100),"%"]}),n.jsx("button",{onClick:u,className:"dk-image-editor__action-btn",title:o("header.zoom.out"),children:n.jsx(ci,{size:16})})]})},di=({onClose:r,onConfirm:t,onUndo:e,onRedo:i,onSave:o,onUpload:s,showCloseButton:a=!0,showDownloadButton:l=!0})=>{const{t:c}=N(),{canvasRef:h,selectionPluginRef:d}=nt(),u=_.useRef(null),p=()=>{u.current?.click()};return n.jsxs("div",{className:"dk-image-editor__header",children:[n.jsxs("div",{className:"dk-image-editor__header-left",children:[n.jsx("input",{ref:u,type:"file",accept:"image/*",onChange:g=>{const m=g.target.files?.[0];m&&s&&s(m),g.target.value=""},style:{display:"none"}}),n.jsx("button",{onClick:p,className:"dk-image-editor__action-btn",title:c("header.upload"),children:n.jsx(ri,{})}),n.jsx("button",{onClick:()=>{e(),d.current?.clearSelection()},className:"dk-image-editor__action-btn",title:c("header.undo"),children:n.jsx(ai,{})}),n.jsx("button",{onClick:()=>{i(),d.current?.clearSelection()},className:"dk-image-editor__action-btn",title:c("header.redo"),children:n.jsx(ni,{})}),n.jsx(hi,{})]}),n.jsxs("div",{className:"dk-image-editor__header-right ms-2",children:[l&&n.jsx("button",{onClick:o,className:"dk-image-editor__save-btn",children:c("header.download")}),t&&n.jsx("button",{onClick:t,className:"dk-image-editor__confirm-btn",children:c("header.confirm")}),a&&n.jsx("button",{onClick:()=>{confirm(c("header.close.confirm"))&&r()},className:"dk-image-editor__action-btn",children:c("header.close")})]})]})},ui=({tools:r})=>{const{activeTool:t}=dt(),{updateUIState:e}=ut(),{t:i}=N();return n.jsx("div",{className:"dk-image-editor__sidebar",children:r.map(o=>n.jsxs("button",{className:`dk-image-editor__tool-btn ${t===o.id?"dk-image-editor__tool-btn--active":""}`,onClick:()=>e({activeTool:o.id}),children:[n.jsx("span",{className:"dk-image-editor__tool-icon",children:o.icon}),n.jsx("span",{className:"dk-image-editor__tool-name",children:i(`tool.${o.id}`)})]},o.id))})},gi=()=>{const{editorRef:r,cropPluginRef:t,filterPluginRef:e,annotatePluginRef:i,stickerPluginRef:o,finetunePluginRef:s,imagePluginRef:a,selectionPluginRef:l,advancedFilterPluginRef:c}=nt();return{editorRef:r,cropPluginRef:t,filterPluginRef:e,annotatePluginRef:i,stickerPluginRef:o,finetunePluginRef:s,imagePluginRef:a,selectionPluginRef:l,advancedFilterPluginRef:c,applyAdvancedFilter:async(h,d)=>{if(!c.current)throw new Error("AdvancedFilterPlugin not initialized");return console.log(" advancedFilterPluginRef.current",c.current,h,d),await c.current.applyAdvancedFilter(h,d)}}};class Dt{constructor(t){this.image=null,this.originalImage=null,this.imageDisplay={x:0,y:0,width:0,height:0},this.history=[],this.historyIndex=-1,this.plugins=new Map,this.eventListeners=new Map,this.resizeObserver=null,this.canvas=t,this.ctx=t.getContext("2d"),this.state=this.getInitialState(),this.setupCanvasResize()}isSticker(t){return"sticker"in t}setupCanvasResize(){this.resizeObserver=new ResizeObserver(()=>this.updateCanvasSize()),this.canvas.parentElement&&this.resizeObserver.observe(this.canvas.parentElement)}updateCanvasSize(){const t=this.canvas.parentElement;if(!t)return;const e=t.getBoundingClientRect();this.canvas.width=Math.floor(e.width),this.canvas.height=Math.floor(e.height),this.image&&(this.calculateImageDisplay(),this.render())}calculateImageDisplay(){if(!this.image)return;const t=this.image.width/this.image.height,e=this.canvas.width/this.canvas.height,i=.8,[o,s]=t>e?[this.canvas.width*i,this.canvas.width*i/t]:[this.canvas.height*i*t,this.canvas.height*i],a=(this.canvas.width-o)/2,l=(this.canvas.height-s)/2,c=this.imageDisplay.width===0;this.imageDisplay={x:a,y:l,width:o,height:s},c&&this.setState({crop:{x:a,y:l,width:o,height:s}},!1)}getInitialState(){return{crop:{x:0,y:0,width:0,height:0},rotation:0,flipX:!1,flipY:!1,scale:1,skewX:0,skewY:0,brightness:0,contrast:0,saturation:0,exposure:0,gamma:0,vignette:0,filter:"none",appliedFilters:[],annotations:[],stickers:[],images:[],backgroundColor:"transparent",frame:"none",filterCounts:{}}}on(t,e){this.eventListeners.has(t)||this.eventListeners.set(t,[]),this.eventListeners.get(t).push(e)}off(t,e){const i=this.eventListeners.get(t);if(!i)return;const o=i.indexOf(e);o>-1&&i.splice(o,1)}emit(t,e){this.eventListeners.get(t)?.forEach(i=>i(e))}addPlugin(t){this.plugins.set(t.name,t),t.init?.(this.canvas,this.ctx),t.initialize?.(this),t.updateStickers?.(this.state.stickers),t.updateAnnotations?.(this.state.annotations)}removePlugin(t){const e=this.plugins.get(t);e&&(e.destroy(),this.plugins.delete(t))}getState(){return{...this.state}}getImageDisplay(){return{...this.imageDisplay}}getOriginalImageSize(){return this.image?{width:this.image.width,height:this.image.height}:{width:0,height:0}}setState(t,e=!0){const i=s=>s.canvasRotation===void 0?{...s,canvasRotation:this.state.rotation,canvasFlipX:this.state.flipX,canvasFlipY:this.state.flipY,canvasScale:this.state.scale,canvasSkewX:this.state.skewX,canvasSkewY:this.state.skewY}:s;t.stickers&&(t.stickers=t.stickers.map(i)),t.annotations&&(t.annotations=t.annotations.map(i)),t.images&&(t.images=t.images.map(i));const o={...this.state,...t};e&&this.saveToHistory(o),this.state=o,this.plugins.forEach(s=>{t.stickers&&s.updateStickers?.(t.stickers),t.annotations&&s.updateAnnotations?.(t.annotations)}),this.emit("stateChange",o),this.render()}saveToHistory(t){this.history=this.history.slice(0,this.historyIndex+1),this.history.push(JSON.parse(JSON.stringify(t))),this.historyIndex++,this.history.length>50&&(this.history.shift(),this.historyIndex--)}restoreState(t){this.historyIndex=t;const e=this.history[t];e&&(this.state=e,this.emit("stateChange",this.state),this.render())}undo(){this.historyIndex>0&&this.restoreState(this.historyIndex-1)}redo(){this.historyIndex<this.history.length-1&&this.restoreState(this.historyIndex+1)}async loadImage(t){return new Promise((e,i)=>{const o=new Image;o.crossOrigin="anonymous",o.onload=()=>{this.image=o,this.originalImage=o.cloneNode(),this.updateCanvasSize(),this.calculateImageDisplay(),this.emit("imageLoaded",o),e()},o.onerror=i,typeof t=="string"?o.src=t:o.src=URL.createObjectURL(t)})}render(){if(!this.image)return;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.state.backgroundColor!=="transparent"&&(this.ctx.fillStyle=this.state.backgroundColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height));const t=this.plugins.get("crop"),e=t&&t.isActive;this.ctx.save(),!e&&this.state.crop&&(this.ctx.beginPath(),this.ctx.rect(this.state.crop.x,this.state.crop.y,this.state.crop.width,this.state.crop.height),this.ctx.clip());const i=this.imageDisplay.x+this.imageDisplay.width/2,o=this.imageDisplay.y+this.imageDisplay.height/2;this.ctx.translate(i,o),this.ctx.rotate(this.state.rotation*Math.PI/180),this.ctx.scale((this.state.flipX?-1:1)*this.state.scale,(this.state.flipY?-1:1)*this.state.scale),this.ctx.transform(1,this.state.skewY,this.state.skewX,1,0,0),this.applyFilters(),this.ctx.drawImage(this.image,-this.imageDisplay.width/2,-this.imageDisplay.height/2,this.imageDisplay.width,this.imageDisplay.height),this.state.vignette!==0&&this.applyVignette(this.ctx,this.state.vignette),this.ctx.restore(),this.ctx.restore(),this.ctx.save(),this.state.crop&&(this.ctx.beginPath(),this.ctx.rect(this.state.crop.x,this.state.crop.y,this.state.crop.width,this.state.crop.height),this.ctx.clip()),this.getAllItems().sort((a,l)=>(a.zIndex||0)-(l.zIndex||0)).forEach(a=>{this.ctx.save(),this.applyCanvasTransformForItem(a),this.isSticker(a)?this.drawSticker(a):a.type==="image"?this.drawImage(a):this.drawAnnotation(a)}),this.ctx.restore(),this.plugins.forEach(a=>{a.render&&a.name!=="selection"&&a.render(this.ctx)});const s=this.plugins.get("selection");s&&s.render&&s.render(this.ctx),this.state.frame!=="none"&&this.drawFrame(this.state.frame),this.emit("render")}applyFiltersToContext(t){const{brightness:e,contrast:i,saturation:o,exposure:s,gamma:a,filter:l}=this.state,c=[];e&&c.push(`brightness(${100+e}%)`),i&&c.push(`contrast(${100+i}%)`),o&&c.push(`saturate(${100+o}%)`),s&&c.push(`brightness(${100+s*.5}%)`),a&&c.push(`contrast(${100+a*.3}%)`);const h={monoDefault:"grayscale(100%)",sepiaDefault:"sepia(100%)",warm:"sepia(20%) saturate(120%) hue-rotate(15deg)",cold:"saturate(120%) hue-rotate(-15deg)",chrome:"contrast(120%) saturate(150%) hue-rotate(10deg)",fade:"contrast(80%) brightness(110%) saturate(80%)",blur:"blur(3px)"};h[l]&&c.push(h[l]),t.filter=c.join(" ")||"none"}applyFilters(){this.applyFiltersToContext(this.ctx)}applyVignette(t,e){if(!e)return;const{width:i,height:o}=this.imageDisplay,s=Math.sqrt((i/2)**2+(o/2)**2),a=s*.3,l=t.createRadialGradient(0,0,a,0,0,s),c=Math.abs(e)/100*.8;e>0?(l.addColorStop(0,"rgba(0, 0, 0, 0)"),l.addColorStop(.7,"rgba(0, 0, 0, 0)"),l.addColorStop(1,`rgba(0, 0, 0, ${c})`)):(l.addColorStop(0,`rgba(0, 0, 0, ${c})`),l.addColorStop(.7,"rgba(0, 0, 0, 0)"),l.addColorStop(1,"rgba(0, 0, 0, 0)")),t.save(),t.globalCompositeOperation="multiply",t.fillStyle=l,t.fillRect(-i/2,-o/2,i,o),t.restore()}drawAnnotation(t){const e=t.strokeColor||t.color,i=t.fillColor||(t.type==="text"?t.color:"transparent");this.ctx.strokeStyle=e,this.ctx.fillStyle=t.type==="text"?t.color:i,this.ctx.lineWidth=t.strokeWidth,this.applyRotation(t),this.drawAnnotationShape(t),this.ctx.restore()}applyRotation(t){if(!t.rotation)return;const{x:e,y:i,width:o=0,height:s=0,fontSize:a=24,type:l}=t,[c,h]=l==="text"?[e+o/2,i-a/2]:[e+o/2,i+s/2];this.ctx.translate(c,h),this.ctx.rotate(t.rotation*Math.PI/180),this.ctx.translate(-c,-h)}drawAnnotationShape(t){const{type:e,x:i,y:o,width:s=0,height:a=0}=t;switch(e){case"text":this.drawText(t);break;case"rectangle":this.drawRectangle(i,o,s,a);break;case"ellipse":this.drawEllipse(i,o,s,a);break;case"line":this.drawLine(i,o,s,a);break;case"arrow":this.drawArrow(t);break;case"sharpie":case"path":this.drawPath(t.points);break}}drawText(t){if(!t.text||!t.fontSize)return;const e=t.fontWeight||"normal",i=t.fontStyle||"normal";this.ctx.font=`${i} ${e} ${t.fontSize}px Arial`;const o=this.ctx.measureText(t.text).width,s=Math.max(1,t.fontSize/16),a=t.textDecoration;a==="underline"?this.drawTextDecoration(t.x,t.y+2,o,s):a==="line-through"&&this.drawTextDecoration(t.x,t.y-t.fontSize/3,o,s),this.ctx.fillText(t.text,t.x,t.y)}drawTextDecoration(t,e,i,o){const s=this.ctx.lineWidth;this.ctx.lineWidth=o,this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(t+i,e),this.ctx.stroke(),this.ctx.lineWidth=s}drawRectangle(t,e,i,o){!i||!o||(this.ctx.fillStyle!=="transparent"&&this.ctx.fillRect(t,e,i,o),this.ctx.strokeRect(t,e,i,o))}drawEllipse(t,e,i,o){!i||!o||(this.ctx.beginPath(),this.ctx.ellipse(t+i/2,e+o/2,Math.abs(i/2),Math.abs(o/2),0,0,2*Math.PI),this.ctx.fillStyle!=="transparent"&&this.ctx.fill(),this.ctx.stroke())}drawLine(t,e,i,o){!i||!o||(this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(t+i,e+o),this.ctx.stroke())}drawArrow(t){const{x:e,y:i,width:o=0,height:s=0,strokeWidth:a}=t;if(!o||!s)return;const l=e+o,c=i+s,h=Math.max(8,a*2),d=Math.atan2(s,o);this.ctx.beginPath(),this.ctx.moveTo(e,i),this.ctx.lineTo(l,c),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(l-h*Math.cos(d+Math.PI/4),c-h*Math.sin(d+Math.PI/4)),this.ctx.lineTo(l,c),this.ctx.lineTo(l-h*Math.cos(d-Math.PI/4),c-h*Math.sin(d-Math.PI/4)),this.ctx.stroke()}drawPath(t){if(!t||t.length<2)return;this.ctx.beginPath();const e=t[0];e&&(this.ctx.moveTo(e.x,e.y),t.slice(1).forEach(i=>this.ctx.lineTo(i.x,i.y))),this.ctx.stroke()}drawImage(t){const{x:e,y:i,rotation:o,width:s,height:a,image:l}=t;this.ctx.translate(e,i),this.ctx.rotate(o*Math.PI/180),this.ctx.drawImage(l,-s/2,-a/2,s,a),this.ctx.restore()}drawSticker(t){const{x:e,y:i,rotation:o,size:s,type:a,content:l,image:c}=t;this.ctx.translate(e,i),this.ctx.rotate(o*Math.PI/180),a==="emoji"?(this.ctx.font=`${s}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(l,0,0)):a==="image"&&c&&this.ctx.drawImage(c,-s/2,-s/2,s,s),this.ctx.restore()}drawFrame(t){if(!this.state.crop)return;this.ctx.save();const{x:e,y:i,width:o,height:s}=this.state.crop;switch(t){case"undefined":case"none":break;case"solidSharp":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=5,this.ctx.strokeRect(e,i,o,s);break;case"solidRound":this.ctx.fillStyle="#fff";const a=5,l=o*.03;this.ctx.beginPath(),this.ctx.rect(e-a,i-a,o+2*a,s+2*a),this.ctx.roundRect(e,i,o,s,l),this.ctx.fill("evenodd");break;case"lineSingle":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3;const c=o*.05;this.ctx.strokeRect(e+c,i+c,o-2*c,s-2*c);break;case"lineMultiple":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3;const h=o*.075;this.ctx.strokeRect(e+h,i+h,o-2*h,s-2*h),this.ctx.strokeRect(e+h*.5,i+h*.5,o-h,s-h);break;case"edgeCross":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3;const d=o*.05;this.ctx.beginPath(),this.ctx.moveTo(e,i+d),this.ctx.lineTo(e+o,i+d),this.ctx.moveTo(e,i+s-d),this.ctx.lineTo(e+o,i+s-d),this.ctx.moveTo(e+d,i),this.ctx.lineTo(e+d,i+s),this.ctx.moveTo(e+o-d,i),this.ctx.lineTo(e+o-d,i+s),this.ctx.stroke();break;case"edgeOverlap":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3;const u=o*.075,p=o*.05;this.ctx.beginPath(),this.ctx.moveTo(e+p,i+u),this.ctx.lineTo(e+o-p,i+u),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e+p,i+s-u),this.ctx.lineTo(e+o-p,i+s-u),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e+u,i+p),this.ctx.lineTo(e+u,i+s-p),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e+o-u,i+p),this.ctx.lineTo(e+o-u,i+s-p),this.ctx.stroke();break;case"edgeSeparate":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3;const g=o*.03125,m=o*.05;this.ctx.beginPath(),this.ctx.moveTo(e+m,i+g),this.ctx.lineTo(e+o-m,i+g),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e+m,i+s-g),this.ctx.lineTo(e+o-m,i+s-g),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e+g,i+m),this.ctx.lineTo(e+g,i+s-m),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e+o-g,i+m),this.ctx.lineTo(e+o-g,i+s-m),this.ctx.stroke();break;case"hook":this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3;const x=o*.075,f=o*.05;this.ctx.beginPath(),this.ctx.moveTo(e+f,i+f+x),this.ctx.lineTo(e+f,i+f),this.ctx.lineTo(e+f+x,i+f),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e+o-f-x,i+f),this.ctx.lineTo(e+o-f,i+f),this.ctx.lineTo(e+o-f,i+f+x),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e+f,i+s-f-x),this.ctx.lineTo(e+f,i+s-f),this.ctx.lineTo(e+f+x,i+s-f),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e+o-f-x,i+s-f),this.ctx.lineTo(e+o-f,i+s-f),this.ctx.lineTo(e+o-f,i+s-f-x),this.ctx.stroke();break;case"polaroid":this.ctx.fillStyle="#fff";const v=o*.05,b=o*.05,k=o*.1;this.ctx.fillRect(e-b,i-v,o+2*b,v),this.ctx.fillRect(e-b,i-v,b,s+v+k),this.ctx.fillRect(e+o,i-v,b,s+v+k),this.ctx.fillRect(e-b,i+s,o+2*b,k);break}this.ctx.restore()}getImageData(){if(!this.image)return null;const t=document.createElement("canvas"),e=t.getContext("2d");return t.width=Math.round(this.imageDisplay.width),t.height=Math.round(this.imageDisplay.height),e.drawImage(this.image,0,0,t.width,t.height),e.getImageData(0,0,t.width,t.height)}resetToOriginal(){this.originalImage&&(this.image=this.originalImage.cloneNode(),this.render())}setImageData(t){const e=document.createElement("canvas"),i=e.getContext("2d");e.width=t.width,e.height=t.height,i.putImageData(t,0,0);const o=new Image;o.onload=()=>{this.image=o,this.render()},o.src=e.toDataURL()}async export(t="blob",e,i){if(!this.originalImage)throw new Error("No image loaded");const o=this.originalImage.width/this.imageDisplay.width;let s=e||Math.round(this.state.crop.width*o),a=i||Math.round(this.state.crop.height*o);if(this.state.frame==="polaroid"){const h=s*.05,d=s*.05,u=s*.1;s+=2*h,a+=d+u}const l=document.createElement("canvas"),c=l.getContext("2d");return l.width=s,l.height=a,c.imageSmoothingEnabled=!1,this.renderToExportCanvas(c,s,a),t==="dataURL"?l.toDataURL("image/png"):new Promise((h,d)=>{l.toBlob(u=>u?h(u):d(new Error("Failed to create blob")),"image/png")})}renderToExportCanvas(t,e,i){if(!this.image)return;t.clearRect(0,0,e,i),this.state.backgroundColor!=="transparent"&&(t.fillStyle=this.state.backgroundColor,t.fillRect(0,0,e,i)),t.save();const o=e/this.state.crop.width,s={x:(this.imageDisplay.x-this.state.crop.x)*o,y:(this.imageDisplay.y-this.state.crop.y)*o,width:this.imageDisplay.width*o,height:this.imageDisplay.height*o},a=s.x+s.width/2,l=s.y+s.height/2;if(t.translate(a,l),t.rotate(this.state.rotation*Math.PI/180),t.scale((this.state.flipX?-1:1)*this.state.scale,(this.state.flipY?-1:1)*this.state.scale),t.transform(1,this.state.skewY,this.state.skewX,1,0,0),this.applyFiltersToContext(t),t.drawImage(this.image,-s.width/2,-s.height/2,s.width,s.height),this.state.vignette!==0&&this.applyVignetteToExport(t,this.state.vignette,s.width,s.height),t.restore(),this.getAllItems().sort((c,h)=>(c.zIndex||0)-(h.zIndex||0)).forEach(c=>{t.save(),this.applyCanvasTransformForItemToExport(t,c,s,o);const h=(c.x-this.state.crop.x)*o,d=(c.y-this.state.crop.y)*o;h>=-100&&h<=e+100&&d>=-100&&d<=i+100&&(this.isSticker(c)?this.drawStickerToExport(t,c,h,d,o):c.type==="image"?this.drawImageToExport(t,c,h,d,o):this.drawAnnotationToExport(t,c,h,d,o)),t.restore()}),this.state.frame!=="none")if(this.state.frame==="polaroid"){const c=e/1.1,h=c*.05,d=c*.05;t.translate(h,d),this.drawFrameToExport(t,this.state.frame,c,i-d-c*.1),t.translate(-h,-d)}else this.drawFrameToExport(t,this.state.frame,e,i)}drawStickerToExport(t,e,i,o,s){if(t.translate(i,o),t.rotate(e.rotation*Math.PI/180),e.type==="emoji")t.font=`${e.size*s}px Arial`,t.textAlign="center",t.textBaseline="middle",t.fillText(e.content,0,0);else if(e.type==="image"&&e.image){const a=e.size*s;t.drawImage(e.image,-a/2,-a/2,a,a)}}drawImageToExport(t,e,i,o,s){t.translate(i,o),t.rotate(e.rotation*Math.PI/180);const a=e.width*s,l=e.height*s;t.drawImage(e.image,-a/2,-l/2,a,l)}drawAnnotationToExport(t,e,i,o,s){const a=e.strokeColor||e.color,l=e.fillColor||(e.type==="text"?e.color:"transparent");if(t.strokeStyle=a,t.fillStyle=e.type==="text"?e.color:l,t.lineWidth=e.strokeWidth*s,e.rotation)if(e.type==="text"){const c=(e.width||0)*s,h=(e.fontSize||24)*s,d=i+c/2,u=o-h/2;t.translate(d,u),t.rotate(e.rotation*Math.PI/180),t.translate(-d,-u)}else{const c=(e.width||0)*s,h=(e.height||0)*s,d=i+c/2,u=o+h/2;t.translate(d,u),t.rotate(e.rotation*Math.PI/180),t.translate(-d,-u)}switch(e.type){case"text":if(e.text&&e.fontSize){const c=e.fontSize*s,h=e.fontWeight||"normal",d=e.fontStyle||"normal";t.font=`${d} ${h} ${c}px Arial`,t.fillText(e.text,i,o)}break;case"rectangle":if(e.width&&e.height){const c=e.width*s,h=e.height*s;l&&l!=="transparent"&&t.fillRect(i,o,c,h),t.strokeRect(i,o,c,h)}break;case"ellipse":if(e.width&&e.height){const c=e.width*s,h=e.height*s;t.beginPath(),t.ellipse(i+c/2,o+h/2,Math.abs(c/2),Math.abs(h/2),0,0,2*Math.PI),l&&l!=="transparent"&&t.fill(),t.stroke()}break;case"line":e.width&&e.height&&(t.beginPath(),t.moveTo(i,o),t.lineTo(i+e.width*s,o+e.height*s),t.stroke());break;case"arrow":if(e.width&&e.height){const c=e.width*s,h=e.height*s,d=i+c,u=o+h,p=Math.max(8,e.strokeWidth*2)*s,g=Math.atan2(h,c);t.beginPath(),t.moveTo(i,o),t.lineTo(d,u),t.stroke(),t.beginPath(),t.moveTo(d-p*Math.cos(g+Math.PI/4),u-p*Math.sin(g+Math.PI/4)),t.lineTo(d,u),t.lineTo(d-p*Math.cos(g-Math.PI/4),u-p*Math.sin(g-Math.PI/4)),t.stroke()}break;case"sharpie":case"path":if(e.points&&e.points.length>1){t.beginPath();const c=e.points[0];if(c){t.moveTo((c.x-this.state.crop.x)*s,(c.y-this.state.crop.y)*s);for(let h=1;h<e.points.length;h++){const d=e.points[h];d&&t.lineTo((d.x-this.state.crop.x)*s,(d.y-this.state.crop.y)*s)}}t.stroke()}break}}drawFrameToExport(t,e,i,o){switch(t.save(),e){case"undefined":case"none":break;case"solidSharp":t.strokeStyle="#fff",t.lineWidth=Math.max(5,i*.01),t.strokeRect(0,0,i,o);break;case"solidRound":t.fillStyle="#fff";const s=Math.max(5,i*.01),a=i*.12;t.beginPath(),t.rect(-s,-s,i+2*s,o+2*s),t.roundRect(0,0,i,o,a),t.fill("evenodd");break;case"lineSingle":t.strokeStyle="#fff",t.lineWidth=Math.max(1,i*.002);const l=i*.05;t.strokeRect(l,l,i-2*l,o-2*l);break;case"lineMultiple":t.strokeStyle="#fff",t.lineWidth=Math.max(3,i*.006);const c=i*.075;t.strokeRect(c,c,i-2*c,o-2*c),t.strokeRect(c*.5,c*.5,i-c,o-c);break;case"edgeCross":t.strokeStyle="#fff",t.lineWidth=Math.max(1,i*.002);const h=i*.05;t.beginPath(),t.moveTo(0,h),t.lineTo(i,h),t.moveTo(0,o-h),t.lineTo(i,o-h),t.moveTo(h,0),t.lineTo(h,o),t.moveTo(i-h,0),t.lineTo(i-h,o),t.stroke();break;case"edgeOverlap":t.strokeStyle="#fff",t.lineWidth=Math.max(1,i*.002);const d=i*.075,u=i*.05;t.beginPath(),t.moveTo(u,d),t.lineTo(i-u,d),t.stroke(),t.beginPath(),t.moveTo(u,o-d),t.lineTo(i-u,o-d),t.stroke(),t.beginPath(),t.moveTo(d,u),t.lineTo(d,o-u),t.stroke(),t.beginPath(),t.moveTo(i-d,u),t.lineTo(i-d,o-u),t.stroke();break;case"edgeSeparate":t.strokeStyle="#fff",t.lineWidth=Math.max(1,i*.002);const p=i*.03125,g=i*.05;t.beginPath(),t.moveTo(g,p),t.lineTo(i-g,p),t.stroke(),t.beginPath(),t.moveTo(g,o-p),t.lineTo(i-g,o-p),t.stroke(),t.beginPath(),t.moveTo(p,g),t.lineTo(p,o-g),t.stroke(),t.beginPath(),t.moveTo(i-p,g),t.lineTo(i-p,o-g),t.stroke();break;case"hook":t.strokeStyle="#fff",t.lineWidth=Math.max(1,i*.002);const m=i*.075,x=i*.05;t.beginPath(),t.moveTo(x,x+m),t.lineTo(x,x),t.lineTo(x+m,x),t.stroke(),t.beginPath(),t.moveTo(i-x-m,x),t.lineTo(i-x,x),t.lineTo(i-x,x+m),t.stroke(),t.beginPath(),t.moveTo(x,o-x-m),t.lineTo(x,o-x),t.lineTo(x+m,o-x),t.stroke(),t.beginPath(),t.moveTo(i-x-m,o-x),t.lineTo(i-x,o-x),t.lineTo(i-x,o-x-m),t.stroke();break;case"polaroid":t.fillStyle="#fff";const f=i*.05,v=i*.05,b=i*.1;t.fillRect(-v,-f,i+2*v,f),t.fillRect(-v,-f,v,o+f+b),t.fillRect(i,-f,v,o+f+b),t.fillRect(-v,o,i+2*v,b);break}t.restore()}applyVignetteToExport(t,e,i,o){if(!e)return;const s=Math.sqrt((i/2)**2+(o/2)**2),a=s*.3,l=t.createRadialGradient(0,0,a,0,0,s),c=Math.abs(e)/100*.8;e>0?(l.addColorStop(0,"rgba(0, 0, 0, 0)"),l.addColorStop(.7,"rgba(0, 0, 0, 0)"),l.addColorStop(1,`rgba(0, 0, 0, ${c})`)):(l.addColorStop(0,`rgba(0, 0, 0, ${c})`),l.addColorStop(.7,"rgba(0, 0, 0, 0)"),l.addColorStop(1,"rgba(0, 0, 0, 0)")),t.save(),t.globalCompositeOperation="multiply",t.fillStyle=l,t.fillRect(-i/2,-o/2,i,o),t.restore()}getAllItems(){return[...this.state.stickers,...this.state.annotations,...this.state.images]}moveToFront(t){const e=Math.max(...this.getAllItems().map(i=>i.zIndex||0));this.updateItemZIndex(t,e+1)}moveToBack(t){const e=Math.min(...this.getAllItems().map(i=>i.zIndex||0));this.updateItemZIndex(t,e-1)}moveForward(t){const e=this.getAllItems(),i=e.find(a=>a.id===t);if(!i)return;const o=i.zIndex||0,s=e.filter(a=>(a.zIndex||0)>o).sort((a,l)=>(a.zIndex||0)-(l.zIndex||0))[0]?.zIndex;s!==void 0&&this.updateItemZIndex(t,s+1)}moveBackward(t){const e=this.getAllItems(),i=e.find(a=>a.id===t);if(!i)return;const o=i.zIndex||0,s=e.filter(a=>(a.zIndex||0)<o).sort((a,l)=>(l.zIndex||0)-(a.zIndex||0))[0]?.zIndex;s!==void 0&&this.updateItemZIndex(t,s-1)}updateItemZIndex(t,e){const i=o=>o.id===t?{...o,zIndex:e}:o;this.setState({stickers:this.state.stickers.map(i),annotations:this.state.annotations.map(i),images:this.state.images.map(i)})}recalculateImageDisplay(){this.canvas.parentElement&&(this.calculateImageDisplay(),this.render())}destroy(){this.plugins.forEach(t=>t.destroy()),this.plugins.clear(),this.eventListeners.clear(),this.resizeObserver?.disconnect(),this.resizeObserver=null}applyCanvasTransformForItem(t){if(t.canvasRotation===void 0||t.canvasFlipX===void 0)return;const e=this.state.rotation-t.canvasRotation,i=this.state.flipX!==t.canvasFlipX,o=this.state.flipY!==(t.canvasFlipY||!1),s=this.state.scale-(t.canvasScale||1),a=this.state.skewX-(t.canvasSkewX||0),l=this.state.skewY-(t.canvasSkewY||0);if(!e&&!i&&!o&&!s&&!a&&!l)return;const c=this.imageDisplay.x+this.imageDisplay.width/2,h=this.imageDisplay.y+this.imageDisplay.height/2;if(this.ctx.translate(c,h),e&&this.ctx.rotate(e*Math.PI/180),s){const d=this.state.scale/(t.canvasScale||1);this.ctx.scale(d,d)}(a||l)&&this.ctx.transform(1,l,a,1,0,0),(i||o)&&this.ctx.scale(i?-1:1,o?-1:1),this.ctx.translate(-c,-h)}applyCanvasTransformForItemToExport(t,e,i,o){if(e.canvasRotation===void 0||e.canvasFlipX===void 0)return;const s=this.state.rotation-e.canvasRotation,a=this.state.flipX!==e.canvasFlipX,l=this.state.flipY!==(e.canvasFlipY||!1),c=this.state.scale-(e.canvasScale||1),h=this.state.skewX-(e.canvasSkewX||0),d=this.state.skewY-(e.canvasSkewY||0);if(!s&&!a&&!l&&!c&&!h&&!d)return;const u=i.x+i.width/2,p=i.y+i.height/2;if(t.translate(u,p),s&&t.rotate(s*Math.PI/180),c){const g=this.state.scale/(e.canvasScale||1);t.scale(g,g)}(h||d)&&t.transform(1,d,h,1,0,0),(a||l)&&t.scale(a?-1:1,l?-1:1),t.translate(-u,-p)}}const W={RGBA_BYTES_PER_PIXEL:4,DEFAULT_CHUNK_SIZE:1024,MAX_CANVAS_POOL_SIZE:10,CANVAS_RESET_SIZE:1,ASYNC_DELAY:0};class K{static setLimits(t){this.limits={...this.limits,...t}}static checkImageSize(t,e){const i=t*e,o=i*W.RGBA_BYTES_PER_PIXEL;return i<=this.limits.maxCanvasSize&&o<=this.limits.maxImageSize}static calculateOptimalSize(t,e){const i=this.limits.maxCanvasSize,o=t*e;if(o<=i)return{width:t,height:e};const s=Math.sqrt(i/o);return{width:Math.floor(t*s),height:Math.floor(e*s)}}static async processLargeImage(t,e,i=W.DEFAULT_CHUNK_SIZE){const{width:o,height:s}=t,a=new ImageData(o,s);for(let l=0;l<s;l+=i)for(let c=0;c<o;c+=i){const h=Math.min(i,o-c),d=Math.min(i,s-l),u=this.extractChunk(t,c,l,h,d),p=e(u);this.insertChunk(a,p,c,l),await new Promise(g=>setTimeout(g,W.ASYNC_DELAY))}return a}static extractChunk(t,e,i,o,s){const a=new ImageData(o,s),l=t.data,c=a.data;for(let h=0;h<s;h++)for(let d=0;d<o;d++){const u=((i+h)*t.width+(e+d))*4,p=(h*o+d)*4;c[p]=l[u]??0,c[p+1]=l[u+1]??0,c[p+2]=l[u+2]??0,c[p+3]=l[u+3]??255}return a}static insertChunk(t,e,i,o){const s=t.data,a=e.data;for(let l=0;l<e.height;l++)for(let c=0;c<e.width;c++){const h=((o+l)*t.width+(i+c))*4,d=(l*e.width+c)*4;s[h]=a[d]??0,s[h+1]=a[d+1]??0,s[h+2]=a[d+2]??0,s[h+3]=a[d+3]??255}}static getCanvas(t,e){const i=this.canvasPool.pop()||document.createElement("canvas");i.width=t,i.height=e;const o=t*e*W.RGBA_BYTES_PER_PIXEL;return this.memoryUsage+=o,i}static releaseCanvas(t){const e=t.width*t.height*W.RGBA_BYTES_PER_PIXEL;this.memoryUsage-=e,this.canvasPool.length<W.MAX_CANVAS_POOL_SIZE&&(t.width=W.CANVAS_RESET_SIZE,t.height=W.CANVAS_RESET_SIZE,this.canvasPool.push(t))}static getMemoryUsage(){return this.memoryUsage}static isMemoryAvailable(t){return this.memoryUsage+t<=this.limits.maxMemoryUsage}static cleanup(){this.canvasPool.forEach(t=>{t.width=W.CANVAS_RESET_SIZE,t.height=W.CANVAS_RESET_SIZE}),this.canvasPool=[],this.memoryUsage=0}}K.limits={maxCanvasSize:16777216,maxImageSize:50*1024*1024,maxMemoryUsage:200*1024*1024},K.memoryUsage=0,K.canvasPool=[];const B=r=>Math.max(0,Math.min(255,r)),Z=(r,t)=>{for(let e=0;e<r.length;e+=4){const[i,o,s,a]=t(r[e]??0,r[e+1]??0,r[e+2]??0,r[e+3]??255,e);r[e]=B(i),r[e+1]=B(o),r[e+2]=B(s),r[e+3]=a}},pi=(r,t,e,i,o)=>{const s=new Uint8ClampedArray(r),a=Math.floor(o/2);for(let l=0;l<e;l++)for(let c=0;c<t;c++){let h=0,d=0,u=0;for(let g=0;g<o;g++)for(let m=0;m<o;m++){const x=Math.min(e-1,Math.max(0,l+g-a)),f=Math.min(t-1,Math.max(0,c+m-a)),v=(x*t+f)*4,b=i[g*o+m]??0;h+=(s[v]??0)*b,d+=(s[v+1]??0)*b,u+=(s[v+2]??0)*b}const p=(l*t+c)*4;r[p]=B(h),r[p+1]=B(d),r[p+2]=B(u)}};class Nt{constructor(){this.name="advancedFilter",this.canvas=null,this.ctx=null}init(t,e){this.canvas=t,this.ctx=e}async applyAdvancedFilter(t,e,i={}){return K.checkImageSize(t.width,t.height)?this.applyFilterDirect(t,e,i):this.applyFilterChunked(t,e,i)}async applyFilterChunked(t,e,i){return K.processLargeImage(t,o=>this.applyFilterDirect(o,e,i),512)}applyFilterDirect(t,e,i){const o=new Uint8ClampedArray(t.data),{width:s,height:a}=t;switch(e){case"blur":this.applyGaussianBlur(o,s,a,i.radius||5);break;case"sharpen":this.applySharpen(o,s,a,i.intensity||1);break;case"emboss":this.applyEmboss(o,s,a);break;case"edge":this.applyEdgeDetection(o,s,a);break;case"oil":this.applyOilPainting(o,s,a,i.radius||3);break;case"vintage":this.applyVintage(o);break;case"cross-process":this.applyCrossProcess(o);break;case"lomo":this.applyLomo(o,s,a);break;default:return t}return new ImageData(o,s,a)}applyGaussianBlur(t,e,i,o){const s=this.createGaussianKernel(o);this.applyHorizontalBlur(t,e,i,s),this.applyVerticalBlur(t,e,i,s)}applyHorizontalBlur(t,e,i,o){const s=new Uint8ClampedArray(t),a=Math.floor(o.length/2);for(let l=0;l<i;l++)for(let c=0;c<e;c++){let h=0,d=0,u=0;for(let g=0;g<o.length;g++){const m=Math.min(e-1,Math.max(0,c+g-a)),x=(l*e+m)*4,f=o[g]??0;h+=(s[x]??0)*f,d+=(s[x+1]??0)*f,u+=(s[x+2]??0)*f}const p=(l*e+c)*4;t[p]=B(h),t[p+1]=B(d),t[p+2]=B(u)}}applyVerticalBlur(t,e,i,o){const s=new Uint8ClampedArray(t),a=Math.floor(o.length/2);for(let l=0;l<i;l++)for(let c=0;c<e;c++){let h=0,d=0,u=0;for(let g=0;g<o.length;g++){const m=(Math.min(i-1,Math.max(0,l+g-a))*e+c)*4,x=o[g]??0;h+=(s[m]??0)*x,d+=(s[m+1]??0)*x,u+=(s[m+2]??0)*x}const p=(l*e+c)*4;t[p]=B(h),t[p+1]=B(d),t[p+2]=B(u)}}applySharpen(t,e,i,o){const s=[0,-o,0,-o,1+4*o,-o,0,-o,0];this.applyConvolution(t,e,i,s,3)}applyEmboss(t,e,i){const o=[-2,-1,0,-1,1,1,0,1,2];this.applyConvolution(t,e,i,o,3)}applyEdgeDetection(t,e,i){const o=[-1,-1,-1,-1,8,-1,-1,-1,-1];this.applyConvolution(t,e,i,o,3)}applyOilPainting(t,e,i,o){const s=new Uint8ClampedArray(t);for(let a=0;a<i;a++)for(let l=0;l<e;l++){const c=new Array(256).fill(0),h=new Array(256).fill(0),d=new Array(256).fill(0),u=new Array(256).fill(0);for(let x=-o;x<=o;x++)for(let f=-o;f<=o;f++){const v=Math.max(0,Math.min(e-1,l+f)),b=(Math.max(0,Math.min(i-1,a+x))*e+v)*4,k=s[b]??0,S=s[b+1]??0,y=s[b+2]??0,C=Math.floor((k+S+y)/3);c[C]++,h[C]+=k,d[C]+=S,u[C]+=y}let p=0,g=0;for(let x=0;x<256;x++)c[x]>p&&(p=c[x],g=x);const m=(a*e+l)*4;t[m]=h[g]/p,t[m+1]=d[g]/p,t[m+2]=u[g]/p}}applyVintage(t){Z(t,(e,i,o,s)=>[e*.9+i*.5+o*.1,e*.3+i*.8+o*.1,e*.2+i*.3+o*.5,s])}applyCrossProcess(t){Z(t,(e,i,o,s)=>{const a=e/255,l=i/255,c=o/255;return[(a*1.4-.2)*255,(l*1.2-.1)*255,(c*.8+.2)*255,s]})}applyLomo(t,e,i){const o=e/2,s=i/2,a=Math.sqrt(o*o+s*s);for(let l=0;l<i;l++)for(let c=0;c<e;c++){const h=1-Math.sqrt((c-o)**2+(l-s)**2)/a*.6,d=(l*e+c)*4;t[d]=Math.max(0,Math.min(255,(t[d]??0)*h*1.2)),t[d+1]=Math.max(0,Math.min(255,(t[d+1]??0)*h)),t[d+2]=Math.max(0,Math.min(255,(t[d+2]??0)*h*.8))}}createGaussianKernel(t){const e=t*2+1,i=new Array(e),o=t/3;let s=0;for(let a=0;a<e;a++){const l=a-t;i[a]=Math.exp(-(l*l)/(2*o*o)),s+=i[a]}for(let a=0;a<e;a++)i[a]/=s;return i}applyConvolution(t,e,i,o,s){pi(t,e,i,o,s)}initialize(t){}destroy(){this.canvas=null,this.ctx=null}}const St=(r,t)=>{const e=t.getBoundingClientRect(),i=r.clientX-e.left,o=r.clientY-e.top;return{x:i/e.width*t.width,y:o/e.height*t.height}},mi=(r,t)=>r.x>=t.x&&r.x<=t.x+t.width&&r.y>=t.y&&r.y<=t.y+t.height,ft=()=>Math.random().toString(36).substring(2,9);class Bt{constructor(){this.name="annotate",this.isDrawing=!1,this.currentAnnotation=null,this.canvasScale=1}initialize(t){this.editor=t}setAnnotationCompleteCallback(t){this.onAnnotationComplete=t}setCanvasScale(t){this.canvasScale=t}handleMouseDown(t,e,i){const o=this.editor.canvas;if(!o)return;const{x:s,y:a}=St(t,o),l=this.editor.getImageDisplay();mi({x:s,y:a},l)&&(this.isDrawing=!0,this.currentAnnotation={rotation:0,id:ft(),type:e,x:e==="text"?l.x+l.width/2:s,y:e==="text"?l.y+l.height/2:a,width:0,height:0,color:i.color||"#ff0000",strokeWidth:i.strokeWidth||2,fontSize:i.fontSize||24,text:i.text||(e==="text"?"Text":void 0),points:e==="sharpie"?[{x:s,y:a}]:void 0,zIndex:Date.now(),fillColor:i.fillColor||(e!=="line"&&e!=="sharpie"&&e!=="path"&&e!=="text"?"transparent":void 0),strokeColor:i.strokeColor||i.color||"#ff0000"})}handleMouseMove(t){if(!this.isDrawing||!this.currentAnnotation)return;const e=this.editor.canvas;if(!e)return;const{x:i,y:o}=St(t,e);this.currentAnnotation.type==="sharpie"?this.currentAnnotation.points?.push({x:i,y:o}):this.currentAnnotation.type!=="text"&&(this.currentAnnotation.width=i-this.currentAnnotation.x,this.currentAnnotation.height=o-this.currentAnnotation.y),this.editor.render()}handleMouseUp(){if(this.currentAnnotation&&this.isDrawing){const t=[...this.editor.getState().annotations];let e=!1;this.currentAnnotation.type==="sharpie"&&this.currentAnnotation.points&&this.currentAnnotation.points.length>1?(t.push(this.currentAnnotation),this.editor.setState({annotations:t}),e=!0):this.currentAnnotation.type!=="sharpie"&&(Math.abs(this.currentAnnotation.width||0)>5||Math.abs(this.currentAnnotation.height||0)>5)?(t.push(this.currentAnnotation),this.editor.setState({annotations:t}),e=!0):this.currentAnnotation.type==="text"&&(t.push(this.currentAnnotation),this.editor.setState({annotations:t}),e=!0),e&&this.onAnnotationComplete&&this.onAnnotationComplete(this.currentAnnotation)}this.isDrawing=!1,this.currentAnnotation=null}render(t){this.currentAnnotation&&this.renderAnnotation(t,this.currentAnnotation)}renderAnnotation(t,e){t.save();const i=e.strokeColor||e.color,o=e.fillColor||(e.type==="text"?e.color:"transparent");switch(t.strokeStyle=i,t.fillStyle=e.type==="text"?e.color:o,t.lineWidth=e.strokeWidth,e.type){case"rectangle":if(e.width&&e.height){const s=e.fillColor;s&&s!=="transparent"&&(t.fillStyle=s,t.fillRect(e.x,e.y,e.width,e.height)),t.strokeRect(e.x,e.y,e.width,e.height)}break;case"ellipse":if(e.width&&e.height){t.beginPath(),t.ellipse(e.x+e.width/2,e.y+e.height/2,Math.abs(e.width/2),Math.abs(e.height/2),0,0,2*Math.PI);const s=e.fillColor;s&&s!=="transparent"&&(t.fillStyle=s,t.fill()),t.stroke()}break;case"line":e.width&&e.height&&(t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(e.x+e.width,e.y+e.height),t.stroke());break;case"arrow":e.width&&e.height&&this.drawArrow(t,e.x,e.y,e.x+e.width,e.y+e.height,e.strokeWidth);break;case"text":if(e.text&&e.fontSize){const s=e.fontWeight||"normal",a=e.fontStyle||"normal";t.font=`${a} ${s} ${e.fontSize}px Arial`;const l=t.measureText(e.text).width,c=Math.max(1,e.fontSize/16);if(e.textDecoration==="underline"){const h=t.lineWidth;t.lineWidth=c,t.beginPath(),t.moveTo(e.x,e.y+2),t.lineTo(e.x+l,e.y+2),t.stroke(),t.lineWidth=h}else if(e.textDecoration==="line-through"){const h=t.lineWidth;t.lineWidth=c,t.beginPath(),t.moveTo(e.x,e.y-e.fontSize/3),t.lineTo(e.x+l,e.y-e.fontSize/3),t.stroke(),t.lineWidth=h}t.fillText(e.text,e.x,e.y)}break;case"sharpie":if(e.points&&e.points.length>1){t.beginPath(),t.moveTo(e.points[0]?.x??0,e.points[0]?.y??0);for(let s=1;s<e.points.length;s++)t.lineTo(e.points[s]?.x??0,e.points[s]?.y??0);t.stroke()}break}t.restore()}drawArrow(t,e,i,o,s,a=2){const l=Math.max(10,a*3),c=Math.atan2(s-i,o-e),h=o-l*.7*Math.cos(c),d=s-l*.7*Math.sin(c);t.beginPath(),t.moveTo(e,i),t.lineTo(h,d),t.stroke(),t.beginPath(),t.moveTo(o,s),t.lineTo(o-l*Math.cos(c-Math.PI/4),s-l*Math.sin(c-Math.PI/4)),t.lineTo(o-l*Math.cos(c+Math.PI/4),s-l*Math.sin(c+Math.PI/4)),t.closePath(),t.fill()}updateAnnotations(t){}destroy(){this.editor=null,this.currentAnnotation=null}}const Y={MIN_CROP_SIZE:50,HANDLE_SIZE:12,GRID_LINES:3,STROKE_WIDTH:2,OVERLAY_ALPHA:.6};class Lt{constructor(){this.name="crop",this.isDragging=!1,this.dragMode="none",this.dragStart={x:0,y:0},this.initialCrop={x:0,y:0,width:0,height:0},this.initialAspectRatio=1,this._isActive=!1,this.isShiftPressed=!1}initialize(t){this.editor=t,document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this))}setActive(t){this._isActive=t}get isActive(){return this._isActive}getTransformedBounds(t){const e=this.editor.getState(),i=this.editor.getImageDisplay(),o=(e.rotation||0)*Math.PI/180,s=e.scale||1,a=e.skewX||0,l=e.skewY||0,c=Math.abs(Math.cos(o)),h=Math.abs(Math.sin(o)),d=i.width*s,u=i.height*s,p=Math.abs(a)*u,g=Math.abs(l)*d,m=(d+p)*c+(u+g)*h,x=(u+g)*c+(d+p)*h,f=i.x+i.width/2,v=i.y+i.height/2;return{x:Math.max(0,Math.min(t.width-m,f-m/2)),y:Math.max(0,Math.min(t.height-x,v-x/2)),width:Math.min(m,t.width),height:Math.min(x,t.height)}}render(t){this._isActive&&this.editor.getState().crop&&this.drawCropOverlay(t)}drawCropOverlay(t){const e=t.canvas,i=this.editor.getState(),{crop:o}=i;t.save();const s=this.getTransformedBounds(e),a=Math.max(s.x,Math.min(o.x,s.x+s.width-Y.MIN_CROP_SIZE)),l=Math.max(s.y,Math.min(o.y,s.y+s.height-Y.MIN_CROP_SIZE)),c=Math.min(o.width,s.x+s.width-a),h=Math.min(o.height,s.y+s.height-l);t.fillStyle=`rgba(0, 0, 0, ${Y.OVERLAY_ALPHA})`,t.beginPath(),t.rect(0,0,e.width,e.height),t.rect(a+c,l,-c,h),t.fill("evenodd"),t.strokeStyle="#fff",t.lineWidth=Y.STROKE_WIDTH,t.strokeRect(a,l,c,h),t.strokeStyle="rgba(255, 255, 255, 0.5)",t.lineWidth=1;for(let u=1;u<Y.GRID_LINES;u++){const p=a+c/3*u,g=l+h/3*u;t.beginPath(),t.moveTo(p,l),t.lineTo(p,l+h),t.moveTo(a,g),t.lineTo(a+c,g),t.stroke()}const d=Y.HANDLE_SIZE;t.fillStyle="#fff",t.strokeStyle="#007bff",t.lineWidth=Y.STROKE_WIDTH,[{x:a,y:l,cursor:"nw-resize"},{x:a+c,y:l,cursor:"ne-resize"},{x:a+c,y:l+h,cursor:"se-resize"},{x:a,y:l+h,cursor:"sw-resize"},{x:a+c/2,y:l,cursor:"n-resize"},{x:a+c,y:l+h/2,cursor:"e-resize"},{x:a+c/2,y:l+h,cursor:"s-resize"},{x:a,y:l+h/2,cursor:"w-resize"}].forEach(u=>{t.fillRect(u.x-d/2,u.y-d/2,d,d),t.strokeRect(u.x-d/2,u.y-d/2,d,d)}),t.restore()}handleMouseDown(t){const e=this.editor.canvas,i=t.canvasX||t.clientX-e.getBoundingClientRect().left,o=t.canvasY||t.clientY-e.getBoundingClientRect().top;this.dragStart={x:i,y:o},this.isDragging=!0;const s=this.editor.getState(),{crop:a}=s;this.initialCrop={...a},this.initialAspectRatio=a.width/a.height;const l=Y.HANDLE_SIZE,c=[{x:a.x,y:a.y,mode:"tl"},{x:a.x+a.width,y:a.y,mode:"tr"},{x:a.x+a.width,y:a.y+a.height,mode:"br"},{x:a.x,y:a.y+a.height,mode:"bl"},{x:a.x+a.width/2,y:a.y,mode:"t"},{x:a.x+a.width,y:a.y+a.height/2,mode:"r"},{x:a.x+a.width/2,y:a.y+a.height,mode:"b"},{x:a.x,y:a.y+a.height/2,mode:"l"}];let h=!1;for(const d of c)if(Math.abs(i-d.x)<l&&Math.abs(o-d.y)<l){this.dragMode=d.mode,h=!0;break}if(!h){const d=this.getTransformedBounds(e);if(i>=a.x&&i<=a.x+a.width&&o>=a.y&&o<=a.y+a.height)this.dragMode="move";else if(i>=d.x&&i<=d.x+d.width&&o>=d.y&&o<=d.y+d.height)this.dragMode="resize";else{this.isDragging=!1;return}}}handleMouseMove(t){if(!this.isDragging)return;const e=this.editor.canvas,i=t.canvasX||t.clientX-e.getBoundingClientRect().left,o=t.canvasY||t.clientY-e.getBoundingClientRect().top,s=Y.MIN_CROP_SIZE,a=this.getTransformedBounds(e);let l={...this.initialCrop};switch(this.dragMode){case"move":const c=i-this.dragStart.x,h=o-this.dragStart.y;l.x=Math.max(a.x,Math.min(a.x+a.width-l.width,this.initialCrop.x+c)),l.y=Math.max(a.y,Math.min(a.y+a.height-l.height,this.initialCrop.y+h));break;case"resize":const d=Math.min(this.dragStart.x,i),u=Math.min(this.dragStart.y,o),p=Math.max(this.dragStart.x,i),g=Math.max(this.dragStart.y,o);l={x:Math.max(a.x,d),y:Math.max(a.y,u),width:Math.min(a.x+a.width-d,p-d),height:Math.min(a.y+a.height-u,g-u)};break;case"tl":const m=this.initialCrop.x+this.initialCrop.width,x=this.initialCrop.y+this.initialCrop.height;if(this.isShiftPressed){const y=i-this.dragStart.x,C=o-this.dragStart.y,j=Math.min(Math.abs(y),Math.abs(C))*(y<0&&C<0?1:-1);l.x=Math.max(a.x,Math.min(this.initialCrop.x+j,m-s)),l.y=Math.max(a.y,Math.min(this.initialCrop.y+j/this.initialAspectRatio,x-s)),l.width=m-l.x,l.height=x-l.y}else l.x=Math.max(a.x,Math.min(i,m-s)),l.y=Math.max(a.y,Math.min(o,x-s)),l.width=m-l.x,l.height=x-l.y;break;case"tr":const f=this.initialCrop.x,v=this.initialCrop.y+this.initialCrop.height;if(this.isShiftPressed){const y=i-this.dragStart.x,C=o-this.dragStart.y,j=Math.min(Math.abs(y),Math.abs(C))*(y>0&&C<0?1:-1);l.x=f,l.y=Math.max(a.y,Math.min(this.initialCrop.y-j/this.initialAspectRatio,v-s)),l.width=Math.min(a.x+a.width-f,Math.max(s,this.initialCrop.width+j)),l.height=v-l.y}else l.x=f,l.y=Math.max(a.y,Math.min(o,v-s)),l.width=Math.min(a.x+a.width-f,Math.max(s,i-f)),l.height=v-l.y;break;case"br":if(this.isShiftPressed){const y=i-this.dragStart.x,C=o-this.dragStart.y,j=Math.min(Math.abs(y),Math.abs(C))*(y>0&&C>0?1:-1);l.width=Math.min(a.x+a.width-this.initialCrop.x,Math.max(s,this.initialCrop.width+j)),l.height=Math.min(a.y+a.height-this.initialCrop.y,Math.max(s,this.initialCrop.height+j/this.initialAspectRatio))}else l.width=Math.min(a.x+a.width-this.initialCrop.x,Math.max(s,i-this.initialCrop.x)),l.height=Math.min(a.y+a.height-this.initialCrop.y,Math.max(s,o-this.initialCrop.y));break;case"bl":const b=this.initialCrop.x+this.initialCrop.width;if(this.isShiftPressed){const y=i-this.dragStart.x,C=o-this.dragStart.y,j=Math.min(Math.abs(y),Math.abs(C))*(y<0&&C>0?1:-1);l.x=Math.max(a.x,Math.min(this.initialCrop.x-j,b-s)),l.width=b-l.x,l.height=Math.min(a.y+a.height-this.initialCrop.y,Math.max(s,this.initialCrop.height+j/this.initialAspectRatio))}else l.x=Math.max(a.x,Math.min(i,b-s)),l.width=b-l.x,l.height=Math.min(a.y+a.height-this.initialCrop.y,Math.max(s,o-this.initialCrop.y));break;case"t":const k=this.initialCrop.y+this.initialCrop.height;l.y=Math.max(a.y,Math.min(o,k-s)),l.height=k-l.y;break;case"r":l.width=Math.min(a.x+a.width-this.initialCrop.x,Math.max(s,i-this.initialCrop.x));break;case"b":l.height=Math.min(a.y+a.height-this.initialCrop.y,Math.max(s,o-this.initialCrop.y));break;case"l":const S=this.initialCrop.x+this.initialCrop.width;l.x=Math.max(a.x,Math.min(i,S-s)),l.width=S-l.x;break}this.editor.setState({crop:l})}handleMouseUp(){this.isDragging=!1,this.dragMode="none"}handleKeyDown(t){t.key==="Shift"&&(this.isShiftPressed=!0)}handleKeyUp(t){t.key==="Shift"&&(this.isShiftPressed=!1)}destroy(){document.removeEventListener("keydown",this.handleKeyDown.bind(this)),document.removeEventListener("keyup",this.handleKeyUp.bind(this))}}const xi=(r,t)=>{for(let e=0;e<r.length;e+=4){const[i,o,s,a]=t(r[e]??0,r[e+1]??0,r[e+2]??0,r[e+3]??255);r[e]=Math.max(0,Math.min(255,i)),r[e+1]=Math.max(0,Math.min(255,o)),r[e+2]=Math.max(0,Math.min(255,s)),r[e+3]=a}},fi={chrome:(r,t,e,i)=>[r*1.2,t*1.1,e*.9,i],fade:(r,t,e,i)=>[r+30,t+30,e+30,i],cold:(r,t,e,i)=>[r-20,t,e+20,i],warm:(r,t,e,i)=>[r+20,t+10,e-20,i],mono:(r,t,e,i)=>{const o=r*.299+t*.587+e*.114;return[o,o,o,i]},sepia:(r,t,e,i)=>[r*.393+t*.769+e*.189,r*.349+t*.686+e*.168,r*.272+t*.534+e*.131,i]},ki=(r,t)=>{const e=new Uint8ClampedArray(r.data),i=fi[t];return i&&xi(e,i),new ImageData(e,r.width,r.height)};class Ot{constructor(){this.name="filter",this.canvas=null,this.ctx=null}init(t,e){this.canvas=t,this.ctx=e}applyFilter(t,e){const i={monoDefault:"mono",sepiaDefault:"sepia"}[e]||e;return ki(t,i)}initialize(t){}destroy(){this.canvas=null,this.ctx=null}}class Ut{constructor(){this.name="finetune",this.canvas=null,this.ctx=null}init(t,e){this.canvas=t,this.ctx=e}applyAdjustments(t,e){const i=new Uint8ClampedArray(t.data),o=t.width,s=t.height;return e.brightness!==void 0&&e.brightness!==0&&this.applyBrightness(i,e.brightness),e.contrast!==void 0&&e.contrast!==0&&this.applyContrast(i,e.contrast),e.saturation!==void 0&&e.saturation!==0&&this.applySaturation(i,e.saturation),e.exposure!==void 0&&e.exposure!==0&&this.applyExposure(i,e.exposure),e.gamma!==void 0&&e.gamma!==0&&this.applyGamma(i,e.gamma),e.vignette!==void 0&&e.vignette!==0&&this.applyVignette(i,o,s,e.vignette),new ImageData(i,o,s)}applyBrightness(t,e){const i=e*2.55;Z(t,(o,s,a,l)=>[o+i,s+i,a+i,l])}applyContrast(t,e){const i=259*(e+255)/(255*(259-e));Z(t,(o,s,a,l)=>[i*(o-128)+128,i*(s-128)+128,i*(a-128)+128,l])}applySaturation(t,e){const i=(e+100)/100;Z(t,(o,s,a,l)=>{const c=.299*o+.587*s+.114*a;return[c+i*(o-c),c+i*(s-c),c+i*(a-c),l]})}applyExposure(t,e){const i=Math.pow(2,e/100);Z(t,(o,s,a,l)=>[o*i,s*i,a*i,l])}applyGamma(t,e){const i=1/(1+e/100);Z(t,(o,s,a,l)=>[255*Math.pow(o/255,i),255*Math.pow(s/255,i),255*Math.pow(a/255,i),l])}applyVignette(t,e,i,o){const s=e/2,a=i/2,l=Math.sqrt(s*s+a*a),c=o/100;Z(t,(h,d,u,p,g)=>{const m=g/4,x=m%e,f=Math.floor(m/e),v=1-Math.sqrt((x-s)**2+(f-a)**2)/l*c;return[h*v,d*v,u*v,p]})}initialize(t){}destroy(){this.canvas=null,this.ctx=null}}class bi{constructor(){this.name="htmlSelection",this.selectedItem=null,this.isDragging=!1,this.isResizing=!1,this.isRotating=!1,this.dragOffset={x:0,y:0},this.resizeHandle="",this.rotateStartAngle=0,this.isSelectMode=!1,this.overlayContainer=null,this.manipulators=[],this.canvasScale=1,this.isBoxSelecting=!1,this.boxSelectStart={x:0,y:0},this.boxSelectEnd={x:0,y:0},this.selectionBox=null,this.selectedItems=[],this.isShiftPressed=!1,this.initialAspectRatio=1,this.handleKeyDown=t=>{t.key==="Shift"&&(this.isShiftPressed=!0)},this.handleKeyUp=t=>{t.key==="Shift"&&(this.isShiftPressed=!1)},this.handleGlobalMouseMove=t=>{if(!this.selectedItem||!this.isResizing&&!this.isRotating)return;const e=this.editor.canvas;if(!e)return;const i=e.getBoundingClientRect(),o=e.width,s=e.height,a=t.clientX-i.left,l=t.clientY-i.top,c=a/i.width*o,h=l/i.height*s;if(this.isResizing)this.resizeItem(this.selectedItem,c,h,this.resizeHandle,this.isShiftPressed),this.showManipulators(this.selectedItem);else if(this.isRotating){const{x:d,y:u}=this.getItemCenter(this.selectedItem),p=Math.atan2(h-u,c-d);let g=(p-this.rotateStartAngle)*180/Math.PI;g>180&&(g-=360),g<-180&&(g+=360),this.selectedItem.rotation=(this.selectedItem.rotation||0)+g,this.rotateStartAngle=p,this.showManipulators(this.selectedItem)}this.updateItemInState(this.selectedItem),this.editor.render()},this.handleGlobalMouseUp=()=>{if(this.isResizing||this.isRotating){const t=this.editor.getState();this.editor.setState({stickers:t.stickers,annotations:t.annotations,images:t.images})}this.isResizing=!1,this.isRotating=!1,this.resizeHandle="",this.removeGlobalListeners()}}initialize(t){this.editor=t,this.createOverlay(),this.addKeyboardListeners()}setSelectMode(t){this.isSelectMode=t,t||this.hideManipulators()}selectItem(t){this.selectedItem=t,this.selectedItems=[t],this.showManipulators(t),this.onSelectionChange&&this.onSelectionChange(!0)}setSelectionChangeCallback(t){this.onSelectionChange=t}setCanvasScale(t){this.canvasScale=t,this.selectedItem&&this.isSelectMode&&this.showManipulators(this.selectedItem)}clearSelection(){this.selectedItem=null,this.selectedItems=[],this.hideManipulators(),this.hideSelectionBox(),this.onSelectionChange&&this.onSelectionChange(!1)}createOverlay(){const t=this.editor.canvas;t&&(this.overlayContainer=document.createElement("div"),this.overlayContainer.className="dk-img-editor-selection-overlay",this.overlayContainer.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    `,t.parentElement?.appendChild(this.overlayContainer))}createManipulator(t,e,i,o,s){const a=document.createElement("div");a.className="dk-img-editor-manipulator",a.dataset.control=t,s&&(a.dataset.handle=s);const l=t==="rotate"?16:12,c=t==="rotate"?0:2;return a.style.cssText=`
      position: absolute;
      width: ${l}px;
      height: ${l}px;
      background: ${t==="rotate"?"transparent":"#007bff"};
      border: ${t==="rotate"?"none":`${c}px solid white`};
      border-radius: ${t==="rotate"?"0":"2px"};
      cursor: ${e};
      pointer-events: auto;
      transform: translate(-50%, -50%);
      left: ${i}px;
      top: ${o}px;
      z-index: 11;
      color: #007bff;
      box-sizing: border-box;
    `,a.addEventListener("mousedown",h=>{h.stopPropagation(),t==="rotate"?this.startRotation(h):s&&this.startResize(h,s)}),a}showManipulators(t){if(this.hideManipulators(),!this.overlayContainer||!this.isSelectMode)return;const e=this.editor.canvas,i=e.width,o=e.height,s=e.getBoundingClientRect(),a=e.parentElement.getBoundingClientRect();this.overlayContainer.style.transform="none",this.overlayContainer.style.transformOrigin="initial";const l=s.width/i,c=s.height/o,h=l>=1?0:s.left-a.left,d=c>=1?0:s.top-a.top,u=this.getItemBounds(t),{left:p,top:g,right:m,bottom:x}=u,f=(p+m)/2,v=(g+x)/2,b=document.createElement("div");b.className="dk-img-editor-selection-box";const k=t.rotation||0,S="center",y=u.left*l+h,C=u.top*c+d,j=(u.right-u.left)*l,w=(u.bottom-u.top)*c,M=2;b.style.cssText=`
      position: absolute;
      left: ${y}px;
      top: ${C}px;
      width: ${j}px;
      height: ${w}px;
      border: ${M}px dashed white;
      pointer-events: none;
      z-index: 10;
      transform-origin: ${S};
      transform: rotate(${k}deg);
    `,this.manipulators.push(b),this.overlayContainer.appendChild(b),[{x:p,y:g,cursor:"nw-resize",handle:"tl"},{x:m,y:g,cursor:"ne-resize",handle:"tr"},{x:m,y:x,cursor:"se-resize",handle:"br"},{x:p,y:x,cursor:"sw-resize",handle:"bl"}].forEach(z=>{const{x:q,y:F}=this.transformPoint(z.x,z.y,f,v,k,l,c,h,d),P=this.createManipulator("point",z.cursor,q,F,z.handle);this.manipulators.push(P),this.overlayContainer.appendChild(P)});const I=m+25,E=g,{x:R,y:A}=this.transformPoint(I,E,f,v,k,l,c,h,d),L=this.createManipulator("rotate","grab",R,A);L.innerHTML=`
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M1 4v6h6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M3.51 15a9 9 0 102.13-9.36L1 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `,this.manipulators.push(L),this.overlayContainer.appendChild(L)}hideManipulators(){this.manipulators.forEach(t=>t.remove()),this.manipulators=[]}startResize(t,e){if(this.isResizing=!0,this.resizeHandle=e,this.selectedItem){const i=this.getItemBounds(this.selectedItem),o=i.right-i.left,s=i.bottom-i.top;this.initialAspectRatio=o/s}t.preventDefault(),this.addGlobalListeners()}startRotation(t){if(!this.selectedItem)return;this.isRotating=!0;const{x:e,y:i}=this.getItemCenter(this.selectedItem);this.rotateStartAngle=Math.atan2(t.clientY-i,t.clientX-e),t.preventDefault(),this.addGlobalListeners()}addGlobalListeners(){document.addEventListener("mousemove",this.handleGlobalMouseMove),document.addEventListener("mouseup",this.handleGlobalMouseUp)}removeGlobalListeners(){document.removeEventListener("mousemove",this.handleGlobalMouseMove),document.removeEventListener("mouseup",this.handleGlobalMouseUp)}addKeyboardListeners(){document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}handleMouseDown(t){const e=this.editor.canvas;if(!e)return;const i=e.getBoundingClientRect(),o=e.width,s=e.height,a=t.clientX-i.left,l=t.clientY-i.top,c=a/i.width*o,h=l/i.height*s,d=this.editor.getState(),u=[...d.stickers||[],...d.annotations||[],...d.images||[]];let p=null;for(let g=u.length-1;g>=0;g--)if(this.isPointInItem(c,h,u[g])){p=u[g];break}p?(this.selectedItems.some(g=>g.id===p.id)||(this.selectedItem=p,this.selectedItems=[p],this.showManipulators(p)),this.onSelectionChange&&this.onSelectionChange(!0),this.isSelectMode&&!this.isResizing&&!this.isRotating&&(this.isDragging=!0,this.dragOffset={x:c-p.x,y:h-p.y})):(this.hideSelectionBox(),this.isSelectMode&&(this.isBoxSelecting=!0,this.boxSelectStart={x:c,y:h},this.boxSelectEnd={x:c,y:h},this.showSelectionBox()),this.selectedItem=null,this.selectedItems=[],this.hideManipulators(),this.onSelectionChange&&this.onSelectionChange(!1))}handleMouseMove(t){const e=this.editor.canvas;if(!e)return;const i=e.getBoundingClientRect(),o=e.width,s=e.height,a=t.clientX-i.left,l=t.clientY-i.top,c=a/i.width*o,h=l/i.height*s;if(this.isBoxSelecting){this.boxSelectEnd={x:c,y:h},this.updateSelectionBox();return}if(!(!this.selectedItem||!this.isSelectMode)){if(this.isDragging)if(this.selectedItems.length>1){const d=c-this.dragOffset.x,u=h-this.dragOffset.y,p=d-this.selectedItem.x,g=u-this.selectedItem.y;this.selectedItems.forEach(m=>{m.type==="sharpie"&&m.points&&(m.points=m.points.map(x=>({x:x.x+p,y:x.y+g}))),m.x+=p,m.y+=g}),this.hideManipulators(),this.showMultiSelectionBorders()}else this.moveItem(this.selectedItem,c-this.dragOffset.x,h-this.dragOffset.y),this.showManipulators(this.selectedItem);else if(this.isResizing)this.resizeItem(this.selectedItem,c,h,this.resizeHandle),this.showManipulators(this.selectedItem);else if(this.isRotating){const{x:d,y:u}=this.getItemCenter(this.selectedItem),p=Math.atan2(h-u,c-d);let g=(p-this.rotateStartAngle)*180/Math.PI;g>180&&(g-=360),g<-180&&(g+=360),this.selectedItem.rotation=(this.selectedItem.rotation||0)+g,this.rotateStartAngle=p,this.showManipulators(this.selectedItem)}(this.isDragging||this.isResizing||this.isRotating)&&(this.updateItemInState(this.selectedItem),this.editor.render())}}handleMouseUp(){if(this.isBoxSelecting){this.finishBoxSelection(),this.isBoxSelecting=!1,this.hideSelectionBox();return}if((this.isDragging||this.isResizing||this.isRotating)&&this.isSelectMode)if(this.selectedItems.length>1&&this.isDragging)this.updateMultipleItemsInState();else{const t=this.editor.getState();this.editor.setState({stickers:t.stickers,annotations:t.annotations,images:t.images})}this.isDragging=!1,this.isResizing=!1,this.isRotating=!1,this.resizeHandle=""}render(t){}deleteSelected(){if(this.selectedItems.length===0)return;const t=this.editor.getState(),e=new Set(this.selectedItems.map(a=>a.id)),i=t.stickers.filter(a=>!e.has(a.id)),o=t.images.filter(a=>!e.has(a.id)),s=t.annotations.filter(a=>!e.has(a.id));this.editor.setState({stickers:i,images:o,annotations:s}),this.selectedItem=null,this.selectedItems=[],this.hideManipulators(),this.onSelectionChange&&this.onSelectionChange(!1)}copySelected(){if(this.selectedItems.length===0)return;const t=this.editor.getState(),e=[],i=20;this.selectedItems.forEach(l=>{const c=Date.now().toString()+Math.random().toString(36).substr(2,9),h={...l,id:c,x:l.x+i,y:l.y+i,zIndex:(l.zIndex||0)+1};l.type==="sharpie"&&l.points&&(h.points=l.points.map(d=>({x:d.x+i,y:d.y+i}))),e.push(h)});const o=[...t.stickers],s=[...t.images],a=[...t.annotations];e.forEach(l=>{this.isSticker(l)?o.push(l):this.isImage(l)?s.push(l):a.push(l)}),this.editor.setState({stickers:o,images:s,annotations:a}),this.selectedItems=e,e.length===1?(this.selectedItem=e[0]??null,this.selectedItem&&this.showManipulators(this.selectedItem)):(this.selectedItem=e[0]??null,this.hideManipulators(),this.showMultiSelectionBorders())}isSticker(t){return"sticker"in t}isImage(t){return t.type==="image"}getItemCenter(t){return this.isSticker(t)?{x:t.x,y:t.y}:{x:t.x+(t.width||0)/2,y:t.y+(t.height||0)/2}}moveItem(t,e,i){if(t.type==="sharpie"&&t.points){const o=e-t.x,s=i-t.y;t.points=t.points.map(a=>({x:a.x+o,y:a.y+s}))}t.x=e,t.y=i}resizeItem(t,e,i,o,s=!1){if(this.isSticker(t)){const a=t.x,l=t.y;let c=Math.max(20,Math.min(200,Math.sqrt(Math.pow(e-a,2)+Math.pow(i-l,2))*2));t.size=c}else if(this.isImage(t)){const a=t.x,l=t.y,c=t.width/t.height,h=Math.sqrt(Math.pow(e-a,2)+Math.pow(i-l,2));t.width=Math.max(50,Math.min(400,h*2)),t.height=t.width/c}else if(t.type==="sharpie"&&t.points){const a=t.points,l=a.map(y=>y.x),c=a.map(y=>y.y),h=Math.min(...l),d=Math.max(...l),u=Math.min(...c),p=Math.max(...c),g=(h+d)/2,m=(u+p)/2,x=d-h,f=p-u;let v=x,b=f;switch(o){case"br":if(v=Math.max(20,e-h),b=Math.max(20,i-u),s){const y=Math.max(v/x,b/f);v=x*y,b=f*y}break;case"tr":if(v=Math.max(20,e-h),b=Math.max(20,p-i),s){const y=Math.max(v/x,b/f);v=x*y,b=f*y}break;case"bl":if(v=Math.max(20,d-e),b=Math.max(20,i-u),s){const y=Math.max(v/x,b/f);v=x*y,b=f*y}break;case"tl":if(v=Math.max(20,d-e),b=Math.max(20,p-i),s){const y=Math.max(v/x,b/f);v=x*y,b=f*y}break}const k=v/x,S=b/f;t.points=a.map(y=>({x:g+(y.x-g)*k,y:m+(y.y-m)*S})),t.x=g,t.y=m}else if(t.type==="text"){const a=t.width||100,l=t.fontSize||24;let c,h;switch(o){case"br":c=Math.max(50,e-t.x),h=Math.max(12,t.y-i);break;case"tr":c=Math.max(50,e-t.x),h=Math.max(12,l);break;case"bl":c=Math.max(50,a),h=Math.max(12,t.y-i);break;case"tl":c=Math.max(50,a),h=Math.max(12,l);break;default:c=a,h=l}const d=c/a,u=h/l,p=Math.max(d,u),g=Math.max(12,Math.min(72,(t.fontSize||24)*p));if(t.fontSize=g,t.text){const m=document.createElement("canvas").getContext("2d"),x=t.fontWeight||"normal",f=t.fontStyle||"normal";m.font=`${f} ${x} ${g}px Arial`,t.width=m.measureText(t.text).width,t.height=g}}else{const a=t.x,l=t.y,c=t.width||0,h=t.height||0;let d,u,p=a,g=l;switch(o){case"tl":d=a+c-e,u=l+h-i,p=e,g=i;break;case"tr":d=e-a,u=l+h-i,g=i;break;case"br":d=e-a,u=i-l;break;case"bl":d=a+c-e,u=i-l,p=e;break;default:d=c,u=h}if(s&&this.initialAspectRatio>0)switch(d/u>this.initialAspectRatio?d=u*this.initialAspectRatio:u=d/this.initialAspectRatio,o){case"tl":p=a+c-d,g=l+h-u;break;case"tr":g=l+h-u;break;case"bl":p=a+c-d;break}t.width=Math.max(20,d),t.height=Math.max(20,u),t.x=p,t.y=g}}updateItemInState(t){const e=this.editor.getState();if(this.isSticker(t)){const i=[...e.stickers],o=i.findIndex(s=>s.id===t.id);o!==-1&&(i[o]=t,this.editor.setState({stickers:i},!1))}else if(this.isImage(t)){const i=[...e.images],o=i.findIndex(s=>s.id===t.id);o!==-1&&(i[o]=t,this.editor.setState({images:i},!1))}else{const i=[...e.annotations],o=i.findIndex(s=>s.id===t.id);o!==-1&&(i[o]=t,this.editor.setState({annotations:i},!1))}}isPointInItem(t,e,i){if(this.isSticker(i)){const o=i.size/2;return t>=i.x-o&&t<=i.x+o&&e>=i.y-o&&e<=i.y+o}else if(this.isImage(i)){const o=i.width/2,s=i.height/2;return t>=i.x-o&&t<=i.x+o&&e>=i.y-s&&e<=i.y+s}else if(i.type==="text"){const o=this.getTextWidth(i),s=i.fontSize||24,a=i.x,l=i.x+o,c=i.y-s*.8,h=i.y+s*.2;if(i.rotation){const d=(a+l)/2,u=(c+h)/2,p=-i.rotation*Math.PI/180,g=t-d,m=e-u,x=g*Math.cos(p)-m*Math.sin(p)+d,f=g*Math.sin(p)+m*Math.cos(p)+u;return x>=a&&x<=l&&f>=c&&f<=h}else return t>=a&&t<=l&&e>=c&&e<=h}else if(i.type==="sharpie"&&i.points){const o=i.points,s=10;for(let a=0;a<o.length-1;a++){const l=o[a],c=o[a+1];if(this.pointToLineDistance(t,e,l.x,l.y,c.x,c.y)<=s)return!0}return!1}else{const o=Math.min(i.x,i.x+(i.width||0)),s=Math.max(i.x,i.x+(i.width||0)),a=Math.min(i.y,i.y+(i.height||0)),l=Math.max(i.y,i.y+(i.height||0));return t>=o&&t<=s&&e>=a&&e<=l}}refreshSelection(){this.selectedItem&&this.isSelectMode&&this.showManipulators(this.selectedItem)}showSelectionBox(){this.overlayContainer&&(this.selectionBox=document.createElement("div"),this.selectionBox.style.cssText=`
      position: absolute;
      border: 2px dashed #007bff;
      background: rgba(0, 123, 255, 0.1);
      pointer-events: none;
      z-index: 15;
    `,this.overlayContainer.appendChild(this.selectionBox))}updateSelectionBox(){if(!this.selectionBox||!this.overlayContainer)return;const t=this.editor.canvas,e=t.getBoundingClientRect(),i=t.parentElement.getBoundingClientRect(),o=e.width/t.width,s=e.height/t.height,a=e.left-i.left,l=e.top-i.top,c=Math.min(this.boxSelectStart.x,this.boxSelectEnd.x),h=Math.min(this.boxSelectStart.y,this.boxSelectEnd.y),d=Math.abs(this.boxSelectEnd.x-this.boxSelectStart.x),u=Math.abs(this.boxSelectEnd.y-this.boxSelectStart.y);this.selectionBox.style.left=`${c*o+a}px`,this.selectionBox.style.top=`${h*s+l}px`,this.selectionBox.style.width=`${d*o}px`,this.selectionBox.style.height=`${u*s}px`}hideSelectionBox(){this.selectionBox&&(this.selectionBox.remove(),this.selectionBox=null)}finishBoxSelection(){const t=Math.min(this.boxSelectStart.x,this.boxSelectEnd.x),e=Math.min(this.boxSelectStart.y,this.boxSelectEnd.y),i=Math.max(this.boxSelectStart.x,this.boxSelectEnd.x),o=Math.max(this.boxSelectStart.y,this.boxSelectEnd.y);if(i-t<5||o-e<5){this.clearSelection(),this.hideSelectionBox();return}const s=this.editor.getState(),a=[...s.stickers||[],...s.annotations||[],...s.images||[]];this.selectedItems=a.filter(l=>this.isItemInBox(l,t,e,i,o)),this.selectedItems.length>0?(this.selectedItems.length===1?(this.selectedItem=this.selectedItems[0]??null,this.selectedItem&&this.showManipulators(this.selectedItem)):(this.selectedItem=this.selectedItems[0]??null,this.hideManipulators(),this.showMultiSelectionBorders()),this.onSelectionChange&&this.onSelectionChange(!0)):(this.clearSelection(),this.hideSelectionBox())}getItemBounds(t){if(this.isSticker(t)){const e=t.size/2;return{left:t.x-e,top:t.y-e,right:t.x+e,bottom:t.y+e}}if(this.isImage(t)){const e=t.width/2,i=t.height/2;return{left:t.x-e,top:t.y-i,right:t.x+e,bottom:t.y+i}}if(t.type==="text"){const e=this.getTextWidth(t),i=t.fontSize||24;return{left:t.x,right:t.x+e,top:t.y-i*.8,bottom:t.y+i*.2}}if(t.type==="sharpie"&&t.points){const e=t.points,i=e.map(s=>s.x),o=e.map(s=>s.y);return{left:Math.min(...i),right:Math.max(...i),top:Math.min(...o),bottom:Math.max(...o)}}return{left:Math.min(t.x,t.x+(t.width||0)),right:Math.max(t.x,t.x+(t.width||0)),top:Math.min(t.y,t.y+(t.height||0)),bottom:Math.max(t.y,t.y+(t.height||0))}}showMultiSelectionBorders(){if(!this.overlayContainer||this.selectedItems.length===0)return;const t=this.editor.canvas,e=t.getBoundingClientRect(),i=t.parentElement.getBoundingClientRect(),o=e.width/t.width,s=e.height/t.height,a=e.left-i.left,l=e.top-i.top;this.selectedItems.forEach(c=>{const h=this.getItemBounds(c),d=this.createSelectionBorder(h,c.rotation||0,o,s,a,l);this.manipulators.push(d),this.overlayContainer?.appendChild(d)})}isItemInBox(t,e,i,o,s){const{left:a,top:l,right:c,bottom:h}=this.getItemBounds(t);return!(c<e||a>o||h<i||l>s)}updateMultipleItemsInState(){const t=this.editor.getState(),e=[...t.stickers],i=[...t.annotations],o=[...t.images];this.selectedItems.forEach(s=>{if(this.isSticker(s)){const a=e.findIndex(l=>l.id===s.id);a!==-1&&(e[a]=s)}else if(this.isImage(s)){const a=o.findIndex(l=>l.id===s.id);a!==-1&&(o[a]=s)}else{const a=i.findIndex(l=>l.id===s.id);a!==-1&&(i[a]=s)}}),this.editor.setState({stickers:e,annotations:i,images:o})}moveSelectedToFront(){if(this.selectedItems.length===0)return;const t=this.editor.getState(),e=[...t.stickers,...t.annotations,...t.images],i=Math.max(...e.map(o=>o.zIndex||0));this.selectedItems.forEach((o,s)=>{o.zIndex=i+s+1}),this.updateMultipleItemsInState(),this.editor.render()}moveSelectedToBack(){if(this.selectedItems.length===0)return;const t=this.editor.getState(),e=[...t.stickers,...t.annotations,...t.images],i=Math.min(...e.map(o=>o.zIndex||0));this.selectedItems.forEach((o,s)=>{o.zIndex=i-this.selectedItems.length+s}),this.updateMultipleItemsInState(),this.editor.render()}moveSelectedForward(){this.selectedItems.length!==0&&(this.selectedItems.forEach(t=>{t.zIndex=(t.zIndex||0)+1}),this.updateMultipleItemsInState(),this.editor.render())}moveSelectedBackward(){this.selectedItems.length!==0&&(this.selectedItems.forEach(t=>{t.zIndex=(t.zIndex||0)-1}),this.updateMultipleItemsInState(),this.editor.render())}isMultipleSelection(){return this.selectedItems.length>1}getSelectedCount(){return this.selectedItems.length}hasSelection(){return this.selectedItems.length>0}getSelectedItem(){return this.selectedItem}getSelectedItems(){return this.selectedItems}updateSelectedItemColors(t,e){this.selectedItems.length!==0&&(this.selectedItems.forEach(i=>{"color"in i&&(t!==void 0&&(i.type==="text"||(i.strokeColor=t),i.color=t),e!==void 0&&i.type!=="text"&&i.type!=="line"&&i.type!=="sharpie"&&i.type!=="path"&&(i.fillColor=e))}),this.updateMultipleItemsInState(),this.editor.render())}updateSelectedTextProperties(t){if(!(this.selectedItems.length===0||!this.selectedItem)){if(Object.assign(this.selectedItem,t),this.selectedItem.type==="text"&&t.text){const e=document.createElement("canvas").getContext("2d"),i=t.fontSize||24,o=t.fontWeight||"normal",s=t.fontStyle||"normal";e.font=`${s} ${o} ${i}px Arial`,this.selectedItem.width=e.measureText(t.text).width,this.selectedItem.height=i}this.updateItemInState(this.selectedItem),this.showManipulators(this.selectedItem),this.editor.render()}}updateSelectedItemStrokeWidth(t){this.selectedItems.length!==0&&(this.selectedItems.forEach(e=>{"strokeWidth"in e&&(e.strokeWidth=t)}),this.updateMultipleItemsInState(),this.editor.render())}transformPoint(t,e,i,o,s,a,l,c,h){if(s===0)return{x:t*a+c,y:e*l+h};const d=s*Math.PI/180,u=t-i,p=e-o,g=i+u*Math.cos(d)-p*Math.sin(d),m=o+u*Math.sin(d)+p*Math.cos(d);return{x:g*a+c,y:m*l+h}}getTextWidth(t){let e=t.width;if(!e&&t.text){const i=document.createElement("canvas").getContext("2d"),o=t.fontSize||24,s=t.fontWeight||"normal",a=t.fontStyle||"normal";i.font=`${a} ${s} ${o}px Arial`,e=i.measureText(t.text).width}return e||100}createSelectionBorder(t,e,i,o,s,a){const l=document.createElement("div");l.className="dk-img-editor-multi-selection-border";const c=t.left*i+s,h=t.top*o+a,d=(t.right-t.left)*i,u=(t.bottom-t.top)*o;return l.style.cssText=`
      position: absolute;
      left: ${c}px;
      top: ${h}px;
      width: ${d}px;
      height: ${u}px;
      border: 2px dashed #007bff;
      pointer-events: none;
      z-index: 10;
      transform-origin: center;
      transform: rotate(${e}deg);
    `,l}pointToLineDistance(t,e,i,o,s,a){const l=t-i,c=e-o,h=s-i,d=a-o,u=l*h+c*d,p=h*h+d*d;let g=p===0?-1:u/p,m,x;g<0?(m=i,x=o):g>1?(m=s,x=a):(m=i+g*h,x=o+g*d);const f=t-m,v=e-x;return Math.sqrt(f*f+v*v)}destroy(){this.hideManipulators(),this.hideSelectionBox(),this.removeGlobalListeners(),document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp),this.overlayContainer&&this.overlayContainer.remove(),this.editor=null,this.selectedItem=null,this.selectedItems=[]}}class yi{constructor(){this.name="image"}initialize(t){this.editor=t}setImageCompleteCallback(t){this.onImageComplete=t}async addImageFromFile(t){const e=new Image;console.log("file---",t),e.onload=()=>{const i=this.editor.getImageDisplay(),o=Math.min(200/e.width,200/e.height);console.log("imageDisplay",i),console.log("scale",o);const s={id:ft(),type:"image",x:i.x+i.width/2,y:i.y+i.height/2,width:e.width*o,height:e.height*o,rotation:0,zIndex:Date.now(),image:e},a=[...this.editor.getState().images||[],s];this.editor.setState({images:a}),this.onImageComplete&&this.onImageComplete(s)},e.onerror=i=>{console.error("Failed to load image",i)},e.src=typeof t=="string"?t:URL.createObjectURL(t)}async addImageFromClipboard(t){const e=Array.from(t.items).find(i=>i.type.startsWith("image/"));if(e){const i=e.getAsFile();i&&await this.addImageFromFile(i)}}handleMouseDown(t){}handleMouseMove(t){}handleMouseUp(){}render(t){}destroy(){this.editor=null}}class Wt{constructor(){this.name="sticker",this.canvasScale=1}initialize(t){this.editor=t}setCanvasScale(t){this.canvasScale=t}addSticker(t){const e=[...this.editor.getState().stickers,t];this.editor.setState({stickers:e})}handleMouseDown(t){}handleMouseMove(t){}handleMouseUp(){}render(t){}updateStickers(t){}deleteSelected(){}destroy(){this.editor=null}}const $t={SRGB_TO_P3:{r:1.1,g:1.05,b:1.15},P3_TO_SRGB:{r:.9090909090909091,g:.9523809523809523,b:.8695652173913044}};class Ct{static async initialize(){this.supportedColorSpaces=await this.detectSupportedColorSpaces()}static async detectSupportedColorSpaces(){const t=["srgb"];if(typeof window<"u"){const e=document.createElement("canvas");e.width=1,e.height=1;try{const i=e.getContext("2d",{colorSpace:"display-p3"});i&&i.getContextAttributes?.()?.colorSpace==="display-p3"&&t.push("display-p3")}catch{}try{const i=e.getContext("2d",{colorSpace:"rec2020"});i&&i.getContextAttributes?.()?.colorSpace==="rec2020"&&t.push("rec2020")}catch{}}return t}static isSupported(t){return this.supportedColorSpaces.includes(t)}static getBestColorSpace(t="srgb"){return this.isSupported(t)?t:this.isSupported("display-p3")?"display-p3":"srgb"}static createCanvas(t,e,i="srgb"){const o=document.createElement("canvas");return o.width=t,o.height=e,o}static getContext(t,e="srgb"){const i=this.getBestColorSpace(e);return t.getContext("2d",{colorSpace:i,willReadFrequently:!0})}static convertColorSpace(t,e,i){if(e===i)return t;const o=new Uint8ClampedArray(t.data);if(e==="srgb"&&i==="display-p3"){const s=$t.SRGB_TO_P3;for(let a=0;a<o.length;a+=4)o[a]=Math.min(255,(o[a]??0)*s.r),o[a+1]=Math.min(255,(o[a+1]??0)*s.g),o[a+2]=Math.min(255,(o[a+2]??0)*s.b)}else if(e==="display-p3"&&i==="srgb"){const s=$t.P3_TO_SRGB;for(let a=0;a<o.length;a+=4)o[a]=Math.max(0,(o[a]??0)*s.r),o[a+1]=Math.max(0,(o[a+1]??0)*s.g),o[a+2]=Math.max(0,(o[a+2]??0)*s.b)}return new ImageData(o,t.width,t.height)}}Ct.supportedColorSpaces=[];const O={JPEG_MARKER:65496,EXIF_MARKER:65505,SOS_MARKER:65498,EXIF_SIGNATURE:1165519206,LITTLE_ENDIAN:18761,TIFF_MAGIC:42,ENTRY_SIZE:12,TAGS:{ORIENTATION:274,MAKE:271,MODEL:272,DATETIME:306}};class Xt{static async readExif(t){const e=await t.arrayBuffer(),i=new DataView(e);if(i.getUint16(0)!==O.JPEG_MARKER)return{};let o=2;for(;o<i.byteLength;){const s=i.getUint16(o);if(s===O.EXIF_MARKER){const a=i.getUint16(o+2),l=this.parseExifSegment(i,o+4,a-2);if(l)return l}if(s===O.SOS_MARKER)break;o+=2+i.getUint16(o+2)}return{}}static parseExifSegment(t,e,i){if(t.getUint32(e)!==O.EXIF_SIGNATURE)return null;e+=6;const o=t.getUint16(e)===O.LITTLE_ENDIAN;if(e+=2,t.getUint16(e,o)!==O.TIFF_MAGIC)return null;e+=2;const s=t.getUint32(e,o);return this.parseIFD(t,e+s,o)}static parseIFD(t,e,i){const o={},s=t.getUint16(e,i);e+=2;for(let a=0;a<s;a++){const l=t.getUint16(e,i);t.getUint16(e+2,i);const c=t.getUint32(e+4,i),h=t.getUint32(e+8,i);switch(l){case O.TAGS.ORIENTATION:o.orientation=t.getUint16(e+8,i);break;case O.TAGS.MAKE:o.make=this.readString(t,h,c);break;case O.TAGS.MODEL:o.model=this.readString(t,h,c);break;case O.TAGS.DATETIME:o.dateTime=this.readString(t,h,c);break}e+=O.ENTRY_SIZE}return o}static readString(t,e,i){let o="";for(let s=0;s<i-1;s++)o+=String.fromCharCode(t.getUint8(e+s));return o}static getOrientationTransform(t=1){return{1:"none",2:"scaleX(-1)",3:"rotate(180deg)",4:"scaleY(-1)",5:"rotate(90deg) scaleX(-1)",6:"rotate(90deg)",7:"rotate(-90deg) scaleX(-1)",8:"rotate(-90deg)"}[t]||"none"}}const wi=({canvasRef:r,editorRef:t,cropPluginRef:e,filterPluginRef:i,annotatePluginRef:o,stickerPluginRef:s,finetunePluginRef:a,imagePluginRef:l,selectionPluginRef:c,advancedFilterPluginRef:h,src:d,zoomLevel:u,setEditorState:p,setHasSelection:g,onImageLoadStart:m,onImageLoadEnd:x})=>{const f=_.useCallback(async(v,b)=>{try{if(v instanceof File){const k=await Xt.readExif(v);console.log("EXIF data loaded for file:",v.name)}await b.loadImage(v),x?.()}catch(k){console.error("Failed to load image:",k),x?.()}},[x]);_.useEffect(()=>((async()=>{if(r.current&&!t.current){await Ct.initialize();const v=new Dt(r.current),b=new Lt,k=new Ot,S=new Bt,y=new Wt,C=new Ut,j=new yi,w=new bi,M=new Nt;v.addPlugin(b),v.addPlugin(k),v.addPlugin(S),v.addPlugin(y),v.addPlugin(C),v.addPlugin(j),v.addPlugin(w),v.addPlugin(M),v.on("stateChange",I=>{p(I),I.stickers&&y.updateStickers(I.stickers),I.annotations&&S.updateAnnotations(I.annotations)}),t.current=v,e.current=b,i.current=k,o.current=S,s.current=y,a.current=C,l.current=j,c.current=w,h.current=M,S.setAnnotationCompleteCallback(I=>{if(c.current){c.current.setCanvasScale?.(u),c.current.setSelectMode(!0);const E={...I,zIndex:I.zIndex??Date.now()};c.current.selectItem(E),g(!0),t.current?.render()}}),w.setSelectionChangeCallback(I=>{g(I)}),j.setImageCompleteCallback(I=>{c.current&&(c.current.setCanvasScale?.(u),c.current.setSelectMode(!0),c.current.selectItem({...I,zIndex:I.zIndex||Date.now()}),g(!0),t.current?.render())}),b.setActive(!0),d&&await f(d,v)}})(),()=>{t.current&&t.current.destroy(),K.cleanup()}),[]),_.useEffect(()=>{d&&t.current&&f(d,t.current)},[d])},$={PLACEHOLDER:"Double click to edit",FONT_SIZE:24,COLOR:"#000000",FONT_WEIGHT:"normal",FONT_STYLE:"normal",TEXT_DECORATION:"none",STROKE_WIDTH:0},vi=({canvasRef:r,activeTool:t,currentAnnotation:e,currentSticker:i,editorRef:o,cropPluginRef:s,annotatePluginRef:a,stickerPluginRef:l,selectionPluginRef:c,setHasSelection:h,setEditingText:d,setEditingValue:u,setEditingTextItem:p,setActiveTool:g})=>{const m=_.useCallback(k=>{if(!r.current)return{canvasX:0,canvasY:0};const{x:S,y}=St(k,r.current);return{canvasX:S,canvasY:y}},[]),x=_.useCallback(k=>{if(!r.current)return;const{canvasX:S,canvasY:y}=m(k),C={...k.nativeEvent,clientX:k.clientX,clientY:k.clientY,canvasX:S,canvasY:y};let j=!1;if((t==="annotate"||t==="sticker")&&c.current){const w=o.current?.getState(),M=[...w?.stickers||[],...w?.annotations||[],...w?.images||[]];for(let I=M.length-1;I>=0;I--)if(c.current.isPointInItem&&c.current.isPointInItem(S,y,M[I])){c.current.handleMouseDown(C),j=!0;break}}if(!j)switch(t){case"select":c.current?.handleMouseDown(C);break;case"crop":s.current?.handleMouseDown(C);break;case"annotate":if(e?.type==="text"){const w=document.createElement("canvas").getContext("2d");w.font=`${e.fontSize||$.FONT_SIZE}px Arial`;const M=w.measureText($.PLACEHOLDER),I={id:ft(),type:"text",x:S,y,width:M.width,height:e.fontSize||$.FONT_SIZE,text:$.PLACEHOLDER,color:e.color||$.COLOR,strokeWidth:$.STROKE_WIDTH,fontSize:e.fontSize||$.FONT_SIZE,fontWeight:$.FONT_WEIGHT,fontStyle:$.FONT_STYLE,textDecoration:$.TEXT_DECORATION,zIndex:Date.now()},E=[...o.current?.getState()?.annotations||[],I];o.current?.setState({annotations:E}),c.current&&(c.current.setSelectMode(!0),c.current.selectItem(I),h(!0),o.current?.render())}else a.current?.handleMouseDown(C,e?.type||"rectangle",e||{});break;case"sticker":if(i&&l.current){const w={id:ft(),sticker:1,type:i.type,content:i.content,x:S,y,size:48,rotation:0,zIndex:Date.now()};if(i.type==="image"){const M=new Image;M.crossOrigin="anonymous",M.onload=()=>{w.image=M,l.current.addSticker(w),c.current&&(c.current.setSelectMode(!0),c.current.selectItem(w),h(!0),o.current?.render())},M.onerror=I=>{console.error("Failed to load image:",I,i.content)},M.src=i.content}else l.current.addSticker(w),c.current&&(c.current.setSelectMode(!0),c.current.selectItem(w),h(!0),o.current?.render())}break}},[t,e,i,m,l,c,h,o]),f=_.useCallback(k=>{if(!r.current)return;const{canvasX:S,canvasY:y}=m(k),C={...k.nativeEvent,clientX:k.clientX,clientY:k.clientY,canvasX:S,canvasY:y};if((t==="annotate"||t==="sticker")&&c.current&&c.current.isDragging)c.current.handleMouseMove(C);else switch(t){case"select":c.current?.handleMouseMove(C);break;case"crop":s.current?.handleMouseMove(C);break;case"annotate":a.current?.handleMouseMove(C);break;case"sticker":l.current?.handleMouseMove(C);break}},[t,m]),v=_.useCallback(()=>{switch(c.current?.handleMouseUp(),t){case"crop":s.current?.handleMouseUp();break;case"annotate":a.current?.handleMouseUp();break;case"sticker":l.current?.handleMouseUp();break}},[t]),b=_.useCallback(k=>{if(!r.current||!c.current)return;const{canvasX:S,canvasY:y}=m(k),C={...k.nativeEvent,clientX:k.clientX,clientY:k.clientY,canvasX:S,canvasY:y};c.current.handleMouseDown(C);const j=c.current.selectedItem;if(j)if(j.type==="text"){g("select"),d({id:j.id,x:j.x,y:j.y,rotation:j.rotation||0}),u(j.text||"");const w=o.current?.getState()?.annotations?.filter(M=>M.id!==j.id)||[];o.current?.setState({annotations:w}),c.current?.clearSelection(),p(j),h(!0),o.current?.render()}else g("select"),h(!0),o.current?.render()},[m,g,d,u,p,h]);return{handleCanvasMouseDown:x,handleCanvasMouseMove:f,handleCanvasMouseUp:v,handleCanvasDoubleClick:b}},_i=({onUndo:r,onRedo:t,selectionPluginRef:e,imagePluginRef:i,setHasSelection:o})=>{const s=_.useCallback(a=>{const l=a.clipboardData?.items;if(l){for(const c of Array.from(l))if(c.type.startsWith("image/")){const h=c.getAsFile();h&&i.current&&i.current.addImageFromFile(h);break}}},[i]);_.useEffect(()=>{const a=l=>{const c=document.activeElement,h=c&&(c.tagName==="INPUT"||c.tagName==="TEXTAREA"||c.contentEditable==="true");l.ctrlKey||l.metaKey?l.key==="z"&&!l.shiftKey?(l.preventDefault(),r()):l.key==="z"&&l.shiftKey||l.key==="y"?(l.preventDefault(),t()):l.key==="v"&&(l.preventDefault(),navigator.clipboard.read().then(d=>{for(const u of d)for(const p of u.types)if(p.startsWith("image/")){u.getType(p).then(g=>{const m=new File([g],"pasted-image.png",{type:p});i.current&&i.current.addImageFromFile(m)});return}}).catch(()=>{s(l)})):(l.key==="Delete"||l.key==="Backspace")&&!h&&(l.preventDefault(),e.current&&(e.current.deleteSelected(),o(!1)))};return document.addEventListener("keydown",a),()=>document.removeEventListener("keydown",a)},[r,t,s,e,i,o])},pt=(r,t,e)=>{if(r.width===t.width&&r.height===t.height&&r.x===t.x&&r.y===t.y)return e;const i=t.width/r.width,o=t.height/r.height,s=t.x-r.x*i,a=t.y-r.y*o;return e.map(l=>({...l,x:l.x*i+s,y:l.y*o+a,width:l.width?l.width*i:l.width,height:l.height?l.height*o:l.height,size:l.size?l.size*Math.min(i,o):l.size,fontSize:l.fontSize?l.fontSize*Math.min(i,o):l.fontSize}))},Si=(r,t,e)=>{if(!e)return null;const i=t.width/r.width,o=t.height/r.height,s=t.x-r.x*i,a=t.y-r.y*o;return{...e,x:e.x*i+s,y:e.y*o+a}},Ci=10,Mi=({activeTool:r,editingText:t,editingTextItem:e,editorRef:i,cropPluginRef:o,selectionPluginRef:s,updateTextEditing:a})=>{_.useEffect(()=>{if(!i.current)return;const l=i.current.getImageDisplay();o.current&&o.current.setActive(r==="crop"),s.current&&s.current.setSelectMode(r==="select"),setTimeout(()=>{if(i.current){const c=i.current.getImageDisplay(),h=i.current.getState(),d=pt(l,c,h.annotations||[]),u=pt(l,c,h.stickers||[]),p=pt(l,c,h.images||[]);i.current.setState({annotations:d,stickers:u,images:p},!1);const g=Si(l,c,t);if(g&&a({editingText:g}),e){const m=pt(l,c,[e])[0];m&&a({editingTextItem:m})}if(s.current&&s.current.selectedItem){const m=s.current.selectedItem,x=pt(l,c,[m])[0];s.current.selectedItem=x}i.current.render()}},Ci)},[r])},Ii=({utils:r,filterOptions:t,cropSelectPresetOptions:e})=>{const i=_.useMemo(()=>r.map(a=>({id:a,...ge[a]})).filter(Boolean),[r]),o=_.useMemo(()=>[{id:"none",name:"Original"},...t.map(([a,l])=>({id:a,name:l}))],[t]),s=_.useMemo(()=>e.map(([a,l])=>({ratio:a,name:l})),[e]);return{tools:i,filters:o,cropPresets:s}},ji=()=>{const{t:r}=N();return n.jsxs("div",{className:"dk-image-editor__loading",children:[n.jsx("div",{className:"dk-image-editor__loading-spinner"}),n.jsx("div",{className:"dk-image-editor__loading-text",children:r("loading.image")})]})};var Ei='.dk-image-editor{background:#4d4d4d;display:flex;flex-direction:column;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;height:100%;position:relative;width:100%}.dk-image-editor__header{align-items:center;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);background:rgba(0,0,0,.3);border:1px solid hsla(0,0%,100%,.1);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.3);color:#fff;display:flex;justify-content:space-between;left:50%;padding:.5rem;position:absolute;top:20px;transform:translateX(-50%);z-index:1000}.dk-image-editor__header-left,.dk-image-editor__header-right{align-items:center;display:flex;gap:.5rem}.dk-image-editor__action-btn,.dk-image-editor__confirm-btn,.dk-image-editor__save-btn{border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-size:14px;padding:4px 8px}.dk-image-editor__action-btn{background:transparent;color:#fff}.dk-image-editor__action-btn:hover{background:hsla(0,0%,100%,.1)}.dk-image-editor__save-btn{background:#007bff;color:#fff}.dk-image-editor__save-btn:hover{background:#0056b3}.dk-image-editor__confirm-btn{background:#28a745;color:#fff}.dk-image-editor__confirm-btn:hover{background:#1e7e34}.dk-image-editor__output-size{align-items:center;display:flex;gap:4px;position:relative}.dk-image-editor__output-size input[type=number]{background:rgba(0,0,0,.5);border:1px solid hsla(0,0%,100%,.3);border-radius:4px;color:#fff;font-size:12px;padding:4px 6px;text-align:center;width:60px}.dk-image-editor__output-size input[type=number]:focus{border-color:#007bff;outline:none}.dk-image-editor__output-size span{color:hsla(0,0%,100%,.8);font-size:12px}.dk-image-editor__lock-btn{align-items:center;background:transparent;border:1px solid hsla(0,0%,100%,.2);border-radius:4px;color:hsla(0,0%,100%,.7);cursor:pointer;display:flex;font-size:12px;height:32px;justify-content:center;min-width:32px;padding:4px 6px;transition:all .2s}.dk-image-editor__lock-btn:hover{background:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.4);color:#fff}.dk-image-editor__lock-btn.locked{background:rgba(0,123,255,.2);border-color:#007bff;color:#007bff}.dk-image-editor__lock-btn.locked:hover{background:rgba(0,123,255,.3)}.dk-image-editor__main{display:flex;flex:1;overflow:auto;position:relative}.dk-image-editor__sidebar{backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);background:rgba(0,0,0,.3);border:1px solid hsla(0,0%,100%,.1);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.3);display:flex;flex-direction:column;gap:.5rem;left:20px;max-height:70vh;overflow-y:auto;padding:1rem 0;position:absolute;top:50%;transform:translateY(-50%);width:80px;z-index:1000}.dk-image-editor__tool-btn{align-items:center;background:transparent;border:none;border-radius:4px;color:hsla(0,0%,100%,.7);cursor:pointer;display:flex;flex-direction:column;gap:.25rem;margin:0 .5rem;padding:.5rem;transition:all .2s}.dk-image-editor__tool-btn:hover{background:hsla(0,0%,100%,.1);color:#fff}.dk-image-editor__tool-btn--active{background:rgba(0,123,255,.2);color:#007bff}.dk-image-editor__tool-icon{font-size:1.5rem}.dk-image-editor__tool-name{font-size:.75rem;text-align:center}.dk-image-editor__canvas{background:#222;flex:1;min-height:0;overflow:auto;position:relative}.dk-image-editor__canvas,.dk-image-editor__loading{align-items:center;display:flex;justify-content:center}.dk-image-editor__loading{background:rgba(34,34,34,.9);bottom:0;flex-direction:column;gap:1rem;left:0;position:absolute;right:0;top:0;z-index:100}.dk-image-editor__loading-spinner{animation:spin 1s linear infinite;border:3px solid hsla(0,0%,100%,.3);border-radius:50%;border-top-color:#007bff;height:40px;width:40px}.dk-image-editor__loading-text{color:#fff;font-size:14px;font-weight:500}.dk-image-editor__floating-toolbar{backdrop-filter:blur(10px);background:rgba(0,0,0,.5);border-radius:8px;display:flex;gap:8px;left:50%;padding:8px 12px;position:absolute;top:90px;transform:translateX(-50%);z-index:100}.dk-image-editor__toolbar-button{align-items:center;background:transparent;border:1px solid hsla(0,0%,100%,.2);border-radius:4px;color:#fff;cursor:pointer;display:flex;height:32px;justify-content:center;transition:all .2s;width:32px}.dk-image-editor__toolbar-button:hover{background:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.4)}.dk-image-editor__image-canvas{border-radius:4px;box-shadow:0 4px 20px rgba(0,0,0,.3);cursor:default;display:block;height:100%;width:100%}.dk-image-editor__image-canvas--select{cursor:default}.dk-image-editor__image-canvas--annotate,.dk-image-editor__image-canvas--crop{cursor:crosshair}.dk-image-editor__image-canvas--sticker{cursor:copy}.dk-image-editor__image-canvas--resize{cursor:nw-resize}.dk-image-editor__image-canvas--move{cursor:move}.dk-image-editor__image-canvas--rotate{cursor:grab}.dk-image-editor__controls{backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);background:rgba(0,0,0,.3);border:1px solid hsla(0,0%,100%,.1);border-radius:16px;bottom:20px;box-shadow:0 8px 32px rgba(0,0,0,.3);color:#fff;left:50%;max-height:160px;max-width:80vw;min-width:300px;overflow-y:auto;padding:1rem;position:absolute;transform:translateX(-50%);z-index:1000}.dk-image-editor__filter-btn,.dk-image-editor__preset-btn,.dk-image-editor__tool-button,.dk-image-editor__unified-button,.dk-image-editor__upload-button{align-items:center;background:transparent;border:1px solid hsla(0,0%,100%,.2);border-radius:4px;color:#fff;cursor:pointer;display:flex;font-size:12px;font-weight:500;height:32px;justify-content:center;padding:0 12px;transition:all .2s;white-space:nowrap}.dk-image-editor__filter-btn:hover,.dk-image-editor__preset-btn:hover,.dk-image-editor__tool-button:hover,.dk-image-editor__unified-button:hover,.dk-image-editor__upload-button:hover{background:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.4)}.dk-image-editor__unified-button--active{background:rgba(0,123,255,.3);border-color:#007bff;color:#007bff}.dk-image-editor__crop-controls{display:flex;flex-direction:column;gap:1rem}.dk-image-editor__presets{align-items:center;display:flex;flex-wrap:wrap;gap:8px}.dk-image-editor__size-inputs{align-items:center;display:flex;gap:4px;margin-left:12px;position:relative}.dk-image-editor__size-inputs input::-webkit-inner-spin-button,.dk-image-editor__size-inputs input::-webkit-outer-spin-button{-webkit-appearance:none!important}.dk-image-editor__size-inputs input[type=number]{-moz-appearance:textfield;background:rgba(0,0,0,.5);border:1px solid hsla(0,0%,100%,.3);border-radius:4px;color:#fff;font-size:12px;height:32px;padding:0 6px;text-align:center;transition:all .2s;width:60px}.dk-image-editor__size-inputs input[type=number]:focus{background:rgba(0,0,0,.7);border-color:#007bff;outline:none}.dk-image-editor__size-inputs input[type=number]::placeholder{color:hsla(0,0%,100%,.5)}.dk-image-editor__rotation-controls{display:flex;gap:1rem}.dk-image-editor__actions{display:flex;gap:.5rem}.dk-image-editor__actions button{align-items:center;background:transparent;border:1px solid hsla(0,0%,100%,.3);border-radius:4px;color:#fff;cursor:pointer;display:flex;font-size:12px;height:32px;justify-content:center;padding:0 12px;transition:all .2s}.dk-image-editor__actions button:hover{background:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.5)}.dk-image-editor__finetune-controls{display:flex;gap:1rem}.dk-image-editor__finetune-options{display:flex;flex-wrap:wrap;gap:6px}.dk-image-editor__finetune-option{align-items:center;background:transparent;border:1px solid hsla(0,0%,100%,.2);border-radius:4px;color:#fff;cursor:pointer;display:flex;font-size:10px;font-weight:500;height:32px;justify-content:center;transition:all .2s;width:32px}.dk-image-editor__finetune-option:hover{background:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.4)}.dk-image-editor__finetune-option--active{background:rgba(0,123,255,.3);border-color:#007bff;color:#007bff}.dk-image-editor__slider{align-items:center;display:flex;gap:.5rem}.dk-image-editor__slider label{font-size:.9rem}.dk-image-editor__slider input[type=range]{-webkit-appearance:none;background:hsla(0,0%,100%,.2);border-radius:2px;flex:1;height:4px;outline:none;width:90px}.dk-image-editor__slider input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;background:#007bff;border-radius:50%;cursor:pointer;height:16px;width:16px}.dk-image-editor__slider input[type=range]::-moz-range-thumb{background:#007bff;border:none;border-radius:50%;cursor:pointer;height:16px;width:16px}.dk-image-editor__slider span{color:hsla(0,0%,100%,.8);font-size:.875em;text-align:right}.dk-image-editor__slider input[type=number],.dk-image-editor__slider input[type=text]{background:rgba(0,0,0,.5);border:1px solid hsla(0,0%,100%,.3);border-radius:4px;color:#fff;font-size:.875em;padding:.5rem}.dk-image-editor__slider input[type=number]:focus,.dk-image-editor__slider input[type=text]:focus{background:rgba(0,0,0,.7);border-color:#007bff;outline:none}.dk-image-editor__slider input[type=color]{border:none;border-radius:4px;cursor:pointer;height:30px;width:40px}.dk-image-editor__annotate-controls{display:flex;flex-direction:column;gap:1rem}.dk-image-editor__annotate-settings{align-items:center;display:flex;gap:1rem;justify-content:center}.dk-image-editor__clear-fill{align-items:center;background:transparent;border:1px solid hsla(0,0%,100%,.3);border-radius:2px;color:#fff;cursor:pointer;display:flex;font-size:10px;height:20px;justify-content:center;transition:all .2s;width:20px}.dk-image-editor__clear-fill:hover{background:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.5)}.dk-image-editor__color-box{align-items:center;display:flex;gap:8px}.dk-image-editor__color-box label{font-size:12px}.dk-image-editor__compact-slider{align-items:center;display:flex;gap:8px}.dk-image-editor__compact-slider label{font-size:12px}.dk-image-editor__compact-slider input[type=range]{width:80px}.dk-image-editor__compact-slider span{font-size:12px;min-width:20px;text-align:center}.dk-image-editor__toolbar{display:flex;flex-wrap:wrap;gap:.5rem}.dk-image-editor__tool-button{align-items:center;display:flex;gap:4px;justify-content:center}.dk-image-editor__tool-button.active{background:rgba(0,123,255,.3);border-color:#007bff;color:#007bff}.dk-image-editor__fill-controls,.dk-image-editor__frame-controls,.dk-image-editor__image-controls,.dk-image-editor__resize-controls,.dk-image-editor__sticker-controls{display:flex;flex-direction:column;gap:1rem}.dk-image-editor__upload-button{align-items:center;align-self:stretch;border-radius:4px;cursor:pointer;display:flex;flex-direction:row;gap:4px;height:auto;justify-content:center;width:80px}.dk-image-editor__upload-icon{font-size:16px;font-weight:300;line-height:1}.dk-image-editor__upload-text{font-size:12px}.dk-image-editor .dk-img-editor-selection-box{border:2px dashed #fff!important;box-sizing:border-box!important;pointer-events:none!important;z-index:10!important}.dk-image-editor .dk-img-editor-manipulator{box-sizing:border-box!important;pointer-events:auto!important;z-index:11!important}.dk-image-editor .dk-img-editor-manipulator[data-control=point]{background:#007bff!important;border:2px solid #fff!important;border-radius:2px!important;height:12px!important;width:12px!important}.dk-image-editor .dk-img-editor-manipulator[data-control=rotate]{background:transparent!important;border:none!important;border-radius:0!important;height:16px!important;width:16px!important}.dk-image-editor__preset-select{background:transparent;border:1px solid hsla(0,0%,100%,.3);border-radius:4px;color:#fff;font-size:12px}@media (max-width:768px){.dk-image-editor__main{flex-direction:column}.dk-image-editor__sidebar{bottom:10px;flex-direction:row;height:auto;left:5vw;overflow-x:auto;padding:.5rem;top:auto;transform:none;width:90vw}.dk-image-editor__tool-name{font-size:10px}.dk-image-editor__tool-btn{margin:0 .25rem;min-width:60px;padding:2px}.dk-image-editor__controls{bottom:100px;font-size:10px;left:5vw;max-height:120px;max-width:90vw;overflow-y:auto;padding:12px;transform:none;width:90vw}.dk-image-editor__controls label{font-size:10px}.dk-image-editor__loading-spinner{height:30px;width:30px}.dk-image-editor__loading-text{font-size:12px}.dk-image-editor__actions button,.dk-image-editor__lock-btn,.dk-image-editor__preset-btn,.dk-image-editor__size-inputs input[type=number],.dk-image-editor__tool-button{height:24px;padding:0 8px}.dk-image-editor__filter-icon{height:32px;width:32px}.dk-image-editor__filter-name{font-size:10px}.dk-image-editor__filter-preview{border:0}.dk-image-editor__finetune-controls{flex-direction:column}.dk-image-editor__slider input[type=range]{width:50px}}.dk-image-editor__color-button{background:transparent;border:0}.dk-image-editor__color-button .dk-image-editor__color-picker{align-items:center;border:2px solid #fff;border-radius:50%;cursor:pointer;display:flex;flex-shrink:0;height:22px;overflow:hidden;transition:all .2s;width:22px}.dk-image-editor__color-button .dk-image-editor__color-picker input[type=color]{background:none;border:none;cursor:pointer;height:100%;transform:scale(3);transform-origin:center;width:100%}.dk-image-editor__color-button .dk-image-editor__color-picker input[type=color]:hover{border-color:hsla(0,0%,100%,.6);transform:scale(4)}.d-flex{display:flex}.align-items-center{align-items:center}.justify-content-center{justify-content:center}.flex-shrink-0{flex-shrink:0}.gap-2{gap:12px}.gap-50{gap:4px}.css-loading{background-color:rgba(0,0,2,0);min-height:60px;position:relative}.css-loading:before{background:hsla(0,0%,100%,.251);bottom:0;content:"";left:0;position:absolute;right:0;top:0;z-index:1}.css-loading:after{animation:spin 1s linear infinite;border:3px solid #f0f4f7;border-radius:50%;border-top-color:#007bff;content:"";height:30px;left:calc(50% - 15px);position:absolute;top:calc(50% - 15px);width:30px;z-index:2}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}';_t(Ei);const Ti=({src:r,onSave:t,onClose:e,onConfirm:i,className:o="",utils:s=["select","crop","filter","annotate","sticker","finetune","frame"],cropSelectPresetOptions:a=pe,annotateTools:l=me,stickerEnableSelectImagePreset:c=!0,filterOptions:h=xe,finetuneOptions:d=fe,showCloseButton:u=!0,showDownloadButton:p=!0})=>{const g=zt(),m=dt(),x=Pt(),f=He(),{setEditorState:v,updateUIState:b,updateTextEditing:k,setImageLoading:S}=ut(),{canvasRef:y}=nt(),{activeTool:C,isVisible:j,hasSelection:w,selectedFinetuneOption:M,lastAnnotateColor:I,zoomLevel:E,currentAnnotation:R,currentSticker:A}=m,{editingText:L,editingValue:z,editingTextItem:q}=x,{editorRef:F,cropPluginRef:P,filterPluginRef:mt,annotatePluginRef:at,stickerPluginRef:Q,finetunePluginRef:rt,imagePluginRef:lt,selectionPluginRef:D,advancedFilterPluginRef:ct,applyAdvancedFilter:xt}=gi(),{tools:H,filters:V,cropPresets:kt}=Ii({utils:s,filterOptions:h,cropSelectPresetOptions:a}),ht=typeof r=="string"&&(r.startsWith("http://")||r.startsWith("https://"));_.useEffect(()=>{ht&&S(!0)},[r,ht,S]),wi({canvasRef:y,editorRef:F,cropPluginRef:P,filterPluginRef:mt,annotatePluginRef:at,stickerPluginRef:Q,finetunePluginRef:rt,imagePluginRef:lt,selectionPluginRef:D,advancedFilterPluginRef:ct,src:r,zoomLevel:E,setEditorState:v,setHasSelection:T=>b({hasSelection:T}),onImageLoadStart:()=>ht&&S(!0),onImageLoadEnd:()=>S(!1)}),Mi({activeTool:C,editingText:L,editingTextItem:q,editorRef:F,cropPluginRef:P,selectionPluginRef:D,updateTextEditing:k});const{handleCanvasMouseDown:Yt,handleCanvasMouseMove:Gt,handleCanvasMouseUp:Zt,handleCanvasDoubleClick:Ht}=vi({canvasRef:y,activeTool:C,currentAnnotation:R,currentSticker:A,editorRef:F,cropPluginRef:P,annotatePluginRef:at,stickerPluginRef:Q,selectionPluginRef:D,setHasSelection:T=>b({hasSelection:T}),setEditingText:T=>k({editingText:T}),setEditingValue:T=>k({editingValue:T}),setEditingTextItem:T=>k({editingTextItem:T}),setActiveTool:T=>b({activeTool:T})}),Mt=_.useCallback(()=>F.current?.undo(),[]),It=_.useCallback(()=>F.current?.redo(),[]);_i({onUndo:Mt,onRedo:It,selectionPluginRef:D,imagePluginRef:lt,setHasSelection:T=>b({hasSelection:T})});const Vt=_.useCallback(T=>{if(!F.current)return;D.current?.clearSelection();const J={crop:{width:1e3,height:1e3,x:0,y:0},rotation:0,flipX:!1,flipY:!1,scale:1,skewX:0,skewY:0,brightness:0,contrast:0,saturation:0,exposure:0,gamma:0,vignette:0,filter:"none",appliedFilters:[],annotations:[],stickers:[],images:[],backgroundColor:"transparent",frame:"none",filterCounts:{}};F.current.setState(J,!1),v(J),b({activeTool:"crop",hasSelection:!1,selectedFinetuneOption:"brightness",lastAnnotateColor:"#ff0000",zoomLevel:1,currentAnnotation:null,currentSticker:null}),k({editingText:null,editingValue:"",editingTextItem:null}),P.current?.setActive?.(!1);const tt=new FileReader;tt.onload=jt=>{jt.target?.result&&F.current&&F.current.loadImage(jt.target.result)},tt.readAsDataURL(T)},[v,b,k,D,P,mt,at,Q,rt,ct]),Kt=_.useCallback(async()=>{if(!(!F.current||!t||!g))try{const T=await F.current.export("blob"),J=new File([T],"edited-image.png",{type:"image/png"}),tt=URL.createObjectURL(T);t({src:tt,dest:J,imageState:g})}catch(T){console.error("Export failed:",T)}},[t,g]),qt=_.useCallback(async()=>{if(!(!F.current||!i||!y.current||!g))try{const T=await F.current.export("blob"),J=new File([T],"edited-image.png",{type:"image/png"}),tt=URL.createObjectURL(T);i({src:tt,dest:J,imageState:g,canvas:y.current})}catch(T){console.error("Confirm export failed:",T)}},[i,g]),Qt=_.useCallback(T=>{F.current&&F.current.setState(T)},[]),Jt=_.useCallback(()=>{b({isVisible:!1}),setTimeout(()=>e?.(),U.ANIMATION_DURATION)},[e,b]);return j?n.jsxs("div",{className:`dk-image-editor ${o}`,children:[n.jsx(di,{onClose:Jt,onConfirm:qt,onUndo:Mt,onRedo:It,onSave:Kt,onUpload:Vt,showCloseButton:u,showDownloadButton:p}),n.jsxs("div",{className:"dk-image-editor__main",children:[n.jsx(ui,{tools:H}),f&&n.jsx(ji,{}),n.jsx(si,{onMouseDown:Yt,onMouseMove:Gt,onMouseUp:Zt,onDoubleClick:Ht})]}),n.jsx(Ve,{cropPresets:kt,filters:V,annotateTools:l,finetuneOptions:d,onStateChange:Qt,applyAdvancedFilter:xt})]}):null},Fi=r=>n.jsx(Ft,{language:r.language||"en",translations:r.translations,children:n.jsx(Ze,{children:n.jsx(Ti,{...r})})});class Ri{static async loadImageFromFile(t){return new Promise((e,i)=>{const o=new Image;o.onload=()=>e(o),o.onerror=i,o.src=URL.createObjectURL(t)})}static async getImageData(t){const e=document.createElement("canvas");e.width=t.width||t.naturalWidth,e.height=t.height||t.naturalHeight;const i=e.getContext("2d");return i.drawImage(t,0,0),i.getImageData(0,0,e.width,e.height)}static createCanvasFromImageData(t){const e=document.createElement("canvas");return e.width=t.width,e.height=t.height,e.getContext("2d").putImageData(t,0,0),e}static async canvasToBlob(t,e="image/png",i=.9){return new Promise((o,s)=>{t.toBlob(a=>{a?o(a):s(new Error("Failed to create blob"))},e,i)})}}exports.AdvancedFilterPlugin=Nt,exports.AnnotatePlugin=Bt,exports.ColorSpaceManager=Ct,exports.CropPlugin=Lt,exports.DkImageEditor=Fi,exports.EditorCore=Dt,exports.ExifProcessor=Xt,exports.FilterPlugin=Ot,exports.FinetunePlugin=Ut,exports.I18nProvider=Ft,exports.ImageProcessor=Ri,exports.MemoryManager=K,exports.StickerPlugin=Wt,exports.defaultTranslations=it,exports.useTranslation=N;
//# sourceMappingURL=index.js.map
